{"version":3,"file":"lisco.cjs","sources":["../src/common/Utils.js","../src/common/I18nLoader.js","../src/common/JsonResponse.js","../src/common/TokenGenerator.js","../src/server/Server.js","../src/server/ClusterServer.js","../src/events/EventHandler.js","../src/logger/Logger.js","../src/auth/AuthController.js","../src/auth/IAuthHandler.js","../src/auth/jwt/JwtAuthHandler.js","../src/auth/cookie/CookieAuthHandler.js","../src/db/knex/KnexConnector.js","../src/db/knex/filters/KnexFilterParser.js","../src/db/knex/dao/BaseKnexDao.js","../src/db/IUserDao.js","../src/base/BaseController.js","../src/base/BaseService.js","../src/common/Runtime.js","../src/App.js"],"sourcesContent":["import crypto from 'crypto';\r\nimport util from 'util';\r\n\r\nexport default class Utils {\r\n    static arrayToLower(mcArray) {\r\n        let tmp = mcArray.join('~').toLowerCase();\r\n        return tmp.split('~');\r\n    }\r\n\r\n    static replaceAll(str, find, replace) {\r\n        return str.replace(new RegExp(find.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&'), 'g'), replace);\r\n    }\r\n\r\n    /**\r\n     * Metodo de encript para las contraseñas y demas.\r\n     * \r\n     * @param {*} text \r\n     */\r\n    static encrypt(text) {\r\n        const algorithm = 'aes-256-cbc';\r\n        const secret = Buffer.from(process.env.CRYPT_SECRET, 'hex');\r\n        const iv = Buffer.from(process.env.CRYPT_IV, 'hex');\r\n\r\n        const cipher = crypto.createCipheriv(algorithm, secret, iv);\r\n        let encrypted = cipher.update(text);\r\n        encrypted = Buffer.concat([encrypted, cipher.final()]);\r\n        return encrypted.toString('hex');\r\n    }\r\n\r\n    /**\r\n     * Metodo de decrypt para las contraseñas y demas\r\n     * @param {*} text \r\n     */\r\n    static decrypt(text) {\r\n        const algorithm = 'aes-256-cbc';\r\n        const secret = Buffer.from(process.env.CRYPT_SECRET, 'hex');\r\n        const iv = Buffer.from(process.env.CRYPT_IV, 'hex');\r\n\r\n        const encryptedText = Buffer.from(text, 'hex');\r\n\r\n        const decipher = crypto.createDecipheriv(algorithm, secret, iv);\r\n        let decrypted = decipher.update(encryptedText);\r\n        decrypted = Buffer.concat([decrypted, decipher.final()]);\r\n        return decrypted.toString();\r\n    }\r\n\r\n\r\n    /**\r\n     * \r\n     * Utiliza una promise para ejecutar un setTimeout y hacer un falso sleep.\r\n     * \r\n     * @param {*} ms \r\n     */\r\n    static sleep(ms) {\r\n        let promise_sleep = util.promisify(setTimeout);\r\n\r\n        return promise_sleep(ms);\r\n    }\r\n\r\n    /**\r\n     * Genera dos claves para los metodos crypt y decrypt\r\n     */\r\n    static generateKeys() {\r\n        return {\r\n            key: crypto.randomBytes(32).toString('hex'),\r\n            iv: crypto.randomBytes(16).toString('hex')\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * \"aplana\" un objeto jerarquico en una estructura clave-valor.\r\n     * \r\n     * @param {*} ob \r\n     * @returns \r\n     */\r\n    static flattenObject(ob) {\r\n        let toReturn = {};\r\n        let flatObject;\r\n        for (let i in ob) {\r\n            if (!ob.hasOwnProperty(i)) {\r\n                continue;\r\n            }\r\n            //Devolver los arrays tal cual\r\n            if (ob[i] && Array === ob[i].constructor) {\r\n                toReturn[i] = ob[i];\r\n                continue;\r\n            }\r\n            if ((typeof ob[i]) === 'object') {\r\n                flatObject = Utils.flattenObject(ob[i]);\r\n                for (let x in flatObject) {\r\n                    if (!flatObject.hasOwnProperty(x)) {\r\n                        continue;\r\n                    }\r\n                    //Exclude arrays from the final result\r\n                    if (flatObject[x] && Array === flatObject.constructor) {\r\n                        continue;\r\n                    }\r\n                    toReturn[i + (!!isNaN(x) ? '.' + x : '')] = flatObject[x];\r\n                }\r\n            } else {\r\n                toReturn[i] = ob[i];\r\n            }\r\n        }\r\n        return toReturn;\r\n    }\r\n\r\n    /**\r\n     * Invierte un objeto aplanado recuperando su forma original\r\n     * \r\n     * @param {*} data \r\n     * @returns \r\n     */\r\n    static unflatten(data) {\r\n        var result = {}\r\n        for (var i in data) {\r\n            var keys = i.split('.')\r\n            keys.reduce(function (r, e, j) {\r\n                return r[e] || (r[e] = isNaN(Number(keys[j + 1])) ? (keys.length - 1 == j ? data[i] : {}) : [])\r\n            }, result)\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * \r\n     * @returns \r\n     */\r\n    static expressHandler() {\r\n\r\n        return (fn) => {\r\n            return function asyncUtilWrap(...args) {\r\n                const fnReturn = fn(...args);\r\n                const next = args[args.length - 1];\r\n                return Promise.resolve(fnReturn).catch((e) => {\r\n                    return next(e);\r\n                });\r\n            };\r\n        };\r\n    }\r\n}\r\n\r\n","import fs from \"fs\";\r\nimport util from \"util\";\r\nimport Utils from \"./Utils.js\";\r\n\r\nimport chokidar from \"chokidar\";\r\n\r\nexport default class I18nLoader {\r\n    constructor() {\r\n        this.watcher = {};\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param lang\r\n     * @param callback\r\n     */\r\n    async load(custom) {\r\n        const lang = custom || process.env.DEFAULT_LANG;\r\n\r\n        if (!this.currentData) {\r\n            this.currentData = {};\r\n        }\r\n        if (!this.currentDataFlat) {\r\n            this.currentDataFlat = {};\r\n        }\r\n\r\n        const file = process.cwd() + \"/i18n/lang_\" + lang + \".json\";\r\n\r\n        // Initialize watcher.\r\n        this.watcher[lang] = chokidar.watch(file, {\r\n            ignored: /(^|[/\\\\])\\../, // ignore dotfiles\r\n            persistent: true,\r\n        });\r\n        //Add change watcher\r\n        this.watcher[lang].on(\"change\", (path) => this.loadFile(path, lang));\r\n\r\n        //Initialize file load\r\n        await this.loadFile(file, lang);\r\n    }\r\n\r\n    /**\r\n     * Carga el archivo de traducciones.\r\n     *\r\n     * @param {*} file\r\n     * @param {*} lang\r\n     */\r\n    async loadFile(file, lang) {\r\n        const readfile = util.promisify(fs.readFile);\r\n        try {\r\n            const data = await readfile(file, \"utf8\");\r\n            var parsedData = JSON.parse(data);\r\n\r\n            this.currentDataFlat[lang] = Utils.flattenObject(parsedData);\r\n            this.currentData[lang] = parsedData;\r\n        } catch (ex) {\r\n            if (ex?.code === \"ENOENT\") {\r\n                return console.log(\"Lang file does not exist. Create it on ./i18n/lang_{xx}.json\");\r\n            }\r\n            console.error(ex);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {*} key\r\n     */\r\n    async translate(key, lang) {\r\n        if (!lang) lang = process.env.DEFAULT_LANG;\r\n\r\n        if (this.currentDataFlat && this.currentDataFlat[lang] && this.currentDataFlat[lang][key]) {\r\n            return this.currentData[lang][key];\r\n        }\r\n\r\n        if (!this.currentDataFlat || !this.currentDataFlat[lang]) {\r\n            await this.load(lang);\r\n            if (this.currentDataFlat && this.currentDataFlat[lang] && this.currentDataFlat[key]) {\r\n                return this.currentDataFlat[lang][key];\r\n            }\r\n        }\r\n        return \"undefined.\" + key;\r\n    }\r\n}\r\n","export default class JsonResponse {\r\n    constructor(success, data, message, total) {\r\n        this.data = data;\r\n        this.success = success;\r\n        this.total = total;\r\n        this.message = message || '';\r\n    }\r\n\r\n    toJson() {\r\n        return (this);\r\n    }\r\n}\r\n","/**\r\n * Example to refresh tokens using https://github.com/auth0/node-jsonwebtoken\r\n * It was requested to be introduced at as part of the jsonwebtoken library,\r\n * since we feel it does not add too much value but it will add code to mantain\r\n * we won't include it.\r\n *\r\n * I create this gist just to help those who want to auto-refresh JWTs.\r\n */\r\nimport jsonwebtoken from 'jsonwebtoken';\r\nimport * as uuid from 'uuid';\r\n\r\nexport default class TokenGenerator {\r\n\r\n    constructor(privateKey, options) {\r\n        this.privateKey = privateKey;\r\n        this.options = options;\r\n    }\r\n\r\n    sign(payload) {\r\n        const jwtSignOptions = { ...this.options, jwtid: uuid.v4() };\r\n        return jsonwebtoken.sign(payload, this.privateKey, jwtSignOptions);\r\n    }\r\n\r\n    verify(token) {\r\n        return jsonwebtoken.verify(token, this.privateKey, this.options);\r\n    }\r\n\r\n    refresh(token) {\r\n        const payload = jsonwebtoken.verify(token, this.privateKey, this.options);\r\n        delete payload.sub;\r\n        delete payload.iss;\r\n        delete payload.aud;\r\n        delete payload.iat;\r\n        delete payload.exp;\r\n        delete payload.nbf;\r\n        delete payload.jti; //We are generating a new token, if you are using jwtid during signing, pass it in refreshOptions\r\n        const jwtSignOptions = { ...this.options, jwtid: uuid.v4() };\r\n        // The first signing converted all needed options into claims, they are already in the payload\r\n        return jsonwebtoken.sign(payload, this.privateKey, jwtSignOptions);\r\n    }\r\n}\r\n","import helmet from \"helmet\";\r\nimport express from \"express\";\r\nimport compression from \"compression\";\r\nimport cors from \"cors\";\r\nimport fileUpload from \"express-fileupload\";\r\nimport url from \"url\";\r\nimport lodash from \"lodash\";\r\nimport { JsonResponse, Utils } from \"../common/index.js\";\r\n\r\n/**\r\n * Clase servidor encargada de configurar las rutas.\r\n *\r\n * que el codigo se disperse entre diferentes proyectos.\r\n */\r\nexport default class Server {\r\n    /**\r\n     *\r\n     * @param {*} config\r\n     * @param {*} statics\r\n     * @param {*} routes\r\n     */\r\n    constructor(config, statics, routes) {\r\n        this.app = express();\r\n        this.express_config = lodash.defaultsDeep(config, {\r\n            helmet: true,\r\n            json: true,\r\n            urlencoded: true,\r\n            compression: true,\r\n            cors: { origin: true, credentials: true },\r\n            fileupload: true,\r\n            socketio: { transports: [\"websocket\"] },\r\n            traceRequests: false,\r\n        });\r\n        this.statics = statics;\r\n        this.routes = routes;\r\n    }\r\n\r\n    /**\r\n     * Inicializa el servidor\r\n     */\r\n    async initialize() {\r\n        this.config(this.express_config);\r\n        if (this.customizeExpress) {\r\n            await this.customizeExpress(this.app);\r\n        }\r\n        await this.configureRoutes(this.routes);\r\n        await this.errorHandler();\r\n    }\r\n\r\n    /**\r\n     * Funcion sobreescribible para personalizar los componentes cargados en Express\r\n     *\r\n     * Aqui se pueden poner cosas como:\r\n     *\r\n     * this.app.use(cookieParser())... etc\r\n     */\r\n    customizeExpress() {}\r\n\r\n    /**\r\n     * Se encarga de realizar la configuración inicial del servidor\r\n     *\r\n     */\r\n    config(config) {\r\n        if (config && config.helmet) {\r\n            //Security\r\n            this.app.use(helmet(config && lodash.isObject(config.helmet) && config.helmet));\r\n        }\r\n        if (config && config.json) {\r\n            //mount json form parser\r\n            this.app.use(express.json());\r\n        }\r\n\r\n        if (config && config.urlencoded) {\r\n            //mount query string parser\r\n            this.app.use(express.urlencoded({ extended: true }));\r\n        }\r\n        if (config && config.compression) {\r\n            // compress responses\r\n            this.app.use(compression());\r\n        }\r\n        if (config && config.cors) {\r\n            //Enable cors to allow external references\r\n            this.app.options(\"*\", cors(config && lodash.isObject(config.cors) && config.cors));\r\n            this.app.use(cors(config && lodash.isObject(config.cors) && config.cors));\r\n        }\r\n        if (config && config.fileupload) {\r\n            // upload middleware\r\n            this.app.use(fileUpload());\r\n        }\r\n\r\n        if (this.statics) {\r\n            //add static paths\r\n            for (const idx in this.statics) {\r\n                this.app.use(idx, express.static(this.statics[idx]));\r\n            }\r\n        }\r\n\r\n        //Logging\r\n        if (config && config.traceRequests === true && process.env.DISABLE_LOGGER != \"true\") {\r\n            this.app.use((request, response, next) => {\r\n                request.requestTime = Date.now();\r\n                response.on(\"finish\", () => {\r\n                    let pathname = url.parse(request.url).pathname;\r\n                    let end = Date.now() - request.requestTime;\r\n                    let user = (request && request.session && request.session.user_id) || \"\";\r\n\r\n                    console.debug(\"APIRequest[\" + process.pid + \"]::. [\" + request.method + \"] (user:\" + user + \")  \" + pathname + \" |-> took: \" + end + \" ms\");\r\n                    console.debug(JSON.stringify(request.body));\r\n                });\r\n                next();\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Crea el cargador automatico de rutas\r\n     */\r\n    configureRoutes(routes) {\r\n        const router = express.Router();\r\n        this.app.use(router);\r\n\r\n        //create controllers\r\n        this.loadRoutes(this.app, routes);\r\n    }\r\n\r\n    /**\r\n     * Instancia la lista de rutas disponibles\r\n     * @param apps\r\n     * @returns {*}\r\n     */\r\n    loadRoutes(app, routes) {\r\n        if (!routes) return;\r\n\r\n        for (const route of routes) {\r\n            if (!route) {\r\n                console.warn(\"Empty route\");\r\n                continue;\r\n            }\r\n            let router = route.configure();\r\n\r\n            //perform autoconfig for base api crud operations\r\n            if (route.entity) {\r\n                router = route.configure(route.entity, { service: route.service, table: route.table });\r\n            }\r\n\r\n            //load shorthand routes\r\n            if (!lodash.isEmpty(route.routes)) {\r\n                const exAsync = Utils.expressHandler();\r\n                for (const path in route.routes) {\r\n                    const cfg = route.routes[path];\r\n                    for (const method in cfg) {\r\n                        const handler = cfg[method];\r\n                        if (Array.isArray(handler)) {\r\n                            //Securización (keycloak)\r\n                            router[method](path, handler[0], exAsync(handler[1]));\r\n                        } else {\r\n                            router[method](path, exAsync(handler));\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            if (router) {\r\n                app.use(router);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Errores\r\n     */\r\n    errorHandler() {\r\n        // error handler\r\n        this.app.use((err, req, res, next) => {\r\n            let jsRes = new JsonResponse();\r\n            jsRes.success = false;\r\n            jsRes.message = err.message; //!FIXME protect error displaying in REST Responses\r\n            console.error(err);\r\n\r\n            res.status(500).json(jsRes.toJson());\r\n        });\r\n    }\r\n}\r\n","import http from \"http\";\r\nimport https from \"https\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport cluster from \"cluster\";\r\nimport { Server } from \"socket.io\";\r\nimport os from \"os\";\r\nimport { EventEmitter } from \"events\";\r\n\r\nimport ClusterMessages from \"cluster-messages\";\r\n\r\n/**\r\n * Inicializa la escucha del server en modo cluster\r\n */\r\nexport default class ClusterServer extends EventEmitter {\r\n    constructor(app) {\r\n        super();\r\n\r\n        if (!process.env.PORT) {\r\n            console.log(\"Using 3000 as default port. Customize via env PORT.\");\r\n        }\r\n        this.port = this.normalizePort(process.env.PORT || 3000);\r\n        this.clustered = process.env.CLUSTERED;\r\n        this.workers = [];\r\n        this.app = app;\r\n\r\n        this.executeOnlyMain = () => {};\r\n    }\r\n\r\n    setServerCls(cls) {\r\n        this.server = cls;\r\n    }\r\n\r\n    /**\r\n     * Iniciar el servidor en el puerto y con la configuración seleccionadas.\r\n     */\r\n    async start() {\r\n        if (this.clustered == \"true\") {\r\n            this.initClustered();\r\n        } else {\r\n            this.configureSocketIO();\r\n            this.executeOnlyMain();\r\n\r\n            await this.initUnclustered();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Inicializa el servidor de socketio en el puerto siguiente al configurado.\r\n     *\r\n     * Se puede desactivar mediante la config socketio: false al realizar el App.init()\r\n     */\r\n    configureSocketIO() {\r\n        if (this.server.express_config && this.server.express_config.socketio) {\r\n            this.app.io = new Server(this.server.express_config && this.server.express_config.socketio);\r\n            this.app.io.listen(this.port + 1);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Inicializa la clase server encargada del control de las solicitudes en forma multiproceso.\r\n     *\r\n     */\r\n    async initClustered() {\r\n        //Launch cluster\r\n        if (cluster.isPrimary) {\r\n            this.configureSocketIO();\r\n\r\n            this.executeOnlyMain();\r\n\r\n            let messages = new ClusterMessages();\r\n            messages.on(\"event\", (msg, callback) => {\r\n                if (msg && msg.event) {\r\n                    if (process.env.DEBUG_EVENTS == true) {\r\n                        console.debug(`Received '${msg.event}' from ${msg.props.owner} at Master`);\r\n                    }\r\n                    //Desencadenar en el proceso principal tambien\r\n                    this.app.events.emit(msg.event, msg.props, callback);\r\n                }\r\n            });\r\n\r\n            //Count the machine's CPUs\r\n            const cpuCount = os.cpus().length;\r\n\r\n            //Create a worker for each CPU\r\n            for (let idx = 0; idx < cpuCount; idx += 1) {\r\n                this.initWorker();\r\n            }\r\n\r\n            //Listen for dying workers\r\n            cluster.on(\"exit\", (worker) => {\r\n                //Replace the dead worker, we're not sentimental\r\n                console.log(\"Worker \" + worker.id + \" died :(\");\r\n                this.initWorker();\r\n            });\r\n        } else {\r\n            await this.initUnclustered();\r\n            console.log(`Worker ${process.pid} started`);\r\n        }\r\n    }\r\n    /**\r\n     * Inicia un worker\r\n     */\r\n    initWorker() {\r\n        let worker = cluster.fork();\r\n        console.log(`Running worker ${worker.process.pid}`);\r\n\r\n        this.workers.push(worker);\r\n    }\r\n\r\n    /**\r\n     * Inicializa la clase server encargada del control de las solicitudes en un unico proceso.\r\n     *\r\n     */\r\n    async initUnclustered() {\r\n        this.server.port = this.port;\r\n        //create http server\r\n        let server = http.Server(this.server.app);\r\n\r\n        await this.server.initialize();\r\n\r\n        if (this.server.beforeListen) await this.server.beforeListen();\r\n        //listen on provided ports\r\n        server.listen(this.server.port);\r\n\r\n        if (this.server.afterListen) await this.server.afterListen();\r\n\r\n        //add error handler\r\n        server.on(\"error\", (err) => {\r\n            this.handleErrors(err, this.server.port);\r\n        });\r\n        //start listening on port\r\n        server.on(\"listening\", () => {\r\n            console.log(\"Server Worker running on port: \" + this.port + \"!\");\r\n            this.emit(\"listening\", this.port);\r\n        });\r\n\r\n        if (process.env.SSL && process.env.SSL == \"true\") {\r\n            if (!process.env.SSL_KEY || !process.env.SSL_CERT || !process.env.SSL_PASS) {\r\n                console.error(\"Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed\");\r\n                process.exit(0);\r\n            }\r\n\r\n            var key = fs.readFileSync(path.resolve(process.cwd(), process.env.SSL_KEY || \"key.pem\"));\r\n            var cert = fs.readFileSync(path.resolve(process.cwd(), process.env.SSL_CERT || \"cert.pem\"));\r\n\r\n            var options = {\r\n                key: key,\r\n                cert: cert,\r\n                passphrase: process.env.SSL_PASS,\r\n            };\r\n\r\n            if (!process.env.SSL_PORT) {\r\n                console.log(\"Using 3443 as ssl default port. Customize via env SSL_PORT.\");\r\n            }\r\n            var sslPort = this.normalizePort(process.env.SSL_PORT || 3443);\r\n            var serverSsl = https.createServer(options, this.server.app);\r\n            serverSsl.listen(sslPort);\r\n            //add error handler\r\n            serverSsl.on(\"error\", (err) => {\r\n                this.handleErrors(err, sslPort);\r\n            });\r\n            //start listening on port\r\n            serverSsl.on(\"listening\", () => {\r\n                console.log(\"Server Worker running on port: \" + sslPort + \"!\");\r\n                this.emit(\"listening_ssl\", sslPort);\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Controla los posibles errores de formato en el puerto\r\n     * @param val\r\n     * @returns {*}\r\n     */\r\n    normalizePort(val) {\r\n        let port = parseInt(val, 10);\r\n\r\n        if (isNaN(port)) {\r\n            //named pipe\r\n            return val;\r\n        }\r\n\r\n        if (port >= 0) {\r\n            //port number\r\n            return port;\r\n        }\r\n\r\n        return false;\r\n    }\r\n    /**\r\n     * Gestiona los errores en el listen del servidor\r\n     */\r\n    handleErrors(error, port) {\r\n        if (error.syscall !== \"listen\") {\r\n            throw error;\r\n        }\r\n\r\n        let bind = typeof port === \"string\" ? \"Pipe \" + port : \"Port \" + port;\r\n\r\n        //handle specific listen errors with friendly messages\r\n        switch (error.code) {\r\n            case \"EACCES\":\r\n                console.error(bind + \" requires elevated privileges\");\r\n                process.exit(1);\r\n                break;\r\n            case \"EADDRINUSE\":\r\n                console.error(bind + \" is already in use\");\r\n                process.exit(1);\r\n                break;\r\n            default:\r\n                throw error;\r\n        }\r\n    }\r\n}\r\n","import cluster from \"cluster\";\r\nimport { EventEmitter } from \"events\";\r\nimport ClusterMessages from \"cluster-messages\";\r\n\r\n/**\r\n * Clase encargada de la generacion de eventos.\r\n */\r\nexport default class EventHandler extends EventEmitter {\r\n    constructor(app) {\r\n        super();\r\n        this.messages = new ClusterMessages();\r\n\r\n        this.app = app; //Se recibe el singleton App para evitar referencias cruzadas\r\n\r\n        if (cluster.isWorker) {\r\n            // Levanto, en los worker, la escucha para recibir los eventos en broadcast de los demas hilos\r\n            this.messages.on(\"event\", (msg, callback) => {\r\n                if (msg && msg.event && process.pid !== msg.props.owner) {\r\n                    if (process.env.DEBUG_EVENTS == true) {\r\n                        console.debug(`Receiving broadcast ${msg.event} - ${process.pid}`);\r\n                    }\r\n                    super.emit(msg.event, { ...msg.props }, callback);\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sobreescribir el emitter para notificar a los hijos\r\n     *\r\n     * @param {*} evt\r\n     * @param {*} props\r\n     */\r\n    emit(evt, props, callback) {\r\n        //Desencadenar en local\r\n        super.emit(evt, props, callback);\r\n\r\n        if (evt && props && cluster.isWorker && process.pid !== props.owner) {\r\n            if (process.env.DEBUG_EVENTS == true) {\r\n                console.debug(`${evt} -> Firing from ${process.pid} to master`);\r\n            }\r\n            if (!props) {\r\n                props = {};\r\n            }\r\n            props.owner = process.pid;\r\n            this.messages.send(\"event\", { event: evt, props: { ...props } }, callback);\r\n        }\r\n\r\n        if (evt && props && cluster.isPrimary && this.app && this.app.server && this.app.server.workers) {\r\n            if (process.env.DEBUG_EVENTS == true) {\r\n                console.debug(`${evt} -> Firing from master to workers`);\r\n            }\r\n            this.messages.send(\"event\", { event: evt, props: { ...props } }, callback);\r\n        }\r\n    }\r\n}\r\n","import log4js from \"log4js\";\r\nimport path from \"path\";\r\nimport fs from \"fs\";\r\nimport util from \"util\";\r\n\r\nconst { configure, getLogger } = log4js;\r\n\r\nexport default class Logger {\r\n    static async configure() {\r\n        const readfile = util.promisify(fs.readFile);\r\n\r\n        const json = await readfile(path.resolve(process.cwd(), \"./log4js.json\"), \"utf8\");\r\n\r\n        configure(JSON.parse(json));\r\n\r\n        //Nota para el futuro:\r\n        // Esto sobreescribe los metodos de console.log\r\n        // Es necesario que la sitaxis se mantenga tal cual....\r\n        (() => {\r\n            const log_logger = getLogger(\"log\");\r\n            const error_logger = getLogger(\"error\");\r\n            const debug_logger = getLogger(\"debug\");\r\n            console.log = function () {\r\n                let args = Array.prototype.slice.call(arguments);\r\n                // log.apply(this, args);\r\n                log_logger.log(\"info\", args[0]);\r\n            };\r\n            console.error = function () {\r\n                let args = Array.prototype.slice.call(arguments);\r\n                // error.apply(this, args);\r\n                error_logger.log(\"error\", args[0]);\r\n            };\r\n            console.info = function () {\r\n                let args = Array.prototype.slice.call(arguments);\r\n                // info.apply(this, args);\r\n                log_logger.log(\"info\", args[0]);\r\n            };\r\n            console.debug = function () {\r\n                /*if (global.settings.debug.value) {*/\r\n                let args = Array.prototype.slice.call(arguments);\r\n                // debug.apply(this, [args[1], args[2]]);\r\n                debug_logger.log(\"debug\", args[0]);\r\n            };\r\n\r\n            console.custom = function (logger, level, message) {\r\n                const custom_logger = getLogger(logger);\r\n                custom_logger.log(level, message);\r\n            };\r\n        })();\r\n    }\r\n}\r\n","import express from \"express\";\r\nimport url from \"url\";\r\nimport { JsonResponse, Utils } from \"../common/index.js\";\r\n\r\nimport { pathToRegexp } from \"path-to-regexp\";\r\n\r\nexport default class AuthController {\r\n    constructor(publicPathsList, AuthHandler) {\r\n        this.router = express.Router();\r\n        this.publicPathsList = [...publicPathsList, \"/login\"];\r\n\r\n        this.AuthHandler = AuthHandler;\r\n    }\r\n\r\n    configure() {\r\n        const exAsync = Utils.expressHandler();\r\n        this.router.use(exAsync((...args) => this.check(...args)));\r\n        this.router.post(\r\n            \"/login\",\r\n            exAsync((...args) => this.loginPost(...args))\r\n        );\r\n        this.router.post(\r\n            \"/logout\",\r\n            exAsync((...args) => this.logout(...args))\r\n        );\r\n\r\n        return this.router;\r\n    }\r\n\r\n    /**\r\n     * Controla que los usuarios tengan sesion para acceder a los metodos privados de la API\r\n     *\r\n     * @param {*} request\r\n     * @param {*} response\r\n     * @param {*} next\r\n     */\r\n    async check(request, response, next) {\r\n        try {\r\n            //Rutas ublicas\r\n            for (let path of this.publicPathsList) {\r\n                const expr = pathToRegexp(path);\r\n                if (expr.exec(url.parse(request.url).pathname) !== null) {\r\n                    return next();\r\n                }\r\n            }\r\n\r\n            if (await this.AuthHandler.check(request)) {\r\n                return next();\r\n            }\r\n\r\n            return response.status(403).json(new JsonResponse(false, null, \"Forbidden\").toJson());\r\n        } catch (ex) {\r\n            console.error(ex);\r\n            return response.status(403).json(new JsonResponse(false, null, \"Forbidden\").toJson());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Valida los credenciales de un usuario\r\n     *\r\n     * TODO logger console.custom(\"access\", INFO);\r\n     *\r\n     * @param {*} request\r\n     * @param {*} response\r\n     */\r\n    async loginPost(request, response) {\r\n        if (request.body.username) {\r\n            try {\r\n                let data = await this.AuthHandler.validate(request, request.body.username, request.body.password);\r\n                if (data) {\r\n                    return response.status(200).json(new JsonResponse(true, data).toJson());\r\n                }\r\n                return response.status(401).json(new JsonResponse(false, null, \"Unauthorized - Incorrect credentials\").toJson());\r\n            } catch (ex) {\r\n                console.error(ex);\r\n                return response.status(401).json(new JsonResponse(false, null, \"Unauthorized - Error, check log\").toJson());\r\n            }\r\n        }\r\n        return response.status(401).json(new JsonResponse(false, null, \"Unauthorized - Missing parameters\").toJson());\r\n    }\r\n\r\n    /**\r\n     * Cierra la sesion del usuario\r\n     *\r\n     * @param {*} request\r\n     * @param {*} response\r\n     */\r\n    async logout(request, response) {\r\n        if (this.AuthHandler.logout) {\r\n            //Depende de que el authHandler implementado pueda realizar esta accion\r\n            try {\r\n                await this.AuthHandler.logout(request);\r\n                return response.status(200).json(new JsonResponse(true).toJson());\r\n            } catch (ex) {\r\n                console.error(ex);\r\n                return response.status(500).json(new JsonResponse(false, null, ex).toJson());\r\n            }\r\n        }\r\n        return response.status(200).json(new JsonResponse(true).toJson());\r\n    }\r\n}\r\n","export default class IAuthHandler {\r\n    constructor() {\r\n        if (!this.check) {\r\n            throw new Error(\"AuthHandler must have 'check' vethod\");\r\n        }\r\n        if (!this.validate) {\r\n            throw new Error(\"AuthHandler must have 'validate' vethod\");\r\n        }\r\n        // logout method is optional\r\n    }\r\n}\r\n\r\n","import { TokenGenerator, Utils } from '../../common/index.js';\r\nimport IAuthHandler from '../IAuthHandler.js'\r\nimport lodash from 'lodash';\r\nimport moment from 'moment';\r\n\r\nexport default class JwtAuthHandler extends IAuthHandler {\r\n    constructor(UserDao) {\r\n        super();\r\n\r\n        this.tokenGenerator = new TokenGenerator(process.env.JWT_SECRET, { audience: process.env.JWT_AUDIENCE, issuer: process.env.JWT_ISSUER, subject: process.env.JWT_SUBJECT, algorithm: process.env.JWT_ALGORITHM, expiresIn: process.env.JWT_EXPIRES })\r\n\r\n        if (!UserDao) {\r\n            throw new Error(\"Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'\");\r\n        }\r\n        this.userDao = UserDao;\r\n    }\r\n\r\n    /**\r\n     * Metodo encargado de realizar la comprobacion para validar si la sesion del usuario es válida\r\n     * \r\n     * @param {*} request \r\n     */\r\n    async check(request) {\r\n        if (request.headers.authorization) {\r\n            const token = (request.headers.authorization || '').split(' ')[1] || '';\r\n\r\n            if (!token) {\r\n                console.error(\"Token needed\");\r\n                return false;\r\n            }\r\n            try {\r\n                var decoded = this.tokenGenerator.verify(token);\r\n                const { sub, username, exp } = decoded;\r\n\r\n                if (!sub || !username || moment(exp).isAfter(new Date())) {\r\n                    return false;\r\n                }\r\n\r\n                //Si la sesion es valida, lo introducimos en el contexto de la solicitud\r\n                request.session = { ...request.session, ...decoded };\r\n                return true;\r\n            } catch (ex) {\r\n                console.error(ex);\r\n                return false;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Método encargado de realizar la validación de un usuario. Utiliza IUserDao como interfaz para la realización de la query a BD.\r\n     * \r\n     * @param {*} username \r\n     * @param {*} password \r\n     */\r\n    async validate(request, username, password) {\r\n\r\n        const user = await this.userDao.findByUsername(username);\r\n\r\n        if (user && user.username === username && user.password === Utils.encrypt(password)) {\r\n            return this.tokenGenerator.sign(lodash.omit(user, ['password']));\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n}","import { Utils } from \"../../common/index.js\";\r\nimport IAuthHandler from \"../IAuthHandler.js\";\r\nimport lodash from \"lodash\";\r\n\r\n/**\r\n * Necesario:\r\n *  Instalar -->   express-session y algun session store\r\n * \r\n *  Mas info: https://www.npmjs.com/package/express-session\r\n * \r\n *  App.customizeExpress = () => {\r\n       this.app.use(session({\r\n            secret: 'keyboard cat',\r\n            resave: false,\r\n            saveUninitialized: true,\r\n            cookie: { secure: true }\r\n        }));\r\n    }\r\n */\r\n\r\nexport default class CookieAuthHandler extends IAuthHandler {\r\n    constructor(UserDao) {\r\n        super();\r\n\r\n        if (!UserDao) {\r\n            throw new Error(\"Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'\");\r\n        }\r\n        this.userDao = UserDao;\r\n    }\r\n\r\n    /**\r\n     * Metodo encargado de realizar la comprobacion para validar si la sesion del usuario es válida\r\n     *\r\n     * @param {*} request\r\n     */\r\n    async check(request) {\r\n        if (request.headers.authorization) {\r\n            //Si se recibe por Auth Basic\r\n            const token = (request.headers.authorization || \"\").split(\" \")[1] || \"\";\r\n\r\n            const creds = Buffer.from(token, \"base64\").toString().split(\":\");\r\n            const login = creds[0];\r\n            const password = creds[1];\r\n\r\n            if (!(await this.validate(request, login, password))) {\r\n                return false;\r\n            }\r\n            return true;\r\n        }\r\n        if (request.session && request.session.username) {\r\n            //Si hay sesion almacenada\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Método encargado de realizar la validación de un usuario. Utiliza IUserDao como interfaz para la realización de la query a BD.\r\n     *\r\n     * @param {*} username\r\n     * @param {*} password\r\n     */\r\n    async validate(request, username, password) {\r\n        const user = await this.userDao.findByUsername(username);\r\n\r\n        if (user && user.username === username && user.password === Utils.encrypt(password)) {\r\n            request.session = { ...request.session, ...lodash.omit(user, [\"password\"]) };\r\n\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {*} request\r\n     */\r\n    logout(request) {\r\n        return new Promise((resolve) => {\r\n            if (request.session) {\r\n                request.session.destroy(resolve);\r\n            }\r\n        });\r\n    }\r\n}\r\n","import Knex from 'knex'\r\n\r\nclass KnexConnector {\r\n\r\n\r\n    init(config) {\r\n\r\n        /**\r\n         * References the current connection of the app\r\n         * @type {Knex}\r\n         * @public\r\n         */\r\n        this.connection = Knex(config)\r\n    }\r\n\r\n    /**\r\n     * Configura de forma global los aliases de las columnas para utilizar en FQL.\r\n     * \r\n     * La estructura es \r\n     * {\r\n            \"table1\": {\r\n                \"alias1\": \"column1\",\r\n                \"alias2\": \"column2\"\r\n            },\r\n            \"table2\": {\r\n                \"alias1\": \"column1\"\r\n            }\r\n        }\r\n     *\r\n     * @param {*} aliases \r\n     */\r\n    setColumnAliases(aliases) {\r\n        this.columnAliases = aliases;\r\n    }\r\n    \r\n\r\n\r\n    test() {\r\n        return this.connection.raw('select 1+1 as result');\r\n    }\r\n}\r\n\r\n\r\nexport default new KnexConnector();","import { Utils } from \"../../../common/index.js\";\r\n\r\nimport { FQLParser, KnexParser } from \"@landra_sistemas/fql-parser\";\r\nimport KnexConnector from \"../KnexConnector.js\";\r\n\r\nexport default class KnexFilterParser {\r\n    /**\r\n     *\r\n     * @param {*} builder\r\n     * @param {*} string\r\n     * @returns\r\n     */\r\n    static parseQueryString(builder, string, tableName) {\r\n        const options = {\r\n            allowGlobalSearch: true,\r\n            caseInsensitive: true,\r\n        };\r\n        //Agregar los aliases en caso de que se hayan configurado de forma global\r\n        if (KnexConnector.columnAliases && KnexConnector.columnAliases[tableName]) {\r\n            options.aliases = KnexConnector.columnAliases[tableName];\r\n        }\r\n        //Options\r\n        if (KnexConnector.caseInsensitive !== undefined) {\r\n            options.caseInsensitive = KnexConnector.caseInsensitive;\r\n        }\r\n        if (KnexConnector.allowGlobalSearch !== undefined) {\r\n            options.allowGlobalSearch = KnexConnector.allowGlobalSearch;\r\n        }\r\n        const parser = new FQLParser(options);\r\n        const data = parser.parse(string);\r\n\r\n        return new KnexParser(tableName).toKnex(builder, data);\r\n    }\r\n\r\n    /**\r\n     * Convierte un objeto clave valor en un conjunto de filtros.\r\n     *\r\n     * - Filtro estandar:\r\n     *    filters: {\r\n     *       \"column\": \"value\" -> filtro generico exact\r\n     *    }\r\n     * - Filtro Objeto:\r\n     *    filters:{\r\n     *       \"column\": {\r\n     *       \"type\": \"date|between|exists|notexists|greater|greaterEq|less|lessEq|exact|exactI|not|null|notnull|like|likeI\"\r\n     *       \"start\": \"xxx\", //inicio de rango para el filtro de date y between\r\n     *       \"end\": \"xxx\", //fin de rango para el filtro date y between\r\n     *       \"value\": \"xxx\" //valor a utilizar para el resto de filtros\r\n     *     }\r\n     * }\r\n     *  - Filtro Lista:\r\n     *     filters: {\r\n     *       \"column\": [1, 2, 3]\r\n     *     }\r\n     *    Filtro de tipo IN, todos los elementos que coincidan\r\n     *\r\n     * - Definicion de tipos:\r\n     *    date: filtro de fechas desde y hasta\r\n     *    between: filtro entre dos valores concretos\r\n     *    exists: busca si existe la propiedad\r\n     *    notexists: busca si existe la propiedad\r\n     *    greater: mayor que\r\n     *    greaterEq: mayor o igual que\r\n     *    less: menor que\r\n     *    lessEq: menor o igual que\r\n     *    exact: valor exacto\r\n     *    exactI: valor exacto ignorando mayusculas y minusculas\r\n     *    not: distinto de\r\n     *    null: igual a null\r\n     *    notnull: distinto de null\r\n     *    like: filtro like\r\n     *    likeI: filtro like ignorando mayusculas y minusculas\r\n     */\r\n    static parseFilters(builder, filter, tableName) {\r\n        let query = builder;\r\n\r\n        for (let prop in filter) {\r\n            let elm = filter[prop];\r\n\r\n            if (typeof elm === \"object\") {\r\n                switch (elm.type) {\r\n                    case \"fql\":\r\n                        query = KnexFilterParser.parseQueryString(query, elm.value, tableName);\r\n                        break;\r\n                    case \"date\":\r\n                    case \"between\":\r\n                        if (elm.start && elm.end) {\r\n                            query = query.whereBetween(prop, [elm.start, elm.end]);\r\n                        }\r\n                        if (elm.start && !elm.end) {\r\n                            query = query.where(prop, \">=\", elm.start);\r\n                        }\r\n                        if (!elm.start && elm.end) {\r\n                            query = query.where(prop, \">=\", elm.end);\r\n                        }\r\n                        break;\r\n                    case \"dateraw\":\r\n                    case \"betweenraw\":\r\n                        if (elm.start && elm.end) {\r\n                            query = query.whereRaw(`${prop} BETWEEN ? AND ?`, [elm.start, elm.end]);\r\n                        }\r\n                        if (elm.start && !elm.end) {\r\n                            query = query.whereRaw(`${prop} >= ?`, [elm.start]);\r\n                        }\r\n                        if (!elm.start && elm.end) {\r\n                            query = query.whereRaw(`${prop} >= ?`, [elm.end]);\r\n                        }\r\n                        break;\r\n                    case \"jsonb\":\r\n                        query = query.whereRaw(`${prop} ILIKE ?`, [\"%\" + elm.value + \"%\"]);\r\n                        break;\r\n                    case \"full-text-psql\":\r\n                        query = query.whereRaw(`to_tsvector(${prop}::text) @@ to_tsquery(?)`, [elm.value]);\r\n                        break;\r\n\r\n                    case \"greater\":\r\n                    case \"greaterraw\":\r\n                        query = query.whereRaw(`${prop} > ?`, [elm.value]);\r\n                        break;\r\n                    case \"greaterEq\":\r\n                    case \"greaterEqraw\":\r\n                        query = query.whereRaw(`${prop} >= ?`, [elm.value]);\r\n                        break;\r\n                    case \"less\":\r\n                    case \"lessraw\":\r\n                        query = query.whereRaw(`${prop} < ?`, [elm.value]);\r\n                        break;\r\n                    case \"lessEq\":\r\n                    case \"lessEqraw\":\r\n                        query = query.whereRaw(`${prop} <= ?`, [elm.value]);\r\n                        break;\r\n                    case \"exists\":\r\n                        query = query.whereExists(prop);\r\n                        break;\r\n                    case \"notexists\":\r\n                        query = query.whereNotExists(prop);\r\n                        break;\r\n                    case \"exact\":\r\n                    case \"exactraw\":\r\n                        query = query.whereRaw(`${prop} = ?`, [elm.value]);\r\n                        break;\r\n                    case \"in\":\r\n                        let propComplex = prop;\r\n                        if (propComplex.includes(\",\")) {\r\n                            propComplex = prop.split(\",\");\r\n                        }\r\n                        if (!Array.isArray(elm.value) && elm.value != undefined) {\r\n                            query = query.whereIn(propComplex, elm.value.split(\",\"));\r\n                        } else {\r\n                            if (elm.value != undefined) {\r\n                                query = query.whereIn(propComplex, elm.value);\r\n                            }\r\n                        }\r\n                        break;\r\n                    case \"inraw\":\r\n                        if (!Array.isArray(elm.value) && elm.value != undefined) {\r\n                            query = query.whereRaw(`${prop} IN (?)`, [\r\n                                elm.value\r\n                                    .split(\",\")\r\n                                    .map((e) => `'${e}'`)\r\n                                    .join(\",\"),\r\n                            ]);\r\n                        } else {\r\n                            if (elm.value != undefined) {\r\n                                query = query.whereRaw(`${prop} IN (?)`, [elm.value.map((e) => `'${e}'`).join(\",\")]);\r\n                            }\r\n                        }\r\n                        break;\r\n                    case \"not\":\r\n                    case \"notraw\":\r\n                        query = query.whereRaw(`${prop} != ?`, [elm.value]);\r\n                        break;\r\n                    case \"like\":\r\n                    case \"likeraw\":\r\n                        let value_likeraw = Utils.replaceAll(elm.value, \"*\", \"%\");\r\n                        query = query.whereRaw(` ${prop} LIKE ?`, [value_likeraw]);\r\n                        break;\r\n                    case \"notlike\":\r\n                    case \"notlikeraw\":\r\n                        let value_nolikeraw = Utils.replaceAll(elm.value, \"*\", \"%\");\r\n                        query = query.whereRaw(` ${prop} NOT LIKE ?`, [value_nolikeraw]);\r\n                        break;\r\n                    case \"likeI\":\r\n                        let value_rawilike = Utils.replaceAll(elm.value, \"*\", \"%\");\r\n                        query = query.whereRaw(` ${prop} ILIKE ?`, [value_rawilike]);\r\n                        break;\r\n                    case \"notlikeI\":\r\n                        let value_notrawilike = Utils.replaceAll(elm.value, \"*\", \"%\");\r\n                        query = query.whereRaw(` ${prop} NOT ILIKE ?`, [value_notrawilike]);\r\n                        break;\r\n                    case \"null\":\r\n                    case \"nullraw\":\r\n                        query = query.whereRaw(`${prop} is NULL`);\r\n                        break;\r\n                    case \"notnull\":\r\n                    case \"notnullraw\":\r\n                        query = query.whereRaw(`${prop} is not NULL`);\r\n                        break;\r\n                }\r\n            } else {\r\n                //Si el valor no es un objeto se devuelve\r\n                query = query.where(prop, elm);\r\n            }\r\n        }\r\n\r\n        // console.log(query.toSQL());\r\n        return query;\r\n    }\r\n\r\n    /**\r\n     * Conversion de un objeto {property: XX, direction: ASC|DESC - ascend|descend} a un ORDER BY\r\n     *\r\n     * @param {*} sorts\r\n     */\r\n    static parseSort(sort) {\r\n        if (!sort.field || !sort.direction) {\r\n            return 1;\r\n        }\r\n\r\n        let direction = \"ASC\";\r\n        if (sort.direction === \"descend\") {\r\n            direction = \"DESC\";\r\n        }\r\n\r\n        return sort.field + \" \" + direction;\r\n    }\r\n}\r\n","import KnexFilterParser from \"../filters/KnexFilterParser.js\";\r\nimport KnexConnector from \"../KnexConnector.js\";\r\n\r\nimport lodash from \"lodash\";\r\n\r\n/**\r\n * Crear un dao con los métodos básicos\r\n */\r\nexport default class BaseKnexDao {\r\n    constructor() {\r\n        this.tableName = \"\";\r\n    }\r\n\r\n    loadAllData(start, limit) {\r\n        return KnexConnector.connection\r\n            .select(\"*\")\r\n            .from(this.tableName)\r\n            .limit(limit || 10000)\r\n            .offset(start);\r\n    }\r\n\r\n    async loadFilteredData(filters, start, limit) {\r\n        let sorts = 1;\r\n        if (filters.sort) {\r\n            sorts = KnexFilterParser.parseSort(filters.sort);\r\n        }\r\n\r\n        return KnexConnector.connection\r\n            .from(this.tableName)\r\n            .where((builder) => KnexFilterParser.parseFilters(builder, lodash.omit(filters, [\"sort\", \"start\", \"limit\"]), this.tableName))\r\n            .orderByRaw(sorts)\r\n            .limit(limit)\r\n            .offset(start);\r\n    }\r\n\r\n    async countFilteredData(filters) {\r\n        let data = await KnexConnector.connection\r\n            .from(this.tableName)\r\n            .where((builder) => KnexFilterParser.parseFilters(builder, lodash.omit(filters, [\"sort\", \"start\", \"limit\"]), this.tableName))\r\n            .count(\"id\", { as: \"total\" });\r\n\r\n        return data && data[0].total;\r\n    }\r\n\r\n    async loadById(objectId) {\r\n        const data = await KnexConnector.connection.from(this.tableName).where(\"id\", objectId);\r\n\r\n        if (data && data[0]) {\r\n            return data[0];\r\n        }\r\n        return null;\r\n    }\r\n\r\n    save(object) {\r\n        return KnexConnector.connection.from(this.tableName).insert(object).returning(\"*\");\r\n    }\r\n    update(objectId, newObject) {\r\n        return KnexConnector.connection.from(this.tableName).where(\"id\", objectId).update(newObject).returning(\"*\");\r\n    }\r\n    async delete(objectId) {\r\n        const existing = await this.loadById(objectId);\r\n        if (!existing) {\r\n            throw \"NotFound\";\r\n        }\r\n        return KnexConnector.connection.from(this.tableName).where(\"id\", objectId).delete();\r\n    }\r\n}\r\n","import BaseKnexDao from \"./knex/dao/BaseKnexDao.js\";\r\n\r\nexport default class IUserDao extends BaseKnexDao {\r\n    constructor(tableName) {\r\n        super(tableName);\r\n\r\n        if (!this.findByUsername) {\r\n            throw new Error(\"AuthHandler must have 'findByUsername' method\");\r\n        }\r\n    }\r\n}\r\n","import express from \"express\";\r\nimport { JsonResponse, Utils } from \"../common/index.js\";\r\n\r\nexport class BaseController {\r\n    constructor() {\r\n        this.router = express.Router();\r\n        this.routes = {};\r\n        //Example routes shorthand\r\n        /*\r\n         {\r\n            \"/\": {\r\n                \"get\": this.listEntidad.bind(this),\r\n                \"post\": this.listEntidad.bind(this)\r\n            }\r\n         } \r\n         */\r\n    }\r\n\r\n    configure(entity, config) {\r\n        if (!entity) {\r\n            return this.router;\r\n        }\r\n\r\n        const exAsync = Utils.expressHandler();\r\n        this.router.get(\r\n            `/${entity}`,\r\n            exAsync((...args) => this.listEntidad(...args))\r\n        );\r\n        this.router.post(\r\n            `/${entity}/list`,\r\n            exAsync((...args) => this.listEntidad(...args))\r\n        );\r\n        this.router.get(\r\n            `/${entity}/:id`,\r\n            exAsync((...args) => this.getEntidad(...args))\r\n        );\r\n        this.router.post(\r\n            `/${entity}`,\r\n            exAsync((...args) => this.saveEntidad(...args))\r\n        );\r\n        this.router.put(\r\n            `/${entity}/:id`,\r\n            exAsync((...args) => this.updateEntidad(...args))\r\n        );\r\n        this.router.delete(\r\n            `/${entity}/:id`,\r\n            exAsync((...args) => this.deleteEntidad(...args))\r\n        );\r\n\r\n        this.service = config.service;\r\n        this.table = config.table;\r\n\r\n        return this.router;\r\n    }\r\n\r\n    /**\r\n     * Lista entidades en la aplicacion, es posible enviarle parametros de filtrado.\r\n     *\r\n     *\r\n     * @api {post} /:entidad/list Listar entidades\r\n     * @apiName Listar entidades\r\n     * @apiGroup Comun\r\n     * @apiPermission Auth Basic username:pwd\r\n     * @apiParam {Number} id entidades unique ID.\r\n     *\r\n     * @apiSuccess {Boolean} success\r\n     * @apiSuccess {Object[]} data  dataObject\r\n     */\r\n    async listEntidad(request, response, next) {\r\n        try {\r\n            let service = new this.service(null, this.table);\r\n            let filters = request.method === \"POST\" ? request.body : request.query && request.query.filters ? JSON.parse(request.query.filters) : {};\r\n\r\n            let data = await service.list(filters, filters.start, filters.limit);\r\n            let jsRes = new JsonResponse(true, data.data, null, data.total);\r\n\r\n            response.json(jsRes.toJson());\r\n        } catch (e) {\r\n            next(e);\r\n        }\r\n    }\r\n    /**\r\n     *Obtiene un elemento concreto mediante su identificador\r\n     *\r\n     *\r\n     * @api {get} /:entidad/:id Obtener entidad\r\n     * @apiName Obtener entidad\r\n     * @apiGroup Comun\r\n     * @apiPermission Auth Basic username:pwd\r\n     * @apiParam {Number} id entidades unique ID.\r\n     *\r\n     * @apiSuccess {Boolean} success\r\n     * @apiSuccess {Object[]} data  dataObject\r\n     */\r\n    async getEntidad(request, response, next) {\r\n        try {\r\n            let service = new this.service(null, this.table);\r\n            let data = await service.loadById(request.params.id);\r\n            let jsRes = new JsonResponse(true, data);\r\n            let code = 200;\r\n            if (data == null) {\r\n                code = 404;\r\n                let message = \"Element not found\";\r\n                jsRes = new JsonResponse(false, null, message, 0);\r\n            }\r\n\r\n            response.status(code).json(jsRes.toJson());\r\n        } catch (e) {\r\n            console.error(e);\r\n            let message = \"\";\r\n            if (e.code == \"22P02\") {\r\n                //PostgreSQL error Code form string_to_UUID\r\n                message = \"Expected uiid\";\r\n            }\r\n            let jsRes = new JsonResponse(false, null, message, 0);\r\n            response.status(400).json(jsRes.toJson());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Almacena un elemento en BD\r\n     *\r\n     *\r\n     * @api {post} /:entidad/:id Crear entidad\r\n     * @apiName Crear entidad\r\n     * @apiGroup Comun\r\n     * @apiPermission Auth Basic username:pwd\r\n     * @apiParam {Number} id entidades unique ID.\r\n     *\r\n     * @apiSuccess {Boolean} success\r\n     * @apiSuccess {Object[]} data  dataObject\r\n     */\r\n    async saveEntidad(request, response, next) {\r\n        try {\r\n            let service = new this.service(null, this.table);\r\n\r\n            let data = await service.save(request.body);\r\n            let jsRes = new JsonResponse(true, (data && data[0]) || { id: request.body.id });\r\n\r\n            response.setHeader(\"Location\", `/entity/${jsRes.data.id}`);\r\n            response.status(201).json(jsRes.toJson());\r\n        } catch (e) {\r\n            next(e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Almacena un elemento en BD\r\n     *\r\n     *\r\n     * @api {put} /:entidad/:id Actualizar entidad\r\n     * @apiName Actualizar entidad\r\n     * @apiGroup Comun\r\n     * @apiPermission Auth Basic username:pwd\r\n     * @apiParam {Number} id entidades unique ID.\r\n     *\r\n     * @apiSuccess {Boolean} success\r\n     * @apiSuccess {Object[]} data  dataObject\r\n     */\r\n    async updateEntidad(request, response, next) {\r\n        try {\r\n            let service = new this.service(null, this.table);\r\n\r\n            let data = await service.update(request.params.id, request.body);\r\n            let jsRes = new JsonResponse(true, (data && data[0]) || { id: request.body.id });\r\n\r\n            response.json(jsRes.toJson());\r\n        } catch (e) {\r\n            next(e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Elimina un elemento correspondiente al identificador recibido\r\n     *\r\n     *\r\n     * @api {delete} /:entidad/:id/delete Delete entidad\r\n     * @apiName Eliminar entidad\r\n     * @apiGroup Comun\r\n     * @apiPermission Auth Basic username:pwd\r\n     * @apiParam {Number} id entidades unique ID.\r\n     *\r\n     * @apiSuccess {Boolean} success\r\n     * @apiSuccess {Object[]} data  dataObject\r\n     */\r\n    async deleteEntidad(request, response, next) {\r\n        try {\r\n            let service = new this.service(null, this.table);\r\n            let data = await service.delete(request.params.id);\r\n            let jsRes = new JsonResponse(true, data);\r\n\r\n            response.status(204).json(jsRes.toJson());\r\n        } catch (e) {\r\n            console.error(e);\r\n            if (e == \"NotFound\") {\r\n                let message = \"Element not found\";\r\n                let jsRes = new JsonResponse(false, null, message, 0);\r\n                response.status(404).json(jsRes.toJson());\r\n            } else {\r\n                next(e);\r\n            }\r\n        }\r\n    }\r\n}\r\n","import { BaseKnexDao } from \"../db/index.js\";\r\n\r\nexport class BaseService {\r\n    constructor(cls, table) {\r\n        if (cls) {\r\n            this.dao = new cls();\r\n        } else {\r\n            this.dao = new BaseKnexDao(); //El sistema por defecto utiliza knex, si se pasa un dao personalizado se puede sobreescribir este comportamiento\r\n        }\r\n        if (table) {\r\n            this.dao.tableName = table;\r\n        }\r\n    }\r\n    /**\r\n     * Obtencion de una lista de elementos.\r\n     *\r\n     * filters, es opcional. Si no se pasan se devuelve lo que hay ;\r\n     */\r\n    async list(filters, start, limit) {\r\n        //Pagination\r\n        const st = start || 0;\r\n        const lm = limit || 1000; //Default limit\r\n\r\n        let response = {};\r\n        response.total = await this.dao.countFilteredData(filters, st, lm);\r\n\r\n        if (filters && Object.keys(filters).length !== 0) {\r\n            let filteredData = await this.dao.loadFilteredData(filters, st, lm);\r\n            response.data = filteredData;\r\n            return response;\r\n        }\r\n\r\n        response.data = await this.dao.loadAllData(start, limit);\r\n        return response;\r\n    }\r\n\r\n    /**\r\n     * Obtencion de un elemento mediante su identificador\r\n     */\r\n    loadById(id) {\r\n        return this.dao.loadById(id);\r\n    }\r\n    /**\r\n     * Metodo de creacion.\r\n     *\r\n     * Si el identificador se pasa como undefined se creara un nuevo elemento,\r\n     * sino se modifica el correspondiente.\r\n     */\r\n    save(data) {\r\n        //Create\r\n        return this.dao.save(data);\r\n    }\r\n    /**\r\n     * Metodo de creacion.\r\n     *\r\n     * Si el identificador se pasa como undefined se creara un nuevo elemento,\r\n     * sino se modifica el correspondiente.\r\n     */\r\n    update(id, data) {\r\n        if (id) {\r\n            //Update\r\n            return this.dao.update(id, data);\r\n        }\r\n    }\r\n    /**\r\n     * Metodo de eliminado.\r\n     *\r\n     * El identificador es obligatorio para poder localizar el elemento a eliminar.\r\n     */\r\n    delete(id) {\r\n        if (id) {\r\n            return this.dao.delete(id);\r\n        }\r\n    }\r\n}\r\n","import Utils from \"./Utils.js\";\r\n\r\nimport yargs from \"yargs/yargs\";\r\nimport { hideBin } from \"yargs/helpers\";\r\n\r\n/**\r\n * Extra puede ser un array de objetos con la siguiente estructura:\r\n *\r\n * {\r\n *  \"key\": \"c\",\r\n *  \"alias\": \"config\",\r\n *  \"describe\": \"Configuración\",\r\n *  \"fn\": function(argv) { },\r\n *  \"nargs\": 0,\r\n *  \"required\": true\r\n * }\r\n * @param {*} extra\r\n * @returns\r\n */\r\nexport default async function Runtime(extra) {\r\n    const cfg = yargs(hideBin(process.argv))\r\n        .usage(\r\n            `Como usar: \r\n            node $0 [options] \r\n            \r\n            ** Si no se especifican parámetros el servidor arrancará normalmente. **`\r\n        )\r\n        .alias(\"g\", \"generateKeys\")\r\n        .describe(\"g\", \"Genera unas claves para la aplicación\")\r\n        .alias(\"c\", \"encrypt\")\r\n        .describe(\"c\", \"Codifica el String proporcionado en base a la contraseña de .env\")\r\n        .nargs(\"c\", 1)\r\n        .help(\"h\")\r\n        .alias(\"h\", \"help\");\r\n\r\n    let demand = [];\r\n    if (extra) {\r\n        for (const param of extra) {\r\n            cfg.alias(param.key, param.alias);\r\n            if (param.describe) {\r\n                cfg.describe(param.key, param.describe);\r\n            }\r\n            if (param.nargs !== 0) {\r\n                cfg.nargs(param.key, param.nargs);\r\n            }\r\n            if (param.boolean) {\r\n                cfg.boolean(param.key);\r\n            }\r\n            if (param.choices) {\r\n                cfg.choices(param.key, param.choices);\r\n            }\r\n            if (param.required) {\r\n                demand.push(param.key);\r\n            }\r\n        }\r\n    }\r\n\r\n    if (demand.length !== 0) {\r\n        cfg.demandOption(demand);\r\n    }\r\n\r\n    const argv = cfg.argv;\r\n    //Parámetro para no arrancar el servidor y generar las claves JWT\r\n    if (argv.generateKeys) {\r\n        console.log(\"Generando claves para encriptación:\");\r\n        console.log(Utils.generateKeys());\r\n        return process.exit(1);\r\n    }\r\n\r\n    if (argv.encrypt) {\r\n        console.log(\"Resultado encryptación:\");\r\n        console.log(Utils.encrypt(argv.encrypt));\r\n        return process.exit(1);\r\n    }\r\n\r\n    if (extra) {\r\n        for (const param of extra) {\r\n            if (argv[param.key]) {\r\n                await param.fn(argv);\r\n                return process.exit(1);\r\n            }\r\n        }\r\n    }\r\n}\r\n","import { I18nLoader, Utils } from \"./common/index.js\";\r\nimport { EventHandler } from \"./events/index.js\";\r\nimport { ClusterServer, Server } from \"./server/index.js\";\r\nimport { Logger } from \"./logger/index.js\";\r\n\r\nimport net from \"net\";\r\nimport repl from \"repl\";\r\nimport { KnexConnector } from \"./db/index.js\";\r\nimport Runtime from \"./common/Runtime.js\";\r\n\r\nclass App {\r\n    constructor() {\r\n        this.serverClass = Server;\r\n        this.clusterClass = ClusterServer;\r\n    }\r\n\r\n    /**\r\n     * Inicializa la runtime de la aplicación para poder recibir parámetros por consola y generar claves.\r\n     * @returns\r\n     */\r\n    runtime(extra) {\r\n        return Runtime(extra);\r\n    }\r\n\r\n    /**\r\n     * Initializa las configuraciones para la app\r\n     *\r\n     */\r\n    async init(serverConfig) {\r\n        if (process.env.DISABLE_LOGGER != \"true\") {\r\n            await Logger.configure();\r\n        }\r\n\r\n        //Instanciar la clase server\r\n        const server = new this.serverClass(serverConfig, this.statics, this.routes);\r\n        if (this.customizeExpress) {\r\n            server.customizeExpress = this.customizeExpress;\r\n        }\r\n        if (this.beforeListen) {\r\n            server.beforeListen = this.beforeListen;\r\n        }\r\n        if (this.afterListen) {\r\n            server.afterListen = this.afterListen;\r\n        }\r\n\r\n        /**\r\n         * Gestor de eventos\r\n         * @type {EventHandler}\r\n         * @public\r\n         */\r\n        this.events = new EventHandler(this);\r\n\r\n        /**\r\n         * Gestor de traducciones\r\n         * @type {I18nLoader}\r\n         * @public\r\n         */\r\n        this.i18n = new I18nLoader();\r\n        await this.i18n.load();\r\n        /**\r\n         * Servidor actual\r\n         * @type {ClusterServer}\r\n         * @public\r\n         */\r\n        this.server = new this.clusterClass(this);\r\n\r\n        this.server.setServerCls(server);\r\n        this.server.executeOnlyMain = () => {\r\n            if (this.executeOnlyMain) this.executeOnlyMain();\r\n\r\n            if (process.env.REPL_ENABLED == \"true\") {\r\n                this.startRepl();\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Ejecuta el servidor con la configuracion de #init()\r\n     */\r\n    async start() {\r\n        if (!this.server) {\r\n            throw new Error(\"Call init first\");\r\n        }\r\n        await this.server.start();\r\n    }\r\n\r\n    /**\r\n     * Inicia el server replify para poder conectar terminales remotas\r\n     *\r\n     *\r\n     * Para que arranque es necesario especificar REPL_ENABLED en el archivo .env\r\n     */\r\n    startRepl() {\r\n        try {\r\n            net.createServer((socket) => {\r\n                const remote = repl.start({\r\n                    prompt: \"lisco::remote> \",\r\n                    input: socket,\r\n                    output: socket,\r\n                    terminal: true,\r\n                    useColors: true,\r\n                    preview: false,\r\n                });\r\n                remote.context.app = this;\r\n                remote.context.Utils = Utils;\r\n                remote.context.db = KnexConnector.connection;\r\n                remote.on(\"exit\", socket.end.bind(socket));\r\n            }).listen(process.env.REPL_PORT || 5001);\r\n        } catch (e) {\r\n            console.log(\"Remote REPL Conn: \" + e);\r\n        }\r\n\r\n        console.log(`Remote REPL started on port ${process.env.REPL_PORT || 5001}`);\r\n    }\r\n}\r\n\r\nexport default new App();\r\n"],"names":["Utils","arrayToLower","mcArray","join","toLowerCase","split","replaceAll","str","find","replace","RegExp","encrypt","text","secret","Buffer","from","process","env","CRYPT_SECRET","iv","CRYPT_IV","cipher","crypto","createCipheriv","encrypted","update","concat","toString","decrypt","encryptedText","decipher","createDecipheriv","decrypted","sleep","ms","util","promisify","setTimeout","promise_sleep","generateKeys","key","randomBytes","flattenObject","ob","flatObject","toReturn","i","hasOwnProperty","Array","constructor","x","isNaN","unflatten","data","result","keys","reduce","r","e","j","Number","length","expressHandler","fn","args","slice","call","arguments","fnReturn","apply","next","resolve","I18nLoader","this","watcher","load","custom","_this2","lang","DEFAULT_LANG","currentData","currentDataFlat","cwd","chokidar","watch","file","ignored","persistent","on","path","loadFile","Promise","_this4","readfile","fs","readFile","body","recover","parsedData","JSON","parse","then","_catch","ex","code","console","log","error","translate","_exit2","_temp3","_result2","_this6","_temp4","JsonResponse","success","message","total","toJson","privateKey","options","sign","payload","jwtSignOptions","jwtid","uuid","v4","jsonwebtoken","verify","token","refresh","sub","iss","aud","iat","exp","nbf","jti","Server","config","statics","routes","app","express","express_config","lodash","defaultsDeep","helmet","json","urlencoded","compression","cors","origin","credentials","fileupload","socketio","transports","traceRequests","initialize","configureRoutes","errorHandler","customizeExpress","use","isObject","extended","fileUpload","idx","DISABLE_LOGGER","request","response","requestTime","Date","now","pathname","url","debug","pid","method","session","user_id","end","stringify","Router","router","loadRoutes","_step","_iterator","done","route","value","configure","entity","service","table","isEmpty","exAsync","cfg","handler","isArray","warn","err","req","res","jsRes","status","_this","PORT","port","normalizePort","clustered","CLUSTERED","workers","executeOnlyMain","setServerCls","cls","server","start","_this3","_temp2","configureSocketIO","initUnclustered","initClustered","io","listen","_this5","cluster","isPrimary","ClusterMessages","msg","callback","event","DEBUG_EVENTS","props","owner","events","emit","cpuCount","os","cpus","initWorker","worker","id","fork","push","_this7","http","handleErrors","SSL","SSL_KEY","SSL_CERT","SSL_PASS","exit","readFileSync","cert","passphrase","SSL_PORT","serverSsl","https","createServer","sslPort","_temp5","afterListen","_temp6","_temp7","beforeListen","_temp8","val","parseInt","syscall","bind","EventEmitter","messages","isWorker","_EventEmitter","prototype","_assertThisInitialized","_extends","evt","send","log4js","getLogger","Logger","log_logger","error_logger","debug_logger","info","logger","level","AuthController","publicPathsList","AuthHandler","check","post","loginPost","logout","_createForOfIteratorHelperLoose","pathToRegexp","exec","_this2$AuthHandler$ch","_exit5","_result","username","validate","password","_response$status$json4","_response$status$json2","_response$status$json3","_exit7","_response$status$json5","_response$status$json6","IAuthHandler","Error","JwtAuthHandler","UserDao","tokenGenerator","JWT_SECRET","audience","JWT_AUDIENCE","issuer","JWT_ISSUER","subject","JWT_SUBJECT","algorithm","JWT_ALGORITHM","expiresIn","JWT_EXPIRES","userDao","headers","authorization","decoded","moment","isAfter","findByUsername","user","omit","_IAuthHandler","creds","_this2$validate","destroy","KnexConnector$1","init","connection","Knex","setColumnAliases","aliases","columnAliases","test","raw","KnexFilterParser","parseQueryString","builder","string","tableName","allowGlobalSearch","caseInsensitive","KnexConnector","undefined","FQLParser","KnexParser","toKnex","parseFilters","filter","query","prop","elm","type","whereBetween","where","whereRaw","whereExists","whereNotExists","propComplex","includes","whereIn","map","value_likeraw","value_nolikeraw","value_rawilike","value_notrawilike","parseSort","sort","field","direction","loadAllData","limit","select","offset","loadFilteredData","filters","sorts","orderByRaw","countFilteredData","count","as","loadById","objectId","save","object","insert","returning","newObject","_this8","existing","BaseKnexDao","BaseController","get","listEntidad","getEntidad","saveEntidad","put","updateEntidad","deleteEntidad","_proto","list","reject","params","setHeader","_this9","_this11","_temp10","BaseService","dao","st","lm","_this$dao$countFilter","_exit","_this$dao$loadAllData","_temp","Object","filteredData","_settle","pact","state","s","_Pact","o","v","observer","onFulfilled","onRejected","_isSettledPact","thenable","serverClass","clusterClass","ClusterServer","runtime","extra","param","yargs","hideBin","argv","usage","alias","describe","nargs","help","demand","choices","required","demandOption","_iterator2","stage","shouldContinue","_resumeAfterTest","_resumeAfterBody","updateValue","_for","_step2","_process$exit","Runtime","serverConfig","EventHandler","i18n","REPL_ENABLED","startRepl","net","socket","repl","prompt","input","output","terminal","useColors","preview","remote","context","db","REPL_PORT","App"],"mappings":"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"}