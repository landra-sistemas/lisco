var e=require("helmet"),t=require("express"),r=require("compression"),n=require("cors"),i=require("express-fileupload"),s=require("url"),o=require("lodash"),a=require("fs"),l=require("util"),u=require("crypto"),c=require("chokidar"),h=require("buffer"),d=require("stream"),p=require("uuid"),m=require("http"),f=require("https"),g=require("path"),y=require("cluster"),b=require("socket.io"),w=require("os"),v=require("events"),_=require("cluster-messages"),E=require("log4js"),C=require("path-to-regexp"),N=require("moment"),x=require("@landra_sistemas/fql-parser"),$=require("timers"),A=require("lodash/cloneDeep"),T=require("lodash/defaults"),R=require("lodash/uniqueId"),S=require("lodash/merge"),O=require("lodash/chunk"),I=require("lodash/flatten"),j=require("assert"),q=require("lodash/assign"),k=require("lodash/clone"),P=require("lodash/each"),L=require("lodash/isEmpty"),B=require("lodash/isPlainObject"),M=require("lodash/last"),U=require("lodash/reject"),D=require("lodash/tail"),F=require("lodash/toArray"),Q=require("lodash/isTypedArray"),H=require("lodash/reduce"),W=require("lodash/transform"),J=require("lodash/compact"),V=require("lodash/groupBy"),z=require("lodash/has"),K=require("lodash/map"),G=require("lodash/omitBy"),Y=require("lodash/extend"),X=require("lodash/indexOf"),Z=require("lodash/first"),ee=require("tty"),te=require("lodash/constant"),re=require("lodash/identity"),ne=require("lodash/some"),ie=require("lodash/filter"),se=require("lodash/values"),oe=require("lodash/isNil"),ae=require("lodash/defer"),le=require("lodash/uniq"),ue=require("net"),ce=require("repl"),he=require("yargs/yargs"),de=require("yargs/helpers");function pe(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function me(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var fe=/*#__PURE__*/pe(e),ge=/*#__PURE__*/pe(t),ye=/*#__PURE__*/pe(r),be=/*#__PURE__*/pe(n),we=/*#__PURE__*/pe(i),ve=/*#__PURE__*/pe(s),_e=/*#__PURE__*/pe(o),Ee=/*#__PURE__*/pe(a),Ce=/*#__PURE__*/pe(l),Ne=/*#__PURE__*/pe(u),xe=/*#__PURE__*/pe(c),$e=/*#__PURE__*/pe(h),Ae=/*#__PURE__*/pe(d),Te=/*#__PURE__*/me(p),Re=/*#__PURE__*/pe(m),Se=/*#__PURE__*/pe(f),Oe=/*#__PURE__*/pe(g),Ie=/*#__PURE__*/pe(y),je=/*#__PURE__*/pe(w),qe=/*#__PURE__*/pe(v),ke=/*#__PURE__*/pe(_),Pe=/*#__PURE__*/pe(E),Le=/*#__PURE__*/pe(N),Be=/*#__PURE__*/pe($),Me=/*#__PURE__*/pe(A),Ue=/*#__PURE__*/pe(T),De=/*#__PURE__*/pe(R),Fe=/*#__PURE__*/pe(S),Qe=/*#__PURE__*/pe(O),He=/*#__PURE__*/pe(I),We=/*#__PURE__*/pe(j),Je=/*#__PURE__*/pe(q),Ve=/*#__PURE__*/pe(k),ze=/*#__PURE__*/pe(P),Ke=/*#__PURE__*/pe(L),Ge=/*#__PURE__*/pe(B),Ye=/*#__PURE__*/pe(M),Xe=/*#__PURE__*/pe(U),Ze=/*#__PURE__*/pe(D),et=/*#__PURE__*/pe(F),tt=/*#__PURE__*/pe(Q),rt=/*#__PURE__*/pe(H),nt=/*#__PURE__*/pe(W),it=/*#__PURE__*/pe(J),st=/*#__PURE__*/pe(V),ot=/*#__PURE__*/pe(z),at=/*#__PURE__*/pe(K),lt=/*#__PURE__*/pe(G),ut=/*#__PURE__*/pe(Y),ct=/*#__PURE__*/pe(X),ht=/*#__PURE__*/pe(Z),dt=/*#__PURE__*/pe(ee),pt=/*#__PURE__*/pe(te),mt=/*#__PURE__*/pe(re),ft=/*#__PURE__*/pe(ne),gt=/*#__PURE__*/pe(ie),yt=/*#__PURE__*/pe(se),bt=/*#__PURE__*/pe(oe),wt=/*#__PURE__*/pe(ae),vt=/*#__PURE__*/pe(le),_t=/*#__PURE__*/pe(ue),Et=/*#__PURE__*/pe(ce),Ct=/*#__PURE__*/pe(he);function Nt(){return Nt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},Nt.apply(this,arguments)}function xt(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,$t(e,t)}function $t(e,t){return $t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},$t(e,t)}function At(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Tt(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return At(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?At(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var Rt=/*#__PURE__*/function(){function e(){}return e.arrayToLower=function(e){return e.join("~").toLowerCase().split("~")},e.replaceAll=function(e,t,r){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),r)},e.encrypt=function(e){var t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),n=Ne.default.createCipheriv("aes-256-cbc",t,r),i=n.update(e);return(i=Buffer.concat([i,n.final()])).toString("hex")},e.decrypt=function(e){var t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),n=Buffer.from(e,"hex"),i=Ne.default.createDecipheriv("aes-256-cbc",t,r),s=i.update(n);return(s=Buffer.concat([s,i.final()])).toString()},e.sleep=function(e){return Ce.default.promisify(setTimeout)(e)},e.generateKeys=function(){return{key:Ne.default.randomBytes(32).toString("hex"),iv:Ne.default.randomBytes(16).toString("hex")}},e.flattenObject=function(t){var r,n={};for(var i in t)if(t.hasOwnProperty(i))if(t[i]&&Array===t[i].constructor)n[i]=t[i];else if("object"==typeof t[i])for(var s in r=e.flattenObject(t[i]))r.hasOwnProperty(s)&&(r[s]&&Array===r.constructor||(n[i+(isNaN(s)?"."+s:"")]=r[s]));else n[i]=t[i];return n},e.unflatten=function(e){var t={};for(var r in e){var n=r.split(".");n.reduce(function(t,i,s){return t[i]||(t[i]=isNaN(Number(n[s+1]))?n.length-1==s?e[r]:{}:[])},t)}return t},e.expressHandler=function(){return function(e){return function(){var t=[].slice.call(arguments),r=e.apply(void 0,t),n=t[t.length-1];return Promise.resolve(r).catch(function(e){return n(e)})}}},e}(),St=/*#__PURE__*/function(){function e(){this.watcher={}}var t=e.prototype;return t.load=function(e){try{var t=this,r=e||process.env.DEFAULT_LANG;t.currentData||(t.currentData={}),t.currentDataFlat||(t.currentDataFlat={});var n=process.cwd()+"/i18n/lang_"+r+".json";return t.watcher[r]=xe.default.watch(n,{ignored:/(^|[/\\])\../,persistent:!0}),t.watcher[r].on("change",function(e){return t.loadFile(e,r)}),Promise.resolve(t.loadFile(n,r)).then(function(){})}catch(e){return Promise.reject(e)}},t.loadFile=function(e,t){try{var r=this,n=Ce.default.promisify(Ee.default.readFile);return Promise.resolve(function(i,s){try{var o=Promise.resolve(n(e,"utf8")).then(function(e){var n=JSON.parse(e);r.currentDataFlat[t]=Rt.flattenObject(n),r.currentData[t]=n})}catch(e){return s(e)}return o&&o.then?o.then(void 0,s):o}(0,function(e){if("ENOENT"===(null==e?void 0:e.code))return console.log("Lang file does not exist. Create it on ./i18n/lang_{xx}.json");console.error(e)}))}catch(e){return Promise.reject(e)}},t.translate=function(e,t){try{var r,n=function(t){return r?t:"undefined."+e},i=this;if(t||(t=process.env.DEFAULT_LANG),i.currentDataFlat&&i.currentDataFlat[t]&&i.currentDataFlat[t][e])return Promise.resolve(i.currentData[t][e]);var s=function(){if(!i.currentDataFlat||!i.currentDataFlat[t])return Promise.resolve(i.load(t)).then(function(){if(i.currentDataFlat&&i.currentDataFlat[t]&&i.currentDataFlat[e])return r=1,i.currentDataFlat[t][e]})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e}(),Ot=/*#__PURE__*/function(){function e(e,t,r,n){this.data=t,this.success=e,this.total=n,this.message=r||""}return e.prototype.toJson=function(){return this},e}();function It(e){var t={exports:{}};return e(t,t.exports),t.exports}var jt=It(function(e,t){var r=$e.default.Buffer;function n(e,t){for(var r in e)t[r]=e[r]}function i(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=$e.default:(n($e.default,t),t.Buffer=i),n(r,i),i.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},i.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var i=r(e);return void 0!==t?"string"==typeof n?i.fill(t,n):i.fill(t):i.fill(0),i},i.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return $e.default.SlowBuffer(e)}}),qt=jt.Buffer;function kt(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=qt.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=qt.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}Ce.default.inherits(kt,Ae.default),kt.prototype.write=function(e){this.buffer=qt.concat([this.buffer,qt.from(e)]),this.emit("data",e)},kt.prototype.end=function(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1};var Pt=kt,Lt=$e.default.Buffer,Bt=$e.default.SlowBuffer,Mt=Ut;function Ut(e,t){if(!Lt.isBuffer(e)||!Lt.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var r=0,n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}Ut.install=function(){Lt.prototype.equal=Bt.prototype.equal=function(e){return Ut(this,e)}};var Dt=Lt.prototype.equal,Ft=Bt.prototype.equal;function Qt(e){return(e/8|0)+(e%8==0?0:1)}Ut.restore=function(){Lt.prototype.equal=Dt,Bt.prototype.equal=Ft};var Ht={ES256:Qt(256),ES384:Qt(384),ES512:Qt(521)},Wt=function(e){var t=Ht[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},Jt=jt.Buffer;function Vt(e){if(Jt.isBuffer(e))return e;if("string"==typeof e)return Jt.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function zt(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=128&&--n,n}var Kt=function(e,t){e=Vt(e);var r=Wt(t),n=r+1,i=e.length,s=0;if(48!==e[s++])throw new Error('Could not find expected "seq"');var o=e[s++];if(129===o&&(o=e[s++]),i-s<o)throw new Error('"seq" specified length of "'+o+'", only "'+(i-s)+'" remaining');if(2!==e[s++])throw new Error('Could not find expected "int" for "r"');var a=e[s++];if(i-s-2<a)throw new Error('"r" specified length of "'+a+'", only "'+(i-s-2)+'" available');if(n<a)throw new Error('"r" specified length of "'+a+'", max of "'+n+'" is acceptable');var l=s;if(s+=a,2!==e[s++])throw new Error('Could not find expected "int" for "s"');var u=e[s++];if(i-s!==u)throw new Error('"s" specified length of "'+u+'", expected "'+(i-s)+'"');if(n<u)throw new Error('"s" specified length of "'+u+'", max of "'+n+'" is acceptable');var c=s;if((s+=u)!==i)throw new Error('Expected to consume entire buffer, but "'+(i-s)+'" bytes remain');var h=r-a,d=r-u,p=Jt.allocUnsafe(h+a+d+u);for(s=0;s<h;++s)p[s]=0;e.copy(p,s,l+Math.max(-h,0),l+a);for(var m=s=r;s<m+d;++s)p[s]=0;return e.copy(p,s,c+Math.max(-d,0),c+u),(p=p.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},Gt=jt.Buffer,Yt="secret must be a string or buffer",Xt="key must be a string or a buffer",Zt="function"==typeof Ne.default.createPublicKey;function er(e){if(!Gt.isBuffer(e)&&"string"!=typeof e){if(!Zt)throw ir(Xt);if("object"!=typeof e)throw ir(Xt);if("string"!=typeof e.type)throw ir(Xt);if("string"!=typeof e.asymmetricKeyType)throw ir(Xt);if("function"!=typeof e.export)throw ir(Xt)}}function tr(e){if(!Gt.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw ir("key must be a string, a buffer or an object")}function rr(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function nr(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var r=0;r<t;++r)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function ir(e){var t=[].slice.call(arguments,1),r=Ce.default.format.bind(Ce.default,e).apply(null,t);return new TypeError(r)}function sr(e){var t;return Gt.isBuffer(t=e)||"string"==typeof t||(e=JSON.stringify(e)),e}function or(e){return function(t,r){!function(e){if(!Gt.isBuffer(e)){if("string"==typeof e)return e;if(!Zt)throw ir(Yt);if("object"!=typeof e)throw ir(Yt);if("secret"!==e.type)throw ir(Yt);if("function"!=typeof e.export)throw ir(Yt)}}(r),t=sr(t);var n=Ne.default.createHmac("sha"+e,r);return rr((n.update(t),n.digest("base64")))}}function ar(e){return function(t,r,n){var i=or(e)(t,n);return Mt(Gt.from(r),Gt.from(i))}}function lr(e){return function(t,r){tr(r),t=sr(t);var n=Ne.default.createSign("RSA-SHA"+e);return rr((n.update(t),n.sign(r,"base64")))}}function ur(e){return function(t,r,n){er(n),t=sr(t),r=nr(r);var i=Ne.default.createVerify("RSA-SHA"+e);return i.update(t),i.verify(n,r,"base64")}}function cr(e){return function(t,r){tr(r),t=sr(t);var n=Ne.default.createSign("RSA-SHA"+e);return rr((n.update(t),n.sign({key:r,padding:Ne.default.constants.RSA_PKCS1_PSS_PADDING,saltLength:Ne.default.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function hr(e){return function(t,r,n){er(n),t=sr(t),r=nr(r);var i=Ne.default.createVerify("RSA-SHA"+e);return i.update(t),i.verify({key:n,padding:Ne.default.constants.RSA_PKCS1_PSS_PADDING,saltLength:Ne.default.constants.RSA_PSS_SALTLEN_DIGEST},r,"base64")}}function dr(e){var t=lr(e);return function(){var r=t.apply(null,arguments);return Kt(r,"ES"+e)}}function pr(e){var t=ur(e);return function(r,n,i){return n=function(e,t){e=Vt(e);var r=Wt(t),n=e.length;if(n!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+n+'"');var i=zt(e,0,r),s=zt(e,r,e.length),o=r-i,a=r-s,l=2+o+1+1+a,u=l<128,c=Jt.allocUnsafe((u?2:3)+l),h=0;return c[h++]=48,u?c[h++]=l:(c[h++]=129,c[h++]=255&l),c[h++]=2,c[h++]=o,i<0?(c[h++]=0,h+=e.copy(c,h,0,r)):h+=e.copy(c,h,i,r),c[h++]=2,c[h++]=a,s<0?(c[h++]=0,e.copy(c,h,r)):e.copy(c,h,r+s),c}(n,"ES"+e).toString("base64"),t(r,n,i)}}function mr(){return function(){return""}}function fr(){return function(e,t){return""===t}}Zt&&(Xt+=" or a KeyObject",Yt+="or a KeyObject");var gr=function(e){var t={hs:or,rs:lr,ps:cr,es:dr,none:mr},r={hs:ar,rs:ur,ps:hr,es:pr,none:fr},n=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!n)throw ir('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var i=(n[1]||n[3]).toLowerCase(),s=n[2];return{sign:t[i](s),verify:r[i](s)}},yr=$e.default.Buffer,br=function(e){return"string"==typeof e?e:"number"==typeof e||yr.isBuffer(e)?e.toString():JSON.stringify(e)},wr=jt.Buffer;function vr(e,t){return wr.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function _r(e){var t=e.header,r=e.payload,n=e.secret||e.privateKey,i=e.encoding,s=gr(t.alg),o=function(e,t,r){r=r||"utf8";var n=vr(br(e),"binary"),i=vr(br(t),r);return Ce.default.format("%s.%s",n,i)}(t,r,i),a=s.sign(o,n);return Ce.default.format("%s.%s",o,a)}function Er(e){var t=new Pt(e.secret||e.privateKey||e.key);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=t,this.payload=new Pt(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}Ce.default.inherits(Er,Ae.default),Er.prototype.sign=function(){try{var e=_r({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},Er.sign=_r;var Cr=Er,Nr=jt.Buffer,xr=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function $r(e){var t=e.split(".",1)[0];return function(e){if(function(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}(Nr.from(t,"base64").toString("binary"))}function Ar(e){return e.split(".")[2]}function Tr(e){return xr.test(e)&&!!$r(e)}function Rr(e,t,r){if(!t){var n=new Error("Missing algorithm parameter for jws.verify");throw n.code="MISSING_ALGORITHM",n}var i=Ar(e=br(e)),s=function(e){return e.split(".",2).join(".")}(e);return gr(t).verify(s,i,r)}function Sr(e,t){if(t=t||{},!Tr(e=br(e)))return null;var r=$r(e);if(!r)return null;var n=function(e,t){t=t||"utf8";var r=e.split(".")[1];return Nr.from(r,"base64").toString(t)}(e);return("JWT"===r.typ||t.json)&&(n=JSON.parse(n,t.encoding)),{header:r,payload:n,signature:Ar(e)}}function Or(e){var t=new Pt((e=e||{}).secret||e.publicKey||e.key);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=t,this.signature=new Pt(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}Ce.default.inherits(Or,Ae.default),Or.prototype.verify=function(){try{var e=Rr(this.signature.buffer,this.algorithm,this.key.buffer),t=Sr(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},Or.decode=Sr,Or.isValid=Tr,Or.verify=Rr;var Ir=Or,jr={ALGORITHMS:["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],sign:Cr.sign,verify:Ir.verify,decode:Ir.decode,isValid:Ir.isValid,createSign:function(e){return new Cr(e)},createVerify:function(e){return new Ir(e)}},qr=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(qr.prototype=Object.create(Error.prototype)).constructor=qr;var kr=qr,Pr=function(e,t){kr.call(this,e),this.name="NotBeforeError",this.date=t};(Pr.prototype=Object.create(kr.prototype)).constructor=Pr;var Lr=Pr,Br=function(e,t){kr.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(Br.prototype=Object.create(kr.prototype)).constructor=Br;var Mr=Br,Ur=6e4,Dr=60*Ur,Fr=24*Dr;function Qr(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}var Hr=function(e,t){var r=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var n=function(e,t){t=t||{};var r=typeof e;if("string"===r&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*Fr;case"hours":case"hour":case"hrs":case"hr":case"h":return r*Dr;case"minutes":case"minute":case"mins":case"min":case"m":return r*Ur;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(e);if("number"===r&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=Fr?Qr(e,t,Fr,"day"):t>=Dr?Qr(e,t,Dr,"hour"):t>=Ur?Qr(e,t,Ur,"minute"):t>=1e3?Qr(e,t,1e3,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=Fr?Math.round(e/Fr)+"d":t>=Dr?Math.round(e/Dr)+"h":t>=Ur?Math.round(e/Ur)+"m":t>=1e3?Math.round(e/1e3)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}(e);if(void 0===n)return;return Math.floor(r+n/1e3)}return"number"==typeof e?r+e:void 0},Wr=It(function(e,t){var r;t=e.exports=J,r="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("SEMVER"),console.log.apply(console,e)}:function(){},t.SEMVER_SPEC_VERSION="2.0.0";var n=Number.MAX_SAFE_INTEGER||9007199254740991,i=t.re=[],s=t.src=[],o=0,a=o++;s[a]="0|[1-9]\\d*";var l=o++;s[l]="[0-9]+";var u=o++;s[u]="\\d*[a-zA-Z-][a-zA-Z0-9-]*";var c=o++;s[c]="("+s[a]+")\\.("+s[a]+")\\.("+s[a]+")";var h=o++;s[h]="("+s[l]+")\\.("+s[l]+")\\.("+s[l]+")";var d=o++;s[d]="(?:"+s[a]+"|"+s[u]+")";var p=o++;s[p]="(?:"+s[l]+"|"+s[u]+")";var m=o++;s[m]="(?:-("+s[d]+"(?:\\."+s[d]+")*))";var f=o++;s[f]="(?:-?("+s[p]+"(?:\\."+s[p]+")*))";var g=o++;s[g]="[0-9A-Za-z-]+";var y=o++;s[y]="(?:\\+("+s[g]+"(?:\\."+s[g]+")*))";var b=o++,w="v?"+s[c]+s[m]+"?"+s[y]+"?";s[b]="^"+w+"$";var v="[v=\\s]*"+s[h]+s[f]+"?"+s[y]+"?",_=o++;s[_]="^"+v+"$";var E=o++;s[E]="((?:<|>)?=?)";var C=o++;s[C]=s[l]+"|x|X|\\*";var N=o++;s[N]=s[a]+"|x|X|\\*";var x=o++;s[x]="[v=\\s]*("+s[N]+")(?:\\.("+s[N]+")(?:\\.("+s[N]+")(?:"+s[m]+")?"+s[y]+"?)?)?";var $=o++;s[$]="[v=\\s]*("+s[C]+")(?:\\.("+s[C]+")(?:\\.("+s[C]+")(?:"+s[f]+")?"+s[y]+"?)?)?";var A=o++;s[A]="^"+s[E]+"\\s*"+s[x]+"$";var T=o++;s[T]="^"+s[E]+"\\s*"+s[$]+"$";var R=o++;s[R]="(?:^|[^\\d])(\\d{1,16})(?:\\.(\\d{1,16}))?(?:\\.(\\d{1,16}))?(?:$|[^\\d])";var S=o++;s[S]="(?:~>?)";var O=o++;s[O]="(\\s*)"+s[S]+"\\s+",i[O]=new RegExp(s[O],"g");var I=o++;s[I]="^"+s[S]+s[x]+"$";var j=o++;s[j]="^"+s[S]+s[$]+"$";var q=o++;s[q]="(?:\\^)";var k=o++;s[k]="(\\s*)"+s[q]+"\\s+",i[k]=new RegExp(s[k],"g");var P=o++;s[P]="^"+s[q]+s[x]+"$";var L=o++;s[L]="^"+s[q]+s[$]+"$";var B=o++;s[B]="^"+s[E]+"\\s*("+v+")$|^$";var M=o++;s[M]="^"+s[E]+"\\s*("+w+")$|^$";var U=o++;s[U]="(\\s*)"+s[E]+"\\s*("+v+"|"+s[x]+")",i[U]=new RegExp(s[U],"g");var D=o++;s[D]="^\\s*("+s[x]+")\\s+-\\s+("+s[x]+")\\s*$";var F=o++;s[F]="^\\s*("+s[$]+")\\s+-\\s+("+s[$]+")\\s*$";var Q=o++;s[Q]="(<|>)?=?\\s*\\*";for(var H=0;H<35;H++)r(H,s[H]),i[H]||(i[H]=new RegExp(s[H]));function W(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof J)return e;if("string"!=typeof e)return null;if(e.length>256)return null;if(!(t.loose?i[_]:i[b]).test(e))return null;try{return new J(e,t)}catch(e){return null}}function J(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof J){if(e.loose===t.loose)return e;e=e.version}else if("string"!=typeof e)throw new TypeError("Invalid Version: "+e);if(e.length>256)throw new TypeError("version is longer than 256 characters");if(!(this instanceof J))return new J(e,t);r("SemVer",e,t),this.options=t,this.loose=!!t.loose;var s=e.trim().match(t.loose?i[_]:i[b]);if(!s)throw new TypeError("Invalid Version: "+e);if(this.raw=e,this.major=+s[1],this.minor=+s[2],this.patch=+s[3],this.major>n||this.major<0)throw new TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw new TypeError("Invalid patch version");this.prerelease=s[4]?s[4].split(".").map(function(e){if(/^[0-9]+$/.test(e)){var t=+e;if(t>=0&&t<n)return t}return e}):[],this.build=s[5]?s[5].split("."):[],this.format()}t.parse=W,t.valid=function(e,t){var r=W(e,t);return r?r.version:null},t.clean=function(e,t){var r=W(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null},t.SemVer=J,J.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},J.prototype.toString=function(){return this.version},J.prototype.compare=function(e){return r("SemVer.compare",this.version,this.options,e),e instanceof J||(e=new J(e,this.options)),this.compareMain(e)||this.comparePre(e)},J.prototype.compareMain=function(e){return e instanceof J||(e=new J(e,this.options)),z(this.major,e.major)||z(this.minor,e.minor)||z(this.patch,e.patch)},J.prototype.comparePre=function(e){if(e instanceof J||(e=new J(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;var t=0;do{var n=this.prerelease[t],i=e.prerelease[t];if(r("prerelease compare",t,n,i),void 0===n&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===n)return-1;if(n!==i)return z(n,i)}while(++t)},J.prototype.inc=function(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{for(var r=this.prerelease.length;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);-1===r&&this.prerelease.push(0)}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error("invalid increment argument: "+e)}return this.format(),this.raw=this.version,this},t.inc=function(e,t,r,n){"string"==typeof r&&(n=r,r=void 0);try{return new J(e,r).inc(t,n).version}catch(e){return null}},t.diff=function(e,t){if(X(e,t))return null;var r=W(e),n=W(t),i="";if(r.prerelease.length||n.prerelease.length){i="pre";var s="prerelease"}for(var o in r)if(("major"===o||"minor"===o||"patch"===o)&&r[o]!==n[o])return i+o;return s},t.compareIdentifiers=z;var V=/^[0-9]+$/;function z(e,t){var r=V.test(e),n=V.test(t);return r&&n&&(e=+e,t=+t),e===t?0:r&&!n?-1:n&&!r?1:e<t?-1:1}function K(e,t,r){return new J(e,r).compare(new J(t,r))}function G(e,t,r){return K(e,t,r)>0}function Y(e,t,r){return K(e,t,r)<0}function X(e,t,r){return 0===K(e,t,r)}function Z(e,t,r){return 0!==K(e,t,r)}function ee(e,t,r){return K(e,t,r)>=0}function te(e,t,r){return K(e,t,r)<=0}function re(e,t,r,n){switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return X(e,r,n);case"!=":return Z(e,r,n);case">":return G(e,r,n);case">=":return ee(e,r,n);case"<":return Y(e,r,n);case"<=":return te(e,r,n);default:throw new TypeError("Invalid operator: "+t)}}function ne(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof ne){if(e.loose===!!t.loose)return e;e=e.value}if(!(this instanceof ne))return new ne(e,t);r("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.value=this.semver===ie?"":this.operator+this.semver.version,r("comp",this)}t.rcompareIdentifiers=function(e,t){return z(t,e)},t.major=function(e,t){return new J(e,t).major},t.minor=function(e,t){return new J(e,t).minor},t.patch=function(e,t){return new J(e,t).patch},t.compare=K,t.compareLoose=function(e,t){return K(e,t,!0)},t.rcompare=function(e,t,r){return K(t,e,r)},t.sort=function(e,r){return e.sort(function(e,n){return t.compare(e,n,r)})},t.rsort=function(e,r){return e.sort(function(e,n){return t.rcompare(e,n,r)})},t.gt=G,t.lt=Y,t.eq=X,t.neq=Z,t.gte=ee,t.lte=te,t.cmp=re,t.Comparator=ne;var ie={};function se(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof se)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new se(e.raw,t);if(e instanceof ne)return new se(e.value,t);if(!(this instanceof se))return new se(e,t);if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map(function(e){return this.parseRange(e.trim())},this).filter(function(e){return e.length}),!this.set.length)throw new TypeError("Invalid SemVer Range: "+e);this.format()}function oe(e){return!e||"x"===e.toLowerCase()||"*"===e}function ae(e,t,r,n,i,s,o,a,l,u,c,h,d){return((t=oe(r)?"":oe(n)?">="+r+".0.0":oe(i)?">="+r+"."+n+".0":">="+t)+" "+(a=oe(l)?"":oe(u)?"<"+(+l+1)+".0.0":oe(c)?"<"+l+"."+(+u+1)+".0":h?"<="+l+"."+u+"."+c+"-"+h:"<="+a)).trim()}function le(e,t,n){for(var i=0;i<e.length;i++)if(!e[i].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(i=0;i<e.length;i++)if(r(e[i].semver),e[i].semver!==ie&&e[i].semver.prerelease.length>0){var s=e[i].semver;if(s.major===t.major&&s.minor===t.minor&&s.patch===t.patch)return!0}return!1}return!0}function ue(e,t,r){try{t=new se(t,r)}catch(e){return!1}return t.test(e)}function ce(e,t,r,n){var i,s,o,a,l;switch(e=new J(e,n),t=new se(t,n),r){case">":i=G,s=te,o=Y,a=">",l=">=";break;case"<":i=Y,s=ee,o=G,a="<",l="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(ue(e,t,n))return!1;for(var u=0;u<t.set.length;++u){var c=null,h=null;if(t.set[u].forEach(function(e){e.semver===ie&&(e=new ne(">=0.0.0")),h=h||e,i(e.semver,(c=c||e).semver,n)?c=e:o(e.semver,h.semver,n)&&(h=e)}),c.operator===a||c.operator===l)return!1;if((!h.operator||h.operator===a)&&s(e,h.semver))return!1;if(h.operator===l&&o(e,h.semver))return!1}return!0}ne.prototype.parse=function(e){var t=e.match(this.options.loose?i[B]:i[M]);if(!t)throw new TypeError("Invalid comparator: "+e);this.operator=t[1],"="===this.operator&&(this.operator=""),this.semver=t[2]?new J(t[2],this.options.loose):ie},ne.prototype.toString=function(){return this.value},ne.prototype.test=function(e){return r("Comparator.test",e,this.options.loose),this.semver===ie||("string"==typeof e&&(e=new J(e,this.options)),re(e,this.operator,this.semver,this.options))},ne.prototype.intersects=function(e,t){if(!(e instanceof ne))throw new TypeError("a Comparator is required");var r;if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return r=new se(e.value,t),ue(this.value,r,t);if(""===e.operator)return r=new se(this.value,t),ue(e.semver,r,t);var n=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),i=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),s=this.semver.version===e.semver.version,o=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),a=re(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),l=re(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return n||i||s&&o||a||l},t.Range=se,se.prototype.format=function(){return this.range=this.set.map(function(e){return e.join(" ").trim()}).join("||").trim(),this.range},se.prototype.toString=function(){return this.range},se.prototype.parseRange=function(e){var t=this.options.loose;e=(e=e.trim()).replace(t?i[F]:i[D],ae),r("hyphen replace",e),e=e.replace(i[U],"$1$2$3"),r("comparator trim",e,i[U]),e=(e=(e=e.replace(i[O],"$1~")).replace(i[k],"$1^")).split(/\s+/).join(" ");var n=t?i[B]:i[M],s=e.split(" ").map(function(e){return function(e,t){return r("comp",e,t),e=function(e,t){return e.trim().split(/\s+/).map(function(e){return function(e,t){return r("caret",e,t),e.replace(t.loose?i[L]:i[P],function(t,n,i,s,o){var a;return r("caret",e,t,n,i,s,o),oe(n)?a="":oe(i)?a=">="+n+".0.0 <"+(+n+1)+".0.0":oe(s)?a="0"===n?">="+n+"."+i+".0 <"+n+"."+(+i+1)+".0":">="+n+"."+i+".0 <"+(+n+1)+".0.0":o?(r("replaceCaret pr",o),a="0"===n?"0"===i?">="+n+"."+i+"."+s+"-"+o+" <"+n+"."+i+"."+(+s+1):">="+n+"."+i+"."+s+"-"+o+" <"+n+"."+(+i+1)+".0":">="+n+"."+i+"."+s+"-"+o+" <"+(+n+1)+".0.0"):(r("no pr"),a="0"===n?"0"===i?">="+n+"."+i+"."+s+" <"+n+"."+i+"."+(+s+1):">="+n+"."+i+"."+s+" <"+n+"."+(+i+1)+".0":">="+n+"."+i+"."+s+" <"+(+n+1)+".0.0"),r("caret return",a),a})}(e,t)}).join(" ")}(e,t),r("caret",e),e=function(e,t){return e.trim().split(/\s+/).map(function(e){return function(e,t){return e.replace(t.loose?i[j]:i[I],function(t,n,i,s,o){var a;return r("tilde",e,t,n,i,s,o),oe(n)?a="":oe(i)?a=">="+n+".0.0 <"+(+n+1)+".0.0":oe(s)?a=">="+n+"."+i+".0 <"+n+"."+(+i+1)+".0":o?(r("replaceTilde pr",o),a=">="+n+"."+i+"."+s+"-"+o+" <"+n+"."+(+i+1)+".0"):a=">="+n+"."+i+"."+s+" <"+n+"."+(+i+1)+".0",r("tilde return",a),a})}(e,t)}).join(" ")}(e,t),r("tildes",e),e=function(e,t){return r("replaceXRanges",e,t),e.split(/\s+/).map(function(e){return function(e,t){return(e=e.trim()).replace(t.loose?i[T]:i[A],function(t,n,i,s,o,a){r("xRange",e,t,n,i,s,o,a);var l=oe(i),u=l||oe(s),c=u||oe(o);return"="===n&&c&&(n=""),l?t=">"===n||"<"===n?"<0.0.0":"*":n&&c?(u&&(s=0),o=0,">"===n?(n=">=",u?(i=+i+1,s=0,o=0):(s=+s+1,o=0)):"<="===n&&(n="<",u?i=+i+1:s=+s+1),t=n+i+"."+s+"."+o):u?t=">="+i+".0.0 <"+(+i+1)+".0.0":c&&(t=">="+i+"."+s+".0 <"+i+"."+(+s+1)+".0"),r("xRange return",t),t})}(e,t)}).join(" ")}(e,t),r("xrange",e),e=function(e,t){return r("replaceStars",e,t),e.trim().replace(i[Q],"")}(e,t),r("stars",e),e}(e,this.options)},this).join(" ").split(/\s+/);return this.options.loose&&(s=s.filter(function(e){return!!e.match(n)})),s.map(function(e){return new ne(e,this.options)},this)},se.prototype.intersects=function(e,t){if(!(e instanceof se))throw new TypeError("a Range is required");return this.set.some(function(r){return r.every(function(r){return e.set.some(function(e){return e.every(function(e){return r.intersects(e,t)})})})})},t.toComparators=function(e,t){return new se(e,t).set.map(function(e){return e.map(function(e){return e.value}).join(" ").trim().split(" ")})},se.prototype.test=function(e){if(!e)return!1;"string"==typeof e&&(e=new J(e,this.options));for(var t=0;t<this.set.length;t++)if(le(this.set[t],e,this.options))return!0;return!1},t.satisfies=ue,t.maxSatisfying=function(e,t,r){var n=null,i=null;try{var s=new se(t,r)}catch(e){return null}return e.forEach(function(e){s.test(e)&&(n&&-1!==i.compare(e)||(i=new J(n=e,r)))}),n},t.minSatisfying=function(e,t,r){var n=null,i=null;try{var s=new se(t,r)}catch(e){return null}return e.forEach(function(e){s.test(e)&&(n&&1!==i.compare(e)||(i=new J(n=e,r)))}),n},t.minVersion=function(e,t){e=new se(e,t);var r=new J("0.0.0");if(e.test(r))return r;if(r=new J("0.0.0-0"),e.test(r))return r;r=null;for(var n=0;n<e.set.length;++n)e.set[n].forEach(function(e){var t=new J(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":r&&!G(r,t)||(r=t);break;case"<":case"<=":break;default:throw new Error("Unexpected operation: "+e.operator)}});return r&&e.test(r)?r:null},t.validRange=function(e,t){try{return new se(e,t).range||"*"}catch(e){return null}},t.ltr=function(e,t,r){return ce(e,t,"<",r)},t.gtr=function(e,t,r){return ce(e,t,">",r)},t.outside=ce,t.prerelease=function(e,t){var r=W(e,t);return r&&r.prerelease.length?r.prerelease:null},t.intersects=function(e,t,r){return e=new se(e,r),t=new se(t,r),e.intersects(t)},t.coerce=function(e){if(e instanceof J)return e;if("string"!=typeof e)return null;var t=e.match(i[R]);return null==t?null:W(t[1]+"."+(t[2]||"0")+"."+(t[3]||"0"))}}),Jr=Wr.satisfies(process.version,"^6.12.0 || >=8.0.0"),Vr=["RS256","RS384","RS512","ES256","ES384","ES512"],zr=["RS256","RS384","RS512"],Kr=["HS256","HS384","HS512"];Jr&&(Vr.splice(3,0,"PS256","PS384","PS512"),zr.splice(3,0,"PS256","PS384","PS512"));var Gr=/^\s+|\s+$/g,Yr=/^[-+]0x[0-9a-f]+$/i,Xr=/^0b[01]+$/i,Zr=/^0o[0-7]+$/i,en=/^(?:0|[1-9]\d*)$/,tn=parseInt;function rn(e){return e!=e}var nn=Object.prototype,sn=nn.hasOwnProperty,on=nn.toString,an=nn.propertyIsEnumerable,ln=function(e,t){return function(r){return e(t(r))}}(Object.keys,Object),un=Math.max;function cn(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||en.test(e))&&e>-1&&e%1==0&&e<t}var hn=Array.isArray;function dn(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!function(e){var t=pn(e)?on.call(e):"";return"[object Function]"==t||"[object GeneratorFunction]"==t}(e)}function pn(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function mn(e){return!!e&&"object"==typeof e}var fn=Object.prototype.toString,gn=function(e){return!0===e||!1===e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==fn.call(e)},yn=/^\s+|\s+$/g,bn=/^[-+]0x[0-9a-f]+$/i,wn=/^0b[01]+$/i,vn=/^0o[0-7]+$/i,_n=parseInt,En=Object.prototype.toString;function Cn(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var Nn=function(e){return"number"==typeof e&&e==function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==En.call(e)}(e))return NaN;if(Cn(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Cn(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(yn,"");var r=wn.test(e);return r||vn.test(e)?_n(e.slice(2),r?2:8):bn.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e)},xn=Object.prototype.toString,$n=function(e){return"number"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==xn.call(e)},An=Object.prototype,Tn=Function.prototype.toString,Rn=An.hasOwnProperty,Sn=Tn.call(Object),On=An.toString,In=function(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object),jn=function(e){if(!function(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=On.call(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=In(e);if(null===t)return!0;var r=Rn.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&Tn.call(r)==Sn},qn=Object.prototype.toString,kn=Array.isArray,Pn=function(e){return"string"==typeof e||!kn(e)&&function(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==qn.call(e)},Ln=/^\s+|\s+$/g,Bn=/^[-+]0x[0-9a-f]+$/i,Mn=/^0b[01]+$/i,Un=/^0o[0-7]+$/i,Dn=parseInt,Fn=Object.prototype.toString;function Qn(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var Hn=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];Jr&&Hn.splice(3,0,"PS256","PS384","PS512");var Wn={expiresIn:{isValid:function(e){return Nn(e)||Pn(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return Nn(e)||Pn(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return Pn(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:function(e,t,r,n){var i;e=dn(e)?e:(i=e)?function(e,t){return function(t,r){for(var n=-1,i=t?t.length:0,s=Array(i);++n<i;)s[n]=e[t[n]];return s}(t)}(i,function(e){return dn(e)?function(e,t){var r=hn(e)||function(e){return function(e){return mn(e)&&dn(e)}(e)&&sn.call(e,"callee")&&(!an.call(e,"callee")||"[object Arguments]"==on.call(e))}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,i=!!n;for(var s in e)!sn.call(e,s)||i&&("length"==s||cn(s,n))||r.push(s);return r}(e):function(e){if((t=e)!==("function"==typeof(r=t&&t.constructor)&&r.prototype||nn))return ln(e);var t,r,n=[];for(var i in Object(e))sn.call(e,i)&&"constructor"!=i&&n.push(i);return n}(e)}(i)):[],r=r&&!n?function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||mn(e)&&"[object Symbol]"==on.call(e)}(e))return NaN;if(pn(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=pn(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Gr,"");var r=Xr.test(e);return r||Zr.test(e)?tn(e.slice(2),r?2:8):Yr.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(r):0;var s=e.length;return r<0&&(r=un(s+r,0)),function(e){return"string"==typeof e||!hn(e)&&mn(e)&&"[object String]"==on.call(e)}(e)?r<=s&&e.indexOf(t,r)>-1:!!s&&function(e,t,r){if(t!=t)return function(e,t,r,n){for(var i=e.length,s=r+-1;++s<i;)if(t(e[s],s,e))return s;return-1}(e,rn,r);for(var n=r-1,i=e.length;++n<i;)if(e[n]===t)return n;return-1}(e,t,r)>-1}.bind(null,Hn),message:'"algorithm" must be a valid string enum value'},header:{isValid:jn,message:'"header" must be an object'},encoding:{isValid:Pn,message:'"encoding" must be a string'},issuer:{isValid:Pn,message:'"issuer" must be a string'},subject:{isValid:Pn,message:'"subject" must be a string'},jwtid:{isValid:Pn,message:'"jwtid" must be a string'},noTimestamp:{isValid:gn,message:'"noTimestamp" must be a boolean'},keyid:{isValid:Pn,message:'"keyid" must be a string'},mutatePayload:{isValid:gn,message:'"mutatePayload" must be a boolean'}},Jn={iat:{isValid:$n,message:'"iat" should be a number of seconds'},exp:{isValid:$n,message:'"exp" should be a number of seconds'},nbf:{isValid:$n,message:'"nbf" should be a number of seconds'}};function Vn(e,t,r,n){if(!jn(r))throw new Error('Expected "'+n+'" to be a plain object.');Object.keys(r).forEach(function(i){var s=e[i];if(s){if(!s.isValid(r[i]))throw new Error(s.message)}else if(!t)throw new Error('"'+i+'" is not allowed in "'+n+'"')})}var zn={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},Kn=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"],Gn=function(e,t,r,n){var i;if("function"!=typeof r||n||(n=r,r={}),r||(r={}),r=Object.assign({},r),i=n||function(e,t){if(e)throw e;return t},r.clockTimestamp&&"number"!=typeof r.clockTimestamp)return i(new kr("clockTimestamp must be a number"));if(void 0!==r.nonce&&("string"!=typeof r.nonce||""===r.nonce.trim()))return i(new kr("nonce must be a non-empty string"));var s=r.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return i(new kr("jwt must be provided"));if("string"!=typeof e)return i(new kr("jwt must be a string"));var o,a=e.split(".");if(3!==a.length)return i(new kr("jwt malformed"));try{o=function(e,t){var r=jr.decode(e,t=t||{});if(!r)return null;var n=r.payload;if("string"==typeof n)try{var i=JSON.parse(n);null!==i&&"object"==typeof i&&(n=i)}catch(e){}return!0===t.complete?{header:r.header,payload:n,signature:r.signature}:n}(e,{complete:!0})}catch(e){return i(e)}if(!o)return i(new kr("invalid token"));var l,u=o.header;if("function"==typeof t){if(!n)return i(new kr("verify must be called asynchronous if secret or public key is provided as a callback"));l=t}else l=function(e,r){return r(null,t)};return l(u,function(t,n){if(t)return i(new kr("error in secret or public key callback: "+t.message));var l,c=""!==a[2].trim();if(!c&&n)return i(new kr("jwt signature is required"));if(c&&!n)return i(new kr("secret or public key must be provided"));if(c||r.algorithms||(r.algorithms=["none"]),r.algorithms||(r.algorithms=~n.toString().indexOf("BEGIN CERTIFICATE")||~n.toString().indexOf("BEGIN PUBLIC KEY")?Vr:~n.toString().indexOf("BEGIN RSA PUBLIC KEY")?zr:Kr),!~r.algorithms.indexOf(o.header.alg))return i(new kr("invalid algorithm"));try{l=jr.verify(e,o.header.alg,n)}catch(e){return i(e)}if(!l)return i(new kr("invalid signature"));var h=o.payload;if(void 0!==h.nbf&&!r.ignoreNotBefore){if("number"!=typeof h.nbf)return i(new kr("invalid nbf value"));if(h.nbf>s+(r.clockTolerance||0))return i(new Lr("jwt not active",new Date(1e3*h.nbf)))}if(void 0!==h.exp&&!r.ignoreExpiration){if("number"!=typeof h.exp)return i(new kr("invalid exp value"));if(s>=h.exp+(r.clockTolerance||0))return i(new Mr("jwt expired",new Date(1e3*h.exp)))}if(r.audience){var d=Array.isArray(r.audience)?r.audience:[r.audience];if(!(Array.isArray(h.aud)?h.aud:[h.aud]).some(function(e){return d.some(function(t){return t instanceof RegExp?t.test(e):t===e})}))return i(new kr("jwt audience invalid. expected: "+d.join(" or ")))}if(r.issuer&&("string"==typeof r.issuer&&h.iss!==r.issuer||Array.isArray(r.issuer)&&-1===r.issuer.indexOf(h.iss)))return i(new kr("jwt issuer invalid. expected: "+r.issuer));if(r.subject&&h.sub!==r.subject)return i(new kr("jwt subject invalid. expected: "+r.subject));if(r.jwtid&&h.jti!==r.jwtid)return i(new kr("jwt jwtid invalid. expected: "+r.jwtid));if(r.nonce&&h.nonce!==r.nonce)return i(new kr("jwt nonce invalid. expected: "+r.nonce));if(r.maxAge){if("number"!=typeof h.iat)return i(new kr("iat required when maxAge is specified"));var p=Hr(r.maxAge,h.iat);if(void 0===p)return i(new kr('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(s>=p+(r.clockTolerance||0))return i(new Mr("maxAge exceeded",new Date(1e3*p)))}return i(null,!0===r.complete?{header:u,payload:h,signature:o.signature}:h)})},Yn=function(e,t,r,n){"function"==typeof r?(n=r,r={}):r=r||{};var i="object"==typeof e&&!Buffer.isBuffer(e),s=Object.assign({alg:r.algorithm||"HS256",typ:i?"JWT":void 0,kid:r.keyid},r.header);function o(e){if(n)return n(e);throw e}if(!t&&"none"!==r.algorithm)return o(new Error("secretOrPrivateKey must have a value"));if(void 0===e)return o(new Error("payload is required"));if(i){try{!function(e){Vn(Jn,!0,e,"payload")}(e)}catch(e){return o(e)}r.mutatePayload||(e=Object.assign({},e))}else{var a=Kn.filter(function(e){return void 0!==r[e]});if(a.length>0)return o(new Error("invalid "+a.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==r.expiresIn)return o(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==r.notBefore)return o(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function(e){Vn(Wn,!1,e,"options")}(r)}catch(e){return o(e)}var l=e.iat||Math.floor(Date.now()/1e3);if(r.noTimestamp?delete e.iat:i&&(e.iat=l),void 0!==r.notBefore){try{e.nbf=Hr(r.notBefore,l)}catch(e){return o(e)}if(void 0===e.nbf)return o(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==r.expiresIn&&"object"==typeof e){try{e.exp=Hr(r.expiresIn,l)}catch(e){return o(e)}if(void 0===e.exp)return o(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(zn).forEach(function(t){var n=zn[t];if(void 0!==r[t]){if(void 0!==e[n])return o(new Error('Bad "options.'+t+'" option. The payload already has an "'+n+'" property.'));e[n]=r[t]}});var u=r.encoding||"utf8";if("function"!=typeof n)return jr.sign({header:s,payload:e,secret:t,encoding:u});n=n&&function(e,t){var r;if("function"!=typeof t)throw new TypeError("Expected a function");return e=function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==Fn.call(e)}(e))return NaN;if(Qn(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Qn(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Ln,"");var r=Mn.test(e);return r||Un.test(e)?Dn(e.slice(2),r?2:8):Bn.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=void 0),r}}(2,n),jr.createSign({header:s,privateKey:t,payload:e,encoding:u}).once("error",n).once("done",function(e){n(null,e)})},Xn=/*#__PURE__*/function(){function e(e,t){this.privateKey=e,this.options=t}var t=e.prototype;return t.sign=function(e){var t=Nt({},this.options,{jwtid:Te.v4()});return Yn(e,this.privateKey,t)},t.verify=function(e){return Gn(e,this.privateKey,this.options)},t.refresh=function(e){var t=Gn(e,this.privateKey,this.options);delete t.sub,delete t.iss,delete t.aud,delete t.iat,delete t.exp,delete t.nbf,delete t.jti;var r=Nt({},this.options,{jwtid:Te.v4()});return Yn(t,this.privateKey,r)},e}(),Zn=/*#__PURE__*/function(){function e(e,t,r){this.app=ge.default(),this.express_config=_e.default.defaultsDeep(e,{helmet:!0,json:!0,urlencoded:!0,compression:!0,cors:{origin:!0,credentials:!0},fileupload:!0,socketio:{transports:["websocket"]},traceRequests:!1}),this.statics=t,this.routes=r}var t=e.prototype;return t.initialize=function(){try{var e=function(){return Promise.resolve(t.configureRoutes(t.routes)).then(function(){return Promise.resolve(t.errorHandler()).then(function(){})})},t=this;t.config(t.express_config);var r=function(){if(t.customizeExpress)return Promise.resolve(t.customizeExpress(t.app)).then(function(){})}();return Promise.resolve(r&&r.then?r.then(e):e())}catch(e){return Promise.reject(e)}},t.customizeExpress=function(){},t.config=function(e){if(e&&e.helmet&&this.app.use(fe.default(e&&_e.default.isObject(e.helmet)&&e.helmet)),e&&e.json&&this.app.use(ge.default.json()),e&&e.urlencoded&&this.app.use(ge.default.urlencoded({extended:!0})),e&&e.compression&&this.app.use(ye.default()),e&&e.cors&&(this.app.options("*",be.default(e&&_e.default.isObject(e.cors)&&e.cors)),this.app.use(be.default(e&&_e.default.isObject(e.cors)&&e.cors))),e&&e.fileupload&&this.app.use(we.default()),this.statics)for(var t in this.statics)this.app.use(t,ge.default.static(this.statics[t]));e&&!0===e.traceRequests&&"true"!=process.env.DISABLE_LOGGER&&this.app.use(function(e,t,r){e.requestTime=Date.now(),t.on("finish",function(){var t=ve.default.parse(e.url).pathname,r=Date.now()-e.requestTime;console.debug("APIRequest["+process.pid+"]::. ["+e.method+"] (user:"+(e&&e.session&&e.session.user_id||"")+")  "+t+" |-> took: "+r+" ms"),console.debug(JSON.stringify(e.body))}),r()})},t.configureRoutes=function(e){var t=ge.default.Router();this.app.use(t),this.loadRoutes(this.app,e)},t.loadRoutes=function(e,t){if(t)for(var r,n=Tt(t);!(r=n()).done;){var i=r.value;if(i){var s=i.configure();if(i.entity&&(s=i.configure(i.entity,{service:i.service,table:i.table})),!_e.default.isEmpty(i.routes)){var o=Rt.expressHandler();for(var a in i.routes){var l=i.routes[a];for(var u in l){var c=l[u];Array.isArray(c)?s[u](a,c[0],o(c[1])):s[u](a,o(c))}}}s&&e.use(s)}else console.warn("Empty route")}},t.errorHandler=function(){this.app.use(function(e,t,r,n){var i=new Ot;i.success=!1,i.message=e.message,console.error(e),r.status(500).json(i.toJson())})},e}(),ei=/*#__PURE__*/function(e){function t(t){var r;return r=e.call(this)||this,process.env.PORT||console.log("Using 3000 as default port. Customize via env PORT."),r.port=r.normalizePort(process.env.PORT||3e3),r.clustered=process.env.CLUSTERED,r.workers=[],r.app=t,r.executeOnlyMain=function(){},r}xt(t,e);var r=t.prototype;return r.setServerCls=function(e){this.server=e},r.start=function(){try{var e=this,t=function(){if("true"!=e.clustered)return e.configureSocketIO(),e.executeOnlyMain(),Promise.resolve(e.initUnclustered()).then(function(){});e.initClustered()}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.configureSocketIO=function(){this.server.express_config&&this.server.express_config.socketio&&(this.app.io=new b.Server(this.server.express_config&&this.server.express_config.socketio),this.app.io.listen(this.port+1))},r.initClustered=function(){try{var e=this,t=function(){if(!Ie.default.isPrimary)return Promise.resolve(e.initUnclustered()).then(function(){console.log("Worker "+process.pid+" started")});e.configureSocketIO(),e.executeOnlyMain(),(new ke.default).on("event",function(t,r){t&&t.event&&(1==process.env.DEBUG_EVENTS&&console.debug("Received '"+t.event+"' from "+t.props.owner+" at Master"),e.app.events.emit(t.event,t.props,r))});for(var t=je.default.cpus().length,r=0;r<t;r+=1)e.initWorker();Ie.default.on("exit",function(t){console.log("Worker "+t.id+" died :("),e.initWorker()})}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.initWorker=function(){var e=Ie.default.fork();console.log("Running worker "+e.process.pid),this.workers.push(e)},r.initUnclustered=function(){try{var e=this;e.server.port=e.port;var t=Re.default.Server(e.server.app);return Promise.resolve(e.server.initialize()).then(function(){function r(){function r(){if(t.on("error",function(t){e.handleErrors(t,e.server.port)}),t.on("listening",function(){console.log("Server Worker running on port: "+e.port+"!"),e.emit("listening",e.port)}),process.env.SSL&&"true"==process.env.SSL){process.env.SSL_KEY&&process.env.SSL_CERT&&process.env.SSL_PASS||(console.error("Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed"),process.exit(0));var r={key:Ee.default.readFileSync(Oe.default.resolve(process.cwd(),process.env.SSL_KEY||"key.pem")),cert:Ee.default.readFileSync(Oe.default.resolve(process.cwd(),process.env.SSL_CERT||"cert.pem")),passphrase:process.env.SSL_PASS};process.env.SSL_PORT||console.log("Using 3443 as ssl default port. Customize via env SSL_PORT.");var n=e.normalizePort(process.env.SSL_PORT||3443),i=Se.default.createServer(r,e.server.app);i.listen(n),i.on("error",function(t){e.handleErrors(t,n)}),i.on("listening",function(){console.log("Server Worker running on port: "+n+"!"),e.emit("listening_ssl",n)})}}t.listen(e.server.port);var n=function(){if(e.server.afterListen)return Promise.resolve(e.server.afterListen()).then(function(){})}();return n&&n.then?n.then(r):r()}var n=function(){if(e.server.beforeListen)return Promise.resolve(e.server.beforeListen()).then(function(){})}();return n&&n.then?n.then(r):r()})}catch(e){return Promise.reject(e)}},r.normalizePort=function(e){var t=parseInt(e,10);return isNaN(t)?e:t>=0&&t},r.handleErrors=function(e,t){if("listen"!==e.syscall)throw e;var r="string"==typeof t?"Pipe "+t:"Port "+t;switch(e.code){case"EACCES":console.error(r+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(r+" is already in use"),process.exit(1);break;default:throw e}},t}(v.EventEmitter),ti=/*#__PURE__*/function(e){function t(t){var r;return(r=e.call(this)||this).messages=new ke.default,r.app=t,Ie.default.isWorker&&r.messages.on("event",function(t,n){t&&t.event&&process.pid!==t.props.owner&&(1==process.env.DEBUG_EVENTS&&console.debug("Receiving broadcast "+t.event+" - "+process.pid),e.prototype.emit.call(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(r),t.event,Nt({},t.props),n))}),r}return xt(t,e),t.prototype.emit=function(t,r,n){e.prototype.emit.call(this,t,r,n),t&&r&&Ie.default.isWorker&&process.pid!==r.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(t+" -> Firing from "+process.pid+" to master"),r||(r={}),r.owner=process.pid,this.messages.send("event",{event:t,props:Nt({},r)},n)),t&&r&&Ie.default.isPrimary&&this.app&&this.app.server&&this.app.server.workers&&(1==process.env.DEBUG_EVENTS&&console.debug(t+" -> Firing from master to workers"),this.messages.send("event",{event:t,props:Nt({},r)},n))},t}(v.EventEmitter),ri=Pe.default.configure,ni=Pe.default.getLogger,ii=/*#__PURE__*/function(){function e(){}return e.configure=function(){try{var e=Ce.default.promisify(Ee.default.readFile);return Promise.resolve(e(Oe.default.resolve(process.cwd(),"./log4js.json"),"utf8")).then(function(e){var t,r,n;ri(JSON.parse(e)),t=ni("log"),r=ni("error"),n=ni("debug"),console.log=function(){var e=Array.prototype.slice.call(arguments);t.log("info",e[0])},console.error=function(){var e=Array.prototype.slice.call(arguments);r.log("error",e[0])},console.info=function(){var e=Array.prototype.slice.call(arguments);t.log("info",e[0])},console.debug=function(){var e=Array.prototype.slice.call(arguments);n.log("debug",e[0])},console.custom=function(e,t,r){ni(e).log(t,r)}})}catch(e){return Promise.reject(e)}},e}();function si(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var oi=/*#__PURE__*/function(){function e(e,t){this.router=ge.default.Router(),this.publicPathsList=[].concat(e,["/login"]),this.AuthHandler=t}var t=e.prototype;return t.configure=function(){var e=this,t=Rt.expressHandler();return this.router.use(t(function(){return e.check.apply(e,[].slice.call(arguments))})),this.router.post("/login",t(function(){return e.loginPost.apply(e,[].slice.call(arguments))})),this.router.post("/logout",t(function(){return e.logout.apply(e,[].slice.call(arguments))})),this.router},t.check=function(e,t,r){try{var n=this;return Promise.resolve(si(function(){for(var i,s=Tt(n.publicPathsList);!(i=s()).done;)if(null!==C.pathToRegexp(i.value).exec(ve.default.parse(e.url).pathname))return r();return Promise.resolve(n.AuthHandler.check(e)).then(function(e){return e?r():t.status(403).json(new Ot(!1,null,"Forbidden").toJson())})},function(e){return console.error(e),t.status(403).json(new Ot(!1,null,"Forbidden").toJson())}))}catch(e){return Promise.reject(e)}},t.loginPost=function(e,t){try{var r,n=function(e){return r?e:t.status(401).json(new Ot(!1,null,"Unauthorized - Missing parameters").toJson())},i=this,s=function(){if(e.body.username)return si(function(){return Promise.resolve(i.AuthHandler.validate(e,e.body.username,e.body.password)).then(function(e){if(e){var n=t.status(200).json(new Ot(!0,e).toJson());return r=1,n}var i=t.status(401).json(new Ot(!1,null,"Unauthorized - Incorrect credentials").toJson());return r=1,i})},function(e){console.error(e);var n=t.status(401).json(new Ot(!1,null,"Unauthorized - Error, check log").toJson());return r=1,n})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},t.logout=function(e,t){try{var r,n=function(e){return r?e:t.status(200).json(new Ot(!0).toJson())},i=this,s=function(){if(i.AuthHandler.logout)return si(function(){return Promise.resolve(i.AuthHandler.logout(e)).then(function(){var e=t.status(200).json(new Ot(!0).toJson());return r=1,e})},function(e){console.error(e);var n=t.status(500).json(new Ot(!1,null,e).toJson());return r=1,n})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e}(),ai=function(){if(!this.check)throw new Error("AuthHandler must have 'check' vethod");if(!this.validate)throw new Error("AuthHandler must have 'validate' vethod")},li=/*#__PURE__*/function(e){function t(t){var r;if((r=e.call(this)||this).tokenGenerator=new Xn(process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE,issuer:process.env.JWT_ISSUER,subject:process.env.JWT_SUBJECT,algorithm:process.env.JWT_ALGORITHM,expiresIn:process.env.JWT_EXPIRES}),!t)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return r.userDao=t,r}xt(t,e);var r=t.prototype;return r.check=function(e){try{if(e.headers.authorization){var t=(e.headers.authorization||"").split(" ")[1]||"";if(!t)return console.error("Token needed"),Promise.resolve(!1);try{var r=this.tokenGenerator.verify(t);return r.sub&&r.username&&!Le.default(r.exp).isAfter(new Date)?(e.session=Nt({},e.session,r),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return console.error(e),Promise.resolve(!1)}}return Promise.resolve(!1)}catch(e){return Promise.reject(e)}},r.validate=function(e,t,r){try{var n=this;return Promise.resolve(n.userDao.findByUsername(t)).then(function(e){return!(!e||e.username!==t||e.password!==Rt.encrypt(r))&&n.tokenGenerator.sign(_e.default.omit(e,["password"]))})}catch(e){return Promise.reject(e)}},t}(ai),ui=/*#__PURE__*/function(e){function t(t){var r;if(r=e.call(this)||this,!t)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return r.userDao=t,r}xt(t,e);var r=t.prototype;return r.check=function(e){try{var t,r=function(r){return t?r:!(!e.session||!e.session.username)},n=this,i=function(){if(e.headers.authorization){var r=(e.headers.authorization||"").split(" ")[1]||"",i=Buffer.from(r,"base64").toString().split(":");return Promise.resolve(n.validate(e,i[0],i[1])).then(function(e){return e?t=!0:(t=1,!1)})}}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},r.validate=function(e,t,r){try{return Promise.resolve(this.userDao.findByUsername(t)).then(function(n){return!(!n||n.username!==t||n.password!==Rt.encrypt(r)||(e.session=Nt({},e.session,_e.default.omit(n,["password"])),0))})}catch(e){return Promise.reject(e)}},r.logout=function(e){return new Promise(function(t){e.session&&e.session.destroy(t)})},t}(ai);class ci extends Error{}var hi=/*#__PURE__*/Object.defineProperty({TimeoutError:ci},"__esModule",{value:!0}),di=/*#__PURE__*/Object.defineProperty({PromiseInspection:class{constructor(e){this._value=e.value,this._error=e.error}value(){return this._value}reason(){return this._error}isRejected(){return!!this._error}isFulfilled(){return!!this._value}}},"__esModule",{value:!0});function pi(e){return"number"==typeof e&&e===Math.round(e)&&e>0}var mi=/*#__PURE__*/Object.defineProperty({defer:function(){let e=null,t=null;return{promise:new Promise((r,n)=>{e=r,t=n}),resolve:e,reject:t}},now:function(){return Date.now()},duration:function(e,t){return Math.abs(t-e)},checkOptionalTime:function(e){return void 0===e||pi(e)},checkRequiredTime:pi,delay:function(e){return new Promise(t=>setTimeout(t,e))},reflect:function(e){return e.then(e=>new di.PromiseInspection({value:e})).catch(e=>new di.PromiseInspection({error:e}))},tryPromise:function(e){try{const t=e();return Promise.resolve(t)}catch(e){return Promise.reject(e)}}},"__esModule",{value:!0}),fi=/*#__PURE__*/Object.defineProperty({PendingOperation:class{constructor(e){var t,r;this.timeoutMillis=e,this.deferred=mi.defer(),this.possibleTimeoutCause=null,this.isRejected=!1,this.promise=(t=this.deferred.promise,r=e,new Promise((e,n)=>{const i=setTimeout(()=>n(new hi.TimeoutError),r);t.then(t=>{clearTimeout(i),e(t)}).catch(e=>{clearTimeout(i),n(e)})})).catch(e=>(e instanceof hi.TimeoutError&&(e=new hi.TimeoutError(this.possibleTimeoutCause?this.possibleTimeoutCause.message:"operation timed out for an unknown reason")),this.isRejected=!0,Promise.reject(e)))}abort(){this.reject(new Error("aborted"))}reject(e){this.deferred.reject(e)}resolve(e){this.deferred.resolve(e)}}},"__esModule",{value:!0});class gi{constructor(e){this.resource=e,this.resource=e,this.timestamp=mi.now(),this.deferred=mi.defer()}get promise(){return this.deferred.promise}resolve(){return this.deferred.resolve(void 0),new gi(this.resource)}}var yi=/*#__PURE__*/Object.defineProperty({Resource:gi},"__esModule",{value:!0});function bi(e,t){const r=e.indexOf(t);return-1!==r&&(e.splice(r,1),!0)}var wi=/*#__PURE__*/Object.defineProperty({Pool:class{constructor(e){if(this.destroyed=!1,this.emitter=new qe.default.EventEmitter,!(e=e||{}).create)throw new Error("Tarn: opt.create function most be provided");if(!e.destroy)throw new Error("Tarn: opt.destroy function most be provided");if("number"!=typeof e.min||e.min<0||e.min!==Math.round(e.min))throw new Error("Tarn: opt.min must be an integer >= 0");if("number"!=typeof e.max||e.max<=0||e.max!==Math.round(e.max))throw new Error("Tarn: opt.max must be an integer > 0");if(e.min>e.max)throw new Error("Tarn: opt.max is smaller than opt.min");if(!mi.checkOptionalTime(e.acquireTimeoutMillis))throw new Error("Tarn: invalid opt.acquireTimeoutMillis "+JSON.stringify(e.acquireTimeoutMillis));if(!mi.checkOptionalTime(e.createTimeoutMillis))throw new Error("Tarn: invalid opt.createTimeoutMillis "+JSON.stringify(e.createTimeoutMillis));if(!mi.checkOptionalTime(e.destroyTimeoutMillis))throw new Error("Tarn: invalid opt.destroyTimeoutMillis "+JSON.stringify(e.destroyTimeoutMillis));if(!mi.checkOptionalTime(e.idleTimeoutMillis))throw new Error("Tarn: invalid opt.idleTimeoutMillis "+JSON.stringify(e.idleTimeoutMillis));if(!mi.checkOptionalTime(e.reapIntervalMillis))throw new Error("Tarn: invalid opt.reapIntervalMillis "+JSON.stringify(e.reapIntervalMillis));if(!mi.checkOptionalTime(e.createRetryIntervalMillis))throw new Error("Tarn: invalid opt.createRetryIntervalMillis "+JSON.stringify(e.createRetryIntervalMillis));const t={create:!0,validate:!0,destroy:!0,log:!0,min:!0,max:!0,acquireTimeoutMillis:!0,createTimeoutMillis:!0,destroyTimeoutMillis:!0,idleTimeoutMillis:!0,reapIntervalMillis:!0,createRetryIntervalMillis:!0,propagateCreateError:!0};for(const r of Object.keys(e))if(!t[r])throw new Error(`Tarn: unsupported option opt.${r}`);this.creator=e.create,this.destroyer=e.destroy,this.validate="function"==typeof e.validate?e.validate:()=>!0,this.log=e.log||(()=>{}),this.acquireTimeoutMillis=e.acquireTimeoutMillis||3e4,this.createTimeoutMillis=e.createTimeoutMillis||3e4,this.destroyTimeoutMillis=e.destroyTimeoutMillis||5e3,this.idleTimeoutMillis=e.idleTimeoutMillis||3e4,this.reapIntervalMillis=e.reapIntervalMillis||1e3,this.createRetryIntervalMillis=e.createRetryIntervalMillis||200,this.propagateCreateError=!!e.propagateCreateError,this.min=e.min,this.max=e.max,this.used=[],this.free=[],this.pendingCreates=[],this.pendingAcquires=[],this.pendingDestroys=[],this.pendingValidations=[],this.destroyed=!1,this.interval=null,this.eventId=1}numUsed(){return this.used.length}numFree(){return this.free.length}numPendingAcquires(){return this.pendingAcquires.length}numPendingValidations(){return this.pendingValidations.length}numPendingCreates(){return this.pendingCreates.length}acquire(){const e=this.eventId++;this._executeEventHandlers("acquireRequest",e);const t=new fi.PendingOperation(this.acquireTimeoutMillis);return this.pendingAcquires.push(t),t.promise=t.promise.then(t=>(this._executeEventHandlers("acquireSuccess",e,t),t)).catch(r=>(this._executeEventHandlers("acquireFail",e,r),bi(this.pendingAcquires,t),Promise.reject(r))),this._tryAcquireOrCreate(),t}release(e){this._executeEventHandlers("release",e);for(let t=0,r=this.used.length;t<r;++t){const r=this.used[t];if(r.resource===e)return this.used.splice(t,1),this.free.push(r.resolve()),this._tryAcquireOrCreate(),!0}return!1}isEmpty(){return 0===[this.numFree(),this.numUsed(),this.numPendingAcquires(),this.numPendingValidations(),this.numPendingCreates()].reduce((e,t)=>e+t)}check(){const e=mi.now(),t=[],r=this.free.length-(this.min-this.used.length);let n=0;this.free.forEach(i=>{mi.duration(e,i.timestamp)>=this.idleTimeoutMillis&&n<r?(n++,this._destroy(i.resource)):t.push(i)}),this.free=t,this.isEmpty()&&this._stopReaping()}destroy(){const e=this.eventId++;return this._executeEventHandlers("poolDestroyRequest",e),this._stopReaping(),this.destroyed=!0,mi.reflect(Promise.all(this.pendingCreates.map(e=>mi.reflect(e.promise))).then(()=>new Promise((e,t)=>{if(0===this.numPendingValidations())return void e();const r=setInterval(()=>{0===this.numPendingValidations()&&(Be.default.clearInterval(r),e())},100)})).then(()=>Promise.all(this.used.map(e=>mi.reflect(e.promise)))).then(()=>Promise.all(this.pendingAcquires.map(e=>(e.abort(),mi.reflect(e.promise))))).then(()=>Promise.all(this.free.map(e=>mi.reflect(this._destroy(e.resource))))).then(()=>Promise.all(this.pendingDestroys.map(e=>e.promise))).then(()=>{this.free=[],this.pendingAcquires=[]})).then(t=>(this._executeEventHandlers("poolDestroySuccess",e),this.emitter.removeAllListeners(),t))}on(e,t){this.emitter.on(e,t)}removeListener(e,t){this.emitter.removeListener(e,t)}removeAllListeners(e){this.emitter.removeAllListeners(e)}_tryAcquireOrCreate(){this.destroyed||(this._hasFreeResources()?this._doAcquire():this._shouldCreateMoreResources()&&this._doCreate())}_hasFreeResources(){return this.free.length>0}_doAcquire(){for(;this._canAcquire();){const e=this.pendingAcquires.shift(),t=this.free.pop();if(void 0===t||void 0===e){const e="this.free was empty while trying to acquire resource";throw this.log(`Tarn: ${e}`,"warn"),new Error(`Internal error, should never happen. ${e}`)}this.pendingValidations.push(e),this.used.push(t);const r=new fi.PendingOperation(this.acquireTimeoutMillis);e.promise.catch(e=>{r.abort()}),r.promise.catch(e=>(this.log("Tarn: resource validator threw an exception "+e.stack,"warn"),!1)).then(r=>{try{r&&!e.isRejected?(this._startReaping(),e.resolve(t.resource)):(bi(this.used,t),r?this.free.push(t):(this._destroy(t.resource),setTimeout(()=>{this._tryAcquireOrCreate()},0)),e.isRejected||this.pendingAcquires.unshift(e))}finally{bi(this.pendingValidations,e)}}),this._validateResource(t.resource).then(e=>{r.resolve(e)}).catch(e=>{r.reject(e)})}}_canAcquire(){return this.free.length>0&&this.pendingAcquires.length>0}_validateResource(e){try{return Promise.resolve(this.validate(e))}catch(e){return Promise.reject(e)}}_shouldCreateMoreResources(){return this.used.length+this.pendingCreates.length<this.max&&this.pendingCreates.length<this.pendingAcquires.length}_doCreate(){const e=this.pendingAcquires.slice();this._create().promise.then(()=>(this._tryAcquireOrCreate(),null)).catch(t=>{this.propagateCreateError&&0!==this.pendingAcquires.length&&this.pendingAcquires[0].reject(t),e.forEach(e=>{e.possibleTimeoutCause=t}),mi.delay(this.createRetryIntervalMillis).then(()=>this._tryAcquireOrCreate())})}_create(){const e=this.eventId++;this._executeEventHandlers("createRequest",e);const t=new fi.PendingOperation(this.createTimeoutMillis);var r;return t.promise=t.promise.catch(r=>{throw bi(this.pendingCreates,t)&&this._executeEventHandlers("createFail",e,r),r}),this.pendingCreates.push(t),(r=this.creator,new Promise((e,t)=>{const n=(r,n)=>{r?t(r):e(n)};mi.tryPromise(()=>r(n)).then(t=>{t&&e(t)}).catch(e=>{t(e)})})).then(r=>t.isRejected?(this.destroyer(r),null):(bi(this.pendingCreates,t),this.free.push(new yi.Resource(r)),t.resolve(r),this._executeEventHandlers("createSuccess",e,r),null)).catch(r=>(t.isRejected||(bi(this.pendingCreates,t)&&this._executeEventHandlers("createFail",e,r),t.reject(r)),null)),t}_destroy(e){const t=this.eventId++;this._executeEventHandlers("destroyRequest",t,e);const r=new fi.PendingOperation(this.destroyTimeoutMillis);return Promise.resolve().then(()=>this.destroyer(e)).then(()=>{r.resolve(e)}).catch(e=>{r.reject(e)}),this.pendingDestroys.push(r),r.promise.then(r=>(this._executeEventHandlers("destroySuccess",t,e),r)).catch(r=>this._logDestroyerError(t,e,r)).then(e=>{const t=this.pendingDestroys.findIndex(e=>e===r);return this.pendingDestroys.splice(t,1),e})}_logDestroyerError(e,t,r){this._executeEventHandlers("destroyFail",e,t,r),this.log("Tarn: resource destroyer threw an exception "+r.stack,"warn")}_startReaping(){this.interval||(this._executeEventHandlers("startReaping"),this.interval=setInterval(()=>this.check(),this.reapIntervalMillis))}_stopReaping(){null!==this.interval&&(this._executeEventHandlers("stopReaping"),Be.default.clearInterval(this.interval)),this.interval=null}_executeEventHandlers(e,...t){this.emitter.listeners(e).forEach(r=>{try{r(...t)}catch(t){this.log(`Tarn: event handler "${e}" threw an exception ${t.stack}`,"warn")}})}}},"__esModule",{value:!0}),vi=hi.TimeoutError,_i={Pool:wi.Pool,TimeoutError:hi.TimeoutError};_i.Pool=wi.Pool,_i.TimeoutError=vi;const Ei=/[\0\b\t\n\r\x1a"'\\]/g,Ci={"\0":"\\0","\b":"\\b","\t":"\\t","\n":"\\n","\r":"\\r","":"\\Z",'"':'\\"',"'":"\\'","\\":"\\\\"};function Ni(e){return function t(r,n={}){return e(r,t,n)}}function xi(e,t,r){return e&&"function"==typeof e.toSQL?e.toSQL(r):JSON.stringify(e)}function $i(e,t,r){let n="";for(let i=0;i<e.length;i++){const s=e[i];Array.isArray(s)?n+=(0===i?"":", ")+"("+$i(s,t,r)+")":n+=(0===i?"":", ")+t(s,r)}return n}function Ai(e){return"X"+Ti(e.toString("hex"))}function Ti(e,t,r){let n,i=Ei.lastIndex=0,s="";for(;n=Ei.exec(e);)s+=e.slice(i,n.index)+Ci[n[0]],i=Ei.lastIndex;return 0===i?"'"+e+"'":i<e.length?"'"+s+e.slice(i)+"'":"'"+s+"'"}function Ri(e,t,r={}){const n=r.timeZone||"local",i=new Date(e);let s,o,a,l,u,c,h;if("local"===n)s=i.getFullYear(),o=i.getMonth()+1,a=i.getDate(),l=i.getHours(),u=i.getMinutes(),c=i.getSeconds(),h=i.getMilliseconds();else{const e=function(e){if("Z"===e)return 0;const t=e.match(/([+\-\s])(\d\d):?(\d\d)?/);return!!t&&("-"==t[1]?-1:1)*(parseInt(t[2],10)+(t[3]?parseInt(t[3],10):0)/60)*60}(n);!1!==e&&0!==e&&i.setTime(i.getTime()+6e4*e),s=i.getUTCFullYear(),o=i.getUTCMonth()+1,a=i.getUTCDate(),l=i.getUTCHours(),u=i.getUTCMinutes(),c=i.getUTCSeconds(),h=i.getUTCMilliseconds()}return Si(s,4)+"-"+Si(o,2)+"-"+Si(a,2)+" "+Si(l,2)+":"+Si(u,2)+":"+Si(c,2)+"."+Si(h,3)}function Si(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e}var Oi={arrayToList:$i,bufferToString:Ai,dateToString:Ri,escapeString:Ti,charsRegex:Ei,charsMap:Ci,escapeObject:xi,makeEscape:function(e={}){const t=e.escapeDate||Ri,r=e.escapeArray||$i,n=e.escapeBuffer||Ai,i=e.escapeString||Ti,s=e.escapeObject||xi,o=e.wrap||Ni;function a(e,o,a){if(null==e)return"NULL";switch(typeof e){case"boolean":return e?"true":"false";case"number":return e+"";case"object":if(!(e instanceof Date))return Array.isArray(e)?r(e,o,a):Buffer.isBuffer(e)?n(e,o,a):s(e,o,a);e=t(e,o,a)}return i(e,o,a)}return o?o(a):a}};class Ii extends Error{constructor(e){super(e),this.name="KnexTimeoutError"}}var ji={KnexTimeoutError:Ii,timeout:function(e,t){return new Promise(function(r,n){const i=setTimeout(function(){n(new Ii("operation timed out"))},t);e.then(function(e){clearTimeout(i),r(e)},function(e){clearTimeout(i),n(e)})})}},qi={ensureConnectionCallback:function(e){e.client.emit("start",e.builder),e.builder.emit("start",e.builder);const t=e.builder.toSQL();return e.builder._debug&&e.client.logger.debug(t),Array.isArray(t)?e.queryArray(t):e.query(t)},ensureConnectionStreamCallback:function(e,t){try{const r=e.builder.toSQL();if(Array.isArray(r)&&t.hasHandler)throw new Error("The stream may only be used with a single query statement.");return e.client.stream(e.connection,r,t.stream,t.options)}catch(e){throw t.stream.emit("error",e),e}}};const{KnexTimeoutError:ki}=ji,{timeout:Pi}=ji,{ensureConnectionCallback:Li,ensureConnectionStreamCallback:Bi}=qi;let Mi;class Ui{constructor(e,t){this.client=e,this.builder=t,this.queries=[],this.connection=void 0}async run(){const e=this;try{const t=await this.ensureConnection(Li);return e.builder.emit("end"),t}catch(t){throw e.builder._events&&e.builder._events.error&&e.builder.emit("error",t),t}}stream(e,t){const r="function"==typeof e&&1===arguments.length,n=r?{}:e,i=r?e:t,s="function"==typeof i;Mi=Mi||Ae.default.Transform;const o=this.builder.queryContext(),a=new Mi({objectMode:!0,transform:(e,t,r)=>{r(null,this.client.postProcessResponse(e,o))}});a.on("close",()=>{this.client.releaseConnection(this.connection)});const l=this.ensureConnection(Bi,{options:n,hasHandler:s,stream:a}).catch(e=>{this.connection||a.emit("error",e)});return s?(i(a),l):a}pipe(e,t){return this.stream(t).pipe(e)}async query(e){const{__knexUid:t,__knexTxId:r}=this.connection;this.builder.emit("query",Object.assign({__knexUid:t,__knexTxId:r},e));const n=this,i=this.builder.queryContext();null!==e&&"object"==typeof e&&(e.queryContext=i);let s=this.client.query(this.connection,e);return e.timeout&&(s=Pi(s,e.timeout)),s.then(e=>this.client.processResponse(e,n)).then(n=>{const s=this.client.postProcessResponse(n,i);return this.builder.emit("query-response",s,Object.assign({__knexUid:t,__knexTxId:r},e),this.builder),this.client.emit("query-response",s,Object.assign({__knexUid:t,__knexTxId:r},e),this.builder),s}).catch(t=>{if(!(t instanceof ki))return Promise.reject(t);const{timeout:r,sql:n,bindings:i}=e;let s;return e.cancelOnTimeout?s=this.client.cancelQuery(this.connection):(this.connection.__knex__disposed=t,s=Promise.resolve()),s.catch(e=>{throw this.connection.__knex__disposed=t,Object.assign(e,{message:`After query timeout of ${r}ms exceeded, cancelling of query failed.`,sql:n,bindings:i,timeout:r})}).then(()=>{throw Object.assign(t,{message:`Defined query timeout of ${r}ms exceeded when running query.`,sql:n,bindings:i,timeout:r})})}).catch(n=>{throw this.builder.emit("query-error",n,Object.assign({__knexUid:t,__knexTxId:r,queryContext:i},e)),n})}async queryArray(e){if(1===e.length){const t=e[0];if(!t.statementsProducer)return this.query(t);const r=await t.statementsProducer(void 0,this.connection),n=r.sql.map(e=>({sql:e,bindings:t.bindings})),i=r.pre.map(e=>({sql:e,bindings:t.bindings})),s=r.post.map(e=>({sql:e,bindings:t.bindings}));let o=[];await this.queryArray(i);try{await this.client.transaction(async e=>{const t=new Ui(e.client,this.builder);if(t.connection=this.connection,o=await t.queryArray(n),r.check&&(await e.raw(r.check)).length>0)throw new Error("FOREIGN KEY constraint failed")},{connection:this.connection})}finally{await this.queryArray(s)}return o}const t=[];for(const r of e)t.push(await this.queryArray([r]));return t}async ensureConnection(e,t){if(this.builder._connection&&(this.connection=this.builder._connection),this.connection)return e(this,t);let r;try{r=await this.client.acquireConnection()}catch(e){if(!(e instanceof ki))return Promise.reject(e);throw this.builder&&(e.sql=this.builder.sql,e.bindings=this.builder.bindings),e}try{return this.connection=r,await e(this,t)}finally{await this.client.releaseConnection(r)}}}var Di=Ui,Fi=6e4,Qi=60*Fi,Hi=24*Qi,Wi=function(e,t){t=t||{};var r=typeof e;if("string"===r&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*Hi;case"hours":case"hour":case"hrs":case"hr":case"h":return r*Qi;case"minutes":case"minute":case"mins":case"min":case"m":return r*Fi;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(e);if("number"===r&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=Hi?Ji(e,t,Hi,"day"):t>=Qi?Ji(e,t,Qi,"hour"):t>=Fi?Ji(e,t,Fi,"minute"):t>=1e3?Ji(e,t,1e3,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=Hi?Math.round(e/Hi)+"d":t>=Qi?Math.round(e/Qi)+"h":t>=Fi?Math.round(e/Fi)+"m":t>=1e3?Math.round(e/1e3)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function Ji(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}var Vi=It(function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(i=n))}),t.splice(i,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=function(e){function t(e){let n,i,s,o=null;function a(...e){if(!a.enabled)return;const r=a,i=Number(new Date);r.diff=i-(n||i),r.prev=n,r.curr=i,n=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,i)=>{if("%%"===n)return"%";s++;const o=t.formatters[i];return"function"==typeof o&&(n=o.call(r,e[s]),e.splice(s,1),s--),n}),t.formatArgs.call(r,e),(r.log||t.log).apply(r,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=r,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==t.namespaces&&(i=t.namespaces,s=t.enabled(e)),s),set:e=>{o=e}}),"function"==typeof t.init&&t.init(a),a}function r(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names.map(n),...t.skips.map(n).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),i=n.length;for(r=0;r<i;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=Wi,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(r=>{t[r]=e[r]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t}(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}),zi=function(){},Ki=["with","withRecursive","withMaterialized","withNotMaterialized","select","as","columns","column","from","fromJS","fromRaw","into","withSchema","table","distinct","join","joinRaw","innerJoin","leftJoin","leftOuterJoin","rightJoin","rightOuterJoin","outerJoin","fullOuterJoin","crossJoin","where","andWhere","orWhere","whereNot","orWhereNot","whereLike","andWhereLike","orWhereLike","whereILike","andWhereILike","orWhereILike","whereRaw","whereWrapped","havingWrapped","orWhereRaw","whereExists","orWhereExists","whereNotExists","orWhereNotExists","whereIn","orWhereIn","whereNotIn","orWhereNotIn","whereNull","orWhereNull","whereNotNull","orWhereNotNull","whereBetween","whereNotBetween","andWhereBetween","andWhereNotBetween","orWhereBetween","orWhereNotBetween","groupBy","groupByRaw","orderBy","orderByRaw","union","unionAll","intersect","having","havingRaw","orHaving","orHavingRaw","offset","limit","count","countDistinct","min","max","sum","sumDistinct","avg","avgDistinct","increment","decrement","first","debug","pluck","clearSelect","clearWhere","clearGroup","clearOrder","clearHaving","insert","update","returning","del","delete","truncate","transacting","connection","jsonExtract","jsonSet","jsonInsert","jsonRemove","whereJsonObject","orWhereJsonObject","andWhereJsonObject","whereNotJsonObject","orWhereNotJsonObject","andWhereNotJsonObject","whereJsonPath","orWhereJsonPath","andWhereJsonPath","whereJsonSupersetOf","orWhereJsonSupersetOf","andWhereJsonSupersetOf","whereJsonNotSupersetOf","orWhereJsonNotSupersetOf","andWhereJsonNotSupersetOf","whereJsonSubsetOf","orWhereJsonSubsetOf","andWhereJsonSubsetOf","whereJsonNotSubsetOf","orWhereJsonNotSubsetOf","andWhereJsonNotSubsetOf"],Gi={isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isBoolean:function(e){return"boolean"==typeof e},isUndefined:function(e){return void 0===e},isObject:function(e){return"object"==typeof e&&null!==e},isFunction:function(e){return"function"==typeof e}};const{isNumber:Yi}=Gi,{EventEmitter:Xi}=qe.default,{Migrator:Zi}=zi,{isObject:es}=Gi,ts={client:{get(){return this.context.client},set(e){this.context.client=e},configurable:!0},userParams:{get(){return this.context.userParams},set(e){this.context.userParams=e},configurable:!0},schema:{get(){return this.client.schemaBuilder()},configurable:!0},migrate:{get(){return new Zi(this)},configurable:!0},seed:{get:()=>new zi,configurable:!0},fn:{get(){return new class{constructor(e){this.client=e}now(e){return this.client.raw("number"==typeof e?`CURRENT_TIMESTAMP(${e})`:"CURRENT_TIMESTAMP")}uuidToBin(e,t=!0){const r=Buffer.from(e.replace(/-/g,""),"hex");return t?Buffer.concat([r.slice(6,8),r.slice(4,6),r.slice(0,4),r.slice(8,16)]):Buffer.concat([r.slice(0,4),r.slice(4,6),r.slice(6,8),r.slice(8,16)])}binToUuid(e,t=!0){const r=Buffer.from(e,"hex");return t?[r.toString("hex",4,8),r.toString("hex",2,4),r.toString("hex",0,2),r.toString("hex",8,10),r.toString("hex",10,16)].join("-"):[r.toString("hex",0,4),r.toString("hex",4,6),r.toString("hex",6,8),r.toString("hex",8,10),r.toString("hex",10,16)].join("-")}}(this.client)},configurable:!0}},rs=["raw","batchInsert","transaction","transactionProvider","initialize","destroy","ref","withUserParams","queryBuilder","disableProcessing","enableProcessing"];for(const e of rs)ts[e]={value:function(...t){return this.context[e](...t)},configurable:!0};function ns(e,t,r){t.listeners(e).forEach(t=>{r.on(e,t)})}function is(e,t){for(let t=0;t<Ki.length;t++){const r=Ki[t];e[r]=function(){const e=this.queryBuilder();return e[r].apply(e,arguments)}}Object.defineProperties(e,ts),function(e){const t=e.context||{};Object.assign(t,{queryBuilder(){return this.client.queryBuilder()},raw(){return this.client.raw.apply(this.client,arguments)},batchInsert(e,t,r=1e3){return function(e,t,r,n=1e3){let i,s=null;if(!Yi(n)||n<1)throw new TypeError(`Invalid chunkSize: ${n}`);if(!Array.isArray(r))throw new TypeError("Invalid batch: Expected array, got "+typeof r);const o=Qe.default(r,n);return Object.assign(Promise.resolve().then(async()=>{return await new Promise(e=>setTimeout(e,1)),r=async e=>{const r=[];for(const n of o)r.push(await e(t).insert(n,i));return He.default(r)},s?r(s):e.transaction(r);var r}),{returning(e){return i=e,this},transacting(e){return s=e,this}})}(this,e,t,r)},transaction(e,t){!t&&es(e)&&(t=e,e=null);const r=Object.assign({},t);return r.userParams=this.userParams||{},void 0===r.doNotRejectOnRollback&&(r.doNotRejectOnRollback=!0),this._transaction(e,r)},_transaction(e,t,r=null){return e?this.client.transaction(e,t,r):new Promise((e,n)=>{this.client.transaction(e,t,r).catch(n)})},transactionProvider(e){let t;return()=>(t||(t=this.transaction(void 0,e)),t)},initialize(e){return this.client.initializePool(e)},destroy(e){return this.client.destroy(e)},ref(e){return this.client.ref(e)},disableProcessing(){this.userParams.isProcessingDisabled||(this.userParams.wrapIdentifier=this.client.config.wrapIdentifier,this.userParams.postProcessResponse=this.client.config.postProcessResponse,this.client.config.wrapIdentifier=null,this.client.config.postProcessResponse=null,this.userParams.isProcessingDisabled=!0)},enableProcessing(){this.userParams.isProcessingDisabled&&(this.client.config.wrapIdentifier=this.userParams.wrapIdentifier,this.client.config.postProcessResponse=this.userParams.postProcessResponse,this.userParams.isProcessingDisabled=!1)},withUserParams(t){const r=function(e){const t=Object.create(Object.getPrototypeOf(e),Object.getOwnPropertyDescriptors(e)),r={},n=((e,t)=>os(r,e,t)).bind(t);return Object.assign(n,e),n.context=r,n}(e);return this.client&&(r.client=Object.create(this.client.constructor.prototype),Fe.default(r.client,this.client),r.client.config=Object.assign({},this.client.config)),is(r,r.client),ns("query",e,r),ns("query-error",e,r),ns("query-response",e,r),ns("start",e,r),r.userParams=t,r}}),e.context||(e.context=t)}(e),e.client=t,e.userParams={};const r=new Xi;for(const t in r)e[t]=r[t];e._internalListeners&&e._internalListeners.forEach(({eventName:t,listener:r})=>{e.client.removeListener(t,r)}),e._internalListeners=[],ss(e,"start",t=>{e.emit("start",t)}),ss(e,"query",t=>{e.emit("query",t)}),ss(e,"query-error",(t,r)=>{e.emit("query-error",t,r)}),ss(e,"query-response",(t,r,n)=>{e.emit("query-response",t,r,n)})}function ss(e,t,r){e.client.on(t,r),e._internalListeners.push({eventName:t,listener:r})}function os(e,t,r){const n=e.queryBuilder();return t||e.client.logger.warn("calling knex without a tableName is deprecated. Use knex.queryBuilder() instead."),t?n.table(t,r):n}var as=function(e){function t(e,r){return os(t.context,e,r)}return is(t,e),t},ls=Promise.prototype.finally?e=>Object.assign(e,{finally(e){return this.then().finally(e)}}):zi;const{EventEmitter:us}=qe.default,{callbackify:cs}=Ce.default,{timeout:hs,KnexTimeoutError:ds}=ji,ps=Vi("knex:tx"),ms=["read uncommitted","read committed","snapshot","repeatable read","serializable"];class fs extends us{constructor(e,t,r={userParams:{},doNotRejectOnRollback:!0},n=null){super(),this.userParams=r.userParams,this.doNotRejectOnRollback=r.doNotRejectOnRollback;const i=this.txid=De.default("trx");this.client=e,this.logger=e.logger,this.outerTx=n,this.trxClient=void 0,this._completed=!1,this._debug=e.config&&e.config.debug,r.isolationLevel&&this.setIsolationLevel(r.isolationLevel),ps("%s: Starting %s transaction",i,n?"nested":"top level"),this._lastChild=Promise.resolve();const s=(n?n._lastChild:Promise.resolve()).then(()=>this._evaluateContainer(r,t));this._promise=s.then(e=>e),n&&(n._lastChild=s.catch(()=>{}))}isCompleted(){return this._completed||this.outerTx&&this.outerTx.isCompleted()||!1}begin(e){return(this.isolationLevel?this.query(e,`SET TRANSACTION ISOLATION LEVEL ${this.isolationLevel};`):Promise.resolve()).then(()=>this.query(e,"BEGIN;"))}savepoint(e){return this.query(e,`SAVEPOINT ${this.txid};`)}commit(e,t){return this.query(e,"COMMIT;",1,t)}release(e,t){return this.query(e,`RELEASE SAVEPOINT ${this.txid};`,1,t)}setIsolationLevel(e){if(!ms.includes(e))throw new Error(`Invalid isolationLevel, supported isolation levels are: ${JSON.stringify(ms)}`);return this.isolationLevel=e,this}rollback(e,t){return hs(this.query(e,"ROLLBACK",2,t),5e3).catch(e=>{if(!(e instanceof ds))return Promise.reject(e);this._rejecter(t)})}rollbackTo(e,t){return hs(this.query(e,`ROLLBACK TO SAVEPOINT ${this.txid}`,2,t),5e3).catch(e=>{if(!(e instanceof ds))return Promise.reject(e);this._rejecter(t)})}query(e,t,r,n){const i=this.trxClient.query(e,t).catch(e=>{r=2,n=e,this._completed=!0,ps("%s error running transaction query",this.txid)}).then(e=>{if(1===r&&this._resolver(n),2===r){if(void 0===n){if(this.doNotRejectOnRollback&&/^ROLLBACK\b/i.test(t))return void this._resolver();n=new Error(`Transaction rejected with non-error: ${n}`)}this._rejecter(n)}return e});return 1!==r&&2!==r||(this._completed=!0),i}debug(e){return this._debug=!arguments.length||e,this}async _evaluateContainer(e,t){return this.acquireConnection(e,e=>{const r=this.trxClient=function(e,t,r){const n=Object.create(t.constructor.prototype);n.version=t.version,n.config=t.config,n.driver=t.driver,n.connectionSettings=t.connectionSettings,n.transacting=!0,n.valueForUndefined=t.valueForUndefined,n.logger=t.logger,n.on("start",function(r){e.emit("start",r),t.emit("start",r)}),n.on("query",function(r){e.emit("query",r),t.emit("query",r)}),n.on("query-error",function(r,n){e.emit("query-error",r,n),t.emit("query-error",r,n)}),n.on("query-response",function(r,n,i){e.emit("query-response",r,n,i),t.emit("query-response",r,n,i)});const i=n.query;n.query=function(t,s){const o=e.isCompleted();return new Promise(function(a,l){try{if(t!==r)throw new Error("Invalid connection for transaction query.");o&&gs(e,s),a(i.call(n,t,s))}catch(e){l(e)}})};const s=n.stream;return n.stream=function(t,i,o,a){const l=e.isCompleted();return new Promise(function(u,c){try{if(t!==r)throw new Error("Invalid connection for transaction query.");l&&gs(e,i),u(s.call(n,t,i,o,a))}catch(e){c(e)}})},n.acquireConnection=function(){return Promise.resolve(r)},n.releaseConnection=function(){return Promise.resolve()},n}(this,this.client,e),n=this.client.transacting?this.savepoint(e):this.begin(e),i=new Promise((e,t)=>{this._resolver=e,this._rejecter=t});return n.then(()=>function(e,t,r){const n=as(r);return n.context.withUserParams=()=>{throw new Error("Cannot set user params on a transaction - it can only inherit params from main knex instance")},n.isTransaction=!0,n.userParams=e.userParams||{},n.context.transaction=function(t,r){return r?void 0===r.doNotRejectOnRollback&&(r.doNotRejectOnRollback=!0):r={doNotRejectOnRollback:!0},this._transaction(t,r,e)},n.savepoint=function(e,t){return n.transaction(e,t)},e.client.transacting?(n.commit=r=>e.release(t,r),n.rollback=r=>e.rollbackTo(t,r)):(n.commit=r=>e.commit(t,r),n.rollback=r=>e.rollback(t,r)),n.isCompleted=()=>e.isCompleted(),n}(this,e,r)).then(e=>{let r;e.executionPromise=i;try{r=t(e)}catch(e){r=Promise.reject(e)}return r&&r.then&&"function"==typeof r.then&&r.then(t=>e.commit(t)).catch(t=>e.rollback(t)),null}).catch(e=>this._rejecter(e)),i})}async acquireConnection(e,t){const r=e&&e.connection,n=r||await this.client.acquireConnection();try{return n.__knexTxId=this.txid,await t(n)}finally{r?ps("%s: not releasing external connection",this.txid):(ps("%s: releasing connection",this.txid),this.client.releaseConnection(n))}}then(e,t){return this._promise.then(e,t)}catch(...e){return this._promise.catch(...e)}asCallback(e){return cs(()=>this._promise)(e),this._promise}}function gs(e,t){throw ps("%s: Transaction completed: %s",e.txid,"string"==typeof t?t:t&&t.sql),new Error("Transaction query already complete, run with DEBUG=knex:tx for more info")}ls(fs.prototype);var ys=fs;const bs=Vi("knex:query"),ws=Vi("knex:bindings"),{isString:vs}=Gi;function _s(e,t,r,n){t=null==t?[]:[].concat(t);let i=0;return e.replace(/\\?\?/g,e=>{if("\\?"===e)return"?";if(i===t.length)return e;const s=t[i++];return n._escapeBinding(s,{timeZone:r})})}var Es={enrichQueryObject:function(e,t,r){const n=vs(t)?{sql:t}:t;n.bindings=r.prepBindings(n.bindings),n.sql=r.positionBindings(n.sql);const{__knexUid:i,__knexTxId:s}=e;var o;return r.emit("query",Object.assign({__knexUid:i,__knexTxId:s},n)),o=s,bs(n.sql.replace(/%/g,"%%"),o),ws(n.bindings,s),n},executeQuery:function(e,t,r){return r._query(e,t).catch(n=>{throw n.message=_s(t.sql,t.bindings,void 0,r)+" - "+n.message,r.emit("query-error",n,Object.assign({__knexUid:e.__knexUid,__knexTxId:e.__knexUid},t)),n})},formatQuery:_s};const Cs=Object.freeze({pg:"postgres",postgresql:"postgres",sqlite:"sqlite3"}),Ns=Object.freeze(["mssql","mysql","mysql2","oracledb","postgres","pgnative","redshift","sqlite3","cockroachdb","better-sqlite3"].concat(Object.keys(Cs))),xs=Object.freeze({MsSQL:"mssql",MySQL:"mysql",MySQL2:"mysql2",Oracle:"oracledb",PostgreSQL:"pg",PgNative:"pgnative",Redshift:"pg-redshift",SQLite:"sqlite3",CockroachDB:"cockroachdb",BetterSQLite3:"better-sqlite3"});var $s={CLIENT_ALIASES:Cs,SUPPORTED_CLIENTS:Ns,POOL_CONFIG_OPTIONS:Object.freeze(["maxWaitingClients","testOnBorrow","fifo","priorityRange","autostart","evictionRunIntervalMillis","numTestsPerRun","softIdleTimeoutMillis","Promise"]),COMMA_NO_PAREN_REGEX:/,[\s](?![^(]*\))/g,DRIVER_NAMES:xs};const{CLIENT_ALIASES:As}=$s,{isFunction:Ts}=Gi;function Rs(e){let t=!1;if(tt.default(e))return!1;if(e&&Ts(e.toSQL))return t;if(Array.isArray(e))for(let r=0;r<e.length&&!t;r++)t=Rs(e[r]);else Ge.default(e)?Object.keys(e).forEach(r=>{t||(t=Rs(e[r]))}):t=void 0===e;return t}var Ss={addQueryContext:function(e){e.prototype.queryContext=function(e){return void 0===e?this._queryContext:(this._queryContext=e,this)}},containsUndefined:Rs,getUndefinedIndices:function(e){const t=[];return Array.isArray(e)?e.forEach((e,r)=>{Rs(e)&&t.push(r)}):Ge.default(e)?Object.keys(e).forEach(r=>{Rs(e[r])&&t.push(r)}):t.push(0),t},normalizeArr:function(...e){return Array.isArray(e[0])?e[0]:e},resolveClientNameWithAliases:function(e){return As[e]||e},toNumber:function(e,t){if(null==e)return t;const r=parseInt(e,10);return isNaN(r)?t:r}};function Os(e,t,r,n,i){if("function"==typeof r)return{type:"onWrapped",value:r,bool:t};switch(arguments.length){case 3:return{type:"onRaw",value:r,bool:t};case 4:return{type:e,column:r,operator:"=",value:n,bool:t};default:return{type:e,column:r,operator:n,value:i,bool:t}}}class Is{constructor(e,t,r){this.schema=r,this.table=e,this.joinType=t,this.and=this,this.clauses=[]}get or(){return this._bool("or")}on(e){if("object"==typeof e&&"function"!=typeof e.toSQL){const t=Object.keys(e);let r=-1;const n="or"===this._bool()?"orOn":"on";for(;++r<t.length;)this[n](t[r],e[t[r]]);return this}const t=Os("onBasic",this._bool(),...arguments);return t&&this.clauses.push(t),this}orOn(e,t,r){return this._bool("or").on.apply(this,arguments)}onJsonPathEquals(e,t,r,n){return this.clauses.push({type:"onJsonPathEquals",columnFirst:e,jsonPathFirst:t,columnSecond:r,jsonPathSecond:n,bool:this._bool(),not:this._not()}),this}orOnJsonPathEquals(e,t,r,n){return this._bool("or").onJsonPathEquals.apply(this,arguments)}using(e){return this.clauses.push({type:"onUsing",column:e,bool:this._bool()})}onVal(e){if("object"==typeof e&&"function"!=typeof e.toSQL){const t=Object.keys(e);let r=-1;const n="or"===this._bool()?"orOnVal":"onVal";for(;++r<t.length;)this[n](t[r],e[t[r]]);return this}const t=Os("onVal",this._bool(),...arguments);return t&&this.clauses.push(t),this}andOnVal(){return this.onVal(...arguments)}orOnVal(){return this._bool("or").onVal(...arguments)}onBetween(e,t){return We.default(Array.isArray(t),"The second argument to onBetween must be an array."),We.default(2===t.length,"You must specify 2 values for the onBetween clause"),this.clauses.push({type:"onBetween",column:e,value:t,bool:this._bool(),not:this._not()}),this}onNotBetween(e,t){return this._not(!0).onBetween(e,t)}orOnBetween(e,t){return this._bool("or").onBetween(e,t)}orOnNotBetween(e,t){return this._bool("or")._not(!0).onBetween(e,t)}onIn(e,t){return Array.isArray(t)&&0===t.length?this.on(1,"=",0):(this.clauses.push({type:"onIn",column:e,value:t,not:this._not(),bool:this._bool()}),this)}onNotIn(e,t){return this._not(!0).onIn(e,t)}orOnIn(e,t){return this._bool("or").onIn(e,t)}orOnNotIn(e,t){return this._bool("or")._not(!0).onIn(e,t)}onNull(e){return this.clauses.push({type:"onNull",column:e,not:this._not(),bool:this._bool()}),this}orOnNull(e){return this._bool("or").onNull(e)}onNotNull(e){return this._not(!0).onNull(e)}orOnNotNull(e){return this._not(!0)._bool("or").onNull(e)}onExists(e){return this.clauses.push({type:"onExists",value:e,not:this._not(),bool:this._bool()}),this}orOnExists(e){return this._bool("or").onExists(e)}onNotExists(e){return this._not(!0).onExists(e)}orOnNotExists(e){return this._not(!0)._bool("or").onExists(e)}type(e){return this.joinType=e,this}_bool(e){if(1===arguments.length)return this._boolFlag=e,this;const t=this._boolFlag||"and";return this._boolFlag="and",t}_not(e){if(1===arguments.length)return this._notFlag=e,this;const t=this._notFlag;return this._notFlag=!1,t}}Object.assign(Is.prototype,{grouping:"join"}),Is.prototype.andOn=Is.prototype.on,Is.prototype.andOnIn=Is.prototype.onIn,Is.prototype.andOnNotIn=Is.prototype.onNotIn,Is.prototype.andOnNull=Is.prototype.onNull,Is.prototype.andOnNotNull=Is.prototype.onNotNull,Is.prototype.andOnExists=Is.prototype.onExists,Is.prototype.andOnNotExists=Is.prototype.onNotExists,Is.prototype.andOnBetween=Is.prototype.onBetween,Is.prototype.andOnNotBetween=Is.prototype.onNotBetween,Is.prototype.andOnJsonPathEquals=Is.prototype.onJsonPathEquals;var js=Is,qs=function(e,t){e.client.config.asyncStackTraces&&(e._asyncStack={error:new Error,lines:t})};const{callbackify:ks}=Ce.default,{formatQuery:Ps}=Es;var Ls={augmentWithBuilderInterface:function(e){e.prototype.toQuery=function(e){let t=this.toSQL(this._method,e);return Array.isArray(t)||(t=[t]),t.length?t.map(t=>Ps(t.sql,t.bindings,e,this.client)).reduce((e,t)=>e.concat(e.endsWith(";")?"\n":";\n",t)):""},e.prototype.then=function(){let e=this.client.runner(this).run();return this.client.config.asyncStackTraces&&(e=e.catch(e=>{e.originalStack=e.stack;const t=e.stack.split("\n")[0],{error:r,lines:n}=this._asyncStack,i=r.stack.split("\n").slice(n);throw i.unshift(t),e.stack=i.join("\n"),e})),e.then.apply(e,arguments)},e.prototype.options=function(e){return this._options=this._options||[],this._options.push(Ve.default(e)||{}),this},e.prototype.connection=function(e){return this._connection=e,this.client.processPassedConnection(e),this},e.prototype.debug=function(e){return this._debug=!arguments.length||e,this},e.prototype.transacting=function(e){if(e&&e.client&&(e.client.transacting?this.client=e.client:e.client.logger.warn(`Invalid transaction value: ${e.client}`)),Ke.default(e))throw this.client.logger.error("Invalid value on transacting call, potential bug"),Error("Invalid transacting value (null, undefined or empty object)");return this},e.prototype.stream=function(e){return this.client.runner(this).stream(e)},e.prototype.pipe=function(e,t){return this.client.runner(this).pipe(e,t)},e.prototype.asCallback=function(e){const t=this.then();return ks(()=>t)(e),t},e.prototype.catch=function(e){return this.then().catch(e)},Object.defineProperty(e.prototype,Symbol.toStringTag,{get:()=>"object"}),ls(e.prototype)}};const{EventEmitter:Bs}=qe.default,{addQueryContext:Ms,normalizeArr:Us}=Ss,{isBoolean:Ds,isNumber:Fs,isObject:Qs,isString:Hs,isFunction:Ws}=Gi,{lockMode:Js,waitMode:Vs}={lockMode:{forShare:"forShare",forUpdate:"forUpdate",forNoKeyUpdate:"forNoKeyUpdate",forKeyShare:"forKeyShare"},waitMode:{skipLocked:"skipLocked",noWait:"noWait"}},{augmentWithBuilderInterface:zs}=Ls,Ks=new Set(["pluck","first","select"]),Gs=new Set(["with","select","columns","hintComments","where","union","join","group","order","having","limit","offset","counter","counters"]),Ys=new Set([Js.forShare,Js.forUpdate,Js.forNoKeyUpdate,Js.forKeyShare]);class Xs extends Bs{constructor(e){super(),this.client=e,this.and=this,this._single={},this._statements=[],this._method="select",e.config&&(qs(this,5),this._debug=e.config.debug),this._joinFlag="inner",this._boolFlag="and",this._notFlag=!1,this._asColumnFlag=!1}toString(){return this.toQuery()}toSQL(e,t){return this.client.queryCompiler(this).toSQL(e||this._method,t)}clone(){const e=new this.constructor(this.client);return e._method=this._method,e._single=Ve.default(this._single),e._statements=Ve.default(this._statements),e._debug=this._debug,void 0!==this._options&&(e._options=Ve.default(this._options)),void 0!==this._queryContext&&(e._queryContext=Ve.default(this._queryContext)),void 0!==this._connection&&(e._connection=this._connection),e}timeout(e,{cancel:t}={}){return Fs(e)&&e>0&&(this._timeout=e,t&&(this.client.assertCanCancelQuery(),this._cancelOnTimeout=!0)),this}isValidStatementArg(e){return"function"==typeof e||e instanceof Xs||e&&e.isRawInstance}_validateWithArgs(e,t,r,n){const[i,s]=void 0===r?[t,void 0]:[r,t];if("string"!=typeof e)throw new Error(`${n}() first argument must be a string`);if(!this.isValidStatementArg(i)||void 0!==s){if(!(Array.isArray(s)&&s.length>0&&s.every(e=>"string"==typeof e)))throw new Error(`${n}() second argument must be a statement or non-empty column name list.`);if(!this.isValidStatementArg(i))throw new Error(`${n}() third argument must be a function / QueryBuilder or a raw when its second argument is a column name list`)}}with(e,t,r){return this._validateWithArgs(e,t,r,"with"),this.withWrapped(e,t,r)}withMaterialized(e,t,r){throw new Error("With materialized is not supported by this dialect")}withNotMaterialized(e,t,r){throw new Error("With materialized is not supported by this dialect")}withWrapped(e,t,r,n){const[i,s]=void 0===r?[t,void 0]:[r,t],o={grouping:"with",type:"withWrapped",alias:e,columnList:s,value:i};return void 0!==n&&(o.materialized=n),this._statements.push(o),this}withRecursive(e,t,r){return this._validateWithArgs(e,t,r,"withRecursive"),this.withRecursiveWrapped(e,t,r)}withRecursiveWrapped(e,t,r){return this.withWrapped(e,t,r),this._statements[this._statements.length-1].recursive=!0,this}columns(e){return e||0===e?(this._statements.push({grouping:"columns",value:Us(...arguments)}),this):this}as(e){return this._single.as=e,this}hintComment(e){if((e=Array.isArray(e)?e:[e]).some(e=>!Hs(e)))throw new Error("Hint comment must be a string");if(e.some(e=>e.includes("/*")||e.includes("*/")))throw new Error('Hint comment cannot include "/*" or "*/"');if(e.some(e=>e.includes("?")))throw new Error('Hint comment cannot include "?"');return this._statements.push({grouping:"hintComments",value:e}),this}withSchema(e){return this._single.schema=e,this}table(e,t={}){return this._single.table=e,this._single.only=!0===t.only,this}distinct(...e){return this._statements.push({grouping:"columns",value:Us(...e),distinct:!0}),this}distinctOn(...e){if(Ke.default(e))throw new Error("distinctOn requires at least on argument");return this._statements.push({grouping:"columns",value:Us(...e),distinctOn:!0}),this}join(e,t,...r){let n;const i=e instanceof Xs||"function"==typeof e?void 0:this._single.schema,s=this._joinType();return"function"==typeof t?(n=new js(e,s,i),t.call(n,n)):"raw"===s?n=new js(this.client.raw(e,t),"raw"):(n=new js(e,s,i),t&&n.on(t,...r)),this._statements.push(n),this}using(e){throw new Error("'using' function is only available in PostgreSQL dialect with Delete statements.")}innerJoin(...e){return this._joinType("inner").join(...e)}leftJoin(...e){return this._joinType("left").join(...e)}leftOuterJoin(...e){return this._joinType("left outer").join(...e)}rightJoin(...e){return this._joinType("right").join(...e)}rightOuterJoin(...e){return this._joinType("right outer").join(...e)}outerJoin(...e){return this._joinType("outer").join(...e)}fullOuterJoin(...e){return this._joinType("full outer").join(...e)}crossJoin(...e){return this._joinType("cross").join(...e)}joinRaw(...e){return this._joinType("raw").join(...e)}get or(){return this._bool("or")}get not(){return this._not(!0)}where(e,t,r){const n=arguments.length;if(!1===e||!0===e)return this.where(1,"=",e?1:0);if("function"==typeof e)return this.whereWrapped(e);if(Qs(e)&&!e.isRawInstance)return this._objectWhere(e);if(e&&e.isRawInstance&&1===n)return this.whereRaw(e);if(2===n&&(r=t,t="=",null===r))return this.whereNull(e);const i=`${t}`.toLowerCase().trim();if(3===n){if("in"===i||"not in"===i)return this._not("not in"===i).whereIn(e,r);if("between"===i||"not between"===i)return this._not("not between"===i).whereBetween(e,r)}return null!==r||"is"!==i&&"is not"!==i?(this._statements.push({grouping:"where",type:"whereBasic",column:e,operator:t,value:r,not:this._not(),bool:this._bool(),asColumn:this._asColumnFlag}),this):this._not("is not"===i).whereNull(e)}whereColumn(...e){return this._asColumnFlag=!0,this.where(...e),this._asColumnFlag=!1,this}orWhere(e,...t){this._bool("or");const r=e;return Qs(r)&&!r.isRawInstance?this.whereWrapped(function(){for(const e in r)this.andWhere(e,r[e])}):this.where(e,...t)}orWhereColumn(e,...t){this._bool("or");const r=e;return Qs(r)&&!r.isRawInstance?this.whereWrapped(function(){for(const e in r)this.andWhereColumn(e,"=",r[e])}):this.whereColumn(e,...t)}whereNot(e,...t){return t.length>=2&&("in"!==t[0]&&"between"!==t[0]||this.client.logger.warn('whereNot is not suitable for "in" and "between" type subqueries. You should use "not in" and "not between" instead.')),this._not(!0).where(e,...t)}whereNotColumn(...e){return this._not(!0).whereColumn(...e)}orWhereNot(...e){return this._bool("or").whereNot(...e)}orWhereNotColumn(...e){return this._bool("or").whereNotColumn(...e)}_objectWhere(e){const t=this._bool(),r=this._not()?"Not":"";for(const n in e)this[t+"Where"+r](n,e[n]);return this}whereRaw(e,t){const r=e.isRawInstance?e:this.client.raw(e,t);return this._statements.push({grouping:"where",type:"whereRaw",value:r,not:this._not(),bool:this._bool()}),this}orWhereRaw(e,t){return this._bool("or").whereRaw(e,t)}whereWrapped(e){return this._statements.push({grouping:"where",type:"whereWrapped",value:e,not:this._not(),bool:this._bool()}),this}whereExists(e){return this._statements.push({grouping:"where",type:"whereExists",value:e,not:this._not(),bool:this._bool()}),this}orWhereExists(e){return this._bool("or").whereExists(e)}whereNotExists(e){return this._not(!0).whereExists(e)}orWhereNotExists(e){return this._bool("or").whereNotExists(e)}whereIn(e,t){return Array.isArray(t)&&Ke.default(t)?this.where(this._not()):(this._statements.push({grouping:"where",type:"whereIn",column:e,value:t,not:this._not(),bool:this._bool()}),this)}orWhereIn(e,t){return this._bool("or").whereIn(e,t)}whereNotIn(e,t){return this._not(!0).whereIn(e,t)}orWhereNotIn(e,t){return this._bool("or")._not(!0).whereIn(e,t)}whereNull(e){return this._statements.push({grouping:"where",type:"whereNull",column:e,not:this._not(),bool:this._bool()}),this}orWhereNull(e){return this._bool("or").whereNull(e)}whereNotNull(e){return this._not(!0).whereNull(e)}orWhereNotNull(e){return this._bool("or").whereNotNull(e)}whereBetween(e,t){return We.default(Array.isArray(t),"The second argument to whereBetween must be an array."),We.default(2===t.length,"You must specify 2 values for the whereBetween clause"),this._statements.push({grouping:"where",type:"whereBetween",column:e,value:t,not:this._not(),bool:this._bool()}),this}whereNotBetween(e,t){return this._not(!0).whereBetween(e,t)}orWhereBetween(e,t){return this._bool("or").whereBetween(e,t)}orWhereNotBetween(e,t){return this._bool("or").whereNotBetween(e,t)}_whereLike(e,t,r){return this._statements.push({grouping:"where",type:e,column:t,value:r,not:this._not(),bool:this._bool(),asColumn:this._asColumnFlag}),this}whereLike(e,t){return this._whereLike("whereLike",e,t)}orWhereLike(e,t){return this._bool("or")._whereLike("whereLike",e,t)}whereILike(e,t){return this._whereLike("whereILike",e,t)}orWhereILike(e,t){return this._bool("or")._whereLike("whereILike",e,t)}groupBy(e){return e&&e.isRawInstance?this.groupByRaw.apply(this,arguments):(this._statements.push({grouping:"group",type:"groupByBasic",value:Us(...arguments)}),this)}groupByRaw(e,t){const r=e.isRawInstance?e:this.client.raw(e,t);return this._statements.push({grouping:"group",type:"groupByRaw",value:r}),this}orderBy(e,t,r=""){return Array.isArray(e)?this._orderByArray(e):(this._statements.push({grouping:"order",type:"orderByBasic",value:e,direction:t,nulls:r}),this)}_orderByArray(e){for(let t=0;t<e.length;t++){const r=e[t];Qs(r)?this._statements.push({grouping:"order",type:"orderByBasic",value:r.column,direction:r.order,nulls:r.nulls}):Hs(r)&&this._statements.push({grouping:"order",type:"orderByBasic",value:r})}return this}orderByRaw(e,t){const r=e.isRawInstance?e:this.client.raw(e,t);return this._statements.push({grouping:"order",type:"orderByRaw",value:r}),this}_union(e,t){let r=t[0],n=t[1];if(1===t.length||2===t.length&&Ds(n)){Array.isArray(r)||(r=[r]);for(let t=0,i=r.length;t<i;t++)this._statements.push({grouping:"union",clause:e,value:r[t],wrap:n||!1})}else r=et.default(t).slice(0,t.length-1),n=t[t.length-1],Ds(n)||(r.push(n),n=!1),this._union(e,[r,n]);return this}union(...e){return this._union("union",e)}unionAll(...e){return this._union("union all",e)}intersect(e,t){if(1===arguments.length||2===arguments.length&&Ds(t)){Array.isArray(e)||(e=[e]);for(let r=0,n=e.length;r<n;r++)this._statements.push({grouping:"union",clause:"intersect",value:e[r],wrap:t||!1})}else e=et.default(arguments).slice(0,arguments.length-1),Ds(t=arguments[arguments.length-1])||(e.push(t),t=!1),this.intersect(e,t);return this}having(e,t,r){return e.isRawInstance&&1===arguments.length?this.havingRaw(e):"function"==typeof e?this.havingWrapped(e):(this._statements.push({grouping:"having",type:"havingBasic",column:e,operator:t,value:r,bool:this._bool(),not:this._not()}),this)}orHaving(e,...t){this._bool("or");const r=e;return Qs(r)&&!r.isRawInstance?this.havingWrapped(function(){for(const e in r)this.andHaving(e,r[e])}):this.having(e,...t)}havingWrapped(e){return this._statements.push({grouping:"having",type:"havingWrapped",value:e,bool:this._bool(),not:this._not()}),this}havingNull(e){return this._statements.push({grouping:"having",type:"havingNull",column:e,not:this._not(),bool:this._bool()}),this}orHavingNull(e){return this._bool("or").havingNull(e)}havingNotNull(e){return this._not(!0).havingNull(e)}orHavingNotNull(e){return this._not(!0)._bool("or").havingNull(e)}havingExists(e){return this._statements.push({grouping:"having",type:"havingExists",value:e,not:this._not(),bool:this._bool()}),this}orHavingExists(e){return this._bool("or").havingExists(e)}havingNotExists(e){return this._not(!0).havingExists(e)}orHavingNotExists(e){return this._not(!0)._bool("or").havingExists(e)}havingBetween(e,t){return We.default(Array.isArray(t),"The second argument to havingBetween must be an array."),We.default(2===t.length,"You must specify 2 values for the havingBetween clause"),this._statements.push({grouping:"having",type:"havingBetween",column:e,value:t,not:this._not(),bool:this._bool()}),this}orHavingBetween(e,t){return this._bool("or").havingBetween(e,t)}havingNotBetween(e,t){return this._not(!0).havingBetween(e,t)}orHavingNotBetween(e,t){return this._not(!0)._bool("or").havingBetween(e,t)}havingIn(e,t){return Array.isArray(t)&&Ke.default(t)?this.where(this._not()):(this._statements.push({grouping:"having",type:"havingIn",column:e,value:t,not:this._not(),bool:this._bool()}),this)}orHavingIn(e,t){return this._bool("or").havingIn(e,t)}havingNotIn(e,t){return this._not(!0).havingIn(e,t)}orHavingNotIn(e,t){return this._bool("or")._not(!0).havingIn(e,t)}havingRaw(e,t){const r=e.isRawInstance?e:this.client.raw(e,t);return this._statements.push({grouping:"having",type:"havingRaw",value:r,bool:this._bool(),not:this._not()}),this}orHavingRaw(e,t){return this._bool("or").havingRaw(e,t)}_setSkipBinding(e,t){let r=t;Qs(t)&&(r=t.skipBinding),this._single.skipBinding=this._single.skipBinding||{},this._single.skipBinding[e]=r}offset(e,t){if(null==e||e.isRawInstance||e instanceof Xs)this._single.offset=e;else{const t=parseInt(e,10);if(isNaN(t))this.client.logger.warn("A valid integer must be provided to offset");else{if(t<0)throw new Error("A non-negative integer must be provided to offset.");this._single.offset=t}}return this._setSkipBinding("offset",t),this}limit(e,t){const r=parseInt(e,10);return isNaN(r)?this.client.logger.warn("A valid integer must be provided to limit"):(this._single.limit=r,this._setSkipBinding("limit",t)),this}count(e,t){return this._aggregate("count",e||"*",t)}min(e,t){return this._aggregate("min",e,t)}max(e,t){return this._aggregate("max",e,t)}sum(e,t){return this._aggregate("sum",e,t)}avg(e,t){return this._aggregate("avg",e,t)}countDistinct(...e){let t;return e.length>1&&Ge.default(Ye.default(e))&&([t]=e.splice(e.length-1,1)),e.length?1===e.length&&(e=e[0]):e="*",this._aggregate("count",e,{...t,distinct:!0})}sumDistinct(e,t){return this._aggregate("sum",e,{...t,distinct:!0})}avgDistinct(e,t){return this._aggregate("avg",e,{...t,distinct:!0})}increment(e,t=1){if(Qs(e)){for(const t in e)this._counter(t,e[t]);return this}return this._counter(e,t)}decrement(e,t=1){if(Qs(e)){for(const t in e)this._counter(t,-e[t]);return this}return this._counter(e,-t)}clearCounters(){return this._single.counter={},this}first(...e){if(this._method&&"select"!==this._method)throw new Error(`Cannot chain .first() on "${this._method}" query`);return this.select(Us(...e)),this._method="first",this.limit(1),this}connection(e){return this._connection=e,this.client.processPassedConnection(e),this}pluck(e){if(this._method&&"select"!==this._method)throw new Error(`Cannot chain .pluck() on "${this._method}" query`);return this._method="pluck",this._single.pluck=e,this._statements.push({grouping:"columns",type:"pluck",value:e}),this}clearSelect(){return this._clearGrouping("columns"),this}clearWhere(){return this._clearGrouping("where"),this}clearGroup(){return this._clearGrouping("group"),this}clearOrder(){return this._clearGrouping("order"),this}clearHaving(){return this._clearGrouping("having"),this}clear(e){if(!Gs.has(e))throw new Error(`Knex Error: unknown statement '${e}'`);return e.startsWith("counter")?this.clearCounters():("select"===e&&(e="columns"),this._clearGrouping(e),this)}insert(e,t,r){return this._method="insert",Ke.default(t)||this.returning(t,r),this._single.insert=e,this}update(e,t,r){let n;const i=this._single.update||{};if(this._method="update",Hs(e))i[e]=Ge.default(t)?JSON.stringify(t):t,arguments.length>2&&(n=arguments[2]);else{const t=Object.keys(e);this._single.update&&this.client.logger.warn("Update called multiple times with objects.");let r=-1;for(;++r<t.length;)i[t[r]]=e[t[r]];n=arguments[1]}return Ke.default(n)||this.returning(n,r),this._single.update=i,this}returning(e,t){return this._single.returning=e,this._single.options=t,this}onConflict(e){return"string"==typeof e&&(e=[e]),new Zs(this,e||!0)}delete(e,t){return this._method="del",Ke.default(e)||this.returning(e,t),this}truncate(e){return this._method="truncate",e&&(this._single.table=e),this}columnInfo(e){return this._method="columnInfo",this._single.columnInfo=e,this}forUpdate(...e){return this._single.lock=Js.forUpdate,this._single.lockTables=1===e.length&&Array.isArray(e[0])?e[0]:e,this}forShare(...e){return this._single.lock=Js.forShare,this._single.lockTables=e,this}forNoKeyUpdate(...e){return this._single.lock=Js.forNoKeyUpdate,this._single.lockTables=e,this}forKeyShare(...e){return this._single.lock=Js.forKeyShare,this._single.lockTables=e,this}skipLocked(){if(!this._isSelectQuery())throw new Error(`Cannot chain .skipLocked() on "${this._method}" query!`);if(!this._hasLockMode())throw new Error(".skipLocked() can only be used after a call to .forShare() or .forUpdate()!");if(this._single.waitMode===Vs.noWait)throw new Error(".skipLocked() cannot be used together with .noWait()!");return this._single.waitMode=Vs.skipLocked,this}noWait(){if(!this._isSelectQuery())throw new Error(`Cannot chain .noWait() on "${this._method}" query!`);if(!this._hasLockMode())throw new Error(".noWait() can only be used after a call to .forShare() or .forUpdate()!");if(this._single.waitMode===Vs.skipLocked)throw new Error(".noWait() cannot be used together with .skipLocked()!");return this._single.waitMode=Vs.noWait,this}fromJS(e){return ze.default(e,(e,t)=>{"function"!=typeof this[t]&&this.client.logger.warn(`Knex Error: unknown key ${t}`),Array.isArray(e)?this[t].apply(this,e):this[t](e)}),this}fromRaw(e,t){const r=e.isRawInstance?e:this.client.raw(e,t);return this.from(r)}modify(e){return e.apply(this,[this].concat(Ze.default(arguments))),this}upsert(e,t,r){throw new Error(`Upsert is not yet supported for dialect ${this.client.dialect}`)}_json(e,t){return this._statements.push({grouping:"columns",type:"json",method:e,params:t}),this}jsonExtract(){const e=arguments[0];let t,r,n=!0;return arguments.length>=2&&(t=arguments[1]),arguments.length>=3&&(r=arguments[2]),4===arguments.length&&(n=arguments[3]),2===arguments.length&&Array.isArray(arguments[0])&&Ds(arguments[1])&&(n=arguments[1]),this._json("jsonExtract",{column:e,path:t,alias:r,singleValue:n})}jsonSet(e,t,r,n){return this._json("jsonSet",{column:e,path:t,value:r,alias:n})}jsonInsert(e,t,r,n){return this._json("jsonInsert",{column:e,path:t,value:r,alias:n})}jsonRemove(e,t,r){return this._json("jsonRemove",{column:e,path:t,alias:r})}_isJsonObject(e){return Qs(e)&&!(e instanceof Xs)}_whereJsonWrappedValue(e,t,r){const n={grouping:"where",type:e,column:t,value:r,not:this._not(),bool:this._bool(),asColumn:this._asColumnFlag};arguments[3]&&(n.operator=arguments[3]),arguments[4]&&(n.jsonPath=arguments[4]),this._statements.push(n)}whereJsonObject(e,t){return this._whereJsonWrappedValue("whereJsonObject",e,t),this}orWhereJsonObject(e,t,r){return this._bool("or").whereJsonObject(e,t,r)}whereNotJsonObject(e,t){return this._not(!0)._whereJsonWrappedValue("whereJsonObject",e,t),this}orWhereNotJsonObject(e,t,r){return this._not(!0)._bool("or").whereJsonObject(e,t,r)}whereJsonPath(e,t,r,n){return this._whereJsonWrappedValue("whereJsonPath",e,n,r,t),this}orWhereJsonPath(e,t,r,n){return this._bool("or").whereJsonPath(e,t,r,n)}whereJsonSupersetOf(e,t){return this._whereJsonWrappedValue("whereJsonSupersetOf",e,t),this}whereJsonNotSupersetOf(e,t){return this._not(!0).whereJsonSupersetOf(e,t),this}orWhereJsonSupersetOf(e,t){return this._whereJsonWrappedValue("whereJsonSupersetOf",e,t),this}orWhereJsonNotSupersetOf(e,t){return this._not(!0)._bool("or").whereJsonSupersetOf(e,t),this}whereJsonSubsetOf(e,t){return this._whereJsonWrappedValue("whereJsonSubsetOf",e,t),this}whereJsonNotSubsetOf(e,t){return this._not(!0).whereJsonSubsetOf(e,t),this}orWhereJsonSubsetOf(e,t){return this._whereJsonWrappedValue("whereJsonSubsetOf",e,t),this}orWhereJsonNotSubsetOf(e,t){return this._not(!0)._bool("or").whereJsonSubsetOf(e,t),this}whereJsonHasNone(e,t){return this._not(!0).whereJsonHasAll(e,t),this}_analytic(e,t,r){let n;const{schema:i}=this._single,s=this._analyticMethod();if(e="string"==typeof e?e:null,We.default("function"==typeof t||t.isRawInstance||Array.isArray(t)||"string"==typeof t||"object"==typeof t,"The second argument to an analytic function must be either a function, a raw,\n       an array of string or object, an object or a single string."),r&&We.default(Array.isArray(r)||"string"==typeof r||"object"==typeof r,"The third argument to an analytic function must be either a string, an array of string or object or an object."),Ws(t))n=new class{constructor(e,t,r,n,i){this.schema=t,this.type="analytic",this.method=e,this.order=n||[],this.partitions=i||[],this.alias=r,this.and=this,this.grouping="columns"}partitionBy(e,t){return We.default(Array.isArray(e)||"string"==typeof e,"The argument to an analytic partitionBy function must be either a string\n            or an array of string."),Array.isArray(e)?this.partitions=this.partitions.concat(e):this.partitions.push({column:e,order:t}),this}orderBy(e,t){return We.default(Array.isArray(e)||"string"==typeof e,"The argument to an analytic orderBy function must be either a string\n            or an array of string."),Array.isArray(e)?this.order=this.order.concat(e):this.order.push({column:e,order:t}),this}}(s,i,e),t.call(n,n);else if(t.isRawInstance)n={grouping:"columns",type:"analytic",method:s,raw:t,alias:e};else{const i=Array.isArray(t)?t:[t];let o=r||[];o=Array.isArray(o)?o:[o],n={grouping:"columns",type:"analytic",method:s,order:i,alias:e,partitions:o}}return this._statements.push(n),this}rank(...e){return this._analyticMethod("rank")._analytic(...e)}denseRank(...e){return this._analyticMethod("dense_rank")._analytic(...e)}rowNumber(...e){return this._analyticMethod("row_number")._analytic(...e)}_counter(e,t){return t=parseFloat(t),this._method="update",this._single.counter=this._single.counter||{},this._single.counter[e]=t,this}_bool(e){if(1===arguments.length)return this._boolFlag=e,this;const t=this._boolFlag;return this._boolFlag="and",t}_not(e){if(1===arguments.length)return this._notFlag=e,this;const t=this._notFlag;return this._notFlag=!1,t}_joinType(e){if(1===arguments.length)return this._joinFlag=e,this;const t=this._joinFlag||"inner";return this._joinFlag="inner",t}_analyticMethod(e){return 1===arguments.length?(this._analyticFlag=e,this):this._analyticFlag||"row_number"}_aggregate(e,t,r={}){return this._statements.push({grouping:"columns",type:t.isRawInstance?"aggregateRaw":"aggregate",method:e,value:t,aggregateDistinct:r.distinct||!1,alias:r.as}),this}_clearGrouping(e){e in this._single?this._single[e]=void 0:this._statements=Xe.default(this._statements,{grouping:e})}_isSelectQuery(){return Ks.has(this._method)}_hasLockMode(){return Ys.has(this._single.lock)}}Xs.prototype.select=Xs.prototype.columns,Xs.prototype.column=Xs.prototype.columns,Xs.prototype.andWhereNot=Xs.prototype.whereNot,Xs.prototype.andWhereNotColumn=Xs.prototype.whereNotColumn,Xs.prototype.andWhere=Xs.prototype.where,Xs.prototype.andWhereColumn=Xs.prototype.whereColumn,Xs.prototype.andWhereRaw=Xs.prototype.whereRaw,Xs.prototype.andWhereBetween=Xs.prototype.whereBetween,Xs.prototype.andWhereNotBetween=Xs.prototype.whereNotBetween,Xs.prototype.andWhereJsonObject=Xs.prototype.whereJsonObject,Xs.prototype.andWhereNotJsonObject=Xs.prototype.whereJsonObject,Xs.prototype.andWhereJsonPath=Xs.prototype.whereJsonPath,Xs.prototype.andWhereLike=Xs.prototype.whereLike,Xs.prototype.andWhereILike=Xs.prototype.whereILike,Xs.prototype.andHaving=Xs.prototype.having,Xs.prototype.andHavingIn=Xs.prototype.havingIn,Xs.prototype.andHavingNotIn=Xs.prototype.havingNotIn,Xs.prototype.andHavingNull=Xs.prototype.havingNull,Xs.prototype.andHavingNotNull=Xs.prototype.havingNotNull,Xs.prototype.andHavingExists=Xs.prototype.havingExists,Xs.prototype.andHavingNotExists=Xs.prototype.havingNotExists,Xs.prototype.andHavingBetween=Xs.prototype.havingBetween,Xs.prototype.andHavingNotBetween=Xs.prototype.havingNotBetween,Xs.prototype.from=Xs.prototype.table,Xs.prototype.into=Xs.prototype.table,Xs.prototype.del=Xs.prototype.delete,zs(Xs),Ms(Xs),Xs.extend=(e,t)=>{if(Object.prototype.hasOwnProperty.call(Xs.prototype,e))throw new Error(`Can't extend QueryBuilder with existing method ('${e}').`);Je.default(Xs.prototype,{[e]:t})};class Zs{constructor(e,t){this.builder=e,this._columns=t}ignore(){return this.builder._single.onConflict=this._columns,this.builder._single.ignore=!0,this.builder}merge(e){return this.builder._single.onConflict=this._columns,this.builder._single.merge={updates:e},this.builder}then(){throw new Error("Incomplete onConflict clause. .onConflict() must be directly followed by either .merge() or .ignore()")}}var eo=Xs;const{isObject:to}=Gi;var ro={compileCallback:function(e,t,r,n){const i=r.queryBuilder();return e.call(i,i),r.queryCompiler(i,n.bindings).toSQL(t||i._method||"select")},wrapAsIdentifier:function(e,t,r){const n=t.queryContext();return r.wrapIdentifier((e||"").trim(),n)},formatDefault:function(e,t,r){return void 0===e?"":null===e?"null":e&&e.isRawInstance?e.toQuery():"bool"===t?("false"===e&&(e=0),`'${e?1:0}'`):"json"!==t&&"jsonb"!==t||!to(e)?r._escapeBinding(e.toString()):`'${JSON.stringify(e)}'`}};const{compileCallback:no,wrapAsIdentifier:io}=ro,so=["asc","desc"],oo=nt.default(["=","<",">","<=",">=","<>","!=","like","not like","between","not between","ilike","not ilike","exists","not exist","rlike","not rlike","regexp","not regexp","match","&","|","^","<<",">>","~","~=","~*","!~","!~*","#","&&","@>","<@","||","&<","&>","-|-","@@","!!",["?","\\?"],["?|","\\?|"],["?&","\\?&"]],(e,t)=>{Array.isArray(t)?e[t[0]]=t[1]:e[t]=t},{});function ao(e,t,r,n,i){const s=lo(e,t,r,n,i);if(s)return s;switch(typeof e){case"function":return co(no(e,void 0,n,i),!0,r,n);case"object":return function(e,t,r,n){const i=[];for(const s in e){const o=e[s];if("function"==typeof o){const e=no(o,void 0,r,n);e.as=s,i.push(co(e,!0,t,r))}else i.push(r.alias(o instanceof eo?`(${ao(o,void 0,t,r,n)})`:ao(o,void 0,t,r,n),io(s,t,r)))}return i.join(", ")}(e,r,n,i);case"number":return e;default:return uo(e+"",r,n)}}function lo(e,t,r,n,i){let s;return e instanceof eo?(s=n.queryCompiler(e).toSQL(),s.bindings&&i.bindings.push(...s.bindings),co(s,t,r,n)):e&&e.isRawInstance?(e.client=n,r._queryContext&&(e.queryContext=()=>r._queryContext),s=e.toSQL(),s.bindings&&i.bindings.push(...s.bindings),s.sql):void(t&&i.bindings.push(e))}function uo(e,t,r){const n=e.toLowerCase().indexOf(" as ");if(-1!==n){const i=e.slice(0,n),s=e.slice(n+4);return r.alias(uo(i,t,r),io(s,t,r))}const i=[];let s=-1;const o=e.split(".");for(;++s<o.length;)e=o[s],i.push(0===s&&o.length>1?uo((e||"").trim(),t,r):io(e,t,r));return i.join(".")}function co(e,t,r,n){let i=e.sql||"";return i&&("select"===e.method||"first"===e.method)&&(t||e.as)&&(i=`(${i})`,e.as)?n.alias(i,uo(e.as,r,n)):i}var ho={columnize:function(e,t,r,n){const i=Array.isArray(e)?e:[e];let s="",o=-1;for(;++o<i.length;)o>0&&(s+=", "),s+=ao(i[o],void 0,t,r,n);return s},direction:function(e,t,r,n){return lo(e,void 0,t,r,n)||(-1!==so.indexOf((e||"").toLowerCase())?e:"asc")},operator:function(e,t,r,n){const i=lo(e,void 0,t,r,n);if(i)return i;const s=oo[(e||"").toLowerCase()];if(!s)throw new TypeError(`The operator "${e}" is not permitted`);return s},outputQuery:co,rawOrFn:function(e,t,r,n,i){return"function"==typeof e?co(no(e,t,n,i),void 0,r,n):lo(e,void 0,r,n,i)||""},unwrapRaw:lo,wrap:ao,wrapString:uo};const{columnize:po}=ho;var mo={replaceKeyBindings:function(e,t){const r={bindings:[]},n=e,i=e.bindings;return{method:"raw",sql:e.sql.replace(/\\?(:(\w+):(?=::)|:(\w+):(?!:)|:(\w+))/g,function(e,s,o,a,l){if(e!==s)return s;const u=o||a||l,c=e.trim(),h=":"===c[c.length-1],d=i[u];return void 0===d?(Object.prototype.hasOwnProperty.call(i,u)&&r.bindings.push(d),e):e.replace(s,h?po(d,n,t,r):t.parameter(d,n,r))}),bindings:r.bindings}},replaceRawArrBindings:function(e,t){const r={bindings:[]},n=e,i=e.bindings.length,s=e.bindings;let o=0;const a=e.sql.replace(/\\?\?\??/g,function(e){if("\\?"===e)return e;const i=s[o++];return"??"===e?po(i,n,t,r):t.parameter(i,n,r)});if(i!==o)throw new Error(`Expected ${i} bindings, saw ${o}`);return{method:"raw",sql:a,bindings:r.bindings}}},fo={nanoid:function(e=21){let t="",r=e;for(;r--;)t+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[64*Math.random()|0];return t},nanonum:function(e=21){let t="",r=e;for(;r--;)t+="0123456789"[10*Math.random()|0];return t}};const{EventEmitter:go}=qe.default,{replaceRawArrBindings:yo,replaceKeyBindings:bo}=mo,{nanoid:wo}=fo,{isNumber:vo,isObject:_o}=Gi,{augmentWithBuilderInterface:Eo}=Ls,Co=Vi("knex:bindings");class No extends go{constructor(e){super(),this.client=e,this.sql="",this.bindings=[],this._wrappedBefore=void 0,this._wrappedAfter=void 0,e&&e.config&&(this._debug=e.config.debug,qs(this,4))}set(e,t){return this.sql=e,this.bindings=_o(t)&&!t.toSQL||void 0===t?t:[t],this}timeout(e,{cancel:t}={}){return vo(e)&&e>0&&(this._timeout=e,t&&(this.client.assertCanCancelQuery(),this._cancelOnTimeout=!0)),this}wrap(e,t){return this._wrappedBefore=e,this._wrappedAfter=t,this}toString(){return this.toQuery()}toSQL(e,t){let r;if(r=Array.isArray(this.bindings)?yo(this,this.client):this.bindings&&Ge.default(this.bindings)?bo(this,this.client):{method:"raw",sql:this.sql,bindings:void 0===this.bindings?[]:[this.bindings]},this._wrappedBefore&&(r.sql=this._wrappedBefore+r.sql),this._wrappedAfter&&(r.sql=r.sql+this._wrappedAfter),r.options=rt.default(this._options,Je.default,{}),this._timeout&&(r.timeout=this._timeout,this._cancelOnTimeout&&(r.cancelOnTimeout=this._cancelOnTimeout)),r.bindings=r.bindings||[],Ss.containsUndefined(r.bindings)){const e=Ss.getUndefinedIndices(this.bindings);throw Co(r.bindings),new Error(`Undefined binding(s) detected for keys [${e}] when compiling RAW query: ${r.sql}`)}return r.__knexQueryUid=wo(),Object.defineProperties(r,{toNative:{value:()=>({sql:this.client.positionBindings(r.sql),bindings:this.client.prepBindings(r.bindings)}),enumerable:!1}}),r}}No.prototype.isRawInstance=!0,Eo(No),Ss.addQueryContext(No);var xo=No;const{nanoid:$o}=fo,{isString:Ao,isUndefined:To}=Gi,{columnize:Ro,direction:So,operator:Oo,wrap:Io,unwrapRaw:jo,rawOrFn:qo}=ho,ko=Vi("knex:bindings"),Po=["columns","join","where","union","group","having","order","limit","offset","lock","waitMode"];var Lo=class{constructor(e,t,r){this.client=e,this.method=t._method||"select",this.options=t._options,this.single=t._single,this.timeout=t._timeout||!1,this.cancelOnTimeout=t._cancelOnTimeout||!1,this.grouped=st.default(t._statements,"grouping"),this.formatter=e.formatter(t),this._emptyInsertValue="default values",this.first=this.select,this.bindings=r||[],this.formatter.bindings=this.bindings,this.bindingsHolder=this,this.builder=this.formatter.builder}toSQL(e,t){this._undefinedInWhereClause=!1,this.undefinedBindingsInfo=[];const r=this[e=e||this.method]()||"",n={method:e,options:rt.default(this.options,Je.default,{}),timeout:this.timeout,cancelOnTimeout:this.cancelOnTimeout,bindings:this.bindingsHolder.bindings||[],__knexQueryUid:$o()};if(Object.defineProperties(n,{toNative:{value:()=>({sql:this.client.positionBindings(n.sql),bindings:this.client.prepBindings(n.bindings)}),enumerable:!1}}),Ao(r)?n.sql=r:Je.default(n,r),"select"!==e&&"first"!==e||this.single.as&&(n.as=this.single.as),this._undefinedInWhereClause)throw ko(n.bindings),new Error(`Undefined binding(s) detected when compiling ${e.toUpperCase()}. Undefined column(s): [${this.undefinedBindingsInfo.join(", ")}] query: ${n.sql}`);return n}select(){let e=this.with(),t="";const r=[],n=[];Po.forEach(e=>{const i=this[e](this);switch(e){case"union":t=i;break;case"columns":case"join":case"where":r.push(i);break;default:n.push(i)}});const i=this.grouped.union&&this.grouped.union.map(e=>e.wrap).some(e=>e);if(this.onlyUnions()){const i=it.default(r.concat(n)).join(" ");e+=t+(i?" "+i:"")}else{const s=(i?"(":"")+it.default(r).join(" ")+(i?")":""),o=it.default(n).join(" ");e+=s+(t?" "+t:"")+(o?" "+o:o)}return e}pluck(){let e=this.single.pluck;return-1!==e.indexOf(".")&&(e=e.split(".").slice(-1)[0]),{sql:this.select(),pluck:e}}insert(){const e=this.single.insert||[],t=this.with()+`insert into ${this.tableName} `,r=this._insertBody(e);return""===r?"":t+r}_onConflictClause(e){return e instanceof xo?this.formatter.wrap(e):`(${this.formatter.columnize(e)})`}_buildInsertValues(e){let t="",r=-1;for(;++r<e.values.length;)0!==r&&(t+="), ("),t+=this.client.parameterize(e.values[r],this.client.valueForUndefined,this.builder,this.bindingsHolder);return t}_insertBody(e){let t="";if(Array.isArray(e)){if(0===e.length)return""}else if("object"==typeof e&&Ke.default(e))return t+this._emptyInsertValue;const r=this._prepInsert(e);return"string"==typeof r?t+=r:r.columns.length?(t+=`(${Ro(r.columns,this.builder,this.client,this.bindingsHolder)}`,t+=") values ("+this._buildInsertValues(r)+")"):1===e.length&&e[0]?t+=this._emptyInsertValue:t="",t}update(){const e=this.with(),{tableName:t}=this,r=this._prepUpdate(this.single.update),n=this.where();return e+`update ${this.single.only?"only ":""}${t} set `+r.join(", ")+(n?` ${n}`:"")}_hintComments(){let e=this.grouped.hintComments||[];return e=e.map(e=>it.default(e.value).join(" ")),e=it.default(e).join(" "),e?`/*+ ${e} */ `:""}columns(){let e="";if(this.onlyUnions())return"";const t=this._hintComments(),r=this.grouped.columns||[];let n=-1,i=[];if(r)for(;++n<r.length;){const t=r[n];t.distinct&&(e="distinct "),t.distinctOn?e=this.distinctOn(t.value):"aggregate"===t.type?i.push(...this.aggregate(t)):"aggregateRaw"===t.type?i.push(this.aggregateRaw(t)):"analytic"===t.type?i.push(this.analytic(t)):"json"===t.type?i.push(this.json(t)):t.value&&t.value.length>0&&i.push(Ro(t.value,this.builder,this.client,this.bindingsHolder))}return 0===i.length&&(i=["*"]),`${this.onlyJson()?"":"select "}${t}${e}`+i.join(", ")+(this.tableName?` from ${this.single.only?"only ":""}${this.tableName}`:"")}_aggregate(e,{aliasSeparator:t=" as ",distinctParentheses:r}={}){const n=e.value,i=e.method,s=e.aggregateDistinct?"distinct ":"",o=e=>Io(e,void 0,this.builder,this.client,this.bindingsHolder),a=(e,r)=>r?e+t+o(r):e,l=(e,t)=>{let n=e.map(o).join(", ");if(s){const e=r?"(":" ",t=r?")":"";n=s.trim()+e+n+t}return a(`${i}(${n})`,t)},u=(e,t)=>{const r=`${i}(${s+o(e)})`;return a(r,t)};if(Array.isArray(n))return[l(n)];if("object"==typeof n){if(e.alias)throw new Error("When using an object explicit alias can not be used");return Object.entries(n).map(([e,t])=>Array.isArray(t)?l(t,e):u(t,e))}const c=n.toLowerCase().indexOf(" as ");let h=n,{alias:d}=e;if(-1!==c){if(h=n.slice(0,c),d)throw new Error(`Found multiple aliases for same column: ${h}`);d=n.slice(c+4)}return[u(h,d)]}aggregate(e){return this._aggregate(e)}aggregateRaw(e){return`${e.method}(${(e.aggregateDistinct?"distinct ":"")+jo(e.value,void 0,this.builder,this.client,this.bindingsHolder)})`}_joinTable(e){return!e.schema||e.table instanceof xo?e.table:`${e.schema}.${e.table}`}join(){let e="",t=-1;const r=this.grouped.join;if(!r)return"";for(;++t<r.length;){const n=r[t],i=this._joinTable(n);if(t>0&&(e+=" "),"raw"===n.joinType)e+=jo(n.table,void 0,this.builder,this.client,this.bindingsHolder);else{e+=n.joinType+" join "+Io(i,void 0,this.builder,this.client,this.bindingsHolder);let t=-1;for(;++t<n.clauses.length;){const r=n.clauses[t];e+=t>0?` ${r.bool} `:` ${"onUsing"===r.type?"using":"on"} `;const i=this[r.type](r);i&&(e+=i)}}}return e}onBetween(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+this._not(e,"between")+" "+e.value.map(e=>this.client.parameter(e,this.builder,this.bindingsHolder)).join(" and ")}onNull(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" is "+this._not(e,"null")}onExists(e){return this._not(e,"exists")+" ("+qo(e.value,void 0,this.builder,this.client,this.bindingsHolder)+")"}onIn(e){if(Array.isArray(e.column))return this.multiOnIn(e);let t;return t=e.value instanceof xo?this.client.parameter(e.value,this.builder,this.formatter):this.client.parameterize(e.value,void 0,this.builder,this.bindingsHolder),Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+this._not(e,"in ")+this.wrap(t)}multiOnIn(e){let t=-1,r=`(${Ro(e.column,this.builder,this.client,this.bindingsHolder)}) `;for(r+=this._not(e,"in ")+"((";++t<e.value.length;)0!==t&&(r+="),("),r+=this.client.parameterize(e.value[t],void 0,this.builder,this.bindingsHolder);return r+"))"}where(){const e=this.grouped.where;if(!e)return;const t=[];let r=-1;for(;++r<e.length;){const n=e[r];Object.prototype.hasOwnProperty.call(n,"value")&&Ss.containsUndefined(n.value)&&(this.undefinedBindingsInfo.push(n.column),this._undefinedInWhereClause=!0);const i=this[n.type](n);i&&(0===t.length?t[0]="where":t.push(n.bool),t.push(i))}return t.length>1?t.join(" "):""}group(){return this._groupsOrders("group")}order(){return this._groupsOrders("order")}having(){const e=this.grouped.having;if(!e)return"";const t=["having"];for(let r=0,n=e.length;r<n;r++){const n=e[r],i=this[n.type](n);i&&(0===t.length&&(t[0]="where"),(t.length>1||1===t.length&&"having"!==t[0])&&t.push(n.bool),t.push(i))}return t.length>1?t.join(" "):""}havingRaw(e){return this._not(e,"")+jo(e.value,void 0,this.builder,this.client,this.bindingsHolder)}havingWrapped(e){const t=qo(e.value,"where",this.builder,this.client,this.bindingsHolder);return t&&this._not(e,"")+"("+t.slice(6)+")"||""}havingBasic(e){return this._not(e,"")+Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+Oo(e.operator,this.builder,this.client,this.bindingsHolder)+" "+this.client.parameter(e.value,this.builder,this.bindingsHolder)}havingNull(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" is "+this._not(e,"null")}havingExists(e){return this._not(e,"exists")+" ("+qo(e.value,void 0,this.builder,this.client,this.bindingsHolder)+")"}havingBetween(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+this._not(e,"between")+" "+e.value.map(e=>this.client.parameter(e,this.builder,this.bindingsHolder)).join(" and ")}havingIn(e){return Array.isArray(e.column)?this.multiHavingIn(e):Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+this._not(e,"in ")+this.wrap(this.client.parameterize(e.value,void 0,this.builder,this.bindingsHolder))}multiHavingIn(e){return this.multiOnIn(e)}union(){const e=this.onlyUnions(),t=this.grouped.union;if(!t)return"";let r="";for(let n=0,i=t.length;n<i;n++){const i=t[n];n>0&&(r+=" "),(n>0||!e)&&(r+=i.clause+" ");const s=qo(i.value,void 0,this.builder,this.client,this.bindingsHolder);if(s){const e=i.wrap;e&&(r+="("),r+=s,e&&(r+=")")}}return r}onlyUnions(){return(!this.grouped.columns||!!this.grouped.columns[0].value)&&this.grouped.union&&!this.tableName}_getValueOrParameterFromAttribute(e,t){return!0===this.single.skipBinding[e]?null!=t?t:this.single[e]:this.client.parameter(this.single[e],this.builder,this.bindingsHolder)}onlyJson(){return!this.tableName&&this.grouped.columns&&1===this.grouped.columns.length&&"json"===this.grouped.columns[0].type}limit(){return this.single.limit||0===this.single.limit?`limit ${this._getValueOrParameterFromAttribute("limit")}`:""}offset(){return this.single.offset?`offset ${this._getValueOrParameterFromAttribute("offset")}`:""}del(){const{tableName:e}=this,t=this.with(),r=this.where(),n=this.join();return t+`delete ${n?e+" ":""}from ${this.single.only?"only ":""}${e}`+(n?` ${n}`:"")+(r?` ${r}`:"")}truncate(){return`truncate ${this.tableName}`}lock(){if(this.single.lock)return this[this.single.lock]()}waitMode(){if(this.single.waitMode)return this[this.single.waitMode]()}skipLocked(){throw new Error(".skipLocked() is currently only supported on MySQL 8.0+ and PostgreSQL 9.5+")}noWait(){throw new Error(".noWait() is currently only supported on MySQL 8.0+, MariaDB 10.3.0+ and PostgreSQL 9.5+")}distinctOn(e){throw new Error(".distinctOn() is currently only supported on PostgreSQL")}onWrapped(e){const t=this,r=new js;e.value.call(r,r);let n="";for(let e=0;e<r.clauses.length;e++){const i=r.clauses[e];e>0&&(n+=` ${i.bool} `);const s=t[i.type](i);s&&(n+=s)}return n.length?`(${n})`:""}onBasic(e){const t=e.value instanceof eo;return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+Oo(e.operator,this.builder,this.client,this.bindingsHolder)+" "+(t?"(":"")+Io(e.value,void 0,this.builder,this.client,this.bindingsHolder)+(t?")":"")}onVal(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+Oo(e.operator,this.builder,this.client,this.bindingsHolder)+" "+this.client.parameter(e.value,this.builder,this.bindingsHolder)}onRaw(e){return jo(e.value,void 0,this.builder,this.client,this.bindingsHolder)}onUsing(e){return"("+Ro(e.column,this.builder,this.client,this.bindingsHolder)+")"}_valueClause(e){return e.asColumn?Io(e.value,void 0,this.builder,this.client,this.bindingsHolder):this.client.parameter(e.value,this.builder,this.bindingsHolder)}_columnClause(e){let t;return t=Array.isArray(e.column)?`(${Ro(e.column,this.builder,this.client,this.bindingsHolder)})`:Io(e.column,void 0,this.builder,this.client,this.bindingsHolder),t}whereIn(e){const t=this.client.values(e.value,this.builder,this.bindingsHolder);return`${this._columnClause(e)} ${this._not(e,"in ")}${t}`}whereLike(e){return`${this._columnClause(e)} ${this._not(e,"like ")}${this._valueClause(e)}`}whereILike(e){return`${this._columnClause(e)} ${this._not(e,"ilike ")}${this._valueClause(e)}`}whereNull(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" is "+this._not(e,"null")}whereBasic(e){return this._not(e,"")+Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+Oo(e.operator,this.builder,this.client,this.bindingsHolder)+" "+this._valueClause(e)}whereExists(e){return this._not(e,"exists")+" ("+qo(e.value,void 0,this.builder,this.client,this.bindingsHolder)+")"}whereWrapped(e){const t=qo(e.value,"where",this.builder,this.client,this.bindingsHolder);return t&&this._not(e,"")+"("+t.slice(6)+")"||""}whereBetween(e){return Io(e.column,void 0,this.builder,this.client,this.bindingsHolder)+" "+this._not(e,"between")+" "+e.value.map(e=>this.client.parameter(e,this.builder,this.bindingsHolder)).join(" and ")}whereRaw(e){return this._not(e,"")+jo(e.value,void 0,this.builder,this.client,this.bindingsHolder)}_jsonWrapValue(e){if(!this.builder._isJsonObject(e))try{return JSON.stringify(JSON.parse(e.replace(/\n|\t/g,"")))}catch(t){return e}return JSON.stringify(e)}_jsonValueClause(e){return e.value=this._jsonWrapValue(e.value),this._valueClause(e)}whereJsonObject(e){return`${this._columnClause(e)} ${e.not?"!=":"="} ${this._jsonValueClause(e)}`}wrap(e){return"("!==e.charAt(0)?`(${e})`:e}json(e){return this[e.method](e.params)}analytic(e){let t="";const r=this;return t+=e.method+"() over (",e.raw?t+=e.raw:(e.partitions.length&&(t+="partition by ",t+=at.default(e.partitions,function(e){return Ao(e)?r.formatter.columnize(e):r.formatter.columnize(e.column)+(e.order?" "+e.order:"")}).join(", ")+" "),t+="order by ",t+=at.default(e.order,function(e){return Ao(e)?r.formatter.columnize(e):r.formatter.columnize(e.column)+(e.order?" "+e.order:"")}).join(", ")),t+=")",e.alias&&(t+=" as "+e.alias),t}with(){if(!this.grouped.with||!this.grouped.with.length)return"";const e=this.grouped.with;if(!e)return;const t=[];let r=-1,n=!1;for(;++r<e.length;){const i=e[r];i.recursive&&(n=!0);const s=this[i.type](i);t.push(s)}return`with ${n?"recursive ":""}${t.join(", ")} `}withWrapped(e){const t=qo(e.value,void 0,this.builder,this.client,this.bindingsHolder),r=e.columnList?"("+Ro(e.columnList,this.builder,this.client,this.bindingsHolder)+")":"",n=void 0===e.materialized?"":e.materialized?"materialized ":"not materialized ";return t&&Ro(e.alias,this.builder,this.client,this.bindingsHolder)+r+" as "+n+"("+t+")"||""}_not(e,t){return e.not?`not ${t}`:t}_prepInsert(e){const t=qo(e,void 0,this.builder,this.client,this.bindingsHolder);if(t)return t;let r=[];const n=[];Array.isArray(e)||(e=e?[e]:[]);let i=-1;for(;++i<e.length&&null!=e[i];){0===i&&(r=Object.keys(e[i]).sort());const t=new Array(r.length),s=Object.keys(e[i]);let o=-1;for(;++o<s.length;){const a=s[o];let l=r.indexOf(a);if(-1===l){r=r.concat(a).sort(),l=r.indexOf(a);let e=-1;for(;++e<n.length;)n[e].splice(l,0,void 0);t.splice(l,0,void 0)}t[l]=e[i][a]}n.push(t)}return{columns:r,values:n}}_prepUpdate(e={}){const{counter:t={}}=this.single;for(const r of Object.keys(t)){if(ot.default(e,r)){this.client.logger.warn("increment/decrement called for a column that has already been specified in main .update() call. Ignoring increment/decrement and using value from .update() call.");continue}let n=t[r];const i=n<0?"-":"+";"-"===i&&(n=-n),e[r]=this.client.raw(`?? ${i} ?`,[r,n])}e=lt.default(e,To);const r=[],n=Object.keys(e);let i=-1;for(;++i<n.length;)r.push(Io(n[i],void 0,this.builder,this.client,this.bindingsHolder)+" = "+this.client.parameter(e[n[i]],this.builder,this.bindingsHolder));if(Ke.default(r))throw new Error(["Empty .update() call detected!","Update data does not contain any values to update.","This will result in a faulty query.",this.single.table?`Table: ${this.single.table}.`:"",this.single.update?`Columns: ${Object.keys(this.single.update)}.`:""].join(" "));return r}_formatGroupsItemValue(e,t){const{formatter:r}=this;let n,i="";return"last"===t?i=" is null":"first"===t&&(i=" is not null"),n=e instanceof xo?jo(e,void 0,this.builder,this.client,this.bindingsHolder):e instanceof eo||t?"("+r.columnize(e)+i+")":r.columnize(e),n}_basicGroupOrder(e,t){return this._formatGroupsItemValue(e.value,e.nulls)+("order"===t&&"orderByRaw"!==e.type?` ${So(e.direction,this.builder,this.client,this.bindingsHolder)}`:"")}_groupOrder(e,t){return this._basicGroupOrder(e,t)}_groupOrderNulls(e,t){const r=this._formatGroupsItemValue(e.value),n="order"===t&&"orderByRaw"!==e.type?` ${So(e.direction,this.builder,this.client,this.bindingsHolder)}`:"";return!e.nulls||e.value instanceof xo?r+n:`${r}${n||""} nulls ${e.nulls}`}_groupsOrders(e){const t=this.grouped[e];if(!t)return"";const r=t.map(t=>this._groupOrder(t,e));return r.length?e+" by "+r.join(", "):""}get tableName(){if(!this._tableName){let e=this.single.table;const t=this.single.schema;if(e&&t){const r=e instanceof xo,n="function"==typeof e;e instanceof eo||r||n||(e=`${t}.${e}`)}this._tableName=e?Io(e,e instanceof eo,this.builder,this.client,this.bindingsHolder):""}return this._tableName}_jsonPathWrap(e){return this.client.parameter(e.path||e[1],this.builder,this.bindingsHolder)}_jsonExtract(e,t){let r;return r=Array.isArray(t.column)?t.column:[t],Array.isArray(e)||(e=[e]),r.map(t=>{let r=`${Ro(t.column||t[0],this.builder,this.client,this.bindingsHolder)}, ${this._jsonPathWrap(t)}`;e.forEach(e=>{r=e+"("+r+")"});const n=t.alias||t[2];return n?this.client.alias(r,this.formatter.wrap(n)):r}).join(", ")}_jsonSet(e,t){const r=`${e}(${Ro(t.column,this.builder,this.client,this.bindingsHolder)}, ${this.client.parameter(t.path,this.builder,this.bindingsHolder)}, ${this.client.parameter(t.value,this.builder,this.bindingsHolder)})`;return t.alias?this.client.alias(r,this.formatter.wrap(t.alias)):r}_whereJsonPath(e,t){return`${e}(${this._columnClause(t)}, ${this._jsonPathWrap({path:t.jsonPath})}) ${Oo(t.operator,this.builder,this.client,this.bindingsHolder)} ${this._jsonValueClause(t)}`}_onJsonPathEquals(e,t){return e+"("+Io(t.columnFirst,void 0,this.builder,this.client,this.bindingsHolder)+", "+this.client.parameter(t.jsonPathFirst,this.builder,this.bindingsHolder)+") = "+e+"("+Io(t.columnSecond,void 0,this.builder,this.client,this.bindingsHolder)+", "+this.client.parameter(t.jsonPathSecond,this.builder,this.bindingsHolder)+")"}};const{EventEmitter:Bo}=qe.default,{addQueryContext:Mo}=Ss,{augmentWithBuilderInterface:Uo}=Ls;class Do extends Bo{constructor(e){super(),this.client=e,this._sequence=[],e.config&&(this._debug=e.config.debug,qs(this,4))}withSchema(e){return this._schema=e,this}toString(){return this.toQuery()}toSQL(){return this.client.schemaCompiler(this).toSQL()}async generateDdlCommands(){return await this.client.schemaCompiler(this).generateDdlCommands()}}["createTable","createTableIfNotExists","createTableLike","createView","createViewOrReplace","createMaterializedView","refreshMaterializedView","dropView","dropViewIfExists","dropMaterializedView","dropMaterializedViewIfExists","createSchema","createSchemaIfNotExists","dropSchema","dropSchemaIfExists","createExtension","createExtensionIfNotExists","dropExtension","dropExtensionIfExists","table","alterTable","view","alterView","hasTable","hasColumn","dropTable","renameTable","renameView","dropTableIfExists","raw"].forEach(function(e){Do.prototype[e]=function(){return"createTableIfNotExists"===e&&this.client.logger.warn(["Use async .hasTable to check if table exists and then use plain .createTable. Since ",'.createTableIfNotExists actually just generates plain "CREATE TABLE IF NOT EXIST..." ',"query it will not work correctly if there are any alter table queries generated for ","columns afterwards. To not break old migrations this function is left untouched for now",", but it should not be used when writing new code and it is removed from documentation."].join("")),"table"===e&&(e="alterTable"),"view"===e&&(e="alterView"),this._sequence.push({method:e,args:et.default(arguments)}),this}}),Do.extend=(e,t)=>{if(Object.prototype.hasOwnProperty.call(Do.prototype,e))throw new Error(`Can't extend SchemaBuilder with existing method ('${e}').`);Je.default(Do.prototype,{[e]:t})},Uo(Do),Mo(Do);var Fo=Do;const{isString:Qo}=Gi;var Ho={pushAdditional:function(e){const t=new this.constructor(this.client,this.tableCompiler,this.columnBuilder);e.call(t,Ze.default(arguments)),this.sequence.additional=(this.sequence.additional||[]).concat(t.sequence)},pushQuery:function(e){e&&(Qo(e)&&(e={sql:e}),e.bindings||(e.bindings=this.bindingsHolder.bindings),this.sequence.push(e),this.formatter=this.client.formatter(this._commonBuilder),this.bindings=[],this.formatter.bindings=this.bindings)},unshiftQuery:function(e){e&&(Qo(e)&&(e={sql:e}),e.bindings||(e.bindings=this.bindingsHolder.bindings),this.sequence.unshift(e),this.formatter=this.client.formatter(this._commonBuilder),this.bindings=[],this.formatter.bindings=this.bindings)}};const{pushQuery:Wo,pushAdditional:Jo,unshiftQuery:Vo}=Ho;class zo{constructor(e,t){this.builder=t,this._commonBuilder=this.builder,this.client=e,this.schema=t._schema,this.bindings=[],this.bindingsHolder=this,this.formatter=e.formatter(t),this.formatter.bindings=this.bindings,this.sequence=[]}createSchema(){Zo("createSchema")}createSchemaIfNotExists(){Zo("createSchemaIfNotExists")}dropSchema(){Zo("dropSchema")}dropSchemaIfExists(){Zo("dropSchemaIfExists")}dropTable(e){this.pushQuery(this.dropTablePrefix+this.formatter.wrap(Xo(this.schema,e)))}dropTableIfExists(e){this.pushQuery(this.dropTablePrefix+"if exists "+this.formatter.wrap(Xo(this.schema,e)))}dropView(e){this._dropView(e,!1,!1)}dropViewIfExists(e){this._dropView(e,!0,!1)}dropMaterializedView(e){throw new Error("materialized views are not supported by this dialect.")}dropMaterializedViewIfExists(e){throw new Error("materialized views are not supported by this dialect.")}renameView(e,t){throw new Error("rename view is not supported by this dialect (instead drop then create another view).")}refreshMaterializedView(){throw new Error("materialized views are not supported by this dialect.")}_dropView(e,t,r){this.pushQuery((r?this.dropMaterializedViewPrefix:this.dropViewPrefix)+(t?"if exists ":"")+this.formatter.wrap(Xo(this.schema,e)))}raw(e,t){this.sequence.push(this.client.raw(e,t).toSQL())}toSQL(){const e=this.builder._sequence;for(let t=0,r=e.length;t<r;t++){const r=e[t];this[r.method].apply(this,r.args)}return this.sequence}async generateDdlCommands(){const e=this.toSQL();return{pre:[],sql:Array.isArray(e)?e:[e],check:null,post:[]}}}function Ko(e){const t=this.builder.queryContext();void 0!==t&&void 0===e.queryContext()&&e.queryContext(t),e.setSchema(this.schema);const r=e.toSQL();for(let e=0,t=r.length;e<t;e++)this.sequence.push(r[e])}function Go(e){return"createLike"===e?function(t,r,n){const i=this.client.tableBuilder(e,t,r,n);Ko.call(this,i)}:function(t,r){const n=this.client.tableBuilder(e,t,null,r);Ko.call(this,n)}}function Yo(e){return function(t,r){const n=this.client.viewBuilder(e,t,r);Ko.call(this,n)}}function Xo(e,t){return e?`${e}.${t}`:t}function Zo(e){throw new Error(`${e} is not supported for this dialect (only PostgreSQL supports it currently).`)}zo.prototype.dropTablePrefix="drop table ",zo.prototype.dropViewPrefix="drop view ",zo.prototype.dropMaterializedViewPrefix="drop materialized view ",zo.prototype.alterViewPrefix="alter view ",zo.prototype.alterTable=Go("alter"),zo.prototype.createTable=Go("create"),zo.prototype.createTableIfNotExists=Go("createIfNot"),zo.prototype.createTableLike=Go("createLike"),zo.prototype.createView=Yo("create"),zo.prototype.createViewOrReplace=Yo("createOrReplace"),zo.prototype.createMaterializedView=Yo("createMaterializedView"),zo.prototype.alterView=Yo("alter"),zo.prototype.pushQuery=Wo,zo.prototype.pushAdditional=Jo,zo.prototype.unshiftQuery=Vo;var ea=zo;const{isString:ta,isFunction:ra,isObject:na}=Gi;class ia{constructor(e,t,r,n,i){if(this.client=e,this._fn=i,this._method=t,this._schemaName=void 0,this._tableName=r,this._tableNameLike=n,this._statements=[],this._single={},!n&&!ra(this._fn))throw new TypeError("A callback function must be supplied to calls against `.createTable` and `.table`")}setSchema(e){this._schemaName=e}toSQL(){return"alter"===this._method&&ut.default(this,sa),this._fn&&this._fn.call(this,this),this.client.tableCompiler(this).toSQL()}timestamps(e,t,r){na(e)&&({useTimestamps:e,defaultToNow:t,useCamelCase:r}=e);const n=!0===e?"timestamp":"datetime",i=this[n](r?"createdAt":"created_at"),s=this[n](r?"updatedAt":"updated_at");if(!0===t){const e=this.client.raw("CURRENT_TIMESTAMP");i.notNullable().defaultTo(e),s.notNullable().defaultTo(e)}}comment(e){if("string"!=typeof e)throw new TypeError("Table comment must be string");this._single.comment=e}foreign(e,t){const r={column:e,keyName:t};this._statements.push({grouping:"alterTable",method:"foreign",args:[r]});let n={references(e){let t;return ta(e)&&(t=e.split(".")),t&&1!==t.length?(r.inTable=t[0],r.references=t[1],n):(r.references=t?t[0]:e,{on(e){if("string"!=typeof e)throw new TypeError("Expected tableName to be a string, got: "+typeof e);return r.inTable=e,n},inTable(){return this.on.apply(this,arguments)}})},withKeyName:e=>(r.keyName=e,n),onUpdate:e=>(r.onUpdate=e,n),onDelete:e=>(r.onDelete=e,n),deferrable:e=>{if(-1!==["mysql","mssql","redshift","mysql2","oracledb"].indexOf(this.client.dialect))throw new Error(`${this.client.dialect} does not support deferrable`);return r.deferrable=e,n},_columnBuilder:e=>(ut.default(e,n),n=e,e)};return n}check(e,t,r){return this._statements.push({grouping:"checks",args:[e,t,r]}),this}}["index","primary","unique","dropPrimary","dropUnique","dropIndex","dropForeign"].forEach(e=>{ia.prototype[e]=function(){return this._statements.push({grouping:"alterTable",method:e,args:et.default(arguments)}),this}}),ze.default({mysql:["engine","charset","collate"],postgresql:["inherits"]},function(e,t){e.forEach(function(e){ia.prototype[e]=function(r){if(this.client.dialect!==t)throw new Error(`Knex only supports ${e} statement with ${t}.`);if("alter"===this._method)throw new Error(`Knex does not support altering the ${e} outside of create table, please use knex.raw statement.`);this._single[e]=r}})}),Ss.addQueryContext(ia),["tinyint","smallint","mediumint","int","bigint","decimal","float","double","real","bit","boolean","serial","date","datetime","timestamp","time","year","geometry","geography","point","char","varchar","tinytext","tinyText","text","mediumtext","mediumText","longtext","longText","binary","varbinary","tinyblob","tinyBlob","mediumblob","mediumBlob","blob","longblob","longBlob","enum","set","bool","dateTime","increments","bigincrements","bigIncrements","integer","biginteger","bigInteger","string","json","jsonb","uuid","enu","specificType"].forEach(e=>{ia.prototype[e]=function(){const t=et.default(arguments),r=this.client.columnBuilder(this,e,t);return this._statements.push({grouping:"columns",builder:r}),r}});const sa={renameColumn(e,t){return this._statements.push({grouping:"alterTable",method:"renameColumn",args:[e,t]}),this},dropTimestamps(){return this.dropColumns(!0===arguments[0]?["createdAt","updatedAt"]:["created_at","updated_at"])},setNullable(e){return this._statements.push({grouping:"alterTable",method:"setNullable",args:[e]}),this},check(e,t,r){this._statements.push({grouping:"alterTable",method:"check",args:[e,t,r]})},dropChecks(){this._statements.push({grouping:"alterTable",method:"dropChecks",args:et.default(arguments)})},dropNullable(e){return this._statements.push({grouping:"alterTable",method:"dropNullable",args:[e]}),this}};sa.dropColumn=sa.dropColumns=function(){return this._statements.push({grouping:"alterTable",method:"dropColumn",args:et.default(arguments)}),this},ia.extend=(e,t)=>{if(Object.prototype.hasOwnProperty.call(ia.prototype,e))throw new Error(`Can't extend TableBuilder with existing method ('${e}').`);Je.default(ia.prototype,{[e]:t})};var oa=ia;const{pushAdditional:aa,pushQuery:la,unshiftQuery:ua}=Ho,{normalizeArr:ca}=Ss;class ha{constructor(e,t){this.client=e,this.tableBuilder=t,this._commonBuilder=this.tableBuilder,this.method=t._method,this.schemaNameRaw=t._schemaName,this.tableNameRaw=t._tableName,this.tableNameLikeRaw=t._tableNameLike,this.single=t._single,this.grouped=st.default(t._statements,"grouping"),this.formatter=e.formatter(t),this.bindings=[],this.formatter.bindings=this.bindings,this.bindingsHolder=this,this.sequence=[],this._formatting=e.config&&e.config.formatting,this.checksCount=0}toSQL(){return this[this.method](),this.sequence}create(e,t){const r=this.getColumns().map(e=>e.toSQL()),n=this.getColumnTypes(r);this.createAlterTableMethods&&this.alterTableForCreate(n),this.createQuery(n,e,t),this.columnQueries(r),delete this.single.comment,this.alterTable()}createIfNot(){this.create(!0)}createLike(){this.create(!1,!0)}createLikeIfNot(){this.create(!0,!0)}alter(){const e=this.getColumns().map(e=>e.toSQL()),t=this.getColumns("alter"),r=t.map(e=>e.toSQL()),n=this.getColumnTypes(e),i=this.getColumnTypes(r);this.addColumns(n),this.alterColumns(i,t),this.columnQueries(e),this.columnQueries(r),this.alterTable()}foreign(e){if(e.inTable&&e.references){const t=e.keyName?this.formatter.wrap(e.keyName):this._indexCommand("foreign",this.tableNameRaw,e.column),r=this.formatter.columnize(e.column),n=this.formatter.columnize(e.references),i=this.formatter.wrap(e.inTable),s=e.onUpdate?(this.lowerCase?" on update ":" ON UPDATE ")+e.onUpdate:"",o=e.onDelete?(this.lowerCase?" on delete ":" ON DELETE ")+e.onDelete:"",a=e.deferrable?this.lowerCase?` deferrable initially ${e.deferrable.toLowerCase()} `:` DEFERRABLE INITIALLY ${e.deferrable.toUpperCase()} `:"";this.pushQuery(this.lowerCase?(this.forCreate?"":`alter table ${this.tableName()} add `)+"constraint "+t+" foreign key ("+r+") references "+i+" ("+n+")"+s+o+a:(this.forCreate?"":`ALTER TABLE ${this.tableName()} ADD `)+"CONSTRAINT "+t+" FOREIGN KEY ("+r+") REFERENCES "+i+" ("+n+")"+s+o+a)}}getColumnTypes(e){return e.reduce(function(e,t){const r=t[0];return e.sql.push(r.sql),e.bindings.concat(r.bindings),e},{sql:[],bindings:[]})}columnQueries(e){const t=e.reduce(function(e,t){const r=Ze.default(t);return Ke.default(r)?e:e.concat(r)},[]);for(const e of t)this.pushQuery(e)}addColumns(e,t){if(t=t||this.addColumnsPrefix,e.sql.length>0){const r=e.sql.map(e=>t+e);this.pushQuery({sql:(this.lowerCase?"alter table ":"ALTER TABLE ")+this.tableName()+" "+r.join(", "),bindings:e.bindings})}}alterColumns(e,t){e.sql.length>0&&this.addColumns(e,this.alterColumnsPrefix,t)}getColumns(e){const t=this.grouped.columns||[];e=e||"add";const r=this.tableBuilder.queryContext();return t.filter(t=>t.builder._method===e).map(e=>(void 0!==r&&void 0===e.builder.queryContext()&&e.builder.queryContext(r),this.client.columnCompiler(this,e.builder)))}tableName(){return this.formatter.wrap(this.schemaNameRaw?`${this.schemaNameRaw}.${this.tableNameRaw}`:this.tableNameRaw)}tableNameLike(){return this.formatter.wrap(this.schemaNameRaw?`${this.schemaNameRaw}.${this.tableNameLikeRaw}`:this.tableNameLikeRaw)}alterTable(){const e=this.grouped.alterTable||[];for(let t=0,r=e.length;t<r;t++){const r=e[t];this[r.method]?this[r.method].apply(this,r.args):this.client.logger.error(`Debug: ${r.method} does not exist`)}for(const e in this.single)"function"==typeof this[e]&&this[e](this.single[e])}alterTableForCreate(e){this.forCreate=!0;const t=this.sequence,r=this.grouped.alterTable||[];this.grouped.alterTable=[];for(let t=0,n=r.length;t<n;t++){const n=r[t];ct.default(this.createAlterTableMethods,n.method)<0?this.grouped.alterTable.push(n):this[n.method]?(this.sequence=[],this[n.method].apply(this,n.args),e.sql.push(this.sequence[0].sql)):this.client.logger.error(`Debug: ${n.method} does not exist`)}this.sequence=t,this.forCreate=!1}dropIndex(e){this.pushQuery(`drop index${e}`)}dropUnique(){throw new Error("Method implemented in the dialect driver")}dropForeign(){throw new Error("Method implemented in the dialect driver")}dropColumn(){const e=Ss.normalizeArr.apply(null,arguments),t=(Array.isArray(e)?e:[e]).map(e=>this.dropColumnPrefix+this.formatter.wrap(e));this.pushQuery((this.lowerCase?"alter table ":"ALTER TABLE ")+this.tableName()+" "+t.join(", "))}_setNullableState(e,t){const r=this.tableName(),n=this.formatter.columnize(e),i=this.alterColumnsPrefix;return this.pushQuery({sql:"SELECT 1",output:()=>this.client.queryBuilder().from(this.tableNameRaw).columnInfo(e).then(e=>{if(Ke.default(e))throw new Error(`.setNullable: Column ${n} does not exist in table ${r}.`);return this.client.raw(`alter table ${r} ${i} ${n} ${e.type+(e.maxLength?`(${e.maxLength})`:"")} ${t?"null":"not null"} ${null!=e.defaultValue?`default '${e.defaultValue}'`:""}`)})})}setNullable(e){return this._setNullableState(e,!0)}dropNullable(e){return this._setNullableState(e,!1)}dropChecks(e){if(void 0===e)return"";e=ca(e);const t=`alter table ${this.tableName()} ${e.map(e=>`drop constraint ${e}`).join(", ")}`;this.pushQuery(t)}check(e,t,r){const n=this.tableName();let i=r;i||(this.checksCount++,i=n+"_"+this.checksCount),this.pushQuery(`alter table ${n} add constraint ${i} check(${e})`)}_addChecks(){return this.grouped.checks?", "+this.grouped.checks.map(e=>`${e.args[2]?"constraint "+e.args[2]+" ":""}check (${this.client.raw(e.args[0],e.args[1])})`).join(", "):""}_indexCommand(e,t,r){Array.isArray(r)||(r=r?[r]:[]);const n=(t.replace(/\.|-/g,"_")+"_"+r.join("_")+"_"+e).toLowerCase();return this.formatter.wrap(n)}_getPrimaryKeys(){return(this.grouped.alterTable||[]).filter(e=>"primary"===e.method).flatMap(e=>e.args).flat()}_canBeAddPrimaryKey(e){return e.primaryKey&&0===this._getPrimaryKeys().length}_getIncrementsColumnNames(){return this.grouped.columns.filter(e=>"increments"===e.builder._type).map(e=>e.builder._args[0])}}ha.prototype.pushQuery=la,ha.prototype.pushAdditional=aa,ha.prototype.unshiftQuery=ua,ha.prototype.lowerCase=!0,ha.prototype.createAlterTableMethods=null,ha.prototype.addColumnsPrefix="add column ",ha.prototype.alterColumnsPrefix="alter column ",ha.prototype.modifyColumnPrefix="modify column ",ha.prototype.dropColumnPrefix="drop column ";var da=ha;const{addQueryContext:pa}=Ss;class ma{constructor(e,t,r,n){this.client=e,this._method="add",this._single={},this._modifiers={},this._statements=[],this._type=ya[r]||r,this._args=n,this._tableBuilder=t,"alter"===t._method&&ut.default(this,ga)}references(e){return this._tableBuilder.foreign.call(this._tableBuilder,this._args[0],void 0,this)._columnBuilder(this).references(e)}}const fa={default:"defaultTo",defaultsTo:"defaultTo"};["default","defaultsTo","defaultTo","unsigned","nullable","first","after","comment","collate","check","checkPositive","checkNegative","checkIn","checkNotIn","checkBetween","checkLength","checkRegex"].forEach(function(e){const t=fa[e]||e;ma.prototype[e]=function(){return this._modifiers[t]=et.default(arguments),this}}),pa(ma),ma.prototype.notNull=ma.prototype.notNullable=function(){return this.nullable(!1)},["index","primary","unique"].forEach(function(e){ma.prototype[e]=function(){return-1===this._type.toLowerCase().indexOf("increments")&&this._tableBuilder[e].apply(this._tableBuilder,[this._args[0]].concat(et.default(arguments))),this}}),ma.extend=(e,t)=>{if(Object.prototype.hasOwnProperty.call(ma.prototype,e))throw new Error(`Can't extend ColumnBuilder with existing method ('${e}').`);Je.default(ma.prototype,{[e]:t})};const ga={drop:function(){return this._single.drop=!0,this},alterType:function(e){return this._statements.push({grouping:"alterType",value:e}),this},alter:function({alterNullable:e=!0,alterType:t=!0}={}){return this._method="alter",this.alterNullable=e,this.alterType=t,this}},ya={float:"floating",enum:"enu",boolean:"bool",string:"varchar",bigint:"bigInteger"};var ba=ma;const{toNumber:wa}=Ss,{formatDefault:va}=ro,{operator:_a}=ho;class Ea{constructor(e,t,r){this.client=e,this.tableCompiler=t,this.columnBuilder=r,this._commonBuilder=this.columnBuilder,this.args=r._args,this.type=r._type.toLowerCase(),this.grouped=st.default(r._statements,"grouping"),this.modified=r._modifiers,this.isIncrements=-1!==this.type.indexOf("increments"),this.formatter=e.formatter(r),this.bindings=[],this.formatter.bindings=this.bindings,this.bindingsHolder=this,this.sequence=[],this.modifiers=[],this.checksCount=0}_addCheckModifiers(){this.modifiers.push("check","checkPositive","checkNegative","checkIn","checkNotIn","checkBetween","checkLength","checkRegex")}defaults(e){if(Object.prototype.hasOwnProperty.call(this._defaultMap,e))return this._defaultMap[e].bind(this)();throw new Error(`There is no default for the specified identifier ${e}`)}toSQL(){return this.pushQuery(this.compileColumn()),this.sequence.additional&&(this.sequence=this.sequence.concat(this.sequence.additional)),this.sequence}compileColumn(){return this.formatter.wrap(this.getColumnName())+" "+this.getColumnType()+this.getModifiers()}getColumnName(){return ht.default(this.args)||this.defaults("columnName")}getColumnType(){if(!this._columnType){const e=this[this.type];this._columnType="function"==typeof e?e.apply(this,Ze.default(this.args)):e}return this._columnType}getModifiers(){const e=[];for(let t=0,r=this.modifiers.length;t<r;t++){const r=this.modifiers[t];if((!this.isIncrements||this.isIncrements&&"comment"===r)&&ot.default(this.modified,r)){const t=this[r].apply(this,this.modified[r]);t&&e.push(t)}}return e.length>0?` ${e.join(" ")}`:""}varchar(e){return`varchar(${wa(e,255)})`}floating(e,t){return`float(${wa(e,8)}, ${wa(t,2)})`}decimal(e,t){if(null===e)throw new Error("Specifying no precision on decimal columns is not supported for that SQL dialect.");return`decimal(${wa(e,8)}, ${wa(t,2)})`}specifictype(e){return e}nullable(e){return!1===e?"not null":"null"}notNullable(){return this.nullable(!1)}defaultTo(e){return`default ${va(e,this.type,this.client)}`}increments(e={primaryKey:!0}){return"integer not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")+" autoincrement"}bigincrements(e={primaryKey:!0}){return this.increments(e)}_pushAlterCheckQuery(e,t){let r=t;r||(this.checksCount++,r=this.tableCompiler.tableNameRaw+"_"+this.getColumnName()+"_"+this.checksCount),this.pushAdditional(function(){this.pushQuery(`alter table ${this.tableCompiler.tableName()} add constraint ${r} check(${e})`)})}_checkConstraintName(e){return e?`constraint ${e} `:""}_check(e,t){return"alter"===this.columnBuilder._method?(this._pushAlterCheckQuery(e,t),""):`${this._checkConstraintName(t)}check (${e})`}checkPositive(e){return this._check(`${this.formatter.wrap(this.getColumnName())} ${_a(">",this.columnBuilder,this.bindingsHolder)} 0`,e)}checkNegative(e){return this._check(`${this.formatter.wrap(this.getColumnName())} ${_a("<",this.columnBuilder,this.bindingsHolder)} 0`,e)}_checkIn(e,t,r){return this._check(`${this.formatter.wrap(this.getColumnName())} ${r?"not ":""}in (${e.map(e=>this.client._escapeBinding(e)).join(",")})`,t)}checkIn(e,t){return this._checkIn(e,t)}checkNotIn(e,t){return this._checkIn(e,t,!0)}checkBetween(e,t){2!==e.length||Array.isArray(e[0])||Array.isArray(e[1])||(e=[e]);const r=e.map(e=>`${this.formatter.wrap(this.getColumnName())} between ${this.client._escapeBinding(e[0])} and ${this.client._escapeBinding(e[1])}`).join(" or ");return this._check(r,t)}checkLength(e,t,r){return this._check(`length(${this.formatter.wrap(this.getColumnName())}) ${_a(e,this.columnBuilder,this.bindingsHolder)} ${wa(t)}`,r)}}Ea.prototype.binary="blob",Ea.prototype.bool="boolean",Ea.prototype.date="date",Ea.prototype.datetime="datetime",Ea.prototype.time="time",Ea.prototype.timestamp="timestamp",Ea.prototype.geometry="geometry",Ea.prototype.geography="geography",Ea.prototype.point="point",Ea.prototype.enu="varchar",Ea.prototype.bit=Ea.prototype.json="text",Ea.prototype.uuid=({useBinaryUuid:e=!1,primaryKey:t=!1}={})=>e?"binary(16)":"char(36)",Ea.prototype.integer=Ea.prototype.smallint=Ea.prototype.mediumint="integer",Ea.prototype.biginteger="bigint",Ea.prototype.text="text",Ea.prototype.tinyint="tinyint",Ea.prototype.pushQuery=Ho.pushQuery,Ea.prototype.pushAdditional=Ho.pushAdditional,Ea.prototype.unshiftQuery=Ho.unshiftQuery,Ea.prototype._defaultMap={columnName:function(){if(!this.isIncrements)throw new Error(`You did not specify a column name for the ${this.type} column.`);return"id"}};var Ca=Ea,Na=class extends xo{constructor(e,t){super(e),this.ref=t,this._schema=null,this._alias=null}withSchema(e){return this._schema=e,this}as(e){return this._alias=e,this}toSQL(){const e=this._schema?`${this._schema}.${this.ref}`:this.ref,t=this.client.formatter(this),r=t.columnize(e),n=this._alias?`${r} as ${t.wrap(this._alias)}`:r;return this.set(n,[]),super.toSQL(...arguments)}};const{columnize:xa,wrap:$a}=ho;var Aa=class{constructor(e,t){this.client=e,this.builder=t,this.bindings=[]}columnize(e){return xa(e,this.builder,this.client,this)}wrap(e,t){return $a(e,t,this.builder,this.client,this)}};function Ta(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,Object.freeze(t)}var Ra=/*#__PURE__*/Ta(dt.default);const{env:Sa={},argv:Oa=[],platform:Ia=""}="undefined"==typeof process?{}:process,ja="NO_COLOR"in Sa||Oa.includes("--no-color"),qa="FORCE_COLOR"in Sa||Oa.includes("--color"),ka="win32"===Ia,Pa="dumb"===Sa.TERM,La=Ra&&Ra.isatty&&Ra.isatty(1)&&Sa.TERM&&!Pa,Ba=!ja&&(qa||ka&&!Pa||La||"CI"in Sa&&("GITHUB_ACTIONS"in Sa||"GITLAB_CI"in Sa||"CIRCLECI"in Sa)),Ma=(e,t,r,n,i=t.substring(0,e)+n,s=t.substring(e+r.length),o=s.indexOf(r))=>i+(o<0?s:Ma(o,s,r,n)),Ua=(e,t,r)=>((e,t,r=e,n=e.length+1)=>i=>i||""!==i&&void 0!==i?((e,t,r,n,i)=>e<0?r+t+n:r+Ma(e,t,n,i)+n)((""+i).indexOf(t,n),i,e,t,r):"")(`[${e}m`,`[${t}m`,r),Da={reset:Ua(0,0),bold:Ua(1,22,"[22m[1m"),dim:Ua(2,22,"[22m[2m"),italic:Ua(3,23),underline:Ua(4,24),inverse:Ua(7,27),hidden:Ua(8,28),strikethrough:Ua(9,29),black:Ua(30,39),red:Ua(31,39),green:Ua(32,39),yellow:Ua(33,39),blue:Ua(34,39),magenta:Ua(35,39),cyan:Ua(36,39),white:Ua(37,39),gray:Ua(90,39),bgBlack:Ua(40,49),bgRed:Ua(41,49),bgGreen:Ua(42,49),bgYellow:Ua(43,49),bgBlue:Ua(44,49),bgMagenta:Ua(45,49),bgCyan:Ua(46,49),bgWhite:Ua(47,49),blackBright:Ua(90,39),redBright:Ua(91,39),greenBright:Ua(92,39),yellowBright:Ua(93,39),blueBright:Ua(94,39),magentaBright:Ua(95,39),cyanBright:Ua(96,39),whiteBright:Ua(97,39),bgBlackBright:Ua(100,49),bgRedBright:Ua(101,49),bgGreenBright:Ua(102,49),bgYellowBright:Ua(103,49),bgBlueBright:Ua(104,49),bgMagentaBright:Ua(105,49),bgCyanBright:Ua(106,49),bgWhiteBright:Ua(107,49)},Fa=({useColor:e=Ba}={})=>e?Da:Object.keys(Da).reduce((e,t)=>({...e,[t]:String}),{}),{reset:Qa,bold:Ha,dim:Wa,italic:Ja,underline:Va,inverse:za,hidden:Ka,strikethrough:Ga,black:Ya,red:Xa,green:Za,yellow:el,blue:tl,magenta:rl,cyan:nl,white:il,gray:sl,bgBlack:ol,bgRed:al,bgGreen:ll,bgYellow:ul,bgBlue:cl,bgMagenta:hl,bgCyan:dl,bgWhite:pl,blackBright:ml,redBright:fl,greenBright:gl,yellowBright:yl,blueBright:bl,magentaBright:wl,cyanBright:vl,whiteBright:_l,bgBlackBright:El,bgRedBright:Cl,bgGreenBright:Nl,bgYellowBright:xl,bgBlueBright:$l,bgMagentaBright:Al,bgCyanBright:Tl,bgWhiteBright:Rl}=Fa();var Sl=/*#__PURE__*/Object.defineProperty({bgBlack:ol,bgBlackBright:El,bgBlue:cl,bgBlueBright:$l,bgCyan:dl,bgCyanBright:Tl,bgGreen:ll,bgGreenBright:Nl,bgMagenta:hl,bgMagentaBright:Al,bgRed:al,bgRedBright:Cl,bgWhite:pl,bgWhiteBright:Rl,bgYellow:ul,bgYellowBright:xl,black:Ya,blackBright:ml,blue:tl,blueBright:bl,bold:Ha,createColors:Fa,cyan:nl,cyanBright:vl,dim:Wa,gray:sl,green:Za,greenBright:gl,hidden:Ka,inverse:za,isColorSupported:Ba,italic:Ja,magenta:rl,magentaBright:wl,red:Xa,redBright:fl,reset:Qa,strikethrough:Ga,underline:Va,white:il,whiteBright:_l,yellow:el,yellowBright:yl},"__esModule",{value:!0});const{inspect:Ol}=Ce.default,{isString:Il,isFunction:jl}=Gi;class ql{constructor(e,t,r,n){this.client=e,this._method=t,this._schemaName=void 0,this._columns=void 0,this._fn=n,this._viewName=r,this._statements=[],this._single={}}setSchema(e){this._schemaName=e}columns(e){this._columns=e}as(e){this._selectQuery=e}checkOption(){throw new Error("check option definition is not supported by this dialect.")}localCheckOption(){throw new Error("check option definition is not supported by this dialect.")}cascadedCheckOption(){throw new Error("check option definition is not supported by this dialect.")}toSQL(){return"alter"===this._method&&ut.default(this,kl),this._fn.call(this,this),this.client.viewCompiler(this).toSQL()}}const kl={column(e){const t=this;return{rename:function(r){return t._statements.push({grouping:"alterView",method:"renameColumn",args:[e,r]}),this},defaultTo:function(r){return t._statements.push({grouping:"alterView",method:"defaultTo",args:[e,r]}),this}}}};Ss.addQueryContext(ql),ql.extend=(e,t)=>{if(Object.prototype.hasOwnProperty.call(ql.prototype,e))throw new Error(`Can't extend ViewBuilder with existing method ('${e}').`);Je.default(ql.prototype,{[e]:t})};var Pl=ql;const{pushQuery:Ll}=Ho,{columnize:Bl}=ho;class Ml{constructor(e,t){this.client=e,this.viewBuilder=t,this._commonBuilder=this.viewBuilder,this.method=t._method,this.schemaNameRaw=t._schemaName,this.viewNameRaw=t._viewName,this.single=t._single,this.selectQuery=t._selectQuery,this.columns=t._columns,this.grouped=st.default(t._statements,"grouping"),this.formatter=e.formatter(t),this.bindings=[],this.formatter.bindings=this.bindings,this.bindingsHolder=this,this.sequence=[]}toSQL(){return this[this.method](),this.sequence}create(){this.createQuery(this.columns,this.selectQuery)}createOrReplace(){throw new Error("replace views is not supported by this dialect.")}createMaterializedView(){throw new Error("materialized views are not supported by this dialect.")}createQuery(e,t,r,n){const i="create "+(r?"materialized ":"")+(n?"or replace ":"")+"view ",s=e?" ("+Bl(e,this.viewBuilder,this.client,this.bindingsHolder)+")":"";let o=i+this.viewName()+s;switch(o+=" as ",o+=t.toString(),this.single.checkOption){case"default_option":o+=" with check option";break;case"local":o+=" with local check option";break;case"cascaded":o+=" with cascaded check option"}this.pushQuery({sql:o})}renameView(e,t){throw new Error("rename view is not supported by this dialect (instead drop, then create another view).")}refreshMaterializedView(){throw new Error("materialized views are not supported by this dialect.")}alter(){this.alterView()}alterView(){const e=this.grouped.alterView||[];for(let t=0,r=e.length;t<r;t++){const r=e[t];this[r.method]?this[r.method].apply(this,r.args):this.client.logger.error(`Debug: ${r.method} does not exist`)}for(const e in this.single)"function"==typeof this[e]&&this[e](this.single[e])}renameColumn(e,t){throw new Error("rename column of views is not supported by this dialect.")}defaultTo(e,t){throw new Error("change default values of views is not supported by this dialect.")}viewName(){return this.formatter.wrap(this.schemaNameRaw?`${this.schemaNameRaw}.${this.viewNameRaw}`:this.viewNameRaw)}}Ml.prototype.pushQuery=Ll;var Ul=Ml;const{Pool:Dl,TimeoutError:Fl}=_i,{EventEmitter:Ql}=qe.default,{promisify:Hl}=Ce.default,{makeEscape:Wl}=Oi,{executeQuery:Jl,enrichQueryObject:Vl}=Es,{KnexTimeoutError:zl}=ji,{outputQuery:Kl,unwrapRaw:Gl}=ho,{compileCallback:Yl}=ro,{POOL_CONFIG_OPTIONS:Xl}=$s,Zl=Vi("knex:client");class eu extends Ql{constructor(e={}){if(super(),this.config=e,this.logger=new class{constructor(e={}){const{log:{debug:t,warn:r,error:n,deprecate:i,inspectionDepth:s,enableColors:o}={}}=e;var a;this._inspectionDepth=s||5,this._enableColors=null!=(a=o)?a:!(!process||!process.stdout)&&process.stdout.isTTY,this._debug=t,this._warn=r,this._error=n,this._deprecate=i}_log(e,t,r){if(null!=t&&!jl(t))throw new TypeError("Extensions to knex logger must be functions!");jl(t)?t(e):(Il(e)||(e=Ol(e,{depth:this._inspectionDepth,colors:this._enableColors})),console.log(r?r(e):e))}debug(e){this._log(e,this._debug)}warn(e){this._log(e,this._warn,Sl.yellow)}error(e){this._log(e,this._error,Sl.red)}deprecate(e,t){this._log(`${e} is deprecated, please use ${t}`,this._deprecate,Sl.yellow)}}(e),this.dialect&&!this.config.client&&this.logger.warn("Using 'this.dialect' to identify the client is deprecated and support for it will be removed in the future. Please use configuration option 'client' instead."),!this.config.client&&!this.dialect)throw new Error("knex: Required configuration option 'client' is missing.");e.version&&(this.version=e.version),e.connection&&e.connection instanceof Function?(this.connectionConfigProvider=e.connection,this.connectionConfigExpirationChecker=()=>!0):(this.connectionSettings=Me.default(e.connection||{}),this.connectionConfigExpirationChecker=null),this.driverName&&e.connection&&(this.initializeDriver(),(!e.pool||e.pool&&0!==e.pool.max)&&this.initializePool(e)),this.valueForUndefined=this.raw("DEFAULT"),e.useNullAsDefault&&(this.valueForUndefined=null)}formatter(e){return new Aa(this,e)}queryBuilder(){return new eo(this)}queryCompiler(e,t){return new Lo(this,e,t)}schemaBuilder(){return new Fo(this)}schemaCompiler(e){return new ea(this,e)}tableBuilder(e,t,r,n){return new oa(this,e,t,r,n)}viewBuilder(e,t,r){return new Pl(this,e,t,r)}tableCompiler(e){return new da(this,e)}viewCompiler(e){return new Ul(this,e)}columnBuilder(e,t,r){return new ba(this,e,t,r)}columnCompiler(e,t){return new Ca(this,e,t)}runner(e){return new Di(this,e)}transaction(e,t,r){return new ys(this,e,t,r)}raw(){return new xo(this).set(...arguments)}ref(){return new Na(this,...arguments)}query(e,t){const r=Vl(e,t,this);return Jl(e,r,this)}stream(e,t,r,n){const i=Vl(e,t,this);return this._stream(e,i,r,n)}prepBindings(e){return e}positionBindings(e){return e}postProcessResponse(e,t){return this.config.postProcessResponse?this.config.postProcessResponse(e,t):e}wrapIdentifier(e,t){return this.customWrapIdentifier(e,this.wrapIdentifierImpl,t)}customWrapIdentifier(e,t,r){return this.config.wrapIdentifier?this.config.wrapIdentifier(e,t,r):t(e)}wrapIdentifierImpl(e){return"*"!==e?`"${e.replace(/"/g,'""')}"`:"*"}initializeDriver(){try{this.driver=this._driver()}catch(e){const t=`Knex: run\n$ npm install ${this.driverName} --save`;throw this.logger.error(`${t}\n${e.message}\n${e.stack}`),new Error(`${t}\n${e.message}`)}}poolDefaults(){return{min:2,max:10,propagateCreateError:!0}}getPoolSettings(e){e=Ue.default({},e,this.poolDefaults()),Xl.forEach(t=>{t in e&&this.logger.warn([`Pool config option "${t}" is no longer supported.`,"See https://github.com/Vincit/tarn.js for possible pool config options."].join(" "))});const t=[this.config.acquireConnectionTimeout||6e4,e.acquireTimeoutMillis].filter(e=>void 0!==e);e.acquireTimeoutMillis=Math.min(...t);const r=async()=>{if(!this.connectionConfigProvider)return;if(!this.connectionConfigExpirationChecker||!this.connectionConfigExpirationChecker())return;const e=await this.connectionConfigProvider();e.expirationChecker?(this.connectionConfigExpirationChecker=e.expirationChecker,delete e.expirationChecker):this.connectionConfigExpirationChecker=null,this.connectionSettings=e};return Object.assign(e,{create:async()=>{await r();const t=await this.acquireRawConnection();return t.__knexUid=De.default("__knexUid"),e.afterCreate&&await Hl(e.afterCreate)(t),t},destroy:e=>{if(void 0!==e)return this.destroyRawConnection(e)},validate:e=>e.__knex__disposed?(this.logger.warn(`Connection Error: ${e.__knex__disposed}`),!1):this.validateConnection(e)})}initializePool(e=this.config){if(this.pool)return void this.logger.warn("The pool has already been initialized");const t={...this.getPoolSettings(e.pool)};t.afterCreate&&delete t.afterCreate,this.pool=new Dl(t)}validateConnection(e){return!0}async acquireConnection(){if(!this.pool)throw new Error("Unable to acquire a connection");try{const e=await this.pool.acquire().promise;return Zl("acquired connection from pool: %s",e.__knexUid),e}catch(e){let t=e;throw e instanceof Fl&&(t=new zl("Knex: Timeout acquiring a connection. The pool is probably full. Are you missing a .transacting(trx) call?")),t}}releaseConnection(e){return Zl("releasing connection to pool: %s",e.__knexUid),this.pool.release(e)||Zl("pool refused connection: %s",e.__knexUid),Promise.resolve()}async destroy(e){try{this.pool&&this.pool.destroy&&await this.pool.destroy(),this.pool=void 0,"function"==typeof e&&e()}catch(t){if("function"==typeof e)return e(t);throw t}}database(){return this.connectionSettings.database}toString(){return"[object KnexClient]"}assertCanCancelQuery(){if(!this.canCancelQuery)throw new Error("Query cancelling not supported for this dialect")}cancelQuery(){throw new Error("Query cancelling not supported for this dialect")}alias(e,t){return e+" as "+t}parameter(e,t,r){return"function"==typeof e?Kl(Yl(e,void 0,this,r),!0,t,this):Gl(e,!0,t,this,r)||"?"}parameterize(e,t,r,n){if("function"==typeof e)return this.parameter(e,r,n);e=Array.isArray(e)?e:[e];let i="",s=-1;for(;++s<e.length;){s>0&&(i+=", ");let o=e[s];Ge.default(o)&&(o=JSON.stringify(o)),i+=this.parameter(void 0===o?t:o,r,n)}return i}values(e,t,r){return Array.isArray(e)?Array.isArray(e[0])?`(${e.map(e=>`(${this.parameterize(e,void 0,t,r)})`).join(", ")})`:`(${this.parameterize(e,void 0,t,r)})`:e&&e.isRawInstance?`(${this.parameter(e,t,r)})`:this.parameter(e,t,r)}processPassedConnection(e){}toPathForJson(e){return e}}Object.assign(eu.prototype,{_escapeBinding:Wl({escapeString:e=>`'${e.replace(/'/g,"''")}'`}),canCancelQuery:!1});var tu=eu;function ru(e){if("/"===e.charAt(0))return{host:(r=e.split(" "))[0],database:r[1]};var t=ve.default.parse(/ |%[^a-f0-9]|%[a-f0-9][^a-f0-9]/i.test(e)?encodeURI(e).replace(/\%25(\d\d)/g,"%$1"):e,!0),r=t.query;for(var n in r)Array.isArray(r[n])&&(r[n]=r[n][r[n].length-1]);var i=(t.auth||":").split(":");if(r.user=i[0],r.password=i.splice(1).join(":"),r.port=t.port,"socket:"==t.protocol)return r.host=decodeURI(t.pathname),r.database=t.query.db,r.client_encoding=t.query.encoding,r;r.host||(r.host=t.hostname);var s=t.pathname;if(!r.host&&s&&/^%2f/i.test(s)){var o=s.split("/");r.host=decodeURIComponent(o[0]),s=o.splice(1).join("/")}switch(s&&"/"===s.charAt(0)&&(s=s.slice(1)||null),r.database=s&&decodeURI(s),"true"!==r.ssl&&"1"!==r.ssl||(r.ssl=!0),"0"===r.ssl&&(r.ssl=!1),(r.sslcert||r.sslkey||r.sslrootcert||r.sslmode)&&(r.ssl={}),r.sslcert&&(r.ssl.cert=Ee.default.readFileSync(r.sslcert).toString()),r.sslkey&&(r.ssl.key=Ee.default.readFileSync(r.sslkey).toString()),r.sslrootcert&&(r.ssl.ca=Ee.default.readFileSync(r.sslrootcert).toString()),r.sslmode){case"disable":r.ssl=!1;break;case"prefer":case"require":case"verify-ca":case"verify-full":break;case"no-verify":r.ssl.rejectUnauthorized=!1}return r}var nu=ru;ru.parse=ru;const{parse:iu}=nu,su=iu,ou=process&&process.platform&&"win32"===process.platform;var au=function(e){const t=function(e){try{return new URL(e)}catch(e){return null}}(e);if(!t||ou&&t&&2===t.protocol.length)return{client:"sqlite3",connection:{filename:e}};let{protocol:r}=t;return":"===r.slice(-1)&&(r=r.slice(0,-1)),{client:r,connection:["postgresql","postgres"].includes(r)?su(e):lu(t)}};function lu(e){const t={};let r=e.pathname;if("/"===r[0]&&(r=r.slice(1)),t.database=r,e.hostname&&(0===e.protocol.indexOf("mssql")?t.server=e.hostname:t.host=e.hostname),e.port&&(t.port=e.port),(e.username||e.password)&&(t.user=decodeURIComponent(e.username)),e.password&&(t.password=decodeURIComponent(e.password)),e.searchParams)for(const[r,n]of e.searchParams.entries())if(["mysql:","mariadb:","mssql:"].includes(e.protocol))try{t[r]=JSON.parse(n)}catch(e){t[r]=n}else t[r]=n;return t}var uu=class extends ys{begin(e){return this.isolationLevel&&this.client.logger.warn("sqlite3 only supports serializable transactions, ignoring the isolation level param"),this.query(e,"BEGIN;")}};const{isString:cu}=Gi,{wrapString:hu,columnize:du}=ho,pu=pt.default("");var mu=class extends Lo{constructor(e,t,r){super(e,t,r),this.forShare=pu,this.forKeyShare=pu,this.forUpdate=pu,this.forNoKeyUpdate=pu}insert(){const e=this.single.insert||[];let t=this.with()+`insert into ${this.tableName} `;if(Array.isArray(e)){if(0===e.length)return"";if(1===e.length&&e[0]&&Ke.default(e[0]))return{sql:t+this._emptyInsertValue}}else if("object"==typeof e&&Ke.default(e))return{sql:t+this._emptyInsertValue};const r=this._prepInsert(e);if(cu(r))return{sql:t+r};if(0===r.columns.length)return{sql:""};if(t+=`(${this.formatter.columnize(r.columns)})`,null!==this.client.valueForUndefined&&r.values.forEach(e=>{ze.default(e,e=>{if(void 0===e)throw new TypeError("`sqlite` does not support inserting default values. Specify values explicitly or use the `useNullAsDefault` config flag. (see docs https://knexjs.org/guide/query-builder.html#insert).")})}),1===r.values.length){t+=` values (${this.client.parameterize(r.values[0],this.client.valueForUndefined,this.builder,this.bindingsHolder)})`;const{onConflict:n,ignore:i,merge:s}=this.single;if(n&&i)t+=this._ignore(n);else if(n&&s){t+=this._merge(s.updates,n,e);const r=this.where();r&&(t+=` ${r}`)}const{returning:o}=this.single;return o&&(t+=this._returning(o)),{sql:t,returning:o}}const n=[];let i=-1;for(;++i<r.values.length;){let e=-1;const t=n[i]=[];let s=r.values[i];for(s=void 0===s?this.client.valueForUndefined:s;++e<r.columns.length;)t.push(this.client.alias(this.client.parameter(s[e],this.builder,this.bindingsHolder),this.formatter.wrap(r.columns[e])));n[i]=t.join(", ")}t+=" select "+n.join(" union all select ");const{onConflict:s,ignore:o,merge:a}=this.single;s&&o?t+=" where true"+this._ignore(s):s&&a&&(t+=" where true"+this._merge(a.updates,s,e));const{returning:l}=this.single;return l&&(t+=this._returning(l)),{sql:t,returning:l}}update(){const e=this.with(),t=this._prepUpdate(this.single.update),r=this.where(),{returning:n}=this.single;return{sql:e+`update ${this.single.only?"only ":""}${this.tableName} `+`set ${t.join(", ")}`+(r?` ${r}`:"")+this._returning(n),returning:n}}_ignore(e){return!0===e?" on conflict do nothing":` on conflict ${this._onConflictClause(e)} do nothing`}_merge(e,t,r){let n=` on conflict ${this._onConflictClause(t)} do update set `;if(e&&Array.isArray(e))return n+=e.map(e=>hu(e.split(".").pop(),this.formatter.builder,this.client,this.formatter)).map(e=>`${e} = excluded.${e}`).join(", "),n;if(e&&"object"==typeof e){const t=this._prepUpdate(e);return n+="string"==typeof t?t:t.join(","),n}{const e=this._prepInsert(r);if("string"==typeof e)throw new Error("If using merge with a raw insert query, then updates must be provided");return n+=e.columns.map(e=>hu(e.split(".").pop(),this.builder,this.client)).map(e=>`${e} = excluded.${e}`).join(", "),n}}_returning(e){return e?` returning ${this.formatter.columnize(e)}`:""}truncate(){const{table:e}=this.single;return{sql:`delete from ${this.tableName}`,output(){return this.query({sql:`delete from sqlite_sequence where name = '${e}'`}).catch(zi)}}}columnInfo(){const e=this.single.columnInfo;return{sql:`PRAGMA table_info(\`${this.client.customWrapIdentifier(this.single.table,mt.default)}\`)`,output(t){const r=/.*\((\d+)\)/,n=rt.default(t,function(e,t){let{type:n}=t,i=n.match(r);return i&&(i=i[1]),n=i?n.split("(")[0]:n,e[t.name]={type:n.toLowerCase(),maxLength:i,nullable:!t.notnull,defaultValue:t.dflt_value},e},{});return e&&n[e]||n}}}limit(){const e=!this.single.limit&&0!==this.single.limit;return e&&!this.single.offset?"":(this.single.limit=e?-1:this.single.limit,`limit ${this._getValueOrParameterFromAttribute("limit")}`)}jsonExtract(e){return this._jsonExtract("json_extract",e)}jsonSet(e){return this._jsonSet("json_set",e)}jsonInsert(e){return this._jsonSet("json_insert",e)}jsonRemove(e){const t=`json_remove(${du(e.column,this.builder,this.client,this.bindingsHolder)},${this.client.parameter(e.path,this.builder,this.bindingsHolder)})`;return e.alias?this.client.alias(t,this.formatter.wrap(e.alias)):t}whereJsonPath(e){return this._whereJsonPath("json_extract",e)}whereJsonSupersetOf(e){throw new Error("Json superset where clause not actually supported by SQLite")}whereJsonSubsetOf(e){throw new Error("Json subset where clause not actually supported by SQLite")}onJsonPathEquals(e){return this._onJsonPathEquals("json_extract",e)}},fu=class extends ea{constructor(e,t){super(e,t)}hasTable(e){const t=`select * from sqlite_master where type = 'table' and name = ${this.client.parameter(this.formatter.wrap(e).replace(/`/g,""),this.builder,this.bindingsHolder)}`;this.pushQuery({sql:t,output:e=>e.length>0})}hasColumn(e,t){this.pushQuery({sql:`PRAGMA table_info(${this.formatter.wrap(e)})`,output(e){return ft.default(e,e=>this.client.wrapIdentifier(e.name.toLowerCase())===this.client.wrapIdentifier(t.toLowerCase()))}})}renameTable(e,t){this.pushQuery(`alter table ${this.formatter.wrap(e)} rename to ${this.formatter.wrap(t)}`)}async generateDdlCommands(){const e=this.builder._sequence;for(let t=0,r=e.length;t<r;t++){const r=e[t];this[r.method].apply(this,r.args)}const t=this.sequence;if(1===t.length&&t[0].statementsProducer)return t[0].statementsProducer();{const e=[];for(const r of t){const t=r.sql;Array.isArray(t)?e.push(...t):e.push(t)}return{pre:[],sql:e,check:null,post:[]}}}};class gu extends Ca{constructor(){super(...arguments),this.modifiers=["nullable","defaultTo"],this._addCheckModifiers()}enu(e){return`text check (${this.formatter.wrap(this.args[0])} in ('${e.join("', '")}'))`}_pushAlterCheckQuery(e,t){throw new Error("Alter table with to add constraints is not permitted in SQLite")}checkRegex(e,t){return this._check(`${this.formatter.wrap(this.getColumnName())} REGEXP ${this.client._escapeBinding(e)}`,t)}}gu.prototype.json="json",gu.prototype.jsonb="json",gu.prototype.double=gu.prototype.decimal=gu.prototype.floating="float",gu.prototype.timestamp="datetime",gu.prototype.increments=gu.prototype.bigincrements="integer not null primary key autoincrement";var yu=gu;const{isObject:bu}=Gi,{formatDefault:wu}=ro;var vu=class extends da{constructor(){super(...arguments)}createQuery(e,t,r){let n=(t?"create table if not exists ":"create table ")+this.tableName();r&&this.tableNameLike()?n+=" as select * from "+this.tableNameLike()+" where 0=1":(n+=" ("+e.sql.join(", "),n+=this.foreignKeys()||"",n+=this.primaryKeys()||"",n+=this._addChecks(),n+=")"),this.pushQuery(n),r&&this.addColumns(e,this.addColumnsPrefix)}addColumns(e,t,r){if(t===this.alterColumnsPrefix){const e=this,t=r.map(e=>{const t=this.client.customWrapIdentifier(e.getColumnName(),mt.default,e.columnBuilder.queryContext()),r=e.getColumnType();return{name:t,type:r,defaultTo:e.modified.defaultTo?wu(e.modified.defaultTo[0],r,this.client):null,notNull:e.modified.nullable&&!1===e.modified.nullable[0]}});this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,statementsProducer:(r,n)=>e.client.ddl(e,r,n).alterColumn(t)})}else for(let t=0,r=e.sql.length;t<r;t++)this.pushQuery({sql:`alter table ${this.tableName()} add column ${e.sql[t]}`,bindings:e.bindings[t]})}dropUnique(e,t){t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`drop index ${t}`)}dropForeign(e,t){const r=this;e=(e=Array.isArray(e)?e:[e]).map(e=>this.client.customWrapIdentifier(e,mt.default)),t=this.client.customWrapIdentifier(t,mt.default),this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,output(n){return r.client.ddl(r,n,this.connection).dropForeign(e,t)}})}dropPrimary(e){const t=this;e=this.client.customWrapIdentifier(e,mt.default),this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,output(r){return t.client.ddl(t,r,this.connection).dropPrimary(e)}})}dropIndex(e,t){t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),this.pushQuery(`drop index ${t}`)}unique(e,t){let r;bu(t)&&({indexName:t,deferrable:r}=t),r&&"not deferrable"!==r&&this.client.logger.warn(`sqlite3: unique index \`${t}\` will not be deferrable ${r} because sqlite3 does not support deferred constraints.`),t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),e=this.formatter.columnize(e),this.pushQuery(`create unique index ${t} on ${this.tableName()} (${e})`)}index(e,t,r){let n;t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),e=this.formatter.columnize(e),bu(r)&&({predicate:n}=r);const i=n?" "+this.client.queryCompiler(n).where():"";this.pushQuery(`create index ${t} on ${this.tableName()} (${e})${i}`)}primary(e,t){const r=this;let n;e=(e=Array.isArray(e)?e:[e]).map(e=>this.client.customWrapIdentifier(e,mt.default)),bu(t)&&({constraintName:t,deferrable:n}=t),n&&"not deferrable"!==n&&this.client.logger.warn(`sqlite3: primary key constraint \`${t}\` will not be deferrable ${n} because sqlite3 does not support deferred constraints.`),t=this.client.customWrapIdentifier(t,mt.default),"create"!==this.method&&"createIfNot"!==this.method&&this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,output(n){return r.client.ddl(r,n,this.connection).primary(e,t)}})}foreign(e){const t=this;"create"!==this.method&&"createIfNot"!==this.method&&(e.column=Array.isArray(e.column)?e.column:[e.column],e.column=e.column.map(e=>this.client.customWrapIdentifier(e,mt.default)),e.inTable=this.client.customWrapIdentifier(e.inTable,mt.default),e.references=Array.isArray(e.references)?e.references:[e.references],e.references=e.references.map(e=>this.client.customWrapIdentifier(e,mt.default)),this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,statementsProducer:(r,n)=>t.client.ddl(t,r,n).foreign(e)}))}primaryKeys(){const e=gt.default(this.grouped.alterTable||[],{method:"primary"});if(e.length>0&&e[0].args.length>0){const t=e[0].args[0];let r=e[0].args[1]||"";r&&(r=" constraint "+this.formatter.wrap(r));const n=this.grouped.columns.filter(e=>"increments"===e.builder._type).length>0;return`,${r} ${n?"unique":"primary key"} (${this.formatter.columnize(t)})`}}foreignKeys(){let e="";const t=gt.default(this.grouped.alterTable||[],{method:"foreign"});for(let r=0,n=t.length;r<n;r++){const n=t[r].args[0],i=this.formatter.columnize(n.column),s=this.formatter.columnize(n.references),o=this.formatter.wrap(n.inTable);let a=n.keyName||"";a&&(a=" constraint "+this.formatter.wrap(a)),e+=`,${a} foreign key(${i}) references ${o}(${s})`,n.onDelete&&(e+=` on delete ${n.onDelete}`),n.onUpdate&&(e+=` on update ${n.onUpdate}`)}return e}createTableBlock(){return this.getColumns().concat().join(",")}renameColumn(e,t){this.pushQuery({sql:`alter table ${this.tableName()} rename ${this.formatter.wrap(e)} to ${this.formatter.wrap(t)}`})}_setNullableState(e,t){const r=this;this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,statementsProducer:(n,i)=>r.client.ddl(r,n,i).setNullable(e,t)})}dropColumn(){const e=this,t=yt.default(arguments).map(e=>this.client.customWrapIdentifier(e,mt.default));this.pushQuery({sql:`PRAGMA table_info(${this.tableName()})`,output(r){return e.client.ddl(e,r,this.connection).dropColumn(t)}})}};const{columnize:_u}=ho;var Eu=class extends Ul{constructor(e,t){super(e,t)}createOrReplace(){const e=this.columns,t=this.selectQuery.toString(),r=this.viewName(),n=`create view ${r}${e?" ("+_u(e,this.viewBuilder,this.client,this.bindingsHolder)+")":""} as ${t}`;this.pushQuery({sql:`drop view if exists ${r}`}),this.pushQuery({sql:n})}},Cu={tokenize:function(e,t){const r=new RegExp(Object.entries(t).map(([e,t])=>`(?<${e}>${t.source})`).join("|"),"yi");let n=0;const i=[];for(;n<e.length;){r.lastIndex=n;const t=e.match(r);if(null===t)throw new Error(`No matching tokenizer rule found at: [${e.substring(n)}]`);{const[e,r]=Object.entries(t.groups).find(([e,t])=>void 0!==t);n+=r.length,e.startsWith("_")||i.push({type:e,text:r})}}return i}};const{tokenize:Nu}=Cu,{s:xu,a:$u,m:Au,o:Tu,l:Ru,n:Su,t:Ou,e:Iu,f:ju}={s:function(e,t=(e=>e)){return function({index:r=0,input:n}){let i=r;const s=[];for(const t of e){const e=t({index:i,input:n});if(!e.success)return e;i=e.index,s.push(e.ast)}return{success:!0,ast:t(s),index:i,input:n}}},a:function(e,t=(e=>e)){return function({index:r=0,input:n}){for(const i of e){const e=i({index:r,input:n});if(e.success)return{success:!0,ast:t(e.ast),index:e.index,input:n}}return{success:!1,ast:null,index:r,input:n}}},m:function(e,t=(e=>e)){return function({index:r=0,input:n}){let i={},s=r;const o=[];do{i=e({index:s,input:n}),i.success&&(s=i.index,o.push(i.ast))}while(i.success);return o.length>0?{success:!0,ast:t(o),index:s,input:n}:{success:!1,ast:null,index:s,input:n}}},o:function(e,t=(e=>e)){return function({index:r=0,input:n}){const i=e({index:r,input:n});return i.success?{success:!0,ast:t(i.ast),index:i.index,input:n}:{success:!0,ast:t(null),index:r,input:n}}},l:function(e,t=(e=>e)){return function({index:r=0,input:n}){const i=e.do({index:r,input:n});return i.success&&e.next({index:i.index,input:n}).success?{success:!0,ast:t(i.ast),index:i.index,input:n}:{success:!1,ast:null,index:r,input:n}}},n:function(e,t=(e=>e)){return function({index:r=0,input:n}){const i=e.do({index:r,input:n});return i.success&&!e.not({index:r,input:n}).success?{success:!0,ast:t(i.ast),index:i.index,input:n}:{success:!1,ast:null,index:r,input:n}}},t:function(e,t=(e=>e.text)){return function({index:r=0,input:n}){const i=n[r];return void 0===i||void 0!==e.type&&e.type!==i.type||void 0!==e.text&&e.text.toUpperCase()!==i.text.toUpperCase()?{success:!1,ast:null,index:r,input:n}:{success:!0,ast:t(i),index:r+1,input:n}}},e:function({index:e=0,input:t}){return{success:!0,ast:null,index:e,input:t}},f:function({index:e=0,input:t}){return{success:e===t.length,ast:null,index:e,input:t}}},qu={keyword:/(?:ABORT|ACTION|ADD|AFTER|ALL|ALTER|ALWAYS|ANALYZE|AND|AS|ASC|ATTACH|AUTOINCREMENT|BEFORE|BEGIN|BETWEEN|BY|CASCADE|CASE|CAST|CHECK|COLLATE|COLUMN|COMMIT|CONFLICT|CONSTRAINT|CREATE|CROSS|CURRENT|CURRENT_DATE|CURRENT_TIME|CURRENT_TIMESTAMP|DATABASE|DEFAULT|DEFERRED|DEFERRABLE|DELETE|DESC|DETACH|DISTINCT|DO|DROP|END|EACH|ELSE|ESCAPE|EXCEPT|EXCLUSIVE|EXCLUDE|EXISTS|EXPLAIN|FAIL|FILTER|FIRST|FOLLOWING|FOR|FOREIGN|FROM|FULL|GENERATED|GLOB|GROUP|GROUPS|HAVING|IF|IGNORE|IMMEDIATE|IN|INDEX|INDEXED|INITIALLY|INNER|INSERT|INSTEAD|INTERSECT|INTO|IS|ISNULL|JOIN|KEY|LAST|LEFT|LIKE|LIMIT|MATCH|MATERIALIZED|NATURAL|NO|NOT|NOTHING|NOTNULL|NULL|NULLS|OF|OFFSET|ON|OR|ORDER|OTHERS|OUTER|OVER|PARTITION|PLAN|PRAGMA|PRECEDING|PRIMARY|QUERY|RAISE|RANGE|RECURSIVE|REFERENCES|REGEXP|REINDEX|RELEASE|RENAME|REPLACE|RESTRICT|RETURNING|RIGHT|ROLLBACK|ROW|ROWS|SAVEPOINT|SELECT|SET|TABLE|TEMP|TEMPORARY|THEN|TIES|TO|TRANSACTION|TRIGGER|UNBOUNDED|UNION|UNIQUE|UPDATE|USING|VACUUM|VALUES|VIEW|VIRTUAL|WHEN|WHERE|WINDOW|WITH|WITHOUT)(?=\s+|-|\(|\)|;|\+|\*|\/|%|==|=|<=|<>|<<|<|>=|>>|>|!=|,|&|~|\|\||\||\.)/,id:/"[^"]*(?:""[^"]*)*"|`[^`]*(?:``[^`]*)*`|\[[^[\]]*\]|[a-z_][a-z0-9_$]*/,string:/'[^']*(?:''[^']*)*'/,blob:/x'(?:[0-9a-f][0-9a-f])+'/,numeric:/(?:\d+(?:\.\d*)?|\.\d+)(?:e(?:\+|-)?\d+)?|0x[0-9a-f]+/,variable:/\?\d*|[@$:][a-z0-9_$]+/,operator:/-|\(|\)|;|\+|\*|\/|%|==|=|<=|<>|<<|<|>=|>>|>|!=|,|&|~|\|\||\||\./,_ws:/\s+/};function ku(e){return $u([Ou({text:"TEMP"}),Ou({text:"TEMPORARY"}),Iu],e=>({temporary:null!==e}))(e)}function Pu(e){return Tu(xu([Ou({text:"WITHOUT"}),Ou({text:"ROWID"})]),e=>({rowid:null!==e}))(e)}function Lu(e){return $u([xu([Bu,Ou({text:","}),Lu],e=>({columns:[e[0]].concat(e[2].columns)})),xu([Bu],e=>({columns:[e[0]]}))])(e)}function Bu(e){return xu([xu([$c],e=>({name:e[0]})),Mu,Uu],e=>Object.assign({},...e))(e)}function Mu(e){return Tu(xu([Au(Ou({type:"id"})),$u([xu([Ou({text:"("}),Rc,Ou({text:","}),Rc,Ou({text:")"})],e=>`(${e[1]}, ${e[3]})`),xu([Ou({text:"("}),Rc,Ou({text:")"})],e=>`(${e[1]})`),Iu])],e=>`${e[0].join(" ")}${e[1]||""}`),e=>({type:e}))(e)}function Uu(e){return Tu(Au(Du),e=>({constraints:Object.assign({primary:null,notnull:null,null:null,unique:null,check:null,default:null,collate:null,references:null,as:null},...e||[])}))(e)}function Du(e){return $u([Fu,Hu,Wu,Ju,Vu,zu,Ku,Gu,Yu])(e)}function Fu(e){return xu([dc,Ou({text:"PRIMARY"},e=>null),Ou({text:"KEY"},e=>null),Cc,rc,Qu],e=>({primary:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Qu(e){return Tu(Ou({text:"AUTOINCREMENT"}),e=>({autoincrement:null!==e}))(e)}function Hu(e){return xu([dc,Ou({text:"NOT"},e=>null),Ou({text:"NULL"},e=>null),rc],e=>({notnull:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Wu(e){return xu([dc,Ou({text:"NULL"},e=>null),rc],e=>({null:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Ju(e){return xu([dc,Ou({text:"UNIQUE"},e=>null),rc],e=>({unique:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Vu(e){return xu([dc,Ou({text:"CHECK"},e=>null),Ou({text:"("},e=>null),xu([xc],e=>({expression:e[0]})),Ou({text:")"},e=>null)],e=>({check:Object.assign({},...e.filter(e=>null!==e))}))(e)}function zu(e){return xu([dc,Ou({text:"DEFAULT"},e=>null),$u([xu([Ou({text:"("}),xc,Ou({text:")"})],e=>({value:e[1],expression:!0})),xu([Tc],e=>({value:e[0],expression:!1})),xu([Rc],e=>({value:e[0],expression:!1}))])],e=>({default:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Ku(e){return xu([dc,Ou({text:"COLLATE"},e=>null),Ou({type:"id"},e=>({collation:e.text}))],e=>({collate:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Gu(e){return xu([dc,xu([sc],e=>e[0].references)],e=>({references:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Yu(e){return xu([dc,Tu(xu([Ou({text:"GENERATED"}),Ou({text:"ALWAYS"})]),e=>({generated:null!==e})),Ou({text:"AS"},e=>null),Ou({text:"("},e=>null),xu([xc],e=>({expression:e[0]})),Ou({text:")"},e=>null),$u([Ou({text:"STORED"}),Ou({text:"VIRTUAL"}),Iu],e=>({mode:e?e.toUpperCase():null}))],e=>({as:Object.assign({},...e.filter(e=>null!==e))}))(e)}function Xu(e){return Tu(Au(xu([Ou({text:","}),Zu],e=>e[1])),e=>({constraints:e||[]}))(e)}function Zu(e){return $u([ec,tc,nc,ic])(e)}function ec(e){return xu([dc,Ou({text:"PRIMARY"},e=>null),Ou({text:"KEY"},e=>null),Ou({text:"("},e=>null),wc,Ou({text:")"},e=>null),rc],e=>Object.assign({type:"PRIMARY KEY"},...e.filter(e=>null!==e)))(e)}function tc(e){return xu([dc,Ou({text:"UNIQUE"},e=>null),Ou({text:"("},e=>null),wc,Ou({text:")"},e=>null),rc],e=>Object.assign({type:"UNIQUE"},...e.filter(e=>null!==e)))(e)}function rc(e){return Tu(xu([Ou({text:"ON"}),Ou({text:"CONFLICT"}),$u([Ou({text:"ROLLBACK"}),Ou({text:"ABORT"}),Ou({text:"FAIL"}),Ou({text:"IGNORE"}),Ou({text:"REPLACE"})])],e=>e[2]),e=>({conflict:e?e.toUpperCase():null}))(e)}function nc(e){return xu([dc,Ou({text:"CHECK"},e=>null),Ou({text:"("},e=>null),xu([xc],e=>({expression:e[0]})),Ou({text:")"},e=>null)],e=>Object.assign({type:"CHECK"},...e.filter(e=>null!==e)))(e)}function ic(e){return xu([dc,Ou({text:"FOREIGN"},e=>null),Ou({text:"KEY"},e=>null),Ou({text:"("},e=>null),ac,Ou({text:")"},e=>null),sc],e=>Object.assign({type:"FOREIGN KEY"},...e.filter(e=>null!==e)))(e)}function sc(e){return xu([Ou({text:"REFERENCES"},e=>null),yc,oc,Tu(Au($u([lc,uc,cc])),e=>Object.assign({delete:null,update:null,match:null},...e||[])),hc],e=>({references:Object.assign({},...e.filter(e=>null!==e))}))(e)}function oc(e){return Tu(xu([Ou({text:"("}),ac,Ou({text:")"})],e=>e[1]),e=>({columns:e?e.columns:[]}))(e)}function ac(e){return xu([Tu(Au(xu([$c,Ou({text:","})],e=>e[0])),e=>null!==e?e:[]),$c],e=>({columns:e[0].concat([e[1]])}))(e)}function lc(e){return xu([Ou({text:"ON"}),Ou({text:"DELETE"}),Ac],e=>({delete:e[2]}))(e)}function uc(e){return xu([Ou({text:"ON"}),Ou({text:"UPDATE"}),Ac],e=>({update:e[2]}))(e)}function cc(e){return xu([Ou({text:"MATCH"}),$u([Ou({type:"keyword"}),Ou({type:"id"})])],e=>({match:e[1]}))(e)}function hc(e){return Tu(xu([Tu(Ou({text:"NOT"})),Ou({text:"DEFERRABLE"}),Tu(xu([Ou({text:"INITIALLY"}),$u([Ou({text:"DEFERRED"}),Ou({text:"IMMEDIATE"})])],e=>e[1].toUpperCase()))]),e=>({deferrable:e?{not:null!==e[0],initially:e[2]}:null}))(e)}function dc(e){return Tu(xu([Ou({text:"CONSTRAINT"}),$c],e=>e[1]),e=>({name:e}))(e)}function pc(e){return Tu(Ou({text:"UNIQUE"}),e=>({unique:null!==e}))(e)}function mc(e){return Tu(xu([Ou({text:"IF"}),Ou({text:"NOT"}),Ou({text:"EXISTS"})]),e=>({exists:null!==e}))(e)}function fc(e){return Tu(xu([$c,Ou({text:"."})],e=>e[0]),e=>({schema:e}))(e)}function gc(e){return xu([$c],e=>({index:e[0]}))(e)}function yc(e){return xu([$c],e=>({table:e[0]}))(e)}function bc(e){return Tu(xu([Ou({text:"WHERE"}),xc],e=>e[1]),e=>({where:e}))(e)}function wc(e){return $u([xu([vc,Ou({text:","}),wc],e=>({columns:[e[0]].concat(e[2].columns)})),xu([_c,Ou({text:","}),wc],e=>({columns:[e[0]].concat(e[2].columns)})),Ru({do:vc,next:Ou({text:")"})},e=>({columns:[e]})),Ru({do:_c,next:Ou({text:")"})},e=>({columns:[e]}))])(e)}function vc(e){return xu([xu([$c],e=>({name:e[0],expression:!1})),Ec,Cc],e=>Object.assign({},...e.filter(e=>null!==e)))(e)}function _c(e){return xu([xu([Nc],e=>({name:e[0],expression:!0})),Ec,Cc],e=>Object.assign({},...e.filter(e=>null!==e)))(e)}function Ec(e){return Tu(xu([Ou({text:"COLLATE"}),Ou({type:"id"})],e=>e[1]),e=>({collation:e}))(e)}function Cc(e){return $u([Ou({text:"ASC"}),Ou({text:"DESC"}),Iu],e=>({order:e?e.toUpperCase():null}))(e)}function Nc(e){return Au($u([Su({do:Ou({type:"keyword"}),not:$u([Ou({text:"COLLATE"}),Ou({text:"ASC"}),Ou({text:"DESC"})])}),Ou({type:"id"}),Ou({type:"string"}),Ou({type:"blob"}),Ou({type:"numeric"}),Ou({type:"variable"}),Su({do:Ou({type:"operator"}),not:$u([Ou({text:"("}),Ou({text:")"}),Ou({text:","})])}),xu([Ou({text:"("}),Tu(xc),Ou({text:")"})],e=>e[1]||[])]))(e)}function xc(e){return Au($u([Ou({type:"keyword"}),Ou({type:"id"}),Ou({type:"string"}),Ou({type:"blob"}),Ou({type:"numeric"}),Ou({type:"variable"}),Su({do:Ou({type:"operator"}),not:$u([Ou({text:"("}),Ou({text:")"})])}),xu([Ou({text:"("}),Tu(xc),Ou({text:")"})],e=>e[1]||[])]))(e)}function $c(e){return $u([Ou({type:"id"}),Ou({type:"string"})],e=>/^["`['][^]*["`\]']$/.test(e)?e.substring(1,e.length-1):e)(e)}function Ac(e){return $u([xu([Ou({text:"SET"}),Ou({text:"NULL"})],e=>`${e[0]} ${e[1]}`),xu([Ou({text:"SET"}),Ou({text:"DEFAULT"})],e=>`${e[0]} ${e[1]}`),Ou({text:"CASCADE"}),Ou({text:"RESTRICT"}),xu([Ou({text:"NO"}),Ou({text:"ACTION"})],e=>`${e[0]} ${e[1]}`)],e=>e.toUpperCase())(e)}function Tc(e){return $u([Ou({type:"numeric"}),Ou({type:"string"}),Ou({type:"id"}),Ou({type:"blob"}),Ou({text:"NULL"}),Ou({text:"TRUE"}),Ou({text:"FALSE"}),Ou({text:"CURRENT_TIME"}),Ou({text:"CURRENT_DATE"}),Ou({text:"CURRENT_TIMESTAMP"})])(e)}function Rc(e){return xu([$u([Ou({text:"+"}),Ou({text:"-"}),Iu]),Ou({type:"numeric"})],e=>`${e[0]||""}${e[1]}`)(e)}var Sc={parseCreateTable:function(e){const t=(r={input:Nu(e,qu)},xu([Ou({text:"CREATE"},e=>null),ku,Ou({text:"TABLE"},e=>null),mc,fc,yc,Ou({text:"("},e=>null),Lu,Xu,Ou({text:")"},e=>null),Pu,ju],e=>Object.assign({},...e.filter(e=>null!==e)))(r));var r;if(!t.success)throw new Error(`Parsing CREATE TABLE failed at [${t.input.slice(t.index).map(e=>e.text).join(" ")}] of "${e}"`);return t.ast},parseCreateIndex:function(e){const t=(r={input:Nu(e,qu)},xu([Ou({text:"CREATE"},e=>null),pc,Ou({text:"INDEX"},e=>null),mc,fc,gc,Ou({text:"ON"},e=>null),yc,Ou({text:"("},e=>null),wc,Ou({text:")"},e=>null),bc,ju],e=>Object.assign({},...e.filter(e=>null!==e)))(r));var r;if(!t.success)throw new Error(`Parsing CREATE INDEX failed at [${t.input.slice(t.index).map(e=>e.text).join(" ")}] of "${e}"`);return t.ast}};function Oc(e,t){return null!==e.conflict?` ON CONFLICT ${e.conflict}`:""}function Ic(e,t){return`REFERENCES ${Lc(e,t)}${function(e,t){return e.columns.length>0?` (${jc(e,t)})`:""}(e,t)}${function(e,t){return`${function(e,t){return null!==e.delete?` ON DELETE ${e.delete}`:""}(e)}${function(e,t){return null!==e.update?` ON UPDATE ${e.update}`:""}(e)}${function(e,t){return null!==e.match?` MATCH ${e.match}`:""}(e)}`}(e)}${function(e,t){return null!==e?` ${e.not?"NOT ":""}DEFERRABLE${null!==e.initially?` INITIALLY ${e.initially}`:""}`:""}(e.deferrable)}`}function jc(e,t){return e.columns.map(e=>Fc(e,t)).join(", ")}function qc(e,t){return null!==e.name?`CONSTRAINT ${Fc(e.name,t)} `:""}function kc(e,t){return e.exists?" IF NOT EXISTS":""}function Pc(e,t){return null!==e.schema?`${Fc(e.schema,t)}.`:""}function Lc(e,t){return Fc(e.table,t)}function Bc(e,t){return e.columns.map(e=>e.expression?function(e,t){return`${function(e,t){return Dc(e)}(e.name)}${Mc(e)}${Uc(e)}`}(e):function(e,t){return`${Fc(e.name,t)}${Mc(e)}${Uc(e)}`}(e,t)).join(", ")}function Mc(e,t){return null!==e.collation?` COLLATE ${e.collation}`:""}function Uc(e,t){return null!==e.order?` ${e.order}`:""}function Dc(e,t){return e.reduce((e,t)=>Array.isArray(t)?`${e}(${Dc(t)})`:e?`${e} ${t}`:t,"")}function Fc(e,t){return t(e)}var Qc={compileCreateTable:function(e,t=(e=>e)){return function(e,t){return`CREATE${function(e,t){return e.temporary?" TEMP":""}(e)} TABLE${kc(e)} ${Pc(e,t)}${Lc(e,t)} (${function(e,t){return e.columns.map(e=>function(e,t){return`${Fc(e.name,t)}${function(e,t){return null!==e.type?` ${e.type}`:""}(e)}${function(e,t){return`${function(e,t){return null!==e.primary?` ${qc(e.primary,t)}PRIMARY KEY${Uc(e.primary)}${Oc(e.primary)}${function(e,t){return e.autoincrement?" AUTOINCREMENT":""}(e.primary)}`:""}(e,t)}${function(e,t){return null!==e.notnull?` ${qc(e.notnull,t)}NOT NULL${Oc(e.notnull)}`:""}(e,t)}${function(e,t){return null!==e.null?` ${qc(e.null,t)}NULL${Oc(e.null)}`:""}(e,t)}${function(e,t){return null!==e.unique?` ${qc(e.unique,t)}UNIQUE${Oc(e.unique)}`:""}(e,t)}${function(e,t){return null!==e.check?` ${qc(e.check,t)}CHECK (${Dc(e.check.expression)})`:""}(e,t)}${function(e,t){return null!==e.default?` ${qc(e.default,t)}DEFAULT ${e.default.expression?`(${Dc(e.default.value)})`:e.default.value}`:""}(e,t)}${function(e,t){return null!==e.collate?` ${qc(e.collate,t)}COLLATE ${e.collate.collation}`:""}(e,t)}${function(e,t){return null!==e.references?` ${qc(e.references,t)}${Ic(e.references,t)}`:""}(e,t)}${function(e,t){return null!==e.as?` ${qc(e.as,t)}${e.as.generated?"GENERATED ALWAYS ":""}AS (${Dc(e.as.expression)})${null!==e.as.mode?` ${e.as.mode}`:""}`:""}(e,t)}`}(e.constraints,t)}`}(e,t)).join(", ")}(e,t)}${function(e,t){return e.constraints.reduce((e,r)=>`${e}, ${function(e,t){switch(e.type){case"PRIMARY KEY":return function(e,t){return`${qc(e,t)}PRIMARY KEY (${Bc(e,t)})${Oc(e)}`}(e,t);case"UNIQUE":return function(e,t){return`${qc(e,t)}UNIQUE (${Bc(e,t)})${Oc(e)}`}(e,t);case"CHECK":return function(e,t){return`${qc(e,t)}CHECK (${Dc(e.expression)})`}(e,t);case"FOREIGN KEY":return function(e,t){return`${qc(e,t)}FOREIGN KEY (${jc(e,t)}) ${Ic(e.references,t)}`}(e,t)}}(r,t)}`,"")}(e,t)})${function(e,t){return e.rowid?" WITHOUT ROWID":""}(e)}`}(e,t)},compileCreateIndex:function(e,t=(e=>e)){return function(e,t){return`CREATE${function(e,t){return e.unique?" UNIQUE":""}(e)} INDEX${kc(e)} ${Pc(e,t)}${function(e,t){return Fc(e.index,t)}(e,t)} on ${Lc(e,t)} (${Bc(e,t)})${function(e,t){return null!==e.where?` where ${Dc(e.where)}`:""}(e)}`}(e,t)}};function Hc(e,t){return e.toLowerCase()===t.toLowerCase()}var Wc={isEqualId:Hc,includesId:function(e,t){return e.some(e=>Hc(e,t))}};const{nanonum:Jc}=fo,{copyData:Vc,dropOriginal:zc,renameTable:Kc,getTableSql:Gc,isForeignCheckEnabled:Yc,setForeignCheck:Xc,executeForeignCheck:Zc}={copyData:function(e,t,r){return`INSERT INTO "${t}" SELECT ${void 0===r?"*":r.map(e=>`"${e}"`).join(", ")} FROM "${e}";`},dropOriginal:function(e){return`DROP TABLE "${e}"`},renameTable:function(e,t){return`ALTER TABLE "${e}" RENAME TO "${t}"`},getTableSql:function(e){return`SELECT type, sql FROM sqlite_master WHERE (type='table' OR (type='index' AND sql IS NOT NULL)) AND tbl_name='${e}'`},isForeignCheckEnabled:function(){return"PRAGMA foreign_keys"},setForeignCheck:function(e){return"PRAGMA foreign_keys = "+(e?"ON":"OFF")},executeForeignCheck:function(){return"PRAGMA foreign_key_check"}},{parseCreateTable:eh,parseCreateIndex:th}=Sc,{compileCreateTable:rh,compileCreateIndex:nh}=Qc,{isEqualId:ih,includesId:sh}=Wc;var oh=class extends eo{withMaterialized(e,t,r){return this._validateWithArgs(e,t,r,"with"),this.withWrapped(e,t,r,!0)}withNotMaterialized(e,t,r){return this._validateWithArgs(e,t,r,"with"),this.withWrapped(e,t,r,!1)}},ah={__proto__:null,default:{}};const{promisify:lh}=Ce.default;class uh extends tu{constructor(e){super(e),e.connection&&void 0===e.connection.filename&&this.logger.warn("Could not find `connection.filename` in config. Please specify the database path and name to avoid errors. (see docs https://knexjs.org/guide/#configuration-options)"),void 0===e.useNullAsDefault&&this.logger.warn("sqlite does not support inserting default values. Set the `useNullAsDefault` flag to hide this warning. (see docs https://knexjs.org/guide/query-builder.html#insert).")}_driver(){return ah}schemaCompiler(){return new fu(this,...arguments)}transaction(){return new uu(this,...arguments)}queryCompiler(e,t){return new mu(this,e,t)}queryBuilder(){return new oh(this)}viewCompiler(e,t){return new Eu(this,e,t)}columnCompiler(){return new yu(this,...arguments)}tableCompiler(){return new vu(this,...arguments)}ddl(e,t,r){return new class{constructor(e,t,r,n){this.client=e,this.tableCompiler=t,this.pragma=r,this.tableNameRaw=this.tableCompiler.tableNameRaw,this.alteredName=`_knex_temp_alter${Jc(3)}`,this.connection=n,this.formatter=e=>this.client.customWrapIdentifier(e,mt.default),this.wrap=e=>this.client.wrapIdentifierImpl(e)}tableName(){return this.formatter(this.tableNameRaw)}getTableSql(){const e=this.tableName();return this.client.transaction(async t=>{t.disableProcessing();const r=await t.raw(Gc(e));return t.enableProcessing(),{createTable:r.filter(e=>"table"===e.type)[0].sql,createIndices:r.filter(e=>"index"===e.type).map(e=>e.sql)}},{connection:this.connection})}async isForeignCheckEnabled(){return 1===(await this.client.raw(Yc()).connection(this.connection))[0].foreign_keys}async setForeignCheck(e){await this.client.raw(Xc(e)).connection(this.connection)}renameTable(e){return e.raw(Kc(this.alteredName,this.tableName()))}dropOriginal(e){return e.raw(zc(this.tableName()))}copyData(e,t){return e.raw(Vc(this.tableName(),this.alteredName,t))}async alterColumn(e){const{createTable:t,createIndices:r}=await this.getTableSql(),n=eh(t);n.table=this.alteredName,n.columns=n.columns.map(t=>{const r=e.find(e=>ih(e.name,t.name));return r&&(t.type=r.type,t.constraints.default=null!==r.defaultTo?{name:null,value:r.defaultTo,expression:!1}:null,t.constraints.notnull=r.notNull?{name:null,conflict:null}:null,t.constraints.null=r.notNull?null:t.constraints.null),t});const i=rh(n,this.wrap);return this.generateAlterCommands(i,r)}async dropColumn(e){const{createTable:t,createIndices:r}=await this.getTableSql(),n=eh(t);if(n.table=this.alteredName,n.columns=n.columns.filter(t=>t.expression||!sh(e,t.name)),0===n.columns.length)throw new Error("Unable to drop last column from table");n.constraints=n.constraints.filter(t=>"PRIMARY KEY"===t.type||"UNIQUE"===t.type?t.columns.every(t=>t.expression||!sh(e,t.name)):"FOREIGN KEY"!==t.type||t.columns.every(t=>!sh(e,t))&&(t.references.table!==n.table||t.references.columns.every(t=>!sh(e,t))));const i=n.columns.map(e=>e.name),s=rh(n,this.wrap),o=[];for(const t of r){const r=th(t);r.columns=r.columns.filter(t=>t.expression||!sh(e,t.name)),r.columns.length>0&&o.push(nh(r,this.wrap))}return this.alter(s,o,i)}async dropForeign(e,t){const{createTable:r,createIndices:n}=await this.getTableSql(),i=eh(r);i.table=this.alteredName,t||(i.columns=i.columns.map(t=>({...t,references:sh(e,t.name)?null:t.references}))),i.constraints=i.constraints.filter(r=>"FOREIGN KEY"!==r.type||(t?!r.name||!ih(r.name,t):r.columns.every(t=>!sh(e,t))));const s=rh(i,this.wrap);return this.alter(s,n)}async dropPrimary(e){const{createTable:t,createIndices:r}=await this.getTableSql(),n=eh(t);n.table=this.alteredName,n.columns=n.columns.map(e=>({...e,primary:null})),n.constraints=n.constraints.filter(t=>"PRIMARY KEY"!==t.type||!!e&&(!t.name||!ih(t.name,e)));const i=rh(n,this.wrap);return this.alter(i,r)}async primary(e,t){const{createTable:r,createIndices:n}=await this.getTableSql(),i=eh(r);i.table=this.alteredName,i.columns=i.columns.map(e=>({...e,primary:null})),i.constraints=i.constraints.filter(e=>"PRIMARY KEY"!==e.type),i.constraints.push({type:"PRIMARY KEY",name:t||null,columns:e.map(e=>({name:e,expression:!1,collation:null,order:null})),conflict:null});const s=rh(i,this.wrap);return this.alter(s,n)}async foreign(e){const{createTable:t,createIndices:r}=await this.getTableSql(),n=eh(t);n.table=this.alteredName,n.constraints.push({type:"FOREIGN KEY",name:e.keyName||null,columns:e.column,references:{table:e.inTable,columns:e.references,delete:e.onDelete||null,update:e.onUpdate||null,match:null,deferrable:null}});const i=rh(n,this.wrap);return this.generateAlterCommands(i,r)}async setNullable(e,t){const{createTable:r,createIndices:n}=await this.getTableSql(),i=eh(r);i.table=this.alteredName;const s=i.columns.find(t=>ih(e,t.name));if(!s)throw new Error(`.setNullable: Column ${e} does not exist in table ${this.tableName()}.`);s.constraints.notnull=t?null:{name:null,conflict:null},s.constraints.null=t?s.constraints.null:null;const o=rh(i,this.wrap);return this.generateAlterCommands(o,n)}async alter(e,t,r){const n=await this.isForeignCheckEnabled();n&&await this.setForeignCheck(!1);try{await this.client.transaction(async i=>{await i.raw(e),await this.copyData(i,r),await this.dropOriginal(i),await this.renameTable(i);for(const e of t)await i.raw(e);if(n&&(await i.raw(Zc())).length>0)throw new Error("FOREIGN KEY constraint failed")},{connection:this.connection})}finally{n&&await this.setForeignCheck(!0)}}async generateAlterCommands(e,t,r){const n=[],i=[],s=[];let o=null;n.push(e),n.push(Vc(this.tableName(),this.alteredName,r)),n.push(zc(this.tableName())),n.push(Kc(this.alteredName,this.tableName()));for(const e of t)n.push(e);return await this.isForeignCheckEnabled()&&(i.push(Xc(!1)),s.push(Xc(!0)),o=Zc()),{pre:i,sql:n,check:o,post:s}}}(this,e,t,r)}wrapIdentifierImpl(e){return"*"!==e?`\`${e.replace(/`/g,"``")}\``:"*"}acquireRawConnection(){return new Promise((e,t)=>{let r=this.driver.OPEN_READWRITE|this.driver.OPEN_CREATE;if(this.connectionSettings.flags){if(!Array.isArray(this.connectionSettings.flags))throw new Error("flags must be an array of strings");this.connectionSettings.flags.forEach(e=>{if(!e.startsWith("OPEN_")||!this.driver[e])throw new Error(`flag ${e} not supported by node-sqlite3`);r|=this.driver[e]})}const n=new this.driver.Database(this.connectionSettings.filename,r,r=>{if(r)return t(r);e(n)})})}async destroyRawConnection(e){return lh(t=>e.close(t))()}_query(e,t){if(!t.sql)throw new Error("The query is empty");const{method:r}=t;let n;switch(r){case"insert":case"update":n=t.returning?"all":"run";break;case"counter":case"del":n="run";break;default:n="all"}return new Promise(function(r,i){if(!e||!e[n])return i(new Error(`Error calling ${n} on connection.`));e[n](t.sql,t.bindings,function(e,n){return e?i(e):(t.response=n,t.context=this,r(t))})})}_stream(e,t,r){if(!t.sql)throw new Error("The query is empty");const n=this;return new Promise(function(i,s){return r.on("error",s),r.on("end",i),n._query(e,t).then(e=>e.response).then(e=>e.forEach(e=>r.write(e))).catch(function(e){r.emit("error",e)}).then(function(){r.end()})})}processResponse(e,t){const r=e.context,{response:n,returning:i}=e;if(e.output)return e.output.call(t,n);switch(e.method){case"select":default:return n;case"first":return n[0];case"pluck":return at.default(n,e.pluck);case"insert":return i&&n?n:[r.lastID];case"update":return i&&n?n:r.changes;case"del":case"counter":return r.changes}}poolDefaults(){return Ue.default({min:1,max:1},super.poolDefaults())}formatter(e){return new Aa(this,e)}values(e,t,r){return Array.isArray(e)?Array.isArray(e[0])?`( values ${e.map(e=>`(${this.parameterize(e,void 0,t,r)})`).join(", ")})`:`(${this.parameterize(e,void 0,t,r)})`:e instanceof xo?`(${this.parameter(e,t,r)})`:this.parameter(e,t,r)}}Object.assign(uh.prototype,{dialect:"sqlite3",driverName:"sqlite3"});var ch=uh;class hh extends ch{_driver(){return ah}async acquireRawConnection(){return new this.driver(this.connectionSettings.filename)}async destroyRawConnection(e){return e.close()}async _query(e,t){if(!t.sql)throw new Error("The query is empty");if(!e)throw new Error("No connection provided");const r=e.prepare(t.sql),n=this._formatBindings(t.bindings);if(r.reader){const e=await r.all(n);return t.response=e,t}const i=await r.run(n);return t.response=i,t.context={lastID:i.lastInsertRowid,changes:i.changes},t}_formatBindings(e){return e?e.map(e=>e instanceof Date?e.valueOf():"boolean"==typeof e?Number(e):e):[]}}Object.assign(hh.prototype,{driverName:"better-sqlite3"});var dh=hh,ph=class extends ys{begin(e){return this.query(e,this.isolationLevel?`BEGIN ISOLATION LEVEL ${this.isolationLevel};`:"BEGIN;")}};const{wrapString:mh,columnize:fh,operator:gh,wrap:yh}=ho;var bh=class extends Lo{constructor(e,t,r){super(e,t,r),this._defaultInsertValue="default"}truncate(){return`truncate ${this.tableName} restart identity`}insert(){let e=super.insert();if(""===e)return e;const{returning:t,onConflict:r,ignore:n,merge:i,insert:s}=this.single;if(r&&n&&(e+=this._ignore(r)),r&&i){e+=this._merge(i.updates,r,s);const t=this.where();t&&(e+=` ${t}`)}return t&&(e+=this._returning(t)),{sql:e,returning:t}}update(){const e=this.with(),t=this._prepUpdate(this.single.update),r=this.where(),{returning:n}=this.single;return{sql:e+`update ${this.single.only?"only ":""}${this.tableName} `+`set ${t.join(", ")}`+(r?` ${r}`:"")+this._returning(n),returning:n}}using(){const e=this.single.using;if(!e)return;let t="using ";return Array.isArray(e)?t+=e.map(e=>this.formatter.wrap(e)).join(","):t+=this.formatter.wrap(e),t}del(){const{tableName:e}=this,t=this.with();let r=this.where()||"",n=this.using()||"";const i=this.grouped.join,s=[];if(Array.isArray(i)){for(const e of i){s.push(yh(this._joinTable(e),void 0,this.builder,this.client,this.bindingsHolder));const t=[];for(const r of e.clauses)t.push(this.whereBasic({column:r.column,operator:"=",value:r.value,asColumn:!0}));t.length>0&&(r+=(r?" and ":"where ")+t.join(" and "))}s.length>0&&(n+=(n?",":"using ")+s.join(","))}const o=t+`delete from ${this.single.only?"only ":""}${e}`+(n?` ${n}`:"")+(r?` ${r}`:""),{returning:a}=this.single;return{sql:o+this._returning(a),returning:a}}aggregate(e){return this._aggregate(e,{distinctParentheses:!0})}_returning(e){return e?` returning ${this.formatter.columnize(e)}`:""}_ignore(e){return!0===e?" on conflict do nothing":` on conflict ${this._onConflictClause(e)} do nothing`}_merge(e,t,r){let n=` on conflict ${this._onConflictClause(t)} do update set `;if(e&&Array.isArray(e))return n+=e.map(e=>mh(e.split(".").pop(),this.formatter.builder,this.client,this.formatter)).map(e=>`${e} = excluded.${e}`).join(", "),n;if(e&&"object"==typeof e){const t=this._prepUpdate(e);return n+="string"==typeof t?t:t.join(","),n}{const e=this._prepInsert(r);if("string"==typeof e)throw new Error("If using merge with a raw insert query, then updates must be provided");return n+=e.columns.map(e=>mh(e.split(".").pop(),this.builder,this.client)).map(e=>`${e} = excluded.${e}`).join(", "),n}}_tableNames(e){const t=this.single.schema,r=[];for(let n=0;n<e.length;n++){let i=e[n];i&&(t&&(i=`${t}.${i}`),r.push(this.formatter.wrap(i)))}return r.join(", ")}_lockingClause(e){const t=this.single.lockTables||[];return e+(t.length?" of "+this._tableNames(t):"")}_groupOrder(e,t){return super._groupOrderNulls(e,t)}forUpdate(){return this._lockingClause("for update")}forShare(){return this._lockingClause("for share")}forNoKeyUpdate(){return this._lockingClause("for no key update")}forKeyShare(){return this._lockingClause("for key share")}skipLocked(){return"skip locked"}noWait(){return"nowait"}columnInfo(){const e=this.single.columnInfo;let t=this.single.schema;const r=this.client.customWrapIdentifier(this.single.table,mt.default);return t&&(t=this.client.customWrapIdentifier(t,mt.default)),this._buildColumnInfoQuery(t,"select * from information_schema.columns where table_name = ? and table_catalog = current_database()",[r],e)}_buildColumnInfoQuery(e,t,r,n){return e?(t+=" and table_schema = ?",r.push(e)):t+=" and table_schema = current_schema()",{sql:t,bindings:r,output(e){const t=rt.default(e.rows,function(e,t){return e[t.column_name]={type:t.data_type,maxLength:t.character_maximum_length,nullable:"YES"===t.is_nullable,defaultValue:t.column_default},e},{});return n&&t[n]||t}}}distinctOn(e){return"distinct on ("+this.formatter.columnize(e)+") "}jsonExtract(e){return this._jsonExtract("jsonb_path_query",e)}jsonSet(e){return this._jsonSet("jsonb_set",Object.assign({},e,{path:this.client.toPathForJson(e.path)}))}jsonInsert(e){return this._jsonSet("jsonb_insert",Object.assign({},e,{path:this.client.toPathForJson(e.path)}))}jsonRemove(e){const t=`${fh(e.column,this.builder,this.client,this.bindingsHolder)} #- ${this.client.parameter(this.client.toPathForJson(e.path),this.builder,this.bindingsHolder)}`;return e.alias?this.client.alias(t,this.formatter.wrap(e.alias)):t}whereJsonPath(e){let t="";return t=!isNaN(e.value)&&parseInt(e.value)?"::int":!isNaN(e.value)&&parseFloat(e.value)?"::float":" #>> '{}'",`jsonb_path_query_first(${this._columnClause(e)}, ${this.client.parameter(e.jsonPath,this.builder,this.bindingsHolder)})${t} ${gh(e.operator,this.builder,this.client,this.bindingsHolder)} ${this._jsonValueClause(e)}`}whereJsonSupersetOf(e){return this._not(e,`${yh(e.column,void 0,this.builder,this.client,this.bindingsHolder)} @> ${this._jsonValueClause(e)}`)}whereJsonSubsetOf(e){return this._not(e,`${fh(e.column,this.builder,this.client,this.bindingsHolder)} <@ ${this._jsonValueClause(e)}`)}onJsonPathEquals(e){return this._onJsonPathEquals("jsonb_path_query_first",e)}},wh=class extends eo{using(e){return this._single.using=e,this}withMaterialized(e,t,r){return this._validateWithArgs(e,t,r,"with"),this.withWrapped(e,t,r,!0)}withNotMaterialized(e,t,r){return this._validateWithArgs(e,t,r,"with"),this.withWrapped(e,t,r,!1)}};const{isObject:vh}=Gi,{toNumber:_h}=Ss,Eh=/(?<!')'(?!')/g;class Ch extends Ca{constructor(e,t,r){super(e,t,r),this.modifiers=["nullable","defaultTo","comment"],this._addCheckModifiers()}bit(e){return!1!==e.length?`bit(${e.length})`:"bit"}enu(e,t){const r=(t=t||{}).useNative&&t.existingType?void 0:e.join("', '");if(t.useNative){let e="";const n=t.schemaName||this.tableCompiler.schemaNameRaw;return n&&(e+=`"${n}".`),e+=`"${t.enumName}"`,t.existingType||this.tableCompiler.unshiftQuery(`create type ${e} as enum ('${r}')`),e}return`text check (${this.formatter.wrap(this.args[0])} in ('${r}'))`}decimal(e,t){return null===e?"decimal":`decimal(${_h(e,8)}, ${_h(t,2)})`}json(e){return e&&this.client.logger.deprecate("json(true)","jsonb()"),Nh(this.client,e)}jsonb(){return Nh(this.client,!0)}checkRegex(e,t){return this._check(`${this.formatter.wrap(this.getColumnName())} ~ ${this.client._escapeBinding(e)}`,t)}datetime(e=!1,t){let r;return vh(e)?({useTz:r,precision:t}=e):r=!e,r="boolean"!=typeof r||r,`${r?"timestamptz":"timestamp"}${t=null!=t?"("+t+")":""}`}timestamp(e=!1,t){return this.datetime(e,t)}comment(e){const t=this.args[0]||this.defaults("columnName"),r=e?`'${e.replace(Eh,"''")}'`:"NULL";this.pushAdditional(function(){this.pushQuery(`comment on column ${this.tableCompiler.tableName()}.`+this.formatter.wrap(t)+` is ${r}`)},e)}increments(e={primaryKey:!0}){return"serial"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}bigincrements(e={primaryKey:!0}){return"bigserial"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}uuid(e={primaryKey:!1}){return"uuid"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}}function Nh(e,t){return!e.version||"cockroachdb"===e.config.client||!0===e.config.jsonbSupport||parseFloat(e.version)>=9.2?t?"jsonb":"json":"text"}Ch.prototype.bigint="bigint",Ch.prototype.binary="bytea",Ch.prototype.bool="boolean",Ch.prototype.double="double precision",Ch.prototype.floating="real",Ch.prototype.smallint="smallint",Ch.prototype.tinyint="smallint";var xh=Ch;const{isObject:$h,isString:Ah}=Gi;var Th=class extends da{constructor(e,t){super(e,t)}renameColumn(e,t){return this.pushQuery({sql:`alter table ${this.tableName()} rename ${this.formatter.wrap(e)} to ${this.formatter.wrap(t)}`})}_setNullableState(e,t){const r=t?"drop not null":"set not null",n=`alter table ${this.tableName()} alter column ${this.formatter.wrap(e)} ${r}`;return this.pushQuery({sql:n})}compileAdd(e){const t=this.formatter.wrap(e),r=this.prefixArray("add column",this.getColumns(e));return this.pushQuery({sql:`alter table ${t} ${r.join(", ")}`})}createQuery(e,t,r){const n=t?"create table if not exists ":"create table ",i=` (${e.sql.join(", ")}${this.primaryKeys()||""}${this._addChecks()})`;let s=n+this.tableName()+(r&&this.tableNameLike()?" (like "+this.tableNameLike()+" including all"+(e.sql.length?", "+e.sql.join(", "):"")+")":i);this.single.inherits&&(s+=` inherits (${this.formatter.wrap(this.single.inherits)})`),this.pushQuery({sql:s,bindings:e.bindings}),ot.default(this.single,"comment")&&this.comment(this.single.comment)}primaryKeys(){const e=(this.grouped.alterTable||[]).filter(e=>"primary"===e.method);if(e.length>0&&e[0].args.length>0){const t=e[0].args[0];let r,n=e[0].args[1]||"";return $h(n)&&({constraintName:n,deferrable:r}=n),r=r?` deferrable initially ${r}`:"",n=this.formatter.wrap(n||`${this.tableNameRaw}_pkey`),`, constraint ${n} primary key (${this.formatter.columnize(t)})${r}`}}addColumns(e,t,r){if(t===this.alterColumnsPrefix)for(const e of r)this._addColumn(e);else super.addColumns(e,t)}_addColumn(e){const t=this.tableName(),r=e.getColumnType(),n=this.client.wrapIdentifier(e.getColumnName(),e.columnBuilder.queryContext()),i="enu"===e.type;this.pushQuery({sql:`alter table ${t} alter column ${n} drop default`,bindings:[]});const s=e.columnBuilder.alterNullable;s&&this.pushQuery({sql:`alter table ${t} alter column ${n} drop not null`,bindings:[]}),e.columnBuilder.alterType&&this.pushQuery({sql:`alter table ${t} alter column ${n} type ${r} using (${n}${i?"::text::":"::"}${r})`,bindings:[]});const o=e.modified.defaultTo;if(o){const r=e.defaultTo.apply(e,o);this.pushQuery({sql:`alter table ${t} alter column ${n} set ${r}`,bindings:[]})}if(s){const r=e.modified.nullable;r&&!1===r[0]&&this.pushQuery({sql:`alter table ${t} alter column ${n} set not null`,bindings:[]})}}comment(e){this.pushQuery(`comment on table ${this.tableName()} is '${this.single.comment}'`)}primary(e,t){let r;$h(t)&&({constraintName:t,deferrable:r}=t),r=r?` deferrable initially ${r}`:"",t=this.formatter.wrap(t||`${this.tableNameRaw}_pkey`),"create"!==this.method&&"createIfNot"!==this.method&&this.pushQuery(`alter table ${this.tableName()} add constraint ${t} primary key (${this.formatter.columnize(e)})${r}`)}unique(e,t){let r;$h(t)&&({indexName:t,deferrable:r}=t),r=r?` deferrable initially ${r}`:"",t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} add constraint ${t} unique (`+this.formatter.columnize(e)+")"+r)}index(e,t,r){let n,i;t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),Ah(r)?i=r:$h(r)&&({indexType:i,predicate:n}=r);const s=n?" "+this.client.queryCompiler(n).where():"";this.pushQuery(`create index ${t} on ${this.tableName()}${i&&` using ${i}`||""} (`+this.formatter.columnize(e)+")"+`${s}`)}dropPrimary(e){e=this.formatter.wrap(e||this.tableNameRaw+"_pkey"),this.pushQuery(`alter table ${this.tableName()} drop constraint ${e}`)}dropIndex(e,t){t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),t=this.schemaNameRaw?`${this.formatter.wrap(this.schemaNameRaw)}.${t}`:t,this.pushQuery(`drop index ${t}`)}dropUnique(e,t){t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop constraint ${t}`)}dropForeign(e,t){t=t?this.formatter.wrap(t):this._indexCommand("foreign",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop constraint ${t}`)}},Rh=class extends Ul{constructor(e,t){super(e,t)}renameColumn(e,t){return this.pushQuery({sql:`alter view ${this.viewName()} rename ${this.formatter.wrap(e)} to ${this.formatter.wrap(t)}`})}defaultTo(e,t){return this.pushQuery({sql:`alter view ${this.viewName()} alter ${this.formatter.wrap(e)} set default ${t}`})}createOrReplace(){this.createQuery(this.columns,this.selectQuery,!1,!0)}createMaterializedView(){this.createQuery(this.columns,this.selectQuery,!0)}},Sh=class extends Pl{constructor(){super(...arguments)}checkOption(){this._single.checkOption="default_option"}localCheckOption(){this._single.checkOption="local"}cascadedCheckOption(){this._single.checkOption="cascaded"}},Oh=class extends ea{constructor(e,t){super(e,t)}hasTable(e){let t="select * from information_schema.tables where table_name = ?";const r=[e];this.schema?(t+=" and table_schema = ?",r.push(this.schema)):t+=" and table_schema = current_schema()",this.pushQuery({sql:t,bindings:r,output:e=>e.rows.length>0})}hasColumn(e,t){let r="select * from information_schema.columns where table_name = ? and column_name = ?";const n=[e,t];this.schema?(r+=" and table_schema = ?",n.push(this.schema)):r+=" and table_schema = current_schema()",this.pushQuery({sql:r,bindings:n,output:e=>e.rows.length>0})}qualifiedTableName(e){return this.formatter.wrap(this.schema?`${this.schema}.${e}`:e)}renameTable(e,t){this.pushQuery(`alter table ${this.qualifiedTableName(e)} rename to ${this.formatter.wrap(t)}`)}createSchema(e){this.pushQuery(`create schema ${this.formatter.wrap(e)}`)}createSchemaIfNotExists(e){this.pushQuery(`create schema if not exists ${this.formatter.wrap(e)}`)}dropSchema(e,t=!1){this.pushQuery(`drop schema ${this.formatter.wrap(e)}${t?" cascade":""}`)}dropSchemaIfExists(e,t=!1){this.pushQuery(`drop schema if exists ${this.formatter.wrap(e)}${t?" cascade":""}`)}dropExtension(e){this.pushQuery(`drop extension ${this.formatter.wrap(e)}`)}dropExtensionIfExists(e){this.pushQuery(`drop extension if exists ${this.formatter.wrap(e)}`)}createExtension(e){this.pushQuery(`create extension ${this.formatter.wrap(e)}`)}createExtensionIfNotExists(e){this.pushQuery(`create extension if not exists ${this.formatter.wrap(e)}`)}renameView(e,t){this.pushQuery(this.alterViewPrefix+`${this.formatter.wrap(e)} rename to ${this.formatter.wrap(t)}`)}refreshMaterializedView(e,t=!1){this.pushQuery({sql:`refresh materialized view${t?" concurrently":""} ${this.formatter.wrap(e)}`})}dropMaterializedView(e){this._dropView(e,!1,!0)}dropMaterializedViewIfExists(e){this._dropView(e,!0,!0)}};const{promisify:Ih}=Ce.default,{makeEscape:jh}=Oi,{isString:qh}=Gi;class kh extends tu{constructor(e){super(e),e.returning&&(this.defaultReturning=e.returning),e.searchPath&&(this.searchPath=e.searchPath)}transaction(){return new ph(this,...arguments)}queryBuilder(){return new wh(this)}queryCompiler(e,t){return new bh(this,e,t)}columnCompiler(){return new xh(this,...arguments)}schemaCompiler(){return new Oh(this,...arguments)}tableCompiler(){return new Th(this,...arguments)}viewCompiler(){return new Rh(this,...arguments)}viewBuilder(){return new Sh(this,...arguments)}_driver(){return ah}wrapIdentifierImpl(e){if("*"===e)return e;let t="";const r=e.match(/(.*?)(\[[0-9]+\])/);return r&&(e=r[1],t=r[2]),`"${e.replace(/"/g,'""')}"${t}`}_acquireOnlyConnection(){const e=new this.driver.Client(this.connectionSettings);return e.connect().then(()=>e)}acquireRawConnection(){const e=this;return this._acquireOnlyConnection().then(function(t){return t.on("error",e=>{t.__knex__disposed=e}),t.on("end",e=>{t.__knex__disposed=e||"Connection ended unexpectedly"}),e.version?t:e.checkVersion(t).then(function(r){return e.version=r,t})}).then(async function(t){return await e.setSchemaSearchPath(t),t})}async destroyRawConnection(e){return Ih(t=>e.end(t))()}checkVersion(e){return new Promise((t,r)=>{e.query("select version();",(e,n)=>{if(e)return r(e);t(this._parseVersion(n.rows[0].version))})})}_parseVersion(e){return/^PostgreSQL (.*?)( |$)/.exec(e)[1]}positionBindings(e){let t=0;return e.replace(/(\\*)(\?)/g,function(e,r){return r.length%2?"?":(t++,`$${t}`)})}setSchemaSearchPath(e,t){let r=t||this.searchPath;if(!r)return Promise.resolve(!0);if(!Array.isArray(r)&&!qh(r))throw new TypeError("knex: Expected searchPath to be Array/String, got: "+typeof r);if(qh(r)){if(r.includes(",")){const e=`[${r.split(",").map(e=>`'${e}'`).join(", ")}]`;this.logger.warn(`Detected comma in searchPath "${r}".If you are trying to specify multiple schemas, use Array syntax: ${e}`)}r=[r]}return r=r.map(e=>`"${e}"`).join(","),new Promise(function(t,n){e.query(`set search_path to ${r}`,function(e){if(e)return n(e);t(!0)})})}_stream(e,t,r,n){if(!t.sql)throw new Error("The query is empty");const i=process.browser?void 0:ah,s=t.sql;return new Promise(function(o,a){const l=e.query(new i(s,t.bindings,n));l.on("error",function(e){a(e),r.emit("error",e)}),r.on("end",o),l.pipe(r)})}_query(e,t){if(!t.sql)throw new Error("The query is empty");let r={text:t.sql,values:t.bindings||[]};return t.options&&(r=ut.default(r,t.options)),new Promise(function(n,i){e.query(r,function(e,r){if(e)return i(e);t.response=r,n(t)})})}processResponse(e,t){const r=e.response;if(e.output)return e.output.call(t,r);if("raw"===e.method)return r;const{returning:n}=e;if("SELECT"===r.command)return"first"===e.method?r.rows[0]:"pluck"===e.method?at.default(r.rows,e.pluck):r.rows;if(n){const e=[];for(let t=0,n=r.rows.length;t<n;t++)e[t]=r.rows[t];return e}return"UPDATE"===r.command||"DELETE"===r.command?r.rowCount:r}async cancelQuery(e){const t=await this.acquireRawConnection();try{return await this._wrappedCancelQueryCall(t,e)}finally{await this.destroyRawConnection(t).catch(e=>{this.logger.warn(`Connection Error: ${e}`)})}}_wrappedCancelQueryCall(e,t){return this._query(e,{sql:"SELECT pg_cancel_backend($1);",bindings:[t.processID],options:{}})}toPathForJson(e){return e.match(/^{.*}$/)?e:"{"+e.replace(/^(\$\.)/,"").replace(".",",").replace(/\[([0-9]+)]/,",$1")+"}"}}function Ph(e,t){let r="{";for(let n=0;n<e.length;n++){n>0&&(r+=",");const i=e[n];null==i?r+="NULL":Array.isArray(i)?r+=Ph(i,t):r+="number"==typeof i?i:JSON.stringify("string"==typeof i?i:t(i))}return r+"}"}Object.assign(kh.prototype,{dialect:"postgresql",driverName:"pg",canCancelQuery:!0,_escapeBinding:jh({escapeArray:(e,t)=>t(Ph(e,t)),escapeString(e){let t=!1,r="'";for(let n=0;n<e.length;n++){const i=e[n];"'"===i?r+=i+i:"\\"===i?(r+=i+i,t=!0):r+=i}return r+="'",!0===t&&(r="E"+r),r},escapeObject(e,t,r,n=[]){if(e&&"function"==typeof e.toPostgres){if(-1!==(n=n||[]).indexOf(e))throw new Error(`circular reference detected while preparing "${e}" for query`);return n.push(e),t(e.toPostgres(t),n)}return JSON.stringify(e)}})});var Lh=kh;const{columnize:Bh,wrap:Mh,operator:Uh}=ho;var Dh=class extends bh{truncate(){return`truncate ${this.tableName}`}upsert(){let e=this._upsert();if(""===e)return e;const{returning:t}=this.single;return t&&(e+=this._returning(t)),{sql:e,returning:t}}_upsert(){const e=this.single.upsert||[],t=this.with()+`upsert into ${this.tableName} `,r=this._insertBody(e);return""===r?"":t+r}_groupOrder(e,t){return this._basicGroupOrder(e,t)}whereJsonPath(e){let t="";return t=!isNaN(e.value)&&parseInt(e.value)?"::int":!isNaN(e.value)&&parseFloat(e.value)?"::float":" #>> '{}'",`json_extract_path(${this._columnClause(e)}, ${this.client.toArrayPathFromJsonPath(e.jsonPath,this.builder,this.bindingsHolder)})${t} ${Uh(e.operator,this.builder,this.client,this.bindingsHolder)} ${this._jsonValueClause(e)}`}_jsonExtract(e,t){let r;return r=Array.isArray(t.column)?t.column:[t],r.map(e=>{const t=`json_extract_path(${Bh(e.column||e[0],this.builder,this.client,this.bindingsHolder)}, ${this.client.toArrayPathFromJsonPath(e.path||e[1],this.builder,this.bindingsHolder)})`,r=e.alias||e[2];return r?this.client.alias(t,this.formatter.wrap(r)):t}).join(", ")}_onJsonPathEquals(e,t){return"json_extract_path("+Mh(t.columnFirst,void 0,this.builder,this.client,this.bindingsHolder)+", "+this.client.toArrayPathFromJsonPath(t.jsonPathFirst,this.builder,this.bindingsHolder)+") = json_extract_path("+Mh(t.columnSecond,void 0,this.builder,this.client,this.bindingsHolder)+", "+this.client.toArrayPathFromJsonPath(t.jsonPathSecond,this.builder,this.bindingsHolder)+")"}},Fh=class extends xh{uuid(e={primaryKey:!1}){return"uuid"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key default gen_random_uuid()":"")}},Qh=class extends Th{constructor(e,t){super(e,t)}addColumns(e,t,r){if(t===this.alterColumnsPrefix)for(const e of r)this.client.logger.warn("Experimental alter column in use, see issue: https://github.com/cockroachdb/cockroach/issues/49329"),this.pushQuery({sql:"SET enable_experimental_alter_column_type_general = true",bindings:[]}),super._addColumn(e);else super.addColumns(e,t)}dropUnique(e,t){t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`drop index ${this.tableName()}@${t} cascade `)}},Hh=class extends Rh{renameColumn(e,t){throw new Error("rename column of views is not supported by this dialect.")}defaultTo(e,t){throw new Error("change default values of views is not supported by this dialect.")}},Wh=class extends eo{upsert(e,t,r){return this._method="upsert",Ke.default(t)||this.returning(t,r),this._single.upsert=e,this}};class Jh extends Lh{transaction(){return new ph(this,...arguments)}queryCompiler(e,t){return new Dh(this,e,t)}columnCompiler(){return new Fh(this,...arguments)}tableCompiler(){return new Qh(this,...arguments)}viewCompiler(){return new Hh(this,...arguments)}queryBuilder(){return new Wh(this)}_parseVersion(e){return e.split(" ")[2]}async cancelQuery(e){try{return await this._wrappedCancelQueryCall(null,e)}catch(e){throw this.logger.warn(`Connection Error: ${e}`),e}}_wrappedCancelQueryCall(e,t){if(0!==t.activeQuery.processID||0!==t.activeQuery.secretKey)return t.cancel(t,t.activeQuery)}toArrayPathFromJsonPath(e,t,r){return e.replace(/^(\$\.)/,"").replace(/\[([0-9]+)]/,".$1").split(".").map(function(e){return this.parameter(e,t,r)}.bind(this)).join(", ")}}Object.assign(Jh.prototype,{driverName:"cockroachdb"});var Vh=Jh,zh=class extends Aa{columnizeWithPrefix(e,t){const r="string"==typeof t?[t]:t;let n="",i=-1;for(;++i<r.length;)i>0&&(n+=", "),n+=e+this.wrap(r[i]);return n}escapingStringDelimiters(e){return(e||"").replace(/'/g,"''")}};const Kh=Vi("knex:tx");var Gh=class extends ys{begin(e){return Kh("transaction::begin id=%s",this.txid),new Promise((t,r)=>{e.beginTransaction(e=>{if(e)return Kh("transaction::begin error id=%s message=%s",this.txid,e.message),r(e);t()},this.outerTx?this.txid:void 0,function(e){if(!e)return;e=e.toUpperCase().replace(" ","_");const t=Yh[e];if(!t)throw new Error(`Unknown Isolation level, was expecting one of: ${JSON.stringify(Xh)}`);return t}(this.isolationLevel))}).then(this._resolver,this._rejecter)}savepoint(e){return Kh("transaction::savepoint id=%s",this.txid),new Promise((t,r)=>{e.saveTransaction(e=>{if(e)return Kh("transaction::savepoint id=%s message=%s",this.txid,e.message),r(e);this.trxClient.emit("query",{__knexUid:this.trxClient.__knexUid,__knexTxId:this.trxClient.__knexTxId,autogenerated:!0,sql:this.outerTx?`SAVE TRANSACTION [${this.txid}]`:"SAVE TRANSACTION"}),t()},this.outerTx?this.txid:void 0)})}commit(e,t){return Kh("transaction::commit id=%s",this.txid),new Promise((r,n)=>{e.commitTransaction(e=>{if(e)return Kh("transaction::commit error id=%s message=%s",this.txid,e.message),n(e);this._completed=!0,r(t)},this.outerTx?this.txid:void 0)}).then(()=>this._resolver(t),this._rejecter)}release(e,t){return this._resolver(t)}rollback(e,t){return this._completed=!0,Kh("transaction::rollback id=%s",this.txid),new Promise((r,n)=>e.inTransaction?"LoggedIn"!==e.state.name?n(new Error("Can't rollback transaction. There is a request in progress")):void e.rollbackTransaction(e=>{e&&Kh("transaction::rollback error id=%s message=%s",this.txid,e.message),n(e||t||new Error("Transaction rejected with non-error: undefined"))},this.outerTx?this.txid:void 0):n(t||new Error("Transaction rejected with non-error: undefined"))).catch(e=>{if(t||!this.doNotRejectOnRollback){if(t)try{e.originalError=t}catch(e){}this._rejecter(e)}else this._resolver()})}rollbackTo(e,t){return this.rollback(e,t).then(()=>{this.trxClient.emit("query",{__knexUid:this.trxClient.__knexUid,__knexTxId:this.trxClient.__knexTxId,autogenerated:!0,sql:"ROLLBACK TRANSACTION"})})}};const Yh={READ_UNCOMMITTED:1,READ_COMMITTED:2,REPEATABLE_READ:3,SERIALIZABLE:4,SNAPSHOT:5},Xh=Object.keys(Yh).map(e=>e.toLowerCase().replace("_"," ")),{columnize:Zh}=ho,ed=["columns","join","lock","where","union","group","having","order","limit","offset"];var td=class extends Lo{constructor(e,t,r){super(e,t,r);const{onConflict:n}=this.single;if(n)throw new Error(".onConflict() is not supported for mssql.");this._emptyInsertValue="default values"}with(){const e=[];if(this.grouped.with)for(const t of this.grouped.with)t.recursive&&(e.push(t),t.recursive=!1);const t=super.with();for(const t of e)t.recursive=!0;return t}select(){const e=this.with(),t=ed.map(e=>this[e](this));return e+it.default(t).join(" ")}insert(){return this.single.options&&this.single.options.includeTriggerModifications?this.insertWithTriggers():this.standardInsert()}insertWithTriggers(){const e=this.single.insert||[],{returning:t}=this.single;let r=this.with()+`${this._buildTempTable(t)}insert into ${this.tableName} `;const n=t?this._returning("insert",t,!0)+" ":"";if(Array.isArray(e)){if(0===e.length)return""}else if("object"==typeof e&&Ke.default(e))return{sql:r+n+this._emptyInsertValue+this._buildReturningSelect(t),returning:t};return r+=this._buildInsertData(e,n),t&&(r+=this._buildReturningSelect(t)),{sql:r,returning:t}}_buildInsertData(e,t){let r="";const n=this._prepInsert(e);if("string"==typeof n)r+=n;else if(n.columns.length)r+=`(${this.formatter.columnize(n.columns)}`,r+=`) ${t}values (`+this._buildInsertValues(n)+")";else{if(1!==e.length||!e[0])return"";r+=t+this._emptyInsertValue}return r}standardInsert(){const e=this.single.insert||[];let t=this.with()+`insert into ${this.tableName} `;const{returning:r}=this.single,n=r?this._returning("insert",r)+" ":"";if(Array.isArray(e)){if(0===e.length)return""}else if("object"==typeof e&&Ke.default(e))return{sql:t+n+this._emptyInsertValue,returning:r};return t+=this._buildInsertData(e,n),{sql:t,returning:r}}update(){return this.single.options&&this.single.options.includeTriggerModifications?this.updateWithTriggers():this.standardUpdate()}updateWithTriggers(){const e=this.top(),t=this.with(),r=this._prepUpdate(this.single.update),n=this.join(),i=this.where(),s=this.order(),{returning:o}=this.single;return{sql:t+this._buildTempTable(o)+`update ${e?e+" ":""}${this.tableName} set `+r.join(", ")+(o?` ${this._returning("update",o,!0)}`:"")+(n?` from ${this.tableName} ${n}`:"")+(i?` ${i}`:"")+(s?` ${s}`:"")+(o?this._buildReturningSelect(o):this._returning("rowcount","@@rowcount")),returning:o||"@@rowcount"}}_formatGroupsItemValue(e,t){const r=super._formatGroupsItemValue(e);if(t&&!(e instanceof xo)){const e=`IIF(${r} is null,`;if("first"===t)return`${e}0,1)`;if("last"===t)return`${e}1,0)`}return r}standardUpdate(){const e=this.top(),t=this.with(),r=this._prepUpdate(this.single.update),n=this.join(),i=this.where(),s=this.order(),{returning:o}=this.single;return{sql:t+`update ${e?e+" ":""}${this.tableName} set `+r.join(", ")+(o?` ${this._returning("update",o)}`:"")+(n?` from ${this.tableName} ${n}`:"")+(i?` ${i}`:"")+(s?` ${s}`:"")+(o?"":this._returning("rowcount","@@rowcount")),returning:o||"@@rowcount"}}del(){return this.single.options&&this.single.options.includeTriggerModifications?this.deleteWithTriggers():this.standardDelete()}deleteWithTriggers(){const e=this.with(),{tableName:t}=this,r=this.where(),n=this.join(),{returning:i}=this.single,s=i?` ${this._returning("del",i,!0)}`:"",o=n?`${t}${s} `:"";return{sql:e+`${this._buildTempTable(i)}delete ${o}from ${t}`+(n?"":s)+(n?` ${n}`:"")+(r?` ${r}`:"")+(i?this._buildReturningSelect(i):this._returning("rowcount","@@rowcount")),returning:i||"@@rowcount"}}standardDelete(){const e=this.with(),{tableName:t}=this,r=this.where(),n=this.join(),{returning:i}=this.single,s=i?` ${this._returning("del",i)}`:"";return{sql:e+`delete ${n?`${t}${s} `:""}from ${t}`+(n?"":s)+(n?` ${n}`:"")+(r?` ${r}`:"")+(i?"":this._returning("rowcount","@@rowcount")),returning:i||"@@rowcount"}}columns(){let e="";if(this.onlyUnions())return"";const t=this.top(),r=this._hintComments(),n=this.grouped.columns||[];let i=-1,s=[];if(n)for(;++i<n.length;){const t=n[i];t.distinct&&(e="distinct "),t.distinctOn?e=this.distinctOn(t.value):"aggregate"===t.type?s.push(...this.aggregate(t)):"aggregateRaw"===t.type?s.push(this.aggregateRaw(t)):"analytic"===t.type?s.push(this.analytic(t)):"json"===t.type?s.push(this.json(t)):t.value&&t.value.length>0&&s.push(this.formatter.columnize(t.value))}return 0===s.length&&(s=["*"]),`${this.onlyJson()?"":"select "}${r}${e}`+(t?t+" ":"")+s.join(", ")+(this.tableName?` from ${this.tableName}`:"")}_returning(e,t,r){switch(e){case"update":case"insert":return t?`output ${this.formatter.columnizeWithPrefix("inserted.",t)}${r?" into #out":""}`:"";case"del":return t?`output ${this.formatter.columnizeWithPrefix("deleted.",t)}${r?" into #out":""}`:"";case"rowcount":return t?";select @@rowcount":""}}_buildTempTable(e){if(e&&e.length>0){let t="";t=Array.isArray(e)?e.map(e=>`[t].${this.formatter.columnize(e)}`).join(","):`[t].${this.formatter.columnize(e)}`;let r=`select top(0) ${t} into #out `;return r+=`from ${this.tableName} as t `,r+=`left join ${this.tableName} on 0=1;`,r}return""}_buildReturningSelect(e){if(e&&e.length>0){let t="";t=Array.isArray(e)?e.map(e=>`${this.formatter.columnize(e)}`).join(","):this.formatter.columnize(e);let r=`; select ${t} from #out; `;return r+="drop table #out;",r}return""}truncate(){return`truncate table ${this.tableName}`}forUpdate(){return"with (UPDLOCK)"}forShare(){return"with (HOLDLOCK)"}columnInfo(){const e=this.single.columnInfo;let t=this.single.schema;const r=this.client.customWrapIdentifier(this.single.table,mt.default);t&&(t=this.client.customWrapIdentifier(t,mt.default));let n="select [COLUMN_NAME], [COLUMN_DEFAULT], [DATA_TYPE], [CHARACTER_MAXIMUM_LENGTH], [IS_NULLABLE] from INFORMATION_SCHEMA.COLUMNS where table_name = ? and table_catalog = ?";const i=[r,this.client.database()];return t?(n+=" and table_schema = ?",i.push(t)):n+=" and table_schema = 'dbo'",{sql:n,bindings:i,output(t){const r=t.reduce((e,t)=>(e[t[0].value]={defaultValue:t[1].value,type:t[2].value,maxLength:t[3].value,nullable:"YES"===t[4].value},e),{});return e&&r[e]||r}}}top(){return!this.single.limit&&0!==this.single.limit||this.single.offset?"":`top (${this._getValueOrParameterFromAttribute("limit")})`}limit(){return""}offset(){const e=!this.single.limit&&0!==this.single.limit,t=!this.single.offset;if(t)return"";let r=`offset ${t?"0":this._getValueOrParameterFromAttribute("offset")} rows`;return e||(r+=` fetch next ${this._getValueOrParameterFromAttribute("limit")} rows only`),r}whereLike(e){return`${this._columnClause(e)} collate SQL_Latin1_General_CP1_CS_AS ${this._not(e,"like ")}${this._valueClause(e)}`}whereILike(e){return`${this._columnClause(e)} collate SQL_Latin1_General_CP1_CI_AS ${this._not(e,"like ")}${this._valueClause(e)}`}jsonExtract(e){return this._jsonExtract(e.singleValue?"JSON_VALUE":"JSON_QUERY",e)}jsonSet(e){return this._jsonSet("JSON_MODIFY",e)}jsonInsert(e){return this._jsonSet("JSON_MODIFY",e)}jsonRemove(e){const t=`JSON_MODIFY(${Zh(e.column,this.builder,this.client,this.bindingsHolder)},${this.client.parameter(e.path,this.builder,this.bindingsHolder)}, NULL)`;return e.alias?this.client.alias(t,this.formatter.wrap(e.alias)):t}whereJsonPath(e){return this._whereJsonPath("JSON_VALUE",e)}whereJsonSupersetOf(e){throw new Error("Json superset where clause not actually supported by MSSQL")}whereJsonSubsetOf(e){throw new Error("Json subset where clause not actually supported by MSSQL")}_getExtracts(e,t){const r=Zh(e.column,this.builder,this.client,this.bindingsHolder);return(Array.isArray(e.values)?e.values:[e.values]).map(function(e){return"JSON_VALUE("+r+","+this.client.parameter(e,this.builder,this.bindingsHolder)+")"},this).join(t)}onJsonPathEquals(e){return this._onJsonPathEquals("JSON_VALUE",e)}};class rd extends ea{constructor(e,t){super(e,t)}dropTableIfExists(e){const t=this.formatter.wrap(nd(this.schema,e));this.pushQuery(`if object_id('${t}', 'U') is not null DROP TABLE ${t}`)}dropViewIfExists(e){const t=this.formatter.wrap(nd(this.schema,e));this.pushQuery(`if object_id('${t}', 'V') is not null DROP VIEW ${t}`)}renameTable(e,t){this.pushQuery(`exec sp_rename ${this.client.parameter(nd(this.schema,e),this.builder,this.bindingsHolder)}, ${this.client.parameter(t,this.builder,this.bindingsHolder)}`)}renameView(e,t){this.pushQuery(`exec sp_rename ${this.client.parameter(nd(this.schema,e),this.builder,this.bindingsHolder)}, ${this.client.parameter(t,this.builder,this.bindingsHolder)}`)}hasTable(e){const t=[e];let r=`SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = ${this.client.parameter(nd(this.schema,e),this.builder,this.bindingsHolder)}`;this.schema&&(r+=" AND TABLE_SCHEMA = ?",t.push(this.schema)),this.pushQuery({sql:r,bindings:t,output:e=>e.length>0})}hasColumn(e,t){const r=this.client.parameter(t,this.builder,this.bindingsHolder),n=this.client.parameter(this.formatter.wrap(nd(this.schema,e)),this.builder,this.bindingsHolder);this.pushQuery({sql:`select object_id from sys.columns where name = ${r} and object_id = object_id(${n})`,output:e=>e.length>0})}}function nd(e,t){return e?`${e}.${t}`:t}rd.prototype.dropTablePrefix="DROP TABLE ";var id=rd;const{isObject:sd}=Gi;class od extends da{constructor(e,t){super(e,t)}createQuery(e,t,r){let n=t?`if object_id('${this.tableName()}', 'U') is null `:"";n+=r?`SELECT * INTO ${this.tableName()} FROM ${this.tableNameLike()} WHERE 0=1`:"CREATE TABLE "+this.tableName()+(this._formatting?" (\n    ":" (")+e.sql.join(this._formatting?",\n    ":", ")+this._addChecks()+")",this.pushQuery(n),this.single.comment&&this.comment(this.single.comment),r&&this.addColumns(e,this.addColumnsPrefix)}comment(e){if(!e)return;e.length>3750&&this.client.logger.warn("Your comment might be longer than the max comment length for MSSQL of 7,500 bytes.");const t=this.formatter.escapingStringDelimiters(e),r=this.formatter.escapingStringDelimiters(this.schemaNameRaw||"dbo"),n=this.formatter.escapingStringDelimiters(this.tableNameRaw),i=`N'MS_Description', N'${t}', N'Schema', N'${r}', N'Table', N'${n}'`;this.pushQuery(`IF EXISTS(SELECT * FROM sys.fn_listextendedproperty(N'MS_Description', N'Schema', N'${r}', N'Table', N'${n}', NULL, NULL))\n  EXEC sys.sp_updateextendedproperty ${i}\nELSE\n  EXEC sys.sp_addextendedproperty ${i}`)}addColumns(e,t){t=t||this.addColumnsPrefix,e.sql.length>0&&this.pushQuery({sql:(this.lowerCase?"alter table ":"ALTER TABLE ")+this.tableName()+" "+t+e.sql.join(", "),bindings:e.bindings})}alterColumns(e,t){for(let e=0,r=t.length;e<r;e++){const r=t[e];if(r.modified.defaultTo){const e=`\n              DECLARE @constraint varchar(100) = (SELECT default_constraints.name\n                                                  FROM sys.all_columns\n                                                  INNER JOIN sys.tables\n                                                    ON all_columns.object_id = tables.object_id\n                                                  INNER JOIN sys.schemas\n                                                    ON tables.schema_id = schemas.schema_id\n                                                  INNER JOIN sys.default_constraints\n                                                    ON all_columns.default_object_id = default_constraints.object_id\n                                                  WHERE schemas.name = '${this.schemaNameRaw||"dbo"}'\n                                                  AND tables.name = '${this.tableNameRaw}'\n                                                  AND all_columns.name = '${r.getColumnName()}')\n\n              IF @constraint IS NOT NULL EXEC('ALTER TABLE ${this.tableNameRaw} DROP CONSTRAINT ' + @constraint)`;this.pushQuery(e)}}e.sql.forEach(t=>{this.pushQuery({sql:(this.lowerCase?"alter table ":"ALTER TABLE ")+this.tableName()+" "+(this.lowerCase?this.alterColumnPrefix.toLowerCase():this.alterColumnPrefix)+t,bindings:e.bindings})})}dropColumn(){const e=this,t=Ss.normalizeArr.apply(null,arguments),r=(Array.isArray(t)?t:[t]).map(t=>e.formatter.wrap(t)),n=this.schemaNameRaw||"dbo";for(const e of t)this.pushQuery(`\n              DECLARE @constraint varchar(100) = (SELECT default_constraints.name\n                                                  FROM sys.all_columns\n                                                  INNER JOIN sys.tables\n                                                    ON all_columns.object_id = tables.object_id\n                                                  INNER JOIN sys.schemas\n                                                    ON tables.schema_id = schemas.schema_id\n                                                  INNER JOIN sys.default_constraints\n                                                    ON all_columns.default_object_id = default_constraints.object_id\n                                                  WHERE schemas.name = '${n}'\n                                                  AND tables.name = '${this.tableNameRaw}'\n                                                  AND all_columns.name = '${e}')\n\n              IF @constraint IS NOT NULL EXEC('ALTER TABLE ${this.tableNameRaw} DROP CONSTRAINT ' + @constraint)`);this.pushQuery((this.lowerCase?"alter table ":"ALTER TABLE ")+this.tableName()+" "+this.dropColumnPrefix+r.join(", "))}changeType(){}renameColumn(e,t){this.pushQuery(`exec sp_rename ${this.client.parameter(this.tableName()+"."+e,this.tableBuilder,this.bindingsHolder)}, ${this.client.parameter(t,this.tableBuilder,this.bindingsHolder)}, 'COLUMN'`)}dropFKRefs(e,t){const r=this.client.formatter(this.tableBuilder);return Promise.all(t.map(function(t){const n=r.wrap(t.CONSTRAINT_NAME),i=r.wrap(t.TABLE_NAME);return e.query({sql:`ALTER TABLE ${i} DROP CONSTRAINT ${n}`})}))}createFKRefs(e,t){const r=this.client.formatter(this.tableBuilder);return Promise.all(t.map(function(t){const n=r.wrap(t.TABLE_NAME),i=r.wrap(t.CONSTRAINT_NAME),s=r.columnize(t.COLUMN_NAME),o=r.columnize(t.REFERENCED_COLUMN_NAME),a=r.wrap(t.REFERENCED_TABLE_NAME);return e.query({sql:`ALTER TABLE ${n} ADD CONSTRAINT ${i} FOREIGN KEY (`+s+") REFERENCES "+a+" ("+o+")"+` ON UPDATE ${t.UPDATE_RULE}`+` ON DELETE ${t.DELETE_RULE}`})}))}index(e,t,r){let n;t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),sd(r)&&({predicate:n}=r);const i=n?" "+this.client.queryCompiler(n).where():"";this.pushQuery(`CREATE INDEX ${t} ON ${this.tableName()} (${this.formatter.columnize(e)})${i}`)}primary(e,t){let r;sd(t)&&({constraintName:t,deferrable:r}=t),r&&"not deferrable"!==r&&this.client.logger.warn(`mssql: primary key constraint [${t}] will not be deferrable ${r} because mssql does not support deferred constraints.`),t=this.formatter.wrap(t||`${this.tableNameRaw}_pkey`),this.pushQuery(this.forCreate?`CONSTRAINT ${t} PRIMARY KEY (${this.formatter.columnize(e)})`:`ALTER TABLE ${this.tableName()} ADD CONSTRAINT ${t} PRIMARY KEY (${this.formatter.columnize(e)})`)}unique(e,t){let r,n=!1;sd(t)&&({indexName:t,deferrable:r,useConstraint:n}=t),r&&"not deferrable"!==r&&this.client.logger.warn(`mssql: unique index [${t}] will not be deferrable ${r} because mssql does not support deferred constraints.`),t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),Array.isArray(e)||(e=[e]);const i=e.map(e=>this.formatter.columnize(e)+" IS NOT NULL").join(" AND ");this.pushQuery(n?`ALTER TABLE ${this.tableName()} ADD CONSTRAINT ${t} UNIQUE (${this.formatter.columnize(e)})`:`CREATE UNIQUE INDEX ${t} ON ${this.tableName()} (${this.formatter.columnize(e)}) WHERE ${i}`)}dropIndex(e,t){t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),this.pushQuery(`DROP INDEX ${t} ON ${this.tableName()}`)}dropForeign(e,t){t=t?this.formatter.wrap(t):this._indexCommand("foreign",this.tableNameRaw,e),this.pushQuery(`ALTER TABLE ${this.tableName()} DROP CONSTRAINT ${t}`)}dropPrimary(e){e=this.formatter.wrap(e||`${this.tableNameRaw}_pkey`),this.pushQuery(`ALTER TABLE ${this.tableName()} DROP CONSTRAINT ${e}`)}dropUnique(e,t){t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`DROP INDEX ${t} ON ${this.tableName()}`)}}od.prototype.createAlterTableMethods=["foreign","primary"],od.prototype.lowerCase=!1,od.prototype.addColumnsPrefix="ADD ",od.prototype.dropColumnPrefix="DROP COLUMN ",od.prototype.alterColumnPrefix="ALTER COLUMN ";var ad=od;const{columnize:ld}=ho;var ud=class extends Ul{constructor(e,t){super(e,t)}createQuery(e,t,r,n){let i="CREATE "+(n?"OR ALTER ":"")+"VIEW "+this.viewName();i+=e?" ("+ld(e,this.viewBuilder,this.client,this.bindingsHolder)+")":"",i+=" AS ",i+=t.toString(),this.pushQuery({sql:i})}renameColumn(e,t){this.pushQuery(`exec sp_rename ${this.client.parameter(this.viewName()+"."+e,this.viewBuilder,this.bindingsHolder)}, ${this.client.parameter(t,this.viewBuilder,this.bindingsHolder)}, 'COLUMN'`)}createOrReplace(){this.createQuery(this.columns,this.selectQuery,!1,!0)}};const{toNumber:cd}=Ss,{formatDefault:hd}=ro,{operator:dd}=ho;class pd extends Ca{constructor(e,t,r){super(e,t,r),this.modifiers=["nullable","defaultTo","first","after","comment"],this._addCheckModifiers()}double(e,t){return"float"}floating(e,t){return"float"}integer(){return"int"}tinyint(){return"tinyint"}varchar(e){return`nvarchar(${cd(e,255)})`}timestamp({useTz:e=!1}={}){return e?"datetimeoffset":"datetime2"}bit(e){return e>1&&this.client.logger.warn("Bit field is exactly 1 bit length for MSSQL"),"bit"}binary(e){return e?`varbinary(${cd(e)})`:"varbinary(max)"}first(){return this.client.logger.warn("Column first modifier not available for MSSQL"),""}after(e){return this.client.logger.warn("Column after modifier not available for MSSQL"),""}defaultTo(e,{constraintName:t}={}){const r=hd(e,this.type,this.client);return t=void 0!==t?t:`${this.tableCompiler.tableNameRaw}_${this.getColumnName()}_default`.toLowerCase(),"alter"===this.columnBuilder._method?(this.pushAdditional(function(){this.pushQuery(`ALTER TABLE ${this.tableCompiler.tableName()} ADD CONSTRAINT ${this.formatter.wrap(t)} DEFAULT ${r} FOR ${this.formatter.wrap(this.getColumnName())}`)}),""):t?`CONSTRAINT ${this.formatter.wrap(t)} DEFAULT ${r}`:`DEFAULT ${r}`}comment(e){if(!e)return;e&&e.length>3750&&this.client.logger.warn("Your comment might be longer than the max comment length for MSSQL of 7,500 bytes.");const t=this.formatter.escapingStringDelimiters(e),r=this.tableCompiler.schemaNameRaw||"dbo",n=this.formatter.escapingStringDelimiters(this.tableCompiler.tableNameRaw),i=this.formatter.escapingStringDelimiters(this.args[0]||this.defaults("columnName")),s=`N'MS_Description', N'${t}', N'Schema', N'${r}', N'Table', N'${n}', N'Column', N'${i}'`;return this.pushAdditional(function(){this.pushQuery(`IF EXISTS(SELECT * FROM sys.fn_listextendedproperty(N'MS_Description', N'Schema', N'${r}', N'Table', N'${n}', N'Column', N'${i}'))\n  EXEC sys.sp_updateextendedproperty ${s}\nELSE\n  EXEC sys.sp_addextendedproperty ${s}`)}),""}checkLength(e,t,r){return this._check(`LEN(${this.formatter.wrap(this.getColumnName())}) ${dd(e,this.columnBuilder,this.bindingsHolder)} ${cd(t)}`,r)}checkRegex(e,t){return this._check(`${this.formatter.wrap(this.getColumnName())} LIKE ${this.client._escapeBinding("%"+e+"%")}`,t)}increments(e={primaryKey:!0}){return"int identity(1,1) not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}bigincrements(e={primaryKey:!0}){return"bigint identity(1,1) not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}}pd.prototype.bigint="bigint",pd.prototype.mediumint="int",pd.prototype.smallint="smallint",pd.prototype.text="nvarchar(max)",pd.prototype.mediumtext="nvarchar(max)",pd.prototype.longtext="nvarchar(max)",pd.prototype.json=pd.prototype.jsonb="nvarchar(max)",pd.prototype.enu="nvarchar(100)",pd.prototype.uuid=({useBinaryUuid:e=!1}={})=>e?"binary(16)":"uniqueidentifier",pd.prototype.datetime="datetime2",pd.prototype.bool="bit";var md=pd;const fd=Vi("knex:mssql");class gd extends tu{constructor(e={}){super(e)}_generateConnection(){const e=this.connectionSettings;e.options=e.options||{};const t={authentication:{type:e.type||"default",options:{userName:e.userName||e.user,password:e.password,domain:e.domain,token:e.token,clientId:e.clientId,clientSecret:e.clientSecret,tenantId:e.tenantId,msiEndpoint:e.msiEndpoint}},server:e.server||e.host,options:{database:e.database,encrypt:e.encrypt||!1,port:e.port||1433,connectTimeout:e.connectionTimeout||e.timeout||15e3,requestTimeout:bt.default(e.requestTimeout)?15e3:e.requestTimeout,rowCollectionOnDone:!1,rowCollectionOnRequestCompletion:!1,useColumnNames:!1,tdsVersion:e.options.tdsVersion||"7_4",appName:e.options.appName||"knex",trustServerCertificate:!1,...e.options}};return t.options.instanceName&&delete t.options.port,isNaN(t.options.requestTimeout)&&(t.options.requestTimeout=15e3),Infinity===t.options.requestTimeout&&(t.options.requestTimeout=0),t.options.requestTimeout<0&&(t.options.requestTimeout=0),e.debug&&(t.options.debug={packet:!0,token:!0,data:!0,payload:!0}),t}_driver(){return ah}formatter(){return new zh(this,...arguments)}transaction(){return new Gh(this,...arguments)}queryCompiler(){return new td(this,...arguments)}schemaCompiler(){return new id(this,...arguments)}tableCompiler(){return new ad(this,...arguments)}viewCompiler(){return new ud(this,...arguments)}queryBuilder(){return new eo(this)}columnCompiler(){return new md(this,...arguments)}wrapIdentifierImpl(e){return"*"===e?"*":`[${e.replace(/[[\]]+/g,"")}]`}acquireRawConnection(){return new Promise((e,t)=>{fd("connection::connection new connection requested");const r=this._driver(),n=Object.assign({},this._generateConnection()),i=new r.Connection(n);i.connect(r=>r?(fd("connection::connect error: %s",r.message),t(r)):(fd("connection::connect connected to server"),i.connected=!0,i.on("error",e=>{fd("connection::error message=%s",e.message),i.__knex__disposed=e,i.connected=!1}),i.once("end",()=>{i.connected=!1,i.__knex__disposed="Connection to server was terminated.",fd("connection::end connection ended.")}),e(i)))})}validateConnection(e){return e&&e.connected}destroyRawConnection(e){return fd("connection::destroy"),new Promise(t=>{e.once("end",()=>{t()}),e.close()})}positionBindings(e){let t=-1;return e.replace(/\\?\?/g,e=>"\\?"===e?"?":(t+=1,`@p${t}`))}_chomp(e){if("LoggedIn"===e.state.name){const t=this.requestQueue.pop();t&&(fd("connection::query executing query, %d more in queue",this.requestQueue.length),e.execSql(t))}}_enqueueRequest(e,t){this.requestQueue.push(e),this._chomp(t)}_makeRequest(e,t){const r=this._driver(),n="string"==typeof e?e:e.sql;let i=0;if(!n)throw new Error("The query is empty");fd("request::request sql=%s",n);const s=new r.Request(n,(e,r)=>{if(e)return fd("request::error message=%s",e.message),t(e);i=r,fd("request::callback rowCount=%d",i)});return s.on("prepared",()=>{fd("request %s::request prepared",this.id)}),s.on("done",(e,t)=>{fd("request::done rowCount=%d more=%s",e,t)}),s.on("doneProc",(e,t)=>{fd("request::doneProc id=%s rowCount=%d more=%s",s.id,e,t)}),s.on("doneInProc",(e,t)=>{fd("request::doneInProc id=%s rowCount=%d more=%s",s.id,e,t)}),s.once("requestCompleted",()=>(fd("request::completed id=%s",s.id),t(null,i))),s.on("error",e=>(fd("request::error id=%s message=%s",s.id,e.message),t(e))),s}_stream(e,t,r){return new Promise((n,i)=>{const s=this._makeRequest(t,e=>{if(e)return r.emit("error",e),i(e);n()});s.on("row",e=>{r.write(e.reduce((e,t)=>({...e,[t.metadata.colName]:t.value}),{}))}),s.on("error",e=>{r.emit("error",e),i(e)}),s.once("requestCompleted",()=>{r.end(),n()}),this._assignBindings(s,t.bindings),this._enqueueRequest(s,e)})}_assignBindings(e,t){if(Array.isArray(t))for(let r=0;r<t.length;r++)this._setReqInput(e,r,t[r])}_scaleForBinding(e){if(e%1==0)throw new Error(`The binding value ${e} must be a decimal number.`);return{scale:10}}_typeForBinding(e){const t=this._driver();if(this.connectionSettings.options&&this.connectionSettings.options.mapBinding){const t=this.connectionSettings.options.mapBinding(e);if(t)return[t.value,t.type]}switch(typeof e){case"string":return[e,t.TYPES.NVarChar];case"boolean":return[e,t.TYPES.Bit];case"number":if(e%1!=0)return[e,t.TYPES.Float];if(e<-2147483648||e>2147483647){if(e<-9007199254740991||e>9007199254740991)throw new Error(`Bigint must be safe integer or must be passed as string, saw ${e}`);return[e,t.TYPES.BigInt]}return[e,t.TYPES.Int];default:return e instanceof Date?[e,t.TYPES.DateTime]:e instanceof Buffer?[e,t.TYPES.VarBinary]:[e,t.TYPES.NVarChar]}}_query(e,t){return new Promise((r,n)=>{const i=[],s=this._makeRequest(t,(s,o)=>{if(s)return n(s);t.response=i,process.nextTick(()=>this._chomp(e)),r(t)});s.on("row",e=>{fd("request::row"),i.push(e)}),this._assignBindings(s,t.bindings),this._enqueueRequest(s,e)})}_setReqInput(e,t,r){const[n,i]=this._typeForBinding(r),s="p".concat(t);let o;"number"==typeof n&&n%1!=0&&(o=this._scaleForBinding(n)),fd("request::binding pos=%d type=%s value=%s",t,i.name,n),Buffer.isBuffer(n)&&(o={length:"max"}),e.addParameter(s,i,n,o)}processResponse(e,t){if(null==e)return;let{response:r}=e;const{method:n}=e;if(e.output)return e.output.call(t,r);if(r=r.map(e=>e.reduce((e,t)=>{const r=t.metadata.colName;return e[r]?(Array.isArray(e[r])||(e[r]=[e[r]]),e[r].push(t.value)):e[r]=t.value,e},{})),e.output)return e.output.call(t,r);switch(n){case"select":default:return r;case"first":return r[0];case"pluck":return at.default(r,e.pluck);case"insert":case"del":case"update":case"counter":return e.returning&&"@@rowcount"===e.returning?r[0][""]:r}}}Object.assign(gd.prototype,{requestQueue:[],dialect:"mssql",driverName:"mssql"});var yd=gd;const bd=Vi("knex:tx");var wd=class extends ys{query(e,t,r,n){const i=this,s=this.trxClient.query(e,t).catch(e=>{1305!==e.errno?(r=2,n=e,i._completed=!0,bd("%s error running transaction query",i.txid)):this.trxClient.logger.warn("Transaction was implicitly committed, do not mix transactions and DDL with MySQL (#805)")}).then(function(e){if(1===r&&i._resolver(n),2===r){if(void 0===n){if(i.doNotRejectOnRollback&&/^ROLLBACK\b/i.test(t))return void i._resolver();n=new Error(`Transaction rejected with non-error: ${n}`)}i._rejecter(n)}return e});return 1!==r&&2!==r||(i._completed=!0),s}};const{wrapAsIdentifier:vd}=ro,{columnize:_d,wrap:Ed}=ho;var Cd=class extends Lo{constructor(e,t,r){super(e,t,r);const{returning:n}=this.single;n&&this.client.logger.warn(".returning() is not supported by mysql and will not have any effect."),this._emptyInsertValue="() values ()"}insert(){let e=super.insert();if(""===e)return e;const{ignore:t,merge:r,insert:n}=this.single;if(t&&(e=e.replace("insert into","insert ignore into")),r&&(e+=this._merge(r.updates,n),this.where()))throw new Error(".onConflict().merge().where() is not supported for mysql");return e}_merge(e,t){const r=" on duplicate key update ";if(e&&Array.isArray(e))return r+e.map(e=>vd(e,this.formatter.builder,this.client)).map(e=>`${e} = values(${e})`).join(", ");if(e&&"object"==typeof e)return r+this._prepUpdate(e).join(",");{const e=this._prepInsert(t);if("string"==typeof e)throw new Error("If using merge with a raw insert query, then updates must be provided");return r+e.columns.map(e=>vd(e,this.builder,this.client)).map(e=>`${e} = values(${e})`).join(", ")}}update(){const e=this.with(),t=this.join(),r=this._prepUpdate(this.single.update),n=this.where(),i=this.order(),s=this.limit();return e+`update ${this.tableName}`+(t?` ${t}`:"")+" set "+r.join(", ")+(n?` ${n}`:"")+(i?` ${i}`:"")+(s?` ${s}`:"")}forUpdate(){return"for update"}forShare(){return"lock in share mode"}skipLocked(){return"skip locked"}noWait(){return"nowait"}columnInfo(){const e=this.single.columnInfo;return{sql:"select * from information_schema.columns where table_name = ? and table_schema = ?",bindings:[this.client.customWrapIdentifier(this.single.table,mt.default),this.client.database()],output(t){const r=t.reduce(function(e,t){return e[t.COLUMN_NAME]={defaultValue:"NULL"===t.COLUMN_DEFAULT?null:t.COLUMN_DEFAULT,type:t.DATA_TYPE,maxLength:t.CHARACTER_MAXIMUM_LENGTH,nullable:"YES"===t.IS_NULLABLE},e},{});return e&&r[e]||r}}}limit(){const e=!this.single.limit&&0!==this.single.limit;return e&&!this.single.offset?"":`limit ${this.single.offset&&e?"18446744073709551615":this._getValueOrParameterFromAttribute("limit")}`}whereLike(e){return`${this._columnClause(e)} ${this._not(e,"like ")}${this._valueClause(e)} COLLATE utf8_bin`}whereILike(e){return`${this._columnClause(e)} ${this._not(e,"like ")}${this._valueClause(e)}`}jsonExtract(e){return this._jsonExtract(["json_extract","json_unquote"],e)}jsonSet(e){return this._jsonSet("json_set",e)}jsonInsert(e){return this._jsonSet("json_insert",e)}jsonRemove(e){const t=`json_remove(${_d(e.column,this.builder,this.client,this.bindingsHolder)},${this.client.parameter(e.path,this.builder,this.bindingsHolder)})`;return e.alias?this.client.alias(t,this.formatter.wrap(e.alias)):t}whereJsonObject(e){return this._not(e,`json_contains(${this._columnClause(e)}, ${this._jsonValueClause(e)})`)}whereJsonPath(e){return this._whereJsonPath("json_extract",e)}whereJsonSupersetOf(e){return this._not(e,`json_contains(${Ed(e.column,void 0,this.builder,this.client,this.bindingsHolder)},${this._jsonValueClause(e)})`)}whereJsonSubsetOf(e){return this._not(e,`json_contains(${this._jsonValueClause(e)},${Ed(e.column,void 0,this.builder,this.client,this.bindingsHolder)})`)}onJsonPathEquals(e){return this._onJsonPathEquals("json_extract",e)}},Nd=class extends ea{constructor(e,t){super(e,t)}renameTable(e,t){this.pushQuery(`rename table ${this.formatter.wrap(e)} to ${this.formatter.wrap(t)}`)}renameView(e,t){this.renameTable(e,t)}hasTable(e){let t="select * from information_schema.tables where table_name = ?";const r=[e];this.schema?(t+=" and table_schema = ?",r.push(this.schema)):t+=" and table_schema = database()",this.pushQuery({sql:t,bindings:r,output:function(e){return e.length>0}})}hasColumn(e,t){this.pushQuery({sql:`show columns from ${this.formatter.wrap(e)}`,output(e){return e.some(e=>this.client.wrapIdentifier(e.Field.toLowerCase())===this.client.wrapIdentifier(t.toLowerCase()))}})}};const{isObject:xd,isString:$d}=Gi;class Ad extends da{constructor(e,t){super(e,t)}createQuery(e,t,r){const n=t?"create table if not exists ":"create table ",{client:i}=this;let s={},o=" ("+e.sql.join(", ");o+=this.primaryKeys()||"",o+=this._addChecks(),o+=")";let a=n+this.tableName()+(r&&this.tableNameLike()?" like "+this.tableNameLike():o);i.connectionSettings&&(s=i.connectionSettings);const l=this.single.charset||s.charset||"",u=this.single.collate||s.collate||"",c=this.single.engine||"";if(l&&!r&&(a+=` default character set ${l}`),u&&(a+=` collate ${u}`),c&&(a+=` engine = ${c}`),this.single.comment){const e=this.single.comment||"",t=1024;e.length>t&&this.client.logger.warn(`The max length for a table comment is ${t} characters`),a+=` comment = '${e}'`}this.pushQuery(a),r&&this.addColumns(e,this.addColumnsPrefix)}comment(e){this.pushQuery(`alter table ${this.tableName()} comment = '${e}'`)}changeType(){}renameColumn(e,t){const r=this,n=this.tableName(),i=this.formatter.wrap(e)+" "+this.formatter.wrap(t);this.pushQuery({sql:`show full fields from ${n} where field = `+this.client.parameter(e,this.tableBuilder,this.bindingsHolder),output(s){const o=s[0],a=this;return r.getFKRefs(a).then(([s])=>new Promise((e,t)=>{try{s.length||e(),e(r.dropFKRefs(a,s))}catch(e){t(e)}}).then(function(){let e=`alter table ${n} change ${i} ${o.Type}`;return"YES"!==String(o.Null).toUpperCase()?e+=" NOT NULL":e+=" NULL",null!=o.Default&&(e+=` DEFAULT '${o.Default}'`),null!=o.Collation&&(e+=` COLLATE '${o.Collation}'`),"auto_increment"==o.Extra&&(e+=" AUTO_INCREMENT"),a.query({sql:e})}).then(function(){if(s.length)return r.createFKRefs(a,s.map(function(r){return r.REFERENCED_COLUMN_NAME===e&&(r.REFERENCED_COLUMN_NAME=t),r.COLUMN_NAME===e&&(r.COLUMN_NAME=t),r}))}))}})}primaryKeys(){const e=(this.grouped.alterTable||[]).filter(e=>"primary"===e.method);if(e.length>0&&e[0].args.length>0){const t=e[0].args[0];let r=e[0].args[1]||"";if(r&&(r=" constraint "+this.formatter.wrap(r)),this.grouped.columns){const e=this._getIncrementsColumnNames();e.length&&e.forEach(e=>{t.includes(e)||t.unshift(e)})}return`,${r} primary key (${this.formatter.columnize(t)})`}}getFKRefs(e){const t={bindings:[]},r="SELECT KCU.CONSTRAINT_NAME, KCU.TABLE_NAME, KCU.COLUMN_NAME,        KCU.REFERENCED_TABLE_NAME, KCU.REFERENCED_COLUMN_NAME,        RC.UPDATE_RULE, RC.DELETE_RULE FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS KCU JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS AS RC        USING(CONSTRAINT_NAME)WHERE KCU.REFERENCED_TABLE_NAME = "+this.client.parameter(this.tableNameRaw,this.tableBuilder,t)+"   AND KCU.CONSTRAINT_SCHEMA = "+this.client.parameter(this.client.database(),this.tableBuilder,t)+"   AND RC.CONSTRAINT_SCHEMA = "+this.client.parameter(this.client.database(),this.tableBuilder,t);return e.query({sql:r,bindings:t.bindings})}dropFKRefs(e,t){const r=this.client.formatter(this.tableBuilder);return Promise.all(t.map(function(t){const n=r.wrap(t.CONSTRAINT_NAME),i=r.wrap(t.TABLE_NAME);return e.query({sql:`alter table ${i} drop foreign key ${n}`})}))}createFKRefs(e,t){const r=this.client.formatter(this.tableBuilder);return Promise.all(t.map(function(t){const n=r.wrap(t.TABLE_NAME),i=r.wrap(t.CONSTRAINT_NAME),s=r.columnize(t.COLUMN_NAME),o=r.columnize(t.REFERENCED_COLUMN_NAME),a=r.wrap(t.REFERENCED_TABLE_NAME);return e.query({sql:`alter table ${n} add constraint ${i} foreign key (`+s+") references "+a+" ("+o+")"+` ON UPDATE ${t.UPDATE_RULE}`+` ON DELETE ${t.DELETE_RULE}`})}))}index(e,t,r){let n,i;$d(r)?i=r:xd(r)&&({indexType:i,storageEngineIndexType:n}=r),t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),n=n?` using ${n}`:"",this.pushQuery(`alter table ${this.tableName()} add${i?` ${i}`:""} index ${t}(${this.formatter.columnize(e)})${n}`)}primary(e,t){let r;xd(t)&&({constraintName:t,deferrable:r}=t),r&&"not deferrable"!==r&&this.client.logger.warn(`mysql: primary key constraint \`${t}\` will not be deferrable ${r} because mysql does not support deferred constraints.`),t=this.formatter.wrap(t||`${this.tableNameRaw}_pkey`);const n=e;let i=[];this.grouped.columns&&(i=this._getIncrementsColumnNames(),i&&i.forEach(e=>{n.includes(e)||n.unshift(e)})),"create"!==this.method&&"createIfNot"!==this.method&&this.pushQuery(`alter table ${this.tableName()} add primary key ${t}(${this.formatter.columnize(n)})`),i.length&&this.pushQuery(`alter table ${this.tableName()} modify column ${this.formatter.columnize(i)} int unsigned not null auto_increment`)}unique(e,t){let r,n;xd(t)&&({indexName:t,deferrable:n,storageEngineIndexType:r}=t),n&&"not deferrable"!==n&&this.client.logger.warn(`mysql: unique index \`${t}\` will not be deferrable ${n} because mysql does not support deferred constraints.`),t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),r=r?` using ${r}`:"",this.pushQuery(`alter table ${this.tableName()} add unique ${t}(${this.formatter.columnize(e)})${r}`)}dropIndex(e,t){t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop index ${t}`)}dropForeign(e,t){t=t?this.formatter.wrap(t):this._indexCommand("foreign",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop foreign key ${t}`)}dropPrimary(){this.pushQuery(`alter table ${this.tableName()} drop primary key`)}dropUnique(e,t){t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop index ${t}`)}}Ad.prototype.addColumnsPrefix="add ",Ad.prototype.alterColumnsPrefix="modify ",Ad.prototype.dropColumnPrefix="drop ";var Td=Ad;const{isObject:Rd}=Gi,{toNumber:Sd}=Ss,Od=/(?<!\\)'/g;class Id extends Ca{constructor(e,t,r){super(e,t,r),this.modifiers=["unsigned","nullable","defaultTo","comment","collate","first","after"],this._addCheckModifiers()}double(e,t){return e?`double(${Sd(e,8)}, ${Sd(t,2)})`:"double"}integer(e){return"int"+(e?`(${Sd(e,11)})`:"")}tinyint(e){return"tinyint"+(e?`(${Sd(e,1)})`:"")}text(e){switch(e){case"medium":case"mediumtext":return"mediumtext";case"long":case"longtext":return"longtext";default:return"text"}}mediumtext(){return this.text("medium")}longtext(){return this.text("long")}enu(e){return`enum('${e.join("', '")}')`}datetime(e){return Rd(e)&&({precision:e}=e),"number"==typeof e?`datetime(${e})`:"datetime"}timestamp(e){return Rd(e)&&({precision:e}=e),"number"==typeof e?`timestamp(${e})`:"timestamp"}time(e){return Rd(e)&&({precision:e}=e),"number"==typeof e?`time(${e})`:"time"}bit(e){return e?`bit(${Sd(e)})`:"bit"}binary(e){return e?`varbinary(${Sd(e)})`:"blob"}json(){return"json"}jsonb(){return"json"}defaultTo(e){if(null==e)return;if(("json"===this.type||"jsonb"===this.type)&&Rd(e))return`default ('${JSON.stringify(e)}')`;const t=super.defaultTo.apply(this,arguments);return"blob"!==this.type&&-1===this.type.indexOf("text")?t:""}unsigned(){return"unsigned"}comment(e){return e&&e.length>255&&this.client.logger.warn("Your comment is longer than the max comment length for MySQL"),e&&`comment '${e.replace(Od,"\\'")}'`}first(){return"first"}after(e){return`after ${this.formatter.wrap(e)}`}collate(e){return e&&`collate '${e}'`}checkRegex(e,t){return this._check(`${this.formatter.wrap(this.getColumnName())} REGEXP ${this.client._escapeBinding(e)}`,t)}increments(e={primaryKey:!0}){return"int unsigned not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" auto_increment primary key":"")}bigincrements(e={primaryKey:!0}){return"bigint unsigned not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" auto_increment primary key":"")}}Id.prototype.bigint="bigint",Id.prototype.mediumint="mediumint",Id.prototype.smallint="smallint";var jd=Id,qd=class extends Ul{constructor(e,t){super(e,t)}createOrReplace(){this.createQuery(this.columns,this.selectQuery,!1,!0)}},kd=class extends Pl{constructor(){super(...arguments)}checkOption(){this._single.checkOption="default_option"}localCheckOption(){this._single.checkOption="local"}cascadedCheckOption(){this._single.checkOption="cascaded"}};const{promisify:Pd}=Ce.default,{makeEscape:Ld}=Oi;class Bd extends tu{_driver(){return ah}queryCompiler(e,t){return new Cd(this,e,t)}schemaCompiler(){return new Nd(this,...arguments)}tableCompiler(){return new Td(this,...arguments)}viewCompiler(){return new qd(this,...arguments)}viewBuilder(){return new kd(this,...arguments)}columnCompiler(){return new jd(this,...arguments)}transaction(){return new wd(this,...arguments)}wrapIdentifierImpl(e){return"*"!==e?`\`${e.replace(/`/g,"``")}\``:"*"}acquireRawConnection(){return new Promise((e,t)=>{const r=this.driver.createConnection(this.connectionSettings);r.on("error",e=>{r.__knex__disposed=e}),r.connect(n=>{if(n)return r.removeAllListeners(),t(n);e(r)})})}async destroyRawConnection(e){try{const t=Pd(t=>e.end(t));return await t()}catch(t){e.__knex__disposed=t}finally{wt.default(()=>e.removeAllListeners())}}validateConnection(e){return"connected"===e.state||"authenticated"===e.state}_stream(e,t,r,n){if(!t.sql)throw new Error("The query is empty");n=n||{};const i=Object.assign({sql:t.sql},t.options);return new Promise((s,o)=>{r.on("error",o),r.on("end",s);const a=e.query(i,t.bindings).stream(n);a.on("error",e=>{o(e),r.emit("error",e)}),a.pipe(r)})}_query(e,t){if(t&&"string"!=typeof t||(t={sql:t}),!t.sql)throw new Error("The query is empty");return new Promise(function(r,n){if(!t.sql)return void r();const i=Object.assign({sql:t.sql},t.options);e.query(i,t.bindings,function(e,i,s){if(e)return n(e);t.response=[i,s],r(t)})})}processResponse(e,t){if(null==e)return;const{response:r}=e,{method:n}=e,i=r[0];if(e.output)return e.output.call(t,i,r[1]);switch(n){case"select":return i;case"first":return i[0];case"pluck":return at.default(i,e.pluck);case"insert":return[i.insertId];case"del":case"update":case"counter":return i.affectedRows;default:return r}}async cancelQuery(e){const t=await this.acquireRawConnection();try{return await this._wrappedCancelQueryCall(t,e)}finally{await this.destroyRawConnection(t),t.__knex__disposed&&this.logger.warn(`Connection Error: ${t.__knex__disposed}`)}}_wrappedCancelQueryCall(e,t){return this._query(e,{sql:"KILL QUERY ?",bindings:[t.threadId],options:{}})}}Object.assign(Bd.prototype,{dialect:"mysql",driverName:"mysql",_escapeBinding:Ld(),canCancelQuery:!0});var Md=Bd;const Ud=Vi("knex:tx");var Dd=class extends ys{query(e,t,r,n){const i=this,s=this.trxClient.query(e,t).catch(e=>{"ER_SP_DOES_NOT_EXIST"!==e.code?(r=2,n=e,i._completed=!0,Ud("%s error running transaction query",i.txid)):this.trxClient.logger.warn("Transaction was implicitly committed, do not mix transactions and DDL with MySQL (#805)")}).then(function(e){if(1===r&&i._resolver(n),2===r){if(void 0===n){if(i.doNotRejectOnRollback&&/^ROLLBACK\b/i.test(t))return void i._resolver();n=new Error(`Transaction rejected with non-error: ${n}`)}return i._rejecter(n),e}});return 1!==r&&2!==r||(i._completed=!0),s}};class Fd extends Md{transaction(){return new Dd(this,...arguments)}_driver(){return ah}validateConnection(e){return e&&!e._fatalError&&!e._protocolError&&!e._closing&&!e.stream.destroyed}}Object.assign(Fd.prototype,{driverName:"mysql2"});var Qd=Fd;function Hd(e){this.columnName=e}Hd.prototype.toString=function(){return`[object ReturningHelper:${this.columnName}]`};var Wd={generateCombinedName:function(e,t,r,n){const i=Ne.default;Array.isArray(n)||(n=n?[n]:[]);const s=r.replace(/\.|-/g,"_"),o=n.join("_");let a=`${s}_${o.length?o+"_":""}${t}`.toLowerCase();return a.length>30&&(e.warn(`Automatically generated name "${a}" exceeds 30 character limit for Oracle. Using base64 encoded sha1 of that name instead.`),a=i.createHash("sha1").update(a).digest("base64").replace("=","")),a},isConnectionError:function(e){return["DPI-1010","DPI-1080","ORA-03114","ORA-03113","ORA-03135","ORA-12514","ORA-00022","ORA-00028","ORA-00031","ORA-00045","ORA-00378","ORA-00602","ORA-00603","ORA-00609","ORA-01012","ORA-01041","ORA-01043","ORA-01089","ORA-01092","ORA-02396","ORA-03122","ORA-12153","ORA-12537","ORA-12547","ORA-12570","ORA-12583","ORA-27146","ORA-28511","ORA-56600","NJS-024","NJS-003"].some(function(t){return 0===e.message.indexOf(t)})},wrapSqlWithCatch:function(e,t){return`begin execute immediate '${e.replace(/'/g,"''")}'; exception when others then if sqlcode != ${t} then raise; end if; end;`},ReturningHelper:Hd},Jd=class extends ea{constructor(){super(...arguments)}renameTable(e,t){const r=function(e,t,r){const n=Wd.generateCombinedName(e,"autoinc_trg",t),i=Wd.generateCombinedName(e,"seq",t),s=Wd.generateCombinedName(e,"autoinc_trg",r),o=Wd.generateCombinedName(e,"seq",r);return`DECLARE PK_NAME VARCHAR(200); IS_AUTOINC NUMBER := 0; BEGIN  EXECUTE IMMEDIATE ('RENAME "${t}" TO "${r}"');  SELECT COUNT(*) INTO IS_AUTOINC from "USER_TRIGGERS" where trigger_name = '${n}';  IF (IS_AUTOINC > 0) THEN    EXECUTE IMMEDIATE ('DROP TRIGGER "${n}"');    EXECUTE IMMEDIATE ('RENAME "${i}" TO "${o}"');    SELECT cols.column_name INTO PK_NAME    FROM all_constraints cons, all_cons_columns cols    WHERE cons.constraint_type = 'P'    AND cons.constraint_name = cols.constraint_name    AND cons.owner = cols.owner    AND cols.table_name = '${r}';    EXECUTE IMMEDIATE ('create or replace trigger "${s}"    BEFORE INSERT on "${r}" for each row      declare      checking number := 1;      begin        if (:new."' || PK_NAME || '" is null) then          while checking >= 1 loop            select "${o}".nextval into :new."' || PK_NAME || '" from dual;            select count("' || PK_NAME || '") into checking from "${r}"            where "' || PK_NAME || '" = :new."' || PK_NAME || '";          end loop;        end if;      end;');  end if;END;`}(this.client.logger,e,t);this.pushQuery(r)}hasTable(e){this.pushQuery({sql:"select TABLE_NAME from USER_TABLES where TABLE_NAME = "+this.client.parameter(e,this.builder,this.bindingsHolder),output:e=>e.length>0})}hasColumn(e,t){const r=`select COLUMN_NAME from ALL_TAB_COLUMNS where TABLE_NAME = ${this.client.parameter(e,this.builder,this.bindingsHolder)} and COLUMN_NAME = ${this.client.parameter(t,this.builder,this.bindingsHolder)}`;this.pushQuery({sql:r,output:e=>e.length>0})}dropSequenceIfExists(e){this.pushQuery(Wd.wrapSqlWithCatch(`drop sequence ${this.schema?`"${this.schema}".`:""}${this.formatter.wrap(e)}`,-2289))}_dropRelatedSequenceIfExists(e){const t=Wd.generateCombinedName(this.client.logger,"seq",e);this.dropSequenceIfExists(t)}dropTable(e){this.pushQuery(`drop table ${this.schema?`"${this.schema}".`:""}${this.formatter.wrap(e)}`),this._dropRelatedSequenceIfExists(e)}dropTableIfExists(e){this.dropObject(e,"table")}dropViewIfExists(e){this.dropObject(e,"view")}dropObject(e,t){let r=-942;"materialized view"===t&&(r=-12003),this.pushQuery(Wd.wrapSqlWithCatch(`drop ${t} ${this.schema?`"${this.schema}".`:""}${this.formatter.wrap(e)}`,r)),this._dropRelatedSequenceIfExists(e)}refreshMaterializedView(e){return this.pushQuery({sql:`BEGIN DBMS_MVIEW.REFRESH('${this.schemaNameRaw?this.schemaNameRaw+".":""}${e}'); END;`})}dropMaterializedView(e){this._dropView(e,!1,!0)}dropMaterializedViewIfExists(e){this.dropObject(e,"materialized view")}},Vd=class extends ba{constructor(){super(...arguments)}checkIn(){return this._modifiers.checkIn=et.default(arguments),this}},zd={createAutoIncrementTriggerAndSequence:function(e){e.pushAdditional(function(){const e=function(e,t,r){const n=`"${t}"`,i=t,s=r?`"${r}".`:"",o=r?`'${r}'`:"cols.owner",a=Wd.generateCombinedName(e,"autoinc_trg",t),l=`"${Wd.generateCombinedName(e,"seq",t)}"`;return`DECLARE PK_NAME VARCHAR(200); BEGIN  EXECUTE IMMEDIATE ('CREATE SEQUENCE ${s}${l}');  SELECT cols.column_name INTO PK_NAME  FROM all_constraints cons, all_cons_columns cols  WHERE cons.constraint_type = 'P'  AND cons.constraint_name = cols.constraint_name  AND cons.owner = ${o}  AND cols.table_name = '${i}';  execute immediate ('create or replace trigger ${s}"${a}"  BEFORE INSERT on ${s}${n}  for each row  declare  checking number := 1;  begin    if (:new."' || PK_NAME || '" is null) then      while checking >= 1 loop        select ${s}${l}.nextval into :new."' || PK_NAME || '" from dual;        select count("' || PK_NAME || '") into checking from ${s}${n}        where "' || PK_NAME || '" = :new."' || PK_NAME || '";      end loop;    end if;  end;'); END;`}(this.client.logger,this.tableCompiler.tableNameRaw,this.tableCompiler.schemaNameRaw);this.pushQuery(e)})}};const{createAutoIncrementTriggerAndSequence:Kd}=zd,{toNumber:Gd}=Ss;class Yd extends Ca{constructor(){super(...arguments),this.modifiers=["defaultTo","checkIn","nullable","comment"]}increments(e={primaryKey:!0}){return Kd(this),"integer not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}bigincrements(e={primaryKey:!0}){return Kd(this),"number(20, 0) not null"+(this.tableCompiler._canBeAddPrimaryKey(e)?" primary key":"")}floating(e){const t=Gd(e,0);return"float"+(t?`(${t})`:"")}double(e,t){return`number(${Gd(e,8)}, ${Gd(t,2)})`}decimal(e,t){return null===e?"decimal":`decimal(${Gd(e,8)}, ${Gd(t,2)})`}integer(e){return e?`number(${Gd(e,11)})`:"integer"}enu(e){const t=((e=vt.default(e))||[]).reduce((e,t)=>Math.max(e,String(t).length),1);return this.columnBuilder._modifiers.checkIn=[e],`varchar2(${t})`}datetime(e){return e?"timestamp":"timestamp with time zone"}timestamp(e){return e?"timestamp":"timestamp with time zone"}bool(){return this.columnBuilder._modifiers.checkIn=[[0,1]],"number(1, 0)"}varchar(e){return`varchar2(${Gd(e,255)})`}comment(e){const t=this.args[0]||this.defaults("columnName");this.pushAdditional(function(){this.pushQuery(`comment on column ${this.tableCompiler.tableName()}.`+this.formatter.wrap(t)+" is '"+(e||"")+"'")},e)}checkIn(e){return void 0===e?"":(e=e instanceof xo?e.toQuery():Array.isArray(e)?e.map(e=>`'${e}'`).join(", "):`'${e}'`,`check (${this.formatter.wrap(this.args[0])} in (${e}))`)}}Yd.prototype.tinyint="smallint",Yd.prototype.smallint="smallint",Yd.prototype.mediumint="integer",Yd.prototype.biginteger="number(20, 0)",Yd.prototype.text="clob",Yd.prototype.time="timestamp with time zone",Yd.prototype.bit="clob",Yd.prototype.json="clob";var Xd=Yd;const{isObject:Zd}=Gi;class ep extends da{constructor(){super(...arguments)}addColumns(e,t){if(e.sql.length>0){t=t||this.addColumnsPrefix;const r=e.sql;let n=`${this.lowerCase?"alter table ":"ALTER TABLE "}${this.tableName()} ${t}`;n+=e.sql.length>1?`(${r.join(", ")})`:r.join(", "),this.pushQuery({sql:n,bindings:e.bindings})}}renameColumn(e,t){const r=this.tableName().slice(1,-1);return this.pushQuery(function(e,t,r,n){const i=Wd.generateCombinedName(e,"autoinc_trg",t);return`DECLARE PK_NAME VARCHAR(200); IS_AUTOINC NUMBER := 0; BEGIN  EXECUTE IMMEDIATE ('ALTER TABLE "${t}" RENAME COLUMN "${r}" TO "${n}"');  SELECT COUNT(*) INTO IS_AUTOINC from "USER_TRIGGERS" where trigger_name = '${i}';  IF (IS_AUTOINC > 0) THEN    SELECT cols.column_name INTO PK_NAME    FROM all_constraints cons, all_cons_columns cols    WHERE cons.constraint_type = 'P'    AND cons.constraint_name = cols.constraint_name    AND cons.owner = cols.owner    AND cols.table_name = '${t}';    IF ('${n}' = PK_NAME) THEN      EXECUTE IMMEDIATE ('DROP TRIGGER "${i}"');      EXECUTE IMMEDIATE ('create or replace trigger "${i}"      BEFORE INSERT on "${t}" for each row        declare        checking number := 1;        begin          if (:new."${n}" is null) then            while checking >= 1 loop              select "${Wd.generateCombinedName(e,"seq",t)}".nextval into :new."${n}" from dual;              select count("${n}") into checking from "${t}"              where "${n}" = :new."${n}";            end loop;          end if;        end;');    end if;  end if;END;`}(this.client.logger,r,e,t))}compileAdd(e){const t=this.formatter.wrap(e),r=this.prefixArray("add column",this.getColumns(e));return this.pushQuery({sql:`alter table ${t} ${r.join(", ")}`})}createQuery(e,t,r){const n=r&&this.tableNameLike()?" as (select * from "+this.tableNameLike()+" where 0=1)":" ("+e.sql.join(", ")+this._addChecks()+")",i=`create table ${this.tableName()}${n}`;this.pushQuery({sql:t?Wd.wrapSqlWithCatch(i,-955):i,bindings:e.bindings}),this.single.comment&&this.comment(this.single.comment),r&&this.addColumns(e,this.addColumnsPrefix)}comment(e){this.pushQuery(`comment on table ${this.tableName()} is '${e}'`)}dropColumn(){const e=Ss.normalizeArr.apply(null,arguments);this.pushQuery(`alter table ${this.tableName()} drop (${this.formatter.columnize(e)})`)}_indexCommand(e,t,r){return this.formatter.wrap(Wd.generateCombinedName(this.client.logger,e,t,r))}primary(e,t){let r;Zd(t)&&({constraintName:t,deferrable:r}=t),r=r?` deferrable initially ${r}`:"",t=this.formatter.wrap(t||`${this.tableNameRaw}_pkey`);const n=e;let i=[];this.grouped.columns&&(i=this._getIncrementsColumnNames(),i&&i.forEach(e=>{n.includes(e)||n.unshift(e)})),this.pushQuery(`alter table ${this.tableName()} add constraint ${t} primary key (${this.formatter.columnize(n)})${r}`)}dropPrimary(e){e=this.formatter.wrap(e||this.tableNameRaw+"_pkey"),this.pushQuery(`alter table ${this.tableName()} drop constraint ${e}`)}index(e,t){t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),this.pushQuery(`create index ${t} on ${this.tableName()} (`+this.formatter.columnize(e)+")")}dropIndex(e,t){t=t?this.formatter.wrap(t):this._indexCommand("index",this.tableNameRaw,e),this.pushQuery(`drop index ${t}`)}unique(e,t){let r;Zd(t)&&({indexName:t,deferrable:r}=t),r=r?` deferrable initially ${r}`:"",t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} add constraint ${t} unique (`+this.formatter.columnize(e)+")"+r)}dropUnique(e,t){t=t?this.formatter.wrap(t):this._indexCommand("unique",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop constraint ${t}`)}dropForeign(e,t){t=t?this.formatter.wrap(t):this._indexCommand("foreign",this.tableNameRaw,e),this.pushQuery(`alter table ${this.tableName()} drop constraint ${t}`)}}ep.prototype.addColumnsPrefix="add ",ep.prototype.alterColumnsPrefix="modify ";var tp=ep;const{ReturningHelper:rp}=Wd,{isConnectionError:np}=Wd;class ip extends tu{schemaCompiler(){return new Jd(this,...arguments)}columnBuilder(){return new Vd(this,...arguments)}columnCompiler(){return new Xd(this,...arguments)}tableCompiler(){return new tp(this,...arguments)}database(){return this.connectionSettings.database}positionBindings(e){let t=0;return e.replace(/\?/g,function(){return t+=1,`:${t}`})}_stream(e,t,r,n){if(!t.sql)throw new Error("The query is empty");return new Promise(function(i,s){r.on("error",t=>{np(t)&&(e.__knex__disposed=t),s(t)}),r.on("end",i);const o=e.queryStream(t.sql,t.bindings,n);o.pipe(r),o.on("error",function(e){s(e),r.emit("error",e)})})}alias(e,t){return e+" "+t}parameter(e,t,r){return e instanceof rp&&this.driver?e=new this.driver.OutParam(this.driver.OCCISTRING):"boolean"==typeof e&&(e=e?1:0),super.parameter(e,t,r)}}Object.assign(ip.prototype,{dialect:"oracle",driverName:"oracle"});var sp=ip;const{ReturningHelper:op}=Wd,{isString:ap}=Gi,lp=["columns","join","where","union","group","having","order","lock"];var up=class extends Lo{constructor(e,t,r){super(e,t,r);const{onConflict:n}=this.single;if(n)throw new Error(".onConflict() is not supported for oracledb.");this.first=this.select}insert(){let e=this.single.insert||[],{returning:t}=this.single;if(!Array.isArray(e)&&Ge.default(this.single.insert)&&(e=[this.single.insert]),t&&!Array.isArray(t)&&(t=[t]),Array.isArray(e)&&1===e.length&&Ke.default(e[0]))return this._addReturningToSqlAndConvert(`insert into ${this.tableName} (${this.formatter.wrap(this.single.returning)}) values (default)`,t,this.tableName);if(Ke.default(this.single.insert)&&"function"!=typeof this.single.insert)return"";const r=this._prepInsert(e),n={};if(ap(r))return this._addReturningToSqlAndConvert(`insert into ${this.tableName} ${r}`,t);if(1===r.values.length)return this._addReturningToSqlAndConvert(`insert into ${this.tableName} (${this.formatter.columnize(r.columns)}) values (${this.client.parameterize(r.values[0],void 0,this.builder,this.bindingsHolder)})`,t,this.tableName);const i=0===r.columns.length;return n.sql="begin "+r.values.map(e=>{let s;const o=i?"":this.client.parameterize(e,this.client.valueForUndefined,this.builder,this.bindingsHolder),a=Array.isArray(t)?t:[t];let l=`insert into ${this.tableName} `;t&&(s=new op(a.join(":")),n.outParams=(n.outParams||[]).concat(s)),l+=i?`(${this.formatter.wrap(this.single.returning)}) values (default)`:`(${this.formatter.columnize(r.columns)}) values (${o})`,l+=t?` returning ROWID into ${this.client.parameter(s,this.builder,this.bindingsHolder)}`:"",l=this.formatter.client.positionBindings(l);const u=o.replace("DEFAULT, ","").replace(", DEFAULT","");return`execute immediate '${l.replace(/'/g,"''")}`+(u||t?"' using ":"")+u+(u&&t?", ":"")+(t?"out ?":"")+";"}).join(" ")+"end;",t&&(n.returning=t,n.returningSql=`select ${this.formatter.columnize(t)} from `+this.tableName+" where ROWID in ("+n.outParams.map((e,t)=>`:${t+1}`).join(", ")+") order by case ROWID "+n.outParams.map((e,t)=>`when CHARTOROWID(:${t+1}) then ${t}`).join(" ")+" end"),n}update(){const e=this._prepUpdate(this.single.update),t=this.where();let{returning:r}=this.single;const n=`update ${this.tableName} set `+e.join(", ")+(t?` ${t}`:"");return r?(Array.isArray(r)||(r=[r]),this._addReturningToSqlAndConvert(n,r,this.tableName)):n}truncate(){return`truncate table ${this.tableName}`}forUpdate(){return"for update"}forShare(){return this.client.logger.warn("lock for share is not supported by oracle dialect"),""}columnInfo(){const e=this.single.columnInfo;return{sql:`select * from xmltable( '/ROWSET/ROW'\n      passing dbms_xmlgen.getXMLType('\n      select char_col_decl_length, column_name, data_type, data_default, nullable\n      from all_tab_columns where table_name = ''${this.client.customWrapIdentifier(this.single.table,mt.default)}'' ')\n      columns\n      CHAR_COL_DECL_LENGTH number, COLUMN_NAME varchar2(200), DATA_TYPE varchar2(106),\n      DATA_DEFAULT clob, NULLABLE varchar2(1))`,output(t){const r=rt.default(t,function(e,t){return e[t.COLUMN_NAME]={type:t.DATA_TYPE,defaultValue:t.DATA_DEFAULT,maxLength:t.CHAR_COL_DECL_LENGTH,nullable:"Y"===t.NULLABLE},e},{});return e&&r[e]||r}}}select(){let e=this.with();const t=lp.map(e=>this[e]());return e+=it.default(t).join(" "),this._surroundQueryWithLimitAndOffset(e)}aggregate(e){return this._aggregate(e,{aliasSeparator:" "})}_addReturningToSqlAndConvert(e,t,r){const n={sql:e};if(!t)return n;const i=Array.isArray(t)?t:[t],s=new op(i.join(":"));return n.sql=e+" returning ROWID into "+this.client.parameter(s,this.builder,this.bindingsHolder),n.returningSql=`select ${this.formatter.columnize(t)} from ${r} where ROWID = :1`,n.outParams=[s],n.returning=t,n}_surroundQueryWithLimitAndOffset(e){let{limit:t}=this.single;const{offset:r}=this.single,n=t||0===t||"0"===t;if(t=+t,!n&&!r)return e;if(e=e||"",n&&!r)return`select * from (${e}) where rownum <= ${this._getValueOrParameterFromAttribute("limit",t)}`;const i=+r+(n?t:1e13);return"select * from (select row_.*, ROWNUM rownum_ from ("+e+") row_ where rownum <= "+(this.single.skipBinding.offset?i:this.client.parameter(i,this.builder,this.bindingsHolder))+") where rownum_ > "+this._getValueOrParameterFromAttribute("offset",r)}};const{promisify:cp}=Ce.default;function hp(e,t){this.columnName=e,this.value=t,this.returning=!1}hp.prototype.toString=function(){return"[object BlobHelper:"+this.columnName+"]"};const dp=function(e){const t=ah;let r;if(e.type)e.type===t.BLOB?r="buffer":e.type===t.CLOB&&(r="string");else{if(!e.iLob)throw new Error("Unrecognized oracledb lob stream type");e.iLob.type===t.CLOB?r="string":e.iLob.type===t.BLOB&&(r="buffer")}return"string"===r&&e.setEncoding("utf-8"),function(e,t){return new Promise((r,n)=>{let i="string"===t?"":Buffer.alloc(0);e.on("error",function(e){n(e)}),e.on("data",function(e){"string"===t?i+=e:i=Buffer.concat([i,e])}),e.on("end",function(){r(i)})})}(e,r)};Wd.BlobHelper=hp,Wd.monkeyPatchConnection=function(e,t){if(e.executeAsync)return;e.commitAsync=function(){return new Promise((e,t)=>{this.commit(function(r){if(r)return t(r);e()})})},e.rollbackAsync=function(){return new Promise((e,t)=>{this.rollback(function(r){if(r)return t(r);e()})})};const r=cp(function(r,n,i,s){if((i=i||{}).outFormat=t.driver.OUT_FORMAT_OBJECT||t.driver.OBJECT,!i.outFormat)throw new Error("not found oracledb.outFormat constants");e.execute(r,n||[],i,i.resultSet?function(t,r){if(t)return Wd.isConnectionError(t)&&(e.close().catch(function(e){}),e.__knex__disposed=t),s(t);const n={rows:[],resultSet:r.resultSet},i=function(e,t,r){t.getRows(r,function(o,a){if(o)Wd.isConnectionError(o)&&(e.close().catch(function(e){}),e.__knex__disposed=o),t.close(function(){return s(o)});else{if(0===a.length)return s(null,n);if(a.length>0){if(a.length!==r)return n.rows=n.rows.concat(a),s(null,n);n.rows=n.rows.concat(a),i(e,t,r)}}})};i(e,r.resultSet,100)}:function(t,r){return t?(Wd.isConnectionError(t)&&(e.close().catch(function(e){}),e.__knex__disposed=t),s(t)):s(null,r)})});e.executeAsync=function(e,t,n){return r(e,t,n).then(async e=>{const t=()=>e.resultSet?cp(e.resultSet.close).call(e.resultSet):Promise.resolve(),r=[];if(e.rows&&Array.isArray(e.rows))for(let t=0;t<e.rows.length;t++){const n=e.rows[t];for(const e in n)n[e]instanceof Ae.default.Readable&&r.push({index:t,key:e,stream:n[e]})}try{for(const t of r)e.rows[t.index][t.key]=await dp(t.stream)}catch(e){throw await t().catch(()=>{}),e}return await t(),e})}};var pp=Wd;const mp=pp.ReturningHelper,fp=pp.BlobHelper,{isString:gp}=Gi,{columnize:yp}=ho;var bp=class extends up{insert(){const e=this,t=this._prepOutbindings(this.single.insert,this.single.returning),r=t.outBinding,n=t.returning,i=t.values;if(Array.isArray(i)&&1===i.length&&Ke.default(i[0])){const e=this.single.returning?" ("+this.formatter.wrap(this.single.returning)+")":"";return this._addReturningToSqlAndConvert("insert into "+this.tableName+e+" values (default)",r[0],this.tableName,n)}if(Ke.default(this.single.insert)&&"function"!=typeof this.single.insert)return"";const s=this._prepInsert(i),o={};if(gp(s))return this._addReturningToSqlAndConvert("insert into "+this.tableName+" "+s,r[0],this.tableName,n);if(1===s.values.length)return this._addReturningToSqlAndConvert("insert into "+this.tableName+" ("+this.formatter.columnize(s.columns)+") values ("+this.client.parameterize(s.values[0],void 0,this.builder,this.bindingsHolder)+")",r[0],this.tableName,n);const a=0===s.columns.length;return o.returning=n,o.sql="begin "+s.values.map(function(t,n){const i=a?"":e.client.parameterize(t,e.client.valueForUndefined,e.builder,e.bindingsHolder);let o="insert into "+e.tableName;o+=a?" ("+e.formatter.wrap(e.single.returning)+") values (default)":" ("+e.formatter.columnize(s.columns)+") values ("+i+")";let l="",u="",c="",h="";ze.default(t,function(e){e instanceof fp||(c+=" ?,")}),c=c.slice(0,-1),r[n].forEach(function(t){const r=t.columnName||t;if(l+=e.formatter.wrap(r)+",",u+=" ?,",h+=" out ?,",t instanceof fp)return e.formatter.bindings.push(t);e.formatter.bindings.push(new mp(r))}),l=l.slice(0,-1),u=u.slice(0,-1),h=h.slice(0,-1),l&&u&&(o+=" returning "+l+" into"+u),o=e.formatter.client.positionBindings(o);const d=i.replace(/DEFAULT, /g,"").replace(/, DEFAULT/g,"").replace("EMPTY_BLOB(), ","").replace(", EMPTY_BLOB()","");return"execute immediate '"+o.replace(/'/g,"''")+(d||t?"' using ":"")+d+(d&&h?",":"")+h+";"}).join(" ")+"end;",o.outBinding=r,"*"===n[0]&&(o.returningSql=function(){return"select * from "+e.tableName+" where ROWID in ("+this.outBinding.map(function(e,t){return":"+(t+1)}).join(", ")+") order by case ROWID "+this.outBinding.map(function(e,t){return"when CHARTOROWID(:"+(t+1)+") then "+t}).join(" ")+" end"}),o}with(){const e=[];if(this.grouped.with)for(const t of this.grouped.with)t.recursive&&(e.push(t),t.recursive=!1);const t=super.with();for(const t of e)t.recursive=!0;return t}_addReturningToSqlAndConvert(e,t,r,n){const i=this,s={sql:e};if(!t)return s;const o=Array.isArray(t)?t:[t];let a="",l="";return o.forEach(function(e){const t=e.columnName||e;if(a+=i.formatter.wrap(t)+",",l+="?,",e instanceof fp)return i.formatter.bindings.push(e);i.formatter.bindings.push(new mp(t))}),s.sql=e,a=a.slice(0,-1),l=l.slice(0,-1),a&&l&&(s.sql+=" returning "+a+" into "+l),s.outBinding=[t],"*"===n[0]&&(s.returningSql=function(){return"select * from "+i.tableName+" where ROWID = :1"}),s.returning=n,s}_prepOutbindings(e,t){const r={};let n=e||[],i=t||[];!Array.isArray(n)&&Ge.default(e)&&(n=[n]),i&&!Array.isArray(i)&&(i=[i]);const s=[];return ze.default(n,function(e,t){s[t]="*"===i[0]?["ROWID"]:Ve.default(i),ze.default(e,function(r,i){if(r instanceof Buffer){e[i]=new fp(i,r);const n=s[t].indexOf(i);n>=0&&(s[t].splice(n,1),e[i].returning=!0),s[t].push(e[i])}void 0===r&&delete n[t][i]})}),r.returning=i,r.outBinding=s,r.values=n,r}_groupOrder(e,t){return super._groupOrderNulls(e,t)}update(){const e=this,t={},r=this._prepOutbindings(this.single.update||this.single.counter,this.single.returning),n=r.outBinding,i=r.returning,s=this._prepUpdate(this.single.update),o=this.where();let a="",l="";return Ke.default(s)&&"function"!=typeof this.single.update?"":(n.forEach(function(t){t.forEach(function(t){const r=t.columnName||t;if(a+=e.formatter.wrap(r)+",",l+=" ?,",t instanceof fp)return e.formatter.bindings.push(t);e.formatter.bindings.push(new mp(r))})}),a=a.slice(0,-1),l=l.slice(0,-1),t.outBinding=n,t.returning=i,t.sql="update "+this.tableName+" set "+s.join(", ")+(o?" "+o:""),n.length&&!Ke.default(n[0])&&(t.sql+=" returning "+a+" into"+l),"*"===i[0]&&(t.returningSql=function(){let t="select * from "+e.tableName;const r=this.rowsAffected.length||this.rowsAffected;let n=" where ROWID in (",i=") order by case ROWID ";for(let e=0;e<r;e++)"*"===this.returning[0]&&(n+=":"+(e+1)+", ",i+="when CHARTOROWID(:"+(e+1)+") then "+e+" ");return"*"===this.returning[0]&&(this.returning=this.returning.slice(0,-1),n=n.slice(0,-2),i=i.slice(0,-1)),t+(n+i+" end")}),t)}_jsonPathWrap(e){return`'${e.path||e[1]}'`}jsonExtract(e){return this._jsonExtract(e.singleValue?"json_value":"json_query",e)}jsonSet(e){return`json_transform(${yp(e.column,this.builder,this.client,this.bindingsHolder)}, set ${this.client.parameter(e.path,this.builder,this.bindingsHolder)} = ${this.client.parameter(e.value,this.builder,this.bindingsHolder)})`}jsonInsert(e){return`json_transform(${yp(e.column,this.builder,this.client,this.bindingsHolder)}, insert ${this.client.parameter(e.path,this.builder,this.bindingsHolder)} = ${this.client.parameter(e.value,this.builder,this.bindingsHolder)})`}jsonRemove(e){const t=`json_transform(${yp(e.column,this.builder,this.client,this.bindingsHolder)}, remove ${this.client.parameter(e.path,this.builder,this.bindingsHolder)})`;return e.alias?this.client.alias(t,this.formatter.wrap(e.alias)):t}whereJsonPath(e){return this._whereJsonPath("json_value",e)}whereJsonSupersetOf(e){throw new Error("Json superset where clause not actually supported by Oracle")}whereJsonSubsetOf(e){throw new Error("Json subset where clause not actually supported by Oracle")}onJsonPathEquals(e){return this._onJsonPathEquals("json_value",e)}},wp=class extends tp{constructor(e,t){super(e,t)}_setNullableState(e,t){const r=t?"NULL":"NOT NULL",n=`alter table ${this.tableName()} modify (${this.formatter.wrap(e)} ${r})`;return this.pushQuery({sql:n})}};const{isObject:vp}=Gi;class _p extends Xd{constructor(){super(...arguments),this.modifiers=["defaultTo","nullable","comment"],this._addCheckModifiers()}datetime(e){let t;return vp(e)?({useTz:t}=e):t=!e,t?"timestamp with local time zone":"timestamp"}timestamp(e){let t;return vp(e)?({useTz:t}=e):t=!e,t?"timestamp with local time zone":"timestamp"}checkRegex(e,t){return this._check(`REGEXP_LIKE(${this.formatter.wrap(this.getColumnName())},${this.client._escapeBinding(e)})`,t)}json(){return`varchar2(4000) check (${this.formatter.columnize(this.getColumnName())} is json)`}jsonb(){return this.json()}}_p.prototype.time="timestamp with local time zone",_p.prototype.uuid=({useBinaryUuid:e=!1}={})=>e?"raw(16)":"char(36)";var Ep=_p,Cp=class extends Ul{constructor(e,t){super(e,t)}createOrReplace(){this.createQuery(this.columns,this.selectQuery,!1,!0)}createMaterializedView(){this.createQuery(this.columns,this.selectQuery,!0)}},Np=class extends Pl{constructor(){super(...arguments)}checkOption(){this._single.checkOption="default_option"}};const{timeout:xp,KnexTimeoutError:$p}=ji,Ap=Vi("knex:tx");var Tp=class extends ys{begin(e){return this.isolationLevel&&this.client.logger.warn("Transaction isolation is not currently supported for Oracle"),Promise.resolve()}async commit(e,t){this._completed=!0;try{await e.commitAsync(),this._resolver(t)}catch(e){this._rejecter(e)}}release(e,t){return this._resolver(t)}rollback(e,t){return this._completed=!0,Ap("%s: rolling back",this.txid),xp(e.rollbackAsync(),5e3).catch(e=>{if(!(e instanceof $p))return Promise.reject(e);this._rejecter(e)}).then(()=>{if(void 0===t){if(this.doNotRejectOnRollback)return void this._resolver();t=new Error(`Transaction rejected with non-error: ${t}`)}this._rejecter(t)})}savepoint(e){return this.query(e,`SAVEPOINT ${this.txid}`)}async acquireConnection(e,t){const r=e&&e.connection,n=r||await this.client.acquireConnection();try{return n.__knexTxId=this.txid,n.isTransaction=!0,await t(n)}finally{Ap("%s: releasing connection",this.txid),n.isTransaction=!1;try{await n.commitAsync()}catch(e){this._rejecter(e)}finally{r?Ap("%s: not releasing external connection",this.txid):await this.client.releaseConnection(n)}}}};const{BlobHelper:Rp,ReturningHelper:Sp,monkeyPatchConnection:Op}=pp,{isString:Ip}=Gi,{outputQuery:jp,unwrapRaw:qp}=ho,{compileCallback:kp}=ro;class Pp extends sp{constructor(e){super(e),this.driver&&(process.env.UV_THREADPOOL_SIZE=process.env.UV_THREADPOOL_SIZE||1,process.env.UV_THREADPOOL_SIZE=parseInt(process.env.UV_THREADPOOL_SIZE)+this.driver.poolMax)}_driver(){const e=this,t=ah;return e.fetchAsString=[],this.config.fetchAsString&&Array.isArray(this.config.fetchAsString)&&this.config.fetchAsString.forEach(function(r){Ip(r)&&(r=r.toUpperCase(),t[r]&&("NUMBER"!==r&&"DATE"!==r&&"CLOB"!==r&&"BUFFER"!==r&&this.logger.warn('Only "date", "number", "clob" and "buffer" are supported for fetchAsString'),e.fetchAsString.push(t[r])))}),t}queryCompiler(e,t){return new bp(this,e,t)}tableCompiler(){return new wp(this,...arguments)}columnCompiler(){return new Ep(this,...arguments)}viewBuilder(){return new Np(this,...arguments)}viewCompiler(){return new Cp(this,...arguments)}formatter(e){return new Aa(this,e)}transaction(){return new Tp(this,...arguments)}prepBindings(e){return at.default(e,e=>e instanceof Rp&&this.driver?{type:this.driver.BLOB,dir:this.driver.BIND_OUT}:e instanceof Sp&&this.driver?{type:this.driver.STRING,dir:this.driver.BIND_OUT}:"boolean"==typeof e?e?1:0:e)}parameter(e,t,r){return"function"==typeof e?jp(kp(e,void 0,this,r),!0,t,this):e instanceof Rp?(r.bindings.push(e.value),"?"):qp(e,!0,t,this,r)||"?"}acquireRawConnection(){const e=this;return new Promise(function(t,r){const n=e.connectionSettings.externalAuth?{externalAuth:e.connectionSettings.externalAuth}:{user:e.connectionSettings.user,password:e.connectionSettings.password};var i;n.connectString=(i=e.connectionSettings).connectString?i.connectString:i.port?i.host+":"+i.port+"/"+i.database:i.host+"/"+i.database,e.connectionSettings.prefetchRowCount&&(n.prefetchRows=e.connectionSettings.prefetchRowCount),void 0!==e.connectionSettings.stmtCacheSize&&(n.stmtCacheSize=e.connectionSettings.stmtCacheSize),e.driver.fetchAsString=e.fetchAsString,e.driver.getConnection(n,function(n,i){if(n)return r(n);Op(i,e),t(i)})})}destroyRawConnection(e){return e.release()}_query(e,t){if(!t.sql)throw new Error("The query is empty");const r={autoCommit:!1};return"select"===t.method&&(r.resultSet=!0),e.executeAsync(t.sql,t.bindings,r).then(async function(r){let n=He.default(r.outBinds);if(t.response=r.rows||[],t.rowsAffected=r.rows?r.rows.rowsAffected:r.rowsAffected,"raw"===t.method&&n.length>0)return{response:n};if("update"===t.method){const e=t.rowsAffected.length||t.rowsAffected,r=[],i=[],s=t=>function(r,s){i.push(n[t+s*e])};for(let n=0;n<e;n++)r.push(t.outBinding[0]),ze.default(t.outBinding[0],s(n));n=i,t.outBinding=r}if(!t.returning&&0===n.length)return e.isTransaction||await e.commitAsync(),t;const i=[];let s=0;for(let e=0;e<t.outBinding.length;e++){const r=t.outBinding[e];s+=t.outBinding[e-1]?t.outBinding[e-1].length:0;for(let o=0;o<r.length;o++){const a=r[o];await new Promise(function(r,l){if(a instanceof Rp){const i=n[o+s];a.returning&&(t.response[e]=t.response[e]||{},t.response[e][a.columnName]=a.value),i.on("error",function(e){l(e)}),i.on("finish",function(){r()}),i.write(a.value),i.end()}else"ROWID"===t.outBinding[e][o]?(i.push(n[o+s]),r()):(t.response[e]=t.response[e]||{},t.response[e][a]=n[o+s],r())})}}if(e.isTransaction)return t;if(await e.commitAsync(),t.returningSql){const r=await e.executeAsync(t.returningSql(),i,{resultSet:!0});t.response=r.rows}return t})}processResponse(e,t){const{response:r}=e;if(e.output)return e.output.call(t,r);switch(e.method){case"select":default:return r;case"first":return r[0];case"pluck":return at.default(r,e.pluck);case"insert":case"del":case"update":case"counter":return e.returning&&!Ke.default(e.returning)?r:void 0!==e.rowsAffected?e.rowsAffected:1}}processPassedConnection(e){Op(e,this)}}Pp.prototype.driverName="oracledb";var Lp=Pp,Bp=class extends Lh{constructor(...e){super(...e),this.driverName="pgnative",this.canCancelQuery=!0}_driver(){return ah.native}_stream(e,t,r,n){if(!t.sql)throw new Error("The query is empty");const i=this;return new Promise((n,s)=>(r.on("error",s),r.on("end",n),i._query(e,t).then(e=>e.response).then(({rows:e})=>e.forEach(e=>r.write(e))).catch(function(e){r.emit("error",e)}).then(function(){r.end()})))}async cancelQuery(e){try{return await this._wrappedCancelQueryCall(null,e)}catch(e){throw this.logger.warn(`Connection Error: ${e}`),e}}_wrappedCancelQueryCall(e,t){return new Promise(function(e,r){t.native.cancel(function(t){t?r(t):e(!0)})})}},Mp=class extends ys{begin(e){return this.query(e,this.isolationLevel?`BEGIN ISOLATION LEVEL ${this.isolationLevel};`:"BEGIN;")}savepoint(e){return this.trxClient.logger("Redshift does not support savepoints."),Promise.resolve()}release(e,t){return this.trxClient.logger("Redshift does not support savepoints."),Promise.resolve()}rollbackTo(e,t){return this.trxClient.logger("Redshift does not support savepoints."),Promise.resolve()}};const{columnize:Up}=ho;var Dp=class extends bh{truncate(){return`truncate ${this.tableName.toLowerCase()}`}insert(){const e=Lo.prototype.insert.apply(this,arguments);return""===e?e:(this._slightReturn(),{sql:e})}update(){const e=Lo.prototype.update.apply(this,arguments);return this._slightReturn(),{sql:e}}del(){const e=Lo.prototype.del.apply(this,arguments);return this._slightReturn(),{sql:e}}_slightReturn(){this.single.isReturning&&this.client.logger.warn("insert/update/delete returning is not supported by redshift dialect")}forUpdate(){return this.client.logger.warn("table lock is not supported by redshift dialect"),""}forShare(){return this.client.logger.warn("lock for share is not supported by redshift dialect"),""}forNoKeyUpdate(){return this.client.logger.warn("table lock is not supported by redshift dialect"),""}forKeyShare(){return this.client.logger.warn("lock for share is not supported by redshift dialect"),""}columnInfo(){const e=this.single.columnInfo;let t=this.single.schema;const r=this.client.customWrapIdentifier(this.single.table,mt.default);t&&(t=this.client.customWrapIdentifier(t,mt.default));const n=[r.toLowerCase(),this.client.database().toLowerCase()];return this._buildColumnInfoQuery(t,"select * from information_schema.columns where table_name = ? and table_catalog = ?",n,e)}jsonExtract(e){let t;return t=Array.isArray(e.column)?e.column:[e],t.map(t=>{const r=`json_extract_path_text(${Up(t.column||t[0],this.builder,this.client,this.bindingsHolder)}, ${this.client.toPathForJson(e.path||t[1],this.builder,this.bindingsHolder)})`,n=t.alias||t[2];return n?this.client.alias(r,this.formatter.wrap(n)):r}).join(", ")}jsonSet(e){throw new Error("Json set is not supported by Redshift")}jsonInsert(e){throw new Error("Json insert is not supported by Redshift")}jsonRemove(e){throw new Error("Json remove is not supported by Redshift")}whereJsonPath(e){return this._whereJsonPath("json_extract_path_text",Object.assign({},e,{path:this.client.toPathForJson(e.path)}))}whereJsonSupersetOf(e){throw new Error("Json superset is not supported by Redshift")}whereJsonSubsetOf(e){throw new Error("Json subset is not supported by Redshift")}onJsonPathEquals(e){return this._onJsonPathEquals("json_extract_path_text",e)}},Fp=class extends ba{constructor(){super(...arguments)}primary(){return this.notNullable(),super.primary(...arguments)}index(){return this.client.logger.warn("Redshift does not support the creation of indexes."),this}};class Qp extends xh{constructor(){super(...arguments)}bit(e){return!1!==e.length?`char(${e.length})`:"char(1)"}datetime(e){return e?"timestamp":"timestamptz"}timestamp(e){return e?"timestamp":"timestamptz"}comment(e){this.pushAdditional(function(){this.pushQuery(`comment on column ${this.tableCompiler.tableName()}.`+this.formatter.wrap(this.args[0])+" is "+(e?`'${e}'`:"NULL"))},e)}}Qp.prototype.increments=({primaryKey:e=!0}={})=>"integer identity(1,1)"+(e?" primary key":"")+" not null",Qp.prototype.bigincrements=({primaryKey:e=!0}={})=>"bigint identity(1,1)"+(e?" primary key":"")+" not null",Qp.prototype.binary="varchar(max)",Qp.prototype.blob="varchar(max)",Qp.prototype.enu="varchar(255)",Qp.prototype.enum="varchar(255)",Qp.prototype.json="varchar(max)",Qp.prototype.jsonb="varchar(max)",Qp.prototype.longblob="varchar(max)",Qp.prototype.mediumblob="varchar(16777218)",Qp.prototype.set="text",Qp.prototype.text="varchar(max)",Qp.prototype.tinyblob="varchar(256)",Qp.prototype.uuid=Ca.prototype.uuid,Qp.prototype.varbinary="varchar(max)",Qp.prototype.bigint="bigint",Qp.prototype.bool="boolean",Qp.prototype.double="double precision",Qp.prototype.floating="real",Qp.prototype.smallint="smallint",Qp.prototype.tinyint="smallint";var Hp=Qp,Wp=class extends Th{constructor(){super(...arguments)}index(e,t,r){this.client.logger.warn("Redshift does not support the creation of indexes.")}dropIndex(e,t){this.client.logger.warn("Redshift does not support the deletion of indexes.")}createQuery(e,t,r){const n=t?"create table if not exists ":"create table ",i=" ("+e.sql.join(", ")+this._addChecks()+")";let s=n+this.tableName()+(r&&this.tableNameLike()?" (like "+this.tableNameLike()+")":i);this.single.inherits&&(s+=` like (${this.formatter.wrap(this.single.inherits)})`),this.pushQuery({sql:s,bindings:e.bindings}),ot.default(this.single,"comment")&&this.comment(this.single.comment),r&&this.addColumns(e,this.addColumnsPrefix)}primary(e,t){const r=this;t=r.formatter.wrap(t||`${this.tableNameRaw}_pkey`),e.constructor!==Array&&(e=[e]);const n=r.grouped.columns;if(n)for(let t=0;t<e.length;t++){let r=n.find(r=>"columns"===r.grouping&&r.builder&&"add"===r.builder._method&&r.builder._args&&r.builder._args.indexOf(e[t])>-1);if(r&&(r=r.builder),!(r&&r._modifiers&&r._modifiers.nullable&&!1===r._modifiers.nullable[0]))return this.client.logger.warn(r?"Redshift does not allow primary keys to contain nullable columns.":"Redshift does not allow primary keys to contain nonexistent columns.")}return r.pushQuery(`alter table ${r.tableName()} add constraint ${t} primary key (${r.formatter.columnize(e)})`)}addColumns(e,t,r){if(t===this.alterColumnsPrefix)super.addColumns(e,t,r);else{t=t||this.addColumnsPrefix,r=r||this.getColumns();for(const e of r){const r=this.tableName(),n=e.compileColumn();this.pushQuery({sql:`alter table ${r} ${t}${n}`,bindings:[]})}}}},Jp=class extends Oh{constructor(){super(...arguments)}},Vp=class extends Rh{constructor(e,t){super(e,t)}};class zp extends Lh{transaction(){return new Mp(this,...arguments)}queryCompiler(e,t){return new Dp(this,e,t)}columnBuilder(){return new Fp(this,...arguments)}columnCompiler(){return new Hp(this,...arguments)}tableCompiler(){return new Wp(this,...arguments)}schemaCompiler(){return new Jp(this,...arguments)}viewCompiler(){return new Vp(this,...arguments)}_driver(){return ah}processResponse(e,t){const r=e.response;return e.output?e.output.call(t,r):"raw"===e.method?r:"SELECT"===r.command?"first"===e.method?r.rows[0]:"pluck"===e.method?at.default(r.rows,e.pluck):r.rows:"INSERT"===r.command||"UPDATE"===r.command||"DELETE"===r.command?r.rowCount:r}toPathForJson(e,t,r){return e.replace(/^(\$\.)/,"").split(".").map(function(e){return this.parameter(e,t,r)}.bind(this)).join(", ")}}Object.assign(zp.prototype,{dialect:"redshift",driverName:"pg-redshift"});var Kp=zp,Gp=It(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getDialectByNameOrAlias=void 0;const{resolveClientNameWithAliases:r}=Ss,n=Object.freeze({"better-sqlite3":()=>dh,cockroachdb:()=>Vh,mssql:()=>yd,mysql:()=>Md,mysql2:()=>Qd,oracle:()=>sp,oracledb:()=>Lp,pgnative:()=>Bp,postgres:()=>Lh,redshift:()=>Kp,sqlite3:()=>ch});t.getDialectByNameOrAlias=function(e){const t=r(e),i=n[t];if(!i)throw new Error(`Invalid clientName given: ${e}`);return i()}});const{SUPPORTED_CLIENTS:Yp}=$s,{getDialectByNameOrAlias:Xp}=Gp;var Zp={resolveConfig:function(e){let t,r;const n="string"==typeof e?Object.assign(au(e),arguments[2]):e;if(0===arguments.length||!n.client&&!n.dialect)t=tu;else if("function"==typeof n.client)t=n.client;else{const e=n.client||n.dialect;if(!Yp.includes(e))throw new Error(`knex: Unknown configuration option 'client' value ${e}. Note that it is case-sensitive, check documentation for supported values.`);t=Xp(e)}return r="string"==typeof n.connection?Object.assign({},n,{connection:au(n.connection).connection}):Object.assign({},n),{resolvedConfig:r,Dialect:t}}};const{KnexTimeoutError:em}=ji,{resolveConfig:tm}=Zp;function rm(e){const{resolvedConfig:t,Dialect:r}=tm(...arguments),n=as(new r(t));return t.userParams&&(n.userParams=t.userParams),n}rm.Client=tu,rm.KnexTimeoutError=em,rm.QueryBuilder={extend:function(e,t){eo.extend(e,t),Ki.push(e)}},rm.SchemaBuilder={extend:function(e,t){Fo.extend(e,t)}},rm.ViewBuilder={extend:function(e,t){Pl.extend(e,t)}},rm.ColumnBuilder={extend:function(e,t){ba.extend(e,t)}},rm.TableBuilder={extend:function(e,t){oa.extend(e,t)}};var nm=rm;nm.knex=nm,nm.default=nm;var im=nm,sm=new(/*#__PURE__*/function(){function e(){}var t=e.prototype;return t.init=function(e){this.connection=im(e)},t.setColumnAliases=function(e){this.columnAliases=e},t.test=function(){return this.connection.raw("select 1+1 as result")},e}()),om=/*#__PURE__*/function(){function e(){}return e.parseQueryString=function(e,t,r){var n={allowGlobalSearch:!0,caseInsensitive:!0};sm.columnAliases&&sm.columnAliases[r]&&(n.aliases=sm.columnAliases[r]),void 0!==sm.caseInsensitive&&(n.caseInsensitive=sm.caseInsensitive),void 0!==sm.allowGlobalSearch&&(n.allowGlobalSearch=sm.allowGlobalSearch);var i=new x.FQLParser(n).parse(t);return new x.KnexParser(r).toKnex(e,i)},e.parseFilters=function(t,r,n){var i=t;for(var s in r){var o=r[s];if("object"==typeof o)switch(o.type){case"fql":i=e.parseQueryString(i,o.value,n);break;case"date":case"between":o.start&&o.end&&(i=i.whereBetween(s,[o.start,o.end])),o.start&&!o.end&&(i=i.where(s,">=",o.start)),!o.start&&o.end&&(i=i.where(s,">=",o.end));break;case"dateraw":case"betweenraw":o.start&&o.end&&(i=i.whereRaw(s+" BETWEEN ? AND ?",[o.start,o.end])),o.start&&!o.end&&(i=i.whereRaw(s+" >= ?",[o.start])),!o.start&&o.end&&(i=i.whereRaw(s+" >= ?",[o.end]));break;case"jsonb":i=i.whereRaw(s+" ILIKE ?",["%"+o.value+"%"]);break;case"full-text-psql":i=i.whereRaw("to_tsvector("+s+"::text) @@ to_tsquery(?)",[o.value]);break;case"greater":case"greaterraw":i=i.whereRaw(s+" > ?",[o.value]);break;case"greaterEq":case"greaterEqraw":i=i.whereRaw(s+" >= ?",[o.value]);break;case"less":case"lessraw":i=i.whereRaw(s+" < ?",[o.value]);break;case"lessEq":case"lessEqraw":i=i.whereRaw(s+" <= ?",[o.value]);break;case"exists":i=i.whereExists(s);break;case"notexists":i=i.whereNotExists(s);break;case"exact":case"exactraw":i=i.whereRaw(s+" = ?",[o.value]);break;case"in":var a=s;a.includes(",")&&(a=s.split(",")),Array.isArray(o.value)||null==o.value?null!=o.value&&(i=i.whereIn(a,o.value)):i=i.whereIn(a,o.value.split(","));break;case"inraw":Array.isArray(o.value)||null==o.value?null!=o.value&&(i=i.whereRaw(s+" IN (?)",[o.value.map(function(e){return"'"+e+"'"}).join(",")])):i=i.whereRaw(s+" IN (?)",[o.value.split(",").map(function(e){return"'"+e+"'"}).join(",")]);break;case"not":case"notraw":i=i.whereRaw(s+" != ?",[o.value]);break;case"like":case"likeraw":var l=Rt.replaceAll(o.value,"*","%");i=i.whereRaw(" "+s+" LIKE ?",[l]);break;case"notlike":case"notlikeraw":var u=Rt.replaceAll(o.value,"*","%");i=i.whereRaw(" "+s+" NOT LIKE ?",[u]);break;case"likeI":var c=Rt.replaceAll(o.value,"*","%");i=i.whereRaw(" "+s+" ILIKE ?",[c]);break;case"notlikeI":var h=Rt.replaceAll(o.value,"*","%");i=i.whereRaw(" "+s+" NOT ILIKE ?",[h]);break;case"null":case"nullraw":i=i.whereRaw(s+" is NULL");break;case"notnull":case"notnullraw":i=i.whereRaw(s+" is not NULL")}else i=i.where(s,o)}return i},e.parseSort=function(e){if(!e.field||!e.direction)return 1;var t="ASC";return"descend"===e.direction&&(t="DESC"),e.field+" "+t},e}(),am=/*#__PURE__*/function(){function e(){this.tableName=""}var t=e.prototype;return t.loadAllData=function(e,t){return sm.connection.select("*").from(this.tableName).limit(t||1e4).offset(e)},t.loadFilteredData=function(e,t,r){try{var n=this,i=1;return e.sort&&(i=om.parseSort(e.sort)),Promise.resolve(sm.connection.from(n.tableName).where(function(t){return om.parseFilters(t,_e.default.omit(e,["sort","start","limit"]),n.tableName)}).orderByRaw(i).limit(r).offset(t))}catch(e){return Promise.reject(e)}},t.countFilteredData=function(e){try{var t=this;return Promise.resolve(sm.connection.from(t.tableName).where(function(r){return om.parseFilters(r,_e.default.omit(e,["sort","start","limit"]),t.tableName)}).count("id",{as:"total"})).then(function(e){return e&&e[0].total})}catch(e){return Promise.reject(e)}},t.loadById=function(e){try{return Promise.resolve(sm.connection.from(this.tableName).where("id",e)).then(function(e){return e&&e[0]?e[0]:null})}catch(e){return Promise.reject(e)}},t.save=function(e){return sm.connection.from(this.tableName).insert(e).returning("*")},t.update=function(e,t){return sm.connection.from(this.tableName).where("id",e).update(t).returning("*")},t.delete=function(e){try{var t=this;return Promise.resolve(t.loadById(e)).then(function(r){if(!r)throw"NotFound";return sm.connection.from(t.tableName).where("id",e).delete()})}catch(e){return Promise.reject(e)}},e}(),lm=/*#__PURE__*/function(e){function t(t){var r;if(!(r=e.call(this,t)||this).findByUsername)throw new Error("AuthHandler must have 'findByUsername' method");return r}return xt(t,e),t}(am);function um(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var cm=/*#__PURE__*/function(){function e(){this.router=ge.default.Router(),this.routes={}}var t=e.prototype;return t.configure=function(e,t){var r=this;if(!e)return this.router;var n=Rt.expressHandler();return this.router.get("/"+e,n(function(){return r.listEntidad.apply(r,[].slice.call(arguments))})),this.router.post("/"+e+"/list",n(function(){return r.listEntidad.apply(r,[].slice.call(arguments))})),this.router.get("/"+e+"/:id",n(function(){return r.getEntidad.apply(r,[].slice.call(arguments))})),this.router.post("/"+e,n(function(){return r.saveEntidad.apply(r,[].slice.call(arguments))})),this.router.put("/"+e+"/:id",n(function(){return r.updateEntidad.apply(r,[].slice.call(arguments))})),this.router.delete("/"+e+"/:id",n(function(){return r.deleteEntidad.apply(r,[].slice.call(arguments))})),this.service=t.service,this.table=t.table,this.router},t.listEntidad=function(e,t,r){try{var n=this,i=um(function(){var r=new n.service(null,n.table),i="POST"===e.method?e.body:e.query&&e.query.filters?JSON.parse(e.query.filters):{};return Promise.resolve(r.list(i,i.start,i.limit)).then(function(e){var r=new Ot(!0,e.data,null,e.total);t.json(r.toJson())})},function(e){r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.getEntidad=function(e,t,r){try{var n=this,i=um(function(){var r=new n.service(null,n.table);return Promise.resolve(r.loadById(e.params.id)).then(function(e){var r=new Ot(!0,e),n=200;null==e&&(n=404,r=new Ot(!1,null,"Element not found",0)),t.status(n).json(r.toJson())})},function(e){console.error(e);var r="";"22P02"==e.code&&(r="Expected uiid");var n=new Ot(!1,null,r,0);t.status(400).json(n.toJson())});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.saveEntidad=function(e,t,r){try{var n=this,i=um(function(){var r=new n.service(null,n.table);return Promise.resolve(r.save(e.body)).then(function(r){var n=new Ot(!0,r&&r[0]||{id:e.body.id});t.setHeader("Location","/entity/"+n.data.id),t.status(201).json(n.toJson())})},function(e){r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.updateEntidad=function(e,t,r){try{var n=this,i=um(function(){var r=new n.service(null,n.table);return Promise.resolve(r.update(e.params.id,e.body)).then(function(r){var n=new Ot(!0,r&&r[0]||{id:e.body.id});t.json(n.toJson())})},function(e){r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.deleteEntidad=function(e,t,r){try{var n=this,i=um(function(){var r=new n.service(null,n.table);return Promise.resolve(r.delete(e.params.id)).then(function(e){var r=new Ot(!0,e);t.status(204).json(r.toJson())})},function(e){if(console.error(e),"NotFound"==e){var n=new Ot(!1,null,"Element not found",0);t.status(404).json(n.toJson())}else r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}(),hm=/*#__PURE__*/function(){function e(e,t){this.dao=e?new e:new am,t&&(this.dao.tableName=t)}var t=e.prototype;return t.list=function(e,t,r){try{var n=this,i=t||0,s=r||1e3,o={};return Promise.resolve(n.dao.countFilteredData(e,i,s)).then(function(a){var l;function u(e){return l?e:Promise.resolve(n.dao.loadAllData(t,r)).then(function(e){return o.data=e,o})}o.total=a;var c=function(){if(e&&0!==Object.keys(e).length)return Promise.resolve(n.dao.loadFilteredData(e,i,s)).then(function(e){return o.data=e,l=1,o})}();return c&&c.then?c.then(u):u(c)})}catch(e){return Promise.reject(e)}},t.loadById=function(e){return this.dao.loadById(e)},t.save=function(e){return this.dao.save(e)},t.update=function(e,t){if(e)return this.dao.update(e,t)},t.delete=function(e){if(e)return this.dao.delete(e)},e}();function dm(e,t,r){if(!e.s){if(r instanceof pm){if(!r.s)return void(r.o=dm.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(dm.bind(null,e,t),dm.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}const pm=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,i=this.s;if(i){const e=1&i?t:r;if(e){try{dm(n,1,e(this.v))}catch(e){dm(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?dm(n,1,t?t(i):i):r?dm(n,1,r(i)):dm(n,2,i)}catch(e){dm(n,2,e)}},n},e}();function mm(e){return e instanceof pm&&1&e.s}var fm=/*#__PURE__*/function(){function e(){this.serverClass=Zn,this.clusterClass=ei}var t=e.prototype;return t.runtime=function(e){return function(e){try{var t,r,n,i,s,o,a,l=Ct.default(de.hideBin(process.argv)).usage("Como usar: \n            node $0 [options] \n            \n            ** Si no se especifican parámetros el servidor arrancará normalmente. **").alias("g","generateKeys").describe("g","Genera unas claves para la aplicación").alias("c","encrypt").describe("c","Codifica el String proporcionado en base a la contraseña de .env").nargs("c",1).help("h").alias("h","help"),u=[];if(e)for(r=Tt(e);!(n=r()).done;)l.alias((i=n.value).key,i.alias),i.describe&&l.describe(i.key,i.describe),0!==i.nargs&&l.nargs(i.key,i.nargs),i.boolean&&l.boolean(i.key),i.choices&&l.choices(i.key,i.choices),i.required&&u.push(i.key);0!==u.length&&l.demandOption(u);var c=l.argv;return c.generateKeys?(console.log("Generando claves para encriptación:"),console.log(Rt.generateKeys()),Promise.resolve(process.exit(1))):c.encrypt?(console.log("Resultado encryptación:"),console.log(Rt.encrypt(c.encrypt)),Promise.resolve(process.exit(1))):Promise.resolve(function(){if(e)return s=Tt(e),function(e,t,r){for(var n;;){var i=e();if(mm(i)&&(i=i.v),!i)return s;if(i.then){n=0;break}var s=r();if(s&&s.then){if(!mm(s)){n=1;break}s=s.s}}var o=new pm,a=dm.bind(null,o,2);return(0===n?i.then(u):1===n?s.then(l):(void 0).then(function(){(i=e())?i.then?i.then(u).then(void 0,a):u(i):dm(o,1,s)})).then(void 0,a),o;function l(t){s=t;do{if(!(i=e())||mm(i)&&!i.v)return void dm(o,1,s);if(i.then)return void i.then(u).then(void 0,a);mm(s=r())&&(s=s.v)}while(!s||!s.then);s.then(l).then(void 0,a)}function u(e){e?(s=r())&&s.then?s.then(l).then(void 0,a):l(s):dm(o,1,s)}}(function(){return!t&&!(o=s()).done},0,function(){return a=o.value,function(){if(c[a.key])return Promise.resolve(a.fn(c)).then(function(){var e=process.exit(1);return t=1,e})}()})}())}catch(e){return Promise.reject(e)}}(e)},t.init=function(e){try{var t=function(){var t=new r.serverClass(e,r.statics,r.routes);return r.customizeExpress&&(t.customizeExpress=r.customizeExpress),r.beforeListen&&(t.beforeListen=r.beforeListen),r.afterListen&&(t.afterListen=r.afterListen),r.events=new ti(r),r.i18n=new St,Promise.resolve(r.i18n.load()).then(function(){r.server=new r.clusterClass(r),r.server.setServerCls(t),r.server.executeOnlyMain=function(){r.executeOnlyMain&&r.executeOnlyMain(),"true"==process.env.REPL_ENABLED&&r.startRepl()}})},r=this,n=function(){if("true"!=process.env.DISABLE_LOGGER)return Promise.resolve(ii.configure()).then(function(){})}();return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},t.start=function(){try{if(!this.server)throw new Error("Call init first");return Promise.resolve(this.server.start()).then(function(){})}catch(e){return Promise.reject(e)}},t.startRepl=function(){var e=this;try{_t.default.createServer(function(t){var r=Et.default.start({prompt:"lisco::remote> ",input:t,output:t,terminal:!0,useColors:!0,preview:!1});r.context.app=e,r.context.Utils=Rt,r.context.db=sm.connection,r.on("exit",t.end.bind(t))}).listen(process.env.REPL_PORT||5001)}catch(e){console.log("Remote REPL Conn: "+e)}console.log("Remote REPL started on port "+(process.env.REPL_PORT||5001))},e}(),gm=new fm;exports.App=gm,exports.AuthController=oi,exports.BaseController=cm,exports.BaseKnexDao=am,exports.BaseService=hm,exports.ClusterServer=ei,exports.CookieAuthHandler=ui,exports.EventHandler=ti,exports.I18nLoader=St,exports.IAuthHandler=ai,exports.IUserDao=lm,exports.JsonResponse=Ot,exports.JwtAuthHandler=li,exports.KnexConnector=sm,exports.KnexFilterParser=om,exports.Logger=ii,exports.Server=Zn,exports.TokenGenerator=Xn,exports.Utils=Rt;
//# sourceMappingURL=lisco.cjs.map
