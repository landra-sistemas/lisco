var e=require("helmet"),t=require("express"),r=require("compression"),n=require("cors"),i=require("express-fileupload"),o=require("url"),s=require("lodash"),a=require("fs"),u=require("util"),c=require("crypto"),l=require("chokidar"),f=require("buffer"),h=require("stream"),p=require("uuid"),d=require("http"),v=require("https"),m=require("path"),y=require("cluster"),g=require("socket.io"),E=require("os"),w=require("events"),b=require("cluster-messages"),S=require("log4js"),R=require("path-to-regexp"),I=require("moment"),A=require("@landra_sistemas/fql-parser"),P=require("knex"),O=require("net"),$=require("repl"),N=require("yargs/yargs"),j=require("yargs/helpers");function x(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function T(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var L=/*#__PURE__*/x(e),k=/*#__PURE__*/x(t),D=/*#__PURE__*/x(r),C=/*#__PURE__*/x(n),_=/*#__PURE__*/x(i),F=/*#__PURE__*/x(o),G=/*#__PURE__*/x(s),B=/*#__PURE__*/x(a),M=/*#__PURE__*/x(u),U=/*#__PURE__*/x(c),K=/*#__PURE__*/x(l),q=/*#__PURE__*/x(f),H=/*#__PURE__*/x(h),V=/*#__PURE__*/T(p),J=/*#__PURE__*/x(d),X=/*#__PURE__*/x(v),z=/*#__PURE__*/x(m),W=/*#__PURE__*/x(y),Y=/*#__PURE__*/x(E),Z=/*#__PURE__*/x(b),Q=/*#__PURE__*/x(S),ee=/*#__PURE__*/x(I),te=/*#__PURE__*/x(P),re=/*#__PURE__*/x(O),ne=/*#__PURE__*/x($),ie=/*#__PURE__*/x(N);function oe(){return oe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},oe.apply(this,arguments)}function se(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ae(e,t)}function ae(e,t){return ae=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ae(e,t)}function ue(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function ce(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return ue(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ue(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var le=/*#__PURE__*/function(){function e(){}return e.arrayToLower=function(e){return e.join("~").toLowerCase().split("~")},e.replaceAll=function(e,t,r){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),r)},e.encrypt=function(e){var t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),n=U.default.createCipheriv("aes-256-cbc",t,r),i=n.update(e);return(i=Buffer.concat([i,n.final()])).toString("hex")},e.decrypt=function(e){var t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),n=Buffer.from(e,"hex"),i=U.default.createDecipheriv("aes-256-cbc",t,r),o=i.update(n);return(o=Buffer.concat([o,i.final()])).toString()},e.sleep=function(e){return M.default.promisify(setTimeout)(e)},e.generateKeys=function(){return{key:U.default.randomBytes(32).toString("hex"),iv:U.default.randomBytes(16).toString("hex")}},e.flattenObject=function(t){var r,n={};for(var i in t)if(t.hasOwnProperty(i))if(t[i]&&Array===t[i].constructor)n[i]=t[i];else if("object"==typeof t[i])for(var o in r=e.flattenObject(t[i]))r.hasOwnProperty(o)&&(r[o]&&Array===r.constructor||(n[i+(isNaN(o)?"."+o:"")]=r[o]));else n[i]=t[i];return n},e.unflatten=function(e){var t={};for(var r in e){var n=r.split(".");n.reduce(function(t,i,o){return t[i]||(t[i]=isNaN(Number(n[o+1]))?n.length-1==o?e[r]:{}:[])},t)}return t},e.expressHandler=function(){return function(e){return function(){var t=[].slice.call(arguments),r=e.apply(void 0,t),n=t[t.length-1];return Promise.resolve(r).catch(function(e){return n(e)})}}},e}(),fe=/*#__PURE__*/function(){function e(e){this.watcher={},this.disableWatchers=e}var t=e.prototype;return t.load=function(e){try{var t=this,r=e||process.env.DEFAULT_LANG;t.currentData||(t.currentData={}),t.currentDataFlat||(t.currentDataFlat={});var n=process.cwd()+"/i18n/lang_"+r+".json";return t.disableWatchers||(t.watcher[r]=K.default.watch(n,{ignored:/(^|[/\\])\../,persistent:!0}),t.watcher[r].on("change",function(e){return t.loadFile(e,r)})),Promise.resolve(t.loadFile(n,r)).then(function(){})}catch(e){return Promise.reject(e)}},t.loadFile=function(e,t){try{var r=this,n=M.default.promisify(B.default.readFile);return Promise.resolve(function(i,o){try{var s=Promise.resolve(n(e,"utf8")).then(function(e){var n=JSON.parse(e);r.currentDataFlat[t]=le.flattenObject(n),r.currentData[t]=n})}catch(e){return o(e)}return s&&s.then?s.then(void 0,o):s}(0,function(e){if("ENOENT"===(null==e?void 0:e.code))return console.log("Lang file does not exist. Create it on ./i18n/lang_{xx}.json");console.error(e)}))}catch(e){return Promise.reject(e)}},t.translate=function(e,t){try{var r,n=function(t){return r?t:"undefined."+e},i=this;if(t||(t=process.env.DEFAULT_LANG),i.currentDataFlat&&i.currentDataFlat[t]&&i.currentDataFlat[t][e])return Promise.resolve(i.currentData[t][e]);var o=function(){if(!i.currentDataFlat||!i.currentDataFlat[t])return Promise.resolve(i.load(t)).then(function(){if(i.currentDataFlat&&i.currentDataFlat[t]&&i.currentDataFlat[e])return r=1,i.currentDataFlat[t][e]})}();return Promise.resolve(o&&o.then?o.then(n):n(o))}catch(e){return Promise.reject(e)}},e}(),he=/*#__PURE__*/function(){function e(e,t,r,n){this.data=t,this.success=e,this.total=n,this.message=r||""}return e.prototype.toJson=function(){return this},e}();function pe(e){var t={exports:{}};return e(t,t.exports),t.exports}var de=pe(function(e,t){var r=q.default.Buffer;function n(e,t){for(var r in e)t[r]=e[r]}function i(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=q.default:(n(q.default,t),t.Buffer=i),n(r,i),i.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},i.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var i=r(e);return void 0!==t?"string"==typeof n?i.fill(t,n):i.fill(t):i.fill(0),i},i.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return q.default.SlowBuffer(e)}}),ve=de.Buffer;function me(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=ve.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=ve.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}M.default.inherits(me,H.default),me.prototype.write=function(e){this.buffer=ve.concat([this.buffer,ve.from(e)]),this.emit("data",e)},me.prototype.end=function(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1};var ye=me,ge=q.default.Buffer,Ee=q.default.SlowBuffer,we=be;function be(e,t){if(!ge.isBuffer(e)||!ge.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var r=0,n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}be.install=function(){ge.prototype.equal=Ee.prototype.equal=function(e){return be(this,e)}};var Se=ge.prototype.equal,Re=Ee.prototype.equal;function Ie(e){return(e/8|0)+(e%8==0?0:1)}be.restore=function(){ge.prototype.equal=Se,Ee.prototype.equal=Re};var Ae={ES256:Ie(256),ES384:Ie(384),ES512:Ie(521)},Pe=function(e){var t=Ae[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},Oe=de.Buffer;function $e(e){if(Oe.isBuffer(e))return e;if("string"==typeof e)return Oe.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function Ne(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=128&&--n,n}var je=function(e,t){e=$e(e);var r=Pe(t),n=r+1,i=e.length,o=0;if(48!==e[o++])throw new Error('Could not find expected "seq"');var s=e[o++];if(129===s&&(s=e[o++]),i-o<s)throw new Error('"seq" specified length of "'+s+'", only "'+(i-o)+'" remaining');if(2!==e[o++])throw new Error('Could not find expected "int" for "r"');var a=e[o++];if(i-o-2<a)throw new Error('"r" specified length of "'+a+'", only "'+(i-o-2)+'" available');if(n<a)throw new Error('"r" specified length of "'+a+'", max of "'+n+'" is acceptable');var u=o;if(o+=a,2!==e[o++])throw new Error('Could not find expected "int" for "s"');var c=e[o++];if(i-o!==c)throw new Error('"s" specified length of "'+c+'", expected "'+(i-o)+'"');if(n<c)throw new Error('"s" specified length of "'+c+'", max of "'+n+'" is acceptable');var l=o;if((o+=c)!==i)throw new Error('Expected to consume entire buffer, but "'+(i-o)+'" bytes remain');var f=r-a,h=r-c,p=Oe.allocUnsafe(f+a+h+c);for(o=0;o<f;++o)p[o]=0;e.copy(p,o,u+Math.max(-f,0),u+a);for(var d=o=r;o<d+h;++o)p[o]=0;return e.copy(p,o,l+Math.max(-h,0),l+c),(p=p.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},xe=de.Buffer,Te="secret must be a string or buffer",Le="key must be a string or a buffer",ke="function"==typeof U.default.createPublicKey;function De(e){if(!xe.isBuffer(e)&&"string"!=typeof e){if(!ke)throw Ge(Le);if("object"!=typeof e)throw Ge(Le);if("string"!=typeof e.type)throw Ge(Le);if("string"!=typeof e.asymmetricKeyType)throw Ge(Le);if("function"!=typeof e.export)throw Ge(Le)}}function Ce(e){if(!xe.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw Ge("key must be a string, a buffer or an object")}function _e(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Fe(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var r=0;r<t;++r)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function Ge(e){var t=[].slice.call(arguments,1),r=M.default.format.bind(M.default,e).apply(null,t);return new TypeError(r)}function Be(e){var t;return xe.isBuffer(t=e)||"string"==typeof t||(e=JSON.stringify(e)),e}function Me(e){return function(t,r){!function(e){if(!xe.isBuffer(e)){if("string"==typeof e)return e;if(!ke)throw Ge(Te);if("object"!=typeof e)throw Ge(Te);if("secret"!==e.type)throw Ge(Te);if("function"!=typeof e.export)throw Ge(Te)}}(r),t=Be(t);var n=U.default.createHmac("sha"+e,r);return _e((n.update(t),n.digest("base64")))}}function Ue(e){return function(t,r,n){var i=Me(e)(t,n);return we(xe.from(r),xe.from(i))}}function Ke(e){return function(t,r){Ce(r),t=Be(t);var n=U.default.createSign("RSA-SHA"+e);return _e((n.update(t),n.sign(r,"base64")))}}function qe(e){return function(t,r,n){De(n),t=Be(t),r=Fe(r);var i=U.default.createVerify("RSA-SHA"+e);return i.update(t),i.verify(n,r,"base64")}}function He(e){return function(t,r){Ce(r),t=Be(t);var n=U.default.createSign("RSA-SHA"+e);return _e((n.update(t),n.sign({key:r,padding:U.default.constants.RSA_PKCS1_PSS_PADDING,saltLength:U.default.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function Ve(e){return function(t,r,n){De(n),t=Be(t),r=Fe(r);var i=U.default.createVerify("RSA-SHA"+e);return i.update(t),i.verify({key:n,padding:U.default.constants.RSA_PKCS1_PSS_PADDING,saltLength:U.default.constants.RSA_PSS_SALTLEN_DIGEST},r,"base64")}}function Je(e){var t=Ke(e);return function(){var r=t.apply(null,arguments);return je(r,"ES"+e)}}function Xe(e){var t=qe(e);return function(r,n,i){return n=function(e,t){e=$e(e);var r=Pe(t),n=e.length;if(n!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+n+'"');var i=Ne(e,0,r),o=Ne(e,r,e.length),s=r-i,a=r-o,u=2+s+1+1+a,c=u<128,l=Oe.allocUnsafe((c?2:3)+u),f=0;return l[f++]=48,c?l[f++]=u:(l[f++]=129,l[f++]=255&u),l[f++]=2,l[f++]=s,i<0?(l[f++]=0,f+=e.copy(l,f,0,r)):f+=e.copy(l,f,i,r),l[f++]=2,l[f++]=a,o<0?(l[f++]=0,e.copy(l,f,r)):e.copy(l,f,r+o),l}(n,"ES"+e).toString("base64"),t(r,n,i)}}function ze(){return function(){return""}}function We(){return function(e,t){return""===t}}ke&&(Le+=" or a KeyObject",Te+="or a KeyObject");var Ye=function(e){var t={hs:Me,rs:Ke,ps:He,es:Je,none:ze},r={hs:Ue,rs:qe,ps:Ve,es:Xe,none:We},n=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!n)throw Ge('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var i=(n[1]||n[3]).toLowerCase(),o=n[2];return{sign:t[i](o),verify:r[i](o)}},Ze=q.default.Buffer,Qe=function(e){return"string"==typeof e?e:"number"==typeof e||Ze.isBuffer(e)?e.toString():JSON.stringify(e)},et=de.Buffer;function tt(e,t){return et.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function rt(e){var t=e.header,r=e.payload,n=e.secret||e.privateKey,i=e.encoding,o=Ye(t.alg),s=function(e,t,r){r=r||"utf8";var n=tt(Qe(e),"binary"),i=tt(Qe(t),r);return M.default.format("%s.%s",n,i)}(t,r,i),a=o.sign(s,n);return M.default.format("%s.%s",s,a)}function nt(e){var t=new ye(e.secret||e.privateKey||e.key);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=t,this.payload=new ye(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}M.default.inherits(nt,H.default),nt.prototype.sign=function(){try{var e=rt({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},nt.sign=rt;var it=nt,ot=de.Buffer,st=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function at(e){var t=e.split(".",1)[0];return function(e){if(function(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}(ot.from(t,"base64").toString("binary"))}function ut(e){return e.split(".")[2]}function ct(e){return st.test(e)&&!!at(e)}function lt(e,t,r){if(!t){var n=new Error("Missing algorithm parameter for jws.verify");throw n.code="MISSING_ALGORITHM",n}var i=ut(e=Qe(e)),o=function(e){return e.split(".",2).join(".")}(e);return Ye(t).verify(o,i,r)}function ft(e,t){if(t=t||{},!ct(e=Qe(e)))return null;var r=at(e);if(!r)return null;var n=function(e,t){t=t||"utf8";var r=e.split(".")[1];return ot.from(r,"base64").toString(t)}(e);return("JWT"===r.typ||t.json)&&(n=JSON.parse(n,t.encoding)),{header:r,payload:n,signature:ut(e)}}function ht(e){var t=new ye((e=e||{}).secret||e.publicKey||e.key);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=t,this.signature=new ye(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}M.default.inherits(ht,H.default),ht.prototype.verify=function(){try{var e=lt(this.signature.buffer,this.algorithm,this.key.buffer),t=ft(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},ht.decode=ft,ht.isValid=ct,ht.verify=lt;var pt=ht,dt={ALGORITHMS:["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],sign:it.sign,verify:pt.verify,decode:pt.decode,isValid:pt.isValid,createSign:function(e){return new it(e)},createVerify:function(e){return new pt(e)}},vt=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(vt.prototype=Object.create(Error.prototype)).constructor=vt;var mt=vt,yt=function(e,t){mt.call(this,e),this.name="NotBeforeError",this.date=t};(yt.prototype=Object.create(mt.prototype)).constructor=yt;var gt=yt,Et=function(e,t){mt.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(Et.prototype=Object.create(mt.prototype)).constructor=Et;var wt=Et,bt=1e3,St=60*bt,Rt=60*St,It=24*Rt;function At(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}var Pt=function(e,t){var r=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var n=function(e,t){t=t||{};var r,n,i=typeof e;if("string"===i&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*It;case"hours":case"hour":case"hrs":case"hr":case"h":return r*Rt;case"minutes":case"minute":case"mins":case"min":case"m":return r*St;case"seconds":case"second":case"secs":case"sec":case"s":return r*bt;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(e);if("number"===i&&isFinite(e))return t.long?(r=e,(n=Math.abs(r))>=It?At(r,n,It,"day"):n>=Rt?At(r,n,Rt,"hour"):n>=St?At(r,n,St,"minute"):n>=bt?At(r,n,bt,"second"):r+" ms"):function(e){var t=Math.abs(e);return t>=It?Math.round(e/It)+"d":t>=Rt?Math.round(e/Rt)+"h":t>=St?Math.round(e/St)+"m":t>=bt?Math.round(e/bt)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}(e);if(void 0===n)return;return Math.floor(r+n/1e3)}return"number"==typeof e?r+e:void 0},Ot={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||9007199254740991,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},$t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{},Nt=pe(function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:i}=Ot,o=(t=e.exports={}).re=[],s=t.safeRe=[],a=t.src=[],u=t.t={};let c=0;const l=[["\\s",1],["\\d",i],["[a-zA-Z0-9-]",n]],f=(e,t,r)=>{const n=(e=>{for(const[t,r]of l)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),i=c++;$t(e,i,t),u[e]=i,a[i]=t,o[i]=new RegExp(t,r?"g":void 0),s[i]=new RegExp(n,r?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER","\\d*[a-zA-Z-][a-zA-Z0-9-]*"),f("MAINVERSION",`(${a[u.NUMERICIDENTIFIER]})\\.(${a[u.NUMERICIDENTIFIER]})\\.(${a[u.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${a[u.NUMERICIDENTIFIERLOOSE]})\\.(${a[u.NUMERICIDENTIFIERLOOSE]})\\.(${a[u.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${a[u.NUMERICIDENTIFIER]}|${a[u.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${a[u.NUMERICIDENTIFIERLOOSE]}|${a[u.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${a[u.PRERELEASEIDENTIFIER]}(?:\\.${a[u.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${a[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${a[u.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER","[a-zA-Z0-9-]+"),f("BUILD",`(?:\\+(${a[u.BUILDIDENTIFIER]}(?:\\.${a[u.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${a[u.MAINVERSION]}${a[u.PRERELEASE]}?${a[u.BUILD]}?`),f("FULL",`^${a[u.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${a[u.MAINVERSIONLOOSE]}${a[u.PRERELEASELOOSE]}?${a[u.BUILD]}?`),f("LOOSE",`^${a[u.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${a[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${a[u.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${a[u.XRANGEIDENTIFIER]})(?:\\.(${a[u.XRANGEIDENTIFIER]})(?:\\.(${a[u.XRANGEIDENTIFIER]})(?:${a[u.PRERELEASE]})?${a[u.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${a[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${a[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${a[u.XRANGEIDENTIFIERLOOSE]})(?:${a[u.PRERELEASELOOSE]})?${a[u.BUILD]}?)?)?`),f("XRANGE",`^${a[u.GTLT]}\\s*${a[u.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${a[u.GTLT]}\\s*${a[u.XRANGEPLAINLOOSE]}$`),f("COERCE",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?(?:$|[^\\d])`),f("COERCERTL",a[u.COERCE],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${a[u.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",f("TILDE",`^${a[u.LONETILDE]}${a[u.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${a[u.LONETILDE]}${a[u.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${a[u.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",f("CARET",`^${a[u.LONECARET]}${a[u.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${a[u.LONECARET]}${a[u.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${a[u.GTLT]}\\s*(${a[u.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${a[u.GTLT]}\\s*(${a[u.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${a[u.GTLT]}\\s*(${a[u.LOOSEPLAIN]}|${a[u.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${a[u.XRANGEPLAIN]})\\s+-\\s+(${a[u.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${a[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${a[u.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});const jt=Object.freeze({loose:!0}),xt=Object.freeze({});var Tt=e=>e?"object"!=typeof e?jt:e:xt;const Lt=/^[0-9]+$/,kt=(e,t)=>{const r=Lt.test(e),n=Lt.test(t);return r&&n&&(e=+e,t=+t),e===t?0:r&&!n?-1:n&&!r?1:e<t?-1:1};var Dt={compareIdentifiers:kt,rcompareIdentifiers:(e,t)=>kt(t,e)};const{MAX_LENGTH:Ct,MAX_SAFE_INTEGER:_t}=Ot,{safeRe:Ft,t:Gt}=Nt,{compareIdentifiers:Bt}=Dt;class Mt{constructor(e,t){if(t=Tt(t),e instanceof Mt){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Ct)throw new TypeError(`version is longer than ${Ct} characters`);$t("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?Ft[Gt.LOOSE]:Ft[Gt.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>_t||this.major<0)throw new TypeError("Invalid major version");if(this.minor>_t||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>_t||this.patch<0)throw new TypeError("Invalid patch version");this.prerelease=r[4]?r[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<_t)return t}return e}):[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if($t("SemVer.compare",this.version,this.options,e),!(e instanceof Mt)){if("string"==typeof e&&e===this.version)return 0;e=new Mt(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof Mt||(e=new Mt(e,this.options)),Bt(this.major,e.major)||Bt(this.minor,e.minor)||Bt(this.patch,e.patch)}comparePre(e){if(e instanceof Mt||(e=new Mt(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],n=e.prerelease[t];if($t("prerelease compare",t,r,n),void 0===r&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===r)return-1;if(r!==n)return Bt(r,n)}while(++t)}compareBuild(e){e instanceof Mt||(e=new Mt(e,this.options));let t=0;do{const r=this.build[t],n=e.build[t];if($t("prerelease compare",t,r,n),void 0===r&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===r)return-1;if(r!==n)return Bt(r,n)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let n=this.prerelease.length;for(;--n>=0;)"number"==typeof this.prerelease[n]&&(this.prerelease[n]++,n=-2);if(-1===n){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let n=[t,e];!1===r&&(n=[t]),0===Bt(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=n):this.prerelease=n}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}var Ut=Mt,Kt=(e,t,r)=>new Ut(e,r).compare(new Ut(t,r)),qt=(e,t,r,n)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return((e,t,r)=>0===Kt(e,t,r))(e,r,n);case"!=":return((e,t,r)=>0!==Kt(e,t,r))(e,r,n);case">":return((e,t,r)=>Kt(e,t,r)>0)(e,r,n);case">=":return((e,t,r)=>Kt(e,t,r)>=0)(e,r,n);case"<":return((e,t,r)=>Kt(e,t,r)<0)(e,r,n);case"<=":return((e,t,r)=>Kt(e,t,r)<=0)(e,r,n);default:throw new TypeError(`Invalid operator: ${t}`)}},Ht=Vt;function Vt(e){var t=this;if(t instanceof Vt||(t=new Vt),t.tail=null,t.head=null,t.length=0,e&&"function"==typeof e.forEach)e.forEach(function(e){t.push(e)});else if(arguments.length>0)for(var r=0,n=arguments.length;r<n;r++)t.push(arguments[r]);return t}function Jt(e,t){e.tail=new zt(t,e.tail,null,e),e.head||(e.head=e.tail),e.length++}function Xt(e,t){e.head=new zt(t,null,e.head,e),e.tail||(e.tail=e.head),e.length++}function zt(e,t,r,n){if(!(this instanceof zt))return new zt(e,t,r,n);this.list=n,this.value=e,t?(t.next=this,this.prev=t):this.prev=null,r?(r.prev=this,this.next=r):this.next=null}Vt.Node=zt,Vt.create=Vt,Vt.prototype.removeNode=function(e){if(e.list!==this)throw new Error("removing node which does not belong to this list");var t=e.next,r=e.prev;return t&&(t.prev=r),r&&(r.next=t),e===this.head&&(this.head=t),e===this.tail&&(this.tail=r),e.list.length--,e.next=null,e.prev=null,e.list=null,t},Vt.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},Vt.prototype.pushNode=function(e){if(e!==this.tail){e.list&&e.list.removeNode(e);var t=this.tail;e.list=this,e.prev=t,t&&(t.next=e),this.tail=e,this.head||(this.head=e),this.length++}},Vt.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)Jt(this,arguments[e]);return this.length},Vt.prototype.unshift=function(){for(var e=0,t=arguments.length;e<t;e++)Xt(this,arguments[e]);return this.length},Vt.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},Vt.prototype.shift=function(){if(this.head){var e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}},Vt.prototype.forEach=function(e,t){t=t||this;for(var r=this.head,n=0;null!==r;n++)e.call(t,r.value,n,this),r=r.next},Vt.prototype.forEachReverse=function(e,t){t=t||this;for(var r=this.tail,n=this.length-1;null!==r;n--)e.call(t,r.value,n,this),r=r.prev},Vt.prototype.get=function(e){for(var t=0,r=this.head;null!==r&&t<e;t++)r=r.next;if(t===e&&null!==r)return r.value},Vt.prototype.getReverse=function(e){for(var t=0,r=this.tail;null!==r&&t<e;t++)r=r.prev;if(t===e&&null!==r)return r.value},Vt.prototype.map=function(e,t){t=t||this;for(var r=new Vt,n=this.head;null!==n;)r.push(e.call(t,n.value,this)),n=n.next;return r},Vt.prototype.mapReverse=function(e,t){t=t||this;for(var r=new Vt,n=this.tail;null!==n;)r.push(e.call(t,n.value,this)),n=n.prev;return r},Vt.prototype.reduce=function(e,t){var r,n=this.head;if(arguments.length>1)r=t;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");n=this.head.next,r=this.head.value}for(var i=0;null!==n;i++)r=e(r,n.value,i),n=n.next;return r},Vt.prototype.reduceReverse=function(e,t){var r,n=this.tail;if(arguments.length>1)r=t;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");n=this.tail.prev,r=this.tail.value}for(var i=this.length-1;null!==n;i--)r=e(r,n.value,i),n=n.prev;return r},Vt.prototype.toArray=function(){for(var e=new Array(this.length),t=0,r=this.head;null!==r;t++)e[t]=r.value,r=r.next;return e},Vt.prototype.toArrayReverse=function(){for(var e=new Array(this.length),t=0,r=this.tail;null!==r;t++)e[t]=r.value,r=r.prev;return e},Vt.prototype.slice=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var r=new Vt;if(t<e||t<0)return r;e<0&&(e=0),t>this.length&&(t=this.length);for(var n=0,i=this.head;null!==i&&n<e;n++)i=i.next;for(;null!==i&&n<t;n++,i=i.next)r.push(i.value);return r},Vt.prototype.sliceReverse=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var r=new Vt;if(t<e||t<0)return r;e<0&&(e=0),t>this.length&&(t=this.length);for(var n=this.length,i=this.tail;null!==i&&n>t;n--)i=i.prev;for(;null!==i&&n>e;n--,i=i.prev)r.push(i.value);return r},Vt.prototype.splice=function(e,t,...r){e>this.length&&(e=this.length-1),e<0&&(e=this.length+e);for(var n=0,i=this.head;null!==i&&n<e;n++)i=i.next;var o,s,a,u,c=[];for(n=0;i&&n<t;n++)c.push(i.value),i=this.removeNode(i);for(null===i&&(i=this.tail),i!==this.head&&i!==this.tail&&(i=i.prev),n=0;n<r.length;n++)a=r[n],null===(u=(s=i)===(o=this).head?new zt(a,null,s,o):new zt(a,s,s.next,o)).next&&(o.tail=u),null===u.prev&&(o.head=u),o.length++,i=u;return c},Vt.prototype.reverse=function(){for(var e=this.head,t=this.tail,r=e;null!==r;r=r.prev){var n=r.prev;r.prev=r.next,r.next=n}return this.head=t,this.tail=e,this};try{!function(e){e.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}(Vt)}catch(e){}const Wt=Symbol("max"),Yt=Symbol("length"),Zt=Symbol("lengthCalculator"),Qt=Symbol("allowStale"),er=Symbol("maxAge"),tr=Symbol("dispose"),rr=Symbol("noDisposeOnSet"),nr=Symbol("lruList"),ir=Symbol("cache"),or=Symbol("updateAgeOnGet"),sr=()=>1,ar=(e,t,r)=>{const n=e[ir].get(t);if(n){const t=n.value;if(ur(e,t)){if(lr(e,n),!e[Qt])return}else r&&(e[or]&&(n.value.now=Date.now()),e[nr].unshiftNode(n));return t.value}},ur=(e,t)=>{if(!t||!t.maxAge&&!e[er])return!1;const r=Date.now()-t.now;return t.maxAge?r>t.maxAge:e[er]&&r>e[er]},cr=e=>{if(e[Yt]>e[Wt])for(let t=e[nr].tail;e[Yt]>e[Wt]&&null!==t;){const r=t.prev;lr(e,t),t=r}},lr=(e,t)=>{if(t){const r=t.value;e[tr]&&e[tr](r.key,r.value),e[Yt]-=r.length,e[ir].delete(r.key),e[nr].removeNode(t)}};class fr{constructor(e,t,r,n,i){this.key=e,this.value=t,this.length=r,this.now=n,this.maxAge=i||0}}const hr=(e,t,r,n)=>{let i=r.value;ur(e,i)&&(lr(e,r),e[Qt]||(i=void 0)),i&&t.call(n,i.value,i.key,e)};var pr=Mr;class dr{constructor(e,t){if(t=Tt(t),e instanceof dr)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new dr(e.raw,t);if(e instanceof pr)return this.raw=e.value,this.set=[[e]],this.format(),this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().split(/\s+/).join(" "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter(e=>!Ir(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&Ar(e[0])){this.set=[e];break}}this.format()}format(){return this.range=this.set.map(e=>e.join(" ").trim()).join("||").trim(),this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&Sr)|(this.options.loose&&Rr))+":"+e,r=mr.get(t);if(r)return r;const n=this.options.loose;e=e.replace(n?yr[gr.HYPHENRANGELOOSE]:yr[gr.HYPHENRANGE],_r(this.options.includePrerelease)),$t("hyphen replace",e),e=e.replace(yr[gr.COMPARATORTRIM],Er),$t("comparator trim",e),e=e.replace(yr[gr.TILDETRIM],wr),$t("tilde trim",e),e=e.replace(yr[gr.CARETTRIM],br),$t("caret trim",e);let i=e.split(" ").map(e=>Or(e,this.options)).join(" ").split(/\s+/).map(e=>Cr(e,this.options));n&&(i=i.filter(e=>($t("loose invalid filter",e,this.options),!!e.match(yr[gr.COMPARATORLOOSE])))),$t("range list",i);const o=new Map,s=i.map(e=>new pr(e,this.options));for(const e of s){if(Ir(e))return[e];o.set(e.value,e)}o.size>1&&o.has("")&&o.delete("");const a=[...o.values()];return mr.set(t,a),a}intersects(e,t){if(!(e instanceof dr))throw new TypeError("a Range is required");return this.set.some(r=>Pr(r,t)&&e.set.some(e=>Pr(e,t)&&r.every(r=>e.every(e=>r.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new Ut(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(Fr(this.set[t],e,this.options))return!0;return!1}}var vr=dr;const mr=new class{constructor(e){if("number"==typeof e&&(e={max:e}),e||(e={}),e.max&&("number"!=typeof e.max||e.max<0))throw new TypeError("max must be a non-negative number");this[Wt]=e.max||Infinity;const t=e.length||sr;if(this[Zt]="function"!=typeof t?sr:t,this[Qt]=e.stale||!1,e.maxAge&&"number"!=typeof e.maxAge)throw new TypeError("maxAge must be a number");this[er]=e.maxAge||0,this[tr]=e.dispose,this[rr]=e.noDisposeOnSet||!1,this[or]=e.updateAgeOnGet||!1,this.reset()}set max(e){if("number"!=typeof e||e<0)throw new TypeError("max must be a non-negative number");this[Wt]=e||Infinity,cr(this)}get max(){return this[Wt]}set allowStale(e){this[Qt]=!!e}get allowStale(){return this[Qt]}set maxAge(e){if("number"!=typeof e)throw new TypeError("maxAge must be a non-negative number");this[er]=e,cr(this)}get maxAge(){return this[er]}set lengthCalculator(e){"function"!=typeof e&&(e=sr),e!==this[Zt]&&(this[Zt]=e,this[Yt]=0,this[nr].forEach(e=>{e.length=this[Zt](e.value,e.key),this[Yt]+=e.length})),cr(this)}get lengthCalculator(){return this[Zt]}get length(){return this[Yt]}get itemCount(){return this[nr].length}rforEach(e,t){t=t||this;for(let r=this[nr].tail;null!==r;){const n=r.prev;hr(this,e,r,t),r=n}}forEach(e,t){t=t||this;for(let r=this[nr].head;null!==r;){const n=r.next;hr(this,e,r,t),r=n}}keys(){return this[nr].toArray().map(e=>e.key)}values(){return this[nr].toArray().map(e=>e.value)}reset(){this[tr]&&this[nr]&&this[nr].length&&this[nr].forEach(e=>this[tr](e.key,e.value)),this[ir]=new Map,this[nr]=new Ht,this[Yt]=0}dump(){return this[nr].map(e=>!ur(this,e)&&{k:e.key,v:e.value,e:e.now+(e.maxAge||0)}).toArray().filter(e=>e)}dumpLru(){return this[nr]}set(e,t,r){if((r=r||this[er])&&"number"!=typeof r)throw new TypeError("maxAge must be a number");const n=r?Date.now():0,i=this[Zt](t,e);if(this[ir].has(e)){if(i>this[Wt])return lr(this,this[ir].get(e)),!1;const o=this[ir].get(e).value;return this[tr]&&(this[rr]||this[tr](e,o.value)),o.now=n,o.maxAge=r,o.value=t,this[Yt]+=i-o.length,o.length=i,this.get(e),cr(this),!0}const o=new fr(e,t,i,n,r);return o.length>this[Wt]?(this[tr]&&this[tr](e,t),!1):(this[Yt]+=o.length,this[nr].unshift(o),this[ir].set(e,this[nr].head),cr(this),!0)}has(e){if(!this[ir].has(e))return!1;const t=this[ir].get(e).value;return!ur(this,t)}get(e){return ar(this,e,!0)}peek(e){return ar(this,e,!1)}pop(){const e=this[nr].tail;return e?(lr(this,e),e.value):null}del(e){lr(this,this[ir].get(e))}load(e){this.reset();const t=Date.now();for(let r=e.length-1;r>=0;r--){const n=e[r],i=n.e||0;if(0===i)this.set(n.k,n.v);else{const e=i-t;e>0&&this.set(n.k,n.v,e)}}}prune(){this[ir].forEach((e,t)=>ar(this,t,!1))}}({max:1e3}),{safeRe:yr,t:gr,comparatorTrimReplace:Er,tildeTrimReplace:wr,caretTrimReplace:br}=Nt,{FLAG_INCLUDE_PRERELEASE:Sr,FLAG_LOOSE:Rr}=Ot,Ir=e=>"<0.0.0-0"===e.value,Ar=e=>""===e.value,Pr=(e,t)=>{let r=!0;const n=e.slice();let i=n.pop();for(;r&&n.length;)r=n.every(e=>i.intersects(e,t)),i=n.pop();return r},Or=(e,t)=>($t("comp",e,t),e=xr(e,t),$t("caret",e),e=Nr(e,t),$t("tildes",e),e=Lr(e,t),$t("xrange",e),e=Dr(e,t),$t("stars",e),e),$r=e=>!e||"x"===e.toLowerCase()||"*"===e,Nr=(e,t)=>e.trim().split(/\s+/).map(e=>jr(e,t)).join(" "),jr=(e,t)=>e.replace(t.loose?yr[gr.TILDELOOSE]:yr[gr.TILDE],(t,r,n,i,o)=>{let s;return $t("tilde",e,t,r,n,i,o),$r(r)?s="":$r(n)?s=`>=${r}.0.0 <${+r+1}.0.0-0`:$r(i)?s=`>=${r}.${n}.0 <${r}.${+n+1}.0-0`:o?($t("replaceTilde pr",o),s=`>=${r}.${n}.${i}-${o} <${r}.${+n+1}.0-0`):s=`>=${r}.${n}.${i} <${r}.${+n+1}.0-0`,$t("tilde return",s),s}),xr=(e,t)=>e.trim().split(/\s+/).map(e=>Tr(e,t)).join(" "),Tr=(e,t)=>{$t("caret",e,t);const r=t.includePrerelease?"-0":"";return e.replace(t.loose?yr[gr.CARETLOOSE]:yr[gr.CARET],(t,n,i,o,s)=>{let a;return $t("caret",e,t,n,i,o,s),$r(n)?a="":$r(i)?a=`>=${n}.0.0${r} <${+n+1}.0.0-0`:$r(o)?a="0"===n?`>=${n}.${i}.0${r} <${n}.${+i+1}.0-0`:`>=${n}.${i}.0${r} <${+n+1}.0.0-0`:s?($t("replaceCaret pr",s),a="0"===n?"0"===i?`>=${n}.${i}.${o}-${s} <${n}.${i}.${+o+1}-0`:`>=${n}.${i}.${o}-${s} <${n}.${+i+1}.0-0`:`>=${n}.${i}.${o}-${s} <${+n+1}.0.0-0`):($t("no pr"),a="0"===n?"0"===i?`>=${n}.${i}.${o}${r} <${n}.${i}.${+o+1}-0`:`>=${n}.${i}.${o}${r} <${n}.${+i+1}.0-0`:`>=${n}.${i}.${o} <${+n+1}.0.0-0`),$t("caret return",a),a})},Lr=(e,t)=>($t("replaceXRanges",e,t),e.split(/\s+/).map(e=>kr(e,t)).join(" ")),kr=(e,t)=>(e=e.trim()).replace(t.loose?yr[gr.XRANGELOOSE]:yr[gr.XRANGE],(r,n,i,o,s,a)=>{$t("xRange",e,r,n,i,o,s,a);const u=$r(i),c=u||$r(o),l=c||$r(s);return"="===n&&l&&(n=""),a=t.includePrerelease?"-0":"",u?r=">"===n||"<"===n?"<0.0.0-0":"*":n&&l?(c&&(o=0),s=0,">"===n?(n=">=",c?(i=+i+1,o=0,s=0):(o=+o+1,s=0)):"<="===n&&(n="<",c?i=+i+1:o=+o+1),"<"===n&&(a="-0"),r=`${n+i}.${o}.${s}${a}`):c?r=`>=${i}.0.0${a} <${+i+1}.0.0-0`:l&&(r=`>=${i}.${o}.0${a} <${i}.${+o+1}.0-0`),$t("xRange return",r),r}),Dr=(e,t)=>($t("replaceStars",e,t),e.trim().replace(yr[gr.STAR],"")),Cr=(e,t)=>($t("replaceGTE0",e,t),e.trim().replace(yr[t.includePrerelease?gr.GTE0PRE:gr.GTE0],"")),_r=e=>(t,r,n,i,o,s,a,u,c,l,f,h,p)=>`${r=$r(n)?"":$r(i)?`>=${n}.0.0${e?"-0":""}`:$r(o)?`>=${n}.${i}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`} ${u=$r(c)?"":$r(l)?`<${+c+1}.0.0-0`:$r(f)?`<${c}.${+l+1}.0-0`:h?`<=${c}.${l}.${f}-${h}`:e?`<${c}.${l}.${+f+1}-0`:`<=${u}`}`.trim(),Fr=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if($t(e[r].semver),e[r].semver!==pr.ANY&&e[r].semver.prerelease.length>0){const n=e[r].semver;if(n.major===t.major&&n.minor===t.minor&&n.patch===t.patch)return!0}return!1}return!0},Gr=Symbol("SemVer ANY");class Br{static get ANY(){return Gr}constructor(e,t){if(t=Tt(t),e instanceof Br){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),$t("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.value=this.semver===Gr?"":this.operator+this.semver.version,$t("comp",this)}parse(e){const t=e.match(this.options.loose?Ur[Kr.COMPARATORLOOSE]:Ur[Kr.COMPARATOR]);if(!t)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==t[1]?t[1]:"","="===this.operator&&(this.operator=""),this.semver=t[2]?new Ut(t[2],this.options.loose):Gr}toString(){return this.value}test(e){if($t("Comparator.test",e,this.options.loose),this.semver===Gr||e===Gr)return!0;if("string"==typeof e)try{e=new Ut(e,this.options)}catch(e){return!1}return qt(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof Br))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new vr(e.value,t).test(this.value):""===e.operator?""===e.value||new vr(this.value,t).test(e.semver):!((t=Tt(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(qt(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(qt(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}var Mr=Br;const{safeRe:Ur,t:Kr}=Nt;new pr(">=0.0.0-0"),new pr(">=0.0.0");var qr=(e,t,r)=>{try{t=new vr(t,r)}catch(e){return!1}return t.test(e)},Hr=qr(process.version,">=15.7.0"),Vr=qr(process.version,">=16.9.0");const Jr={ec:["ES256","ES384","ES512"],rsa:["RS256","PS256","RS384","PS384","RS512","PS512"],"rsa-pss":["PS256","PS384","PS512"]},Xr={ES256:"prime256v1",ES384:"secp384r1",ES512:"secp521r1"};var zr=function(e,t){if(!e||!t)return;const r=t.asymmetricKeyType;if(!r)return;const n=Jr[r];if(!n)throw new Error(`Unknown key type "${r}".`);if(!n.includes(e))throw new Error(`"alg" parameter for "${r}" key type must be one of: ${n.join(", ")}.`);if(Hr)switch(r){case"ec":const r=Xr[e];if(t.asymmetricKeyDetails.namedCurve!==r)throw new Error(`"alg" parameter "${e}" requires curve "${r}".`);break;case"rsa-pss":if(Vr){const r=parseInt(e.slice(-3),10),{hashAlgorithm:n,mgf1HashAlgorithm:i,saltLength:o}=t.asymmetricKeyDetails;if(n!==`sha${r}`||i!==n)throw new Error(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" ${e}.`);if(void 0!==o&&o>r>>3)throw new Error(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" ${e}.`)}}},Wr=qr(process.version,"^6.12.0 || >=8.0.0");const{KeyObject:Yr,createSecretKey:Zr,createPublicKey:Qr}=U.default,en=["RS256","RS384","RS512"],tn=["ES256","ES384","ES512"],rn=["RS256","RS384","RS512"],nn=["HS256","HS384","HS512"];Wr&&(en.splice(en.length,0,"PS256","PS384","PS512"),rn.splice(rn.length,0,"PS256","PS384","PS512"));var on=/^\s+|\s+$/g,sn=/^[-+]0x[0-9a-f]+$/i,an=/^0b[01]+$/i,un=/^0o[0-7]+$/i,cn=/^(?:0|[1-9]\d*)$/,ln=parseInt;function fn(e){return e!=e}var hn,pn,dn=Object.prototype,vn=dn.hasOwnProperty,mn=dn.toString,yn=dn.propertyIsEnumerable,gn=(hn=Object.keys,pn=Object,function(e){return hn(pn(e))}),En=Math.max;function wn(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||cn.test(e))&&e>-1&&e%1==0&&e<t}var bn=Array.isArray;function Sn(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!function(e){var t=Rn(e)?mn.call(e):"";return"[object Function]"==t||"[object GeneratorFunction]"==t}(e)}function Rn(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function In(e){return!!e&&"object"==typeof e}var An=Object.prototype.toString,Pn=function(e){return!0===e||!1===e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==An.call(e)},On=/^\s+|\s+$/g,$n=/^[-+]0x[0-9a-f]+$/i,Nn=/^0b[01]+$/i,jn=/^0o[0-7]+$/i,xn=parseInt,Tn=Object.prototype.toString;function Ln(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var kn=function(e){return"number"==typeof e&&e==function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==Tn.call(e)}(e))return NaN;if(Ln(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Ln(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(On,"");var r=Nn.test(e);return r||jn.test(e)?xn(e.slice(2),r?2:8):$n.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e)},Dn=Object.prototype.toString,Cn=function(e){return"number"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==Dn.call(e)},_n=Object.prototype,Fn=Function.prototype.toString,Gn=_n.hasOwnProperty,Bn=Fn.call(Object),Mn=_n.toString,Un=function(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object),Kn=function(e){if(!function(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=Mn.call(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=Un(e);if(null===t)return!0;var r=Gn.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&Fn.call(r)==Bn},qn=Object.prototype.toString,Hn=Array.isArray,Vn=function(e){return"string"==typeof e||!Hn(e)&&function(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==qn.call(e)},Jn=/^\s+|\s+$/g,Xn=/^[-+]0x[0-9a-f]+$/i,zn=/^0b[01]+$/i,Wn=/^0o[0-7]+$/i,Yn=parseInt,Zn=Object.prototype.toString;function Qn(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}const{KeyObject:ei,createSecretKey:ti,createPrivateKey:ri}=U.default,ni=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];Wr&&ni.splice(3,0,"PS256","PS384","PS512");const ii={expiresIn:{isValid:function(e){return kn(e)||Vn(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return kn(e)||Vn(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return Vn(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:function(e,t,r,n){var i;e=Sn(e)?e:(i=e)?function(e,t){return function(t,r){for(var n=-1,i=t?t.length:0,o=Array(i);++n<i;)o[n]=e[t[n]];return o}(t)}(i,function(e){return Sn(e)?function(e,t){var r=bn(e)||function(e){return function(e){return In(e)&&Sn(e)}(e)&&vn.call(e,"callee")&&(!yn.call(e,"callee")||"[object Arguments]"==mn.call(e))}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,i=!!n;for(var o in e)!vn.call(e,o)||i&&("length"==o||wn(o,n))||r.push(o);return r}(e):function(e){if((t=e)!==("function"==typeof(r=t&&t.constructor)&&r.prototype||dn))return gn(e);var t,r,n=[];for(var i in Object(e))vn.call(e,i)&&"constructor"!=i&&n.push(i);return n}(e)}(i)):[],r=r&&!n?function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||In(e)&&"[object Symbol]"==mn.call(e)}(e))return NaN;if(Rn(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Rn(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(on,"");var r=an.test(e);return r||un.test(e)?ln(e.slice(2),r?2:8):sn.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(r):0;var o=e.length;return r<0&&(r=En(o+r,0)),function(e){return"string"==typeof e||!bn(e)&&In(e)&&"[object String]"==mn.call(e)}(e)?r<=o&&e.indexOf(t,r)>-1:!!o&&function(e,t,r){if(t!=t)return function(e,t,r,n){for(var i=e.length,o=r+-1;++o<i;)if(t(e[o],o,e))return o;return-1}(e,fn,r);for(var n=r-1,i=e.length;++n<i;)if(e[n]===t)return n;return-1}(e,t,r)>-1}.bind(null,ni),message:'"algorithm" must be a valid string enum value'},header:{isValid:Kn,message:'"header" must be an object'},encoding:{isValid:Vn,message:'"encoding" must be a string'},issuer:{isValid:Vn,message:'"issuer" must be a string'},subject:{isValid:Vn,message:'"subject" must be a string'},jwtid:{isValid:Vn,message:'"jwtid" must be a string'},noTimestamp:{isValid:Pn,message:'"noTimestamp" must be a boolean'},keyid:{isValid:Vn,message:'"keyid" must be a string'},mutatePayload:{isValid:Pn,message:'"mutatePayload" must be a boolean'},allowInsecureKeySizes:{isValid:Pn,message:'"allowInsecureKeySizes" must be a boolean'},allowInvalidAsymmetricKeyTypes:{isValid:Pn,message:'"allowInvalidAsymmetricKeyTypes" must be a boolean'}},oi={iat:{isValid:Cn,message:'"iat" should be a number of seconds'},exp:{isValid:Cn,message:'"exp" should be a number of seconds'},nbf:{isValid:Cn,message:'"nbf" should be a number of seconds'}};function si(e,t,r,n){if(!Kn(r))throw new Error('Expected "'+n+'" to be a plain object.');Object.keys(r).forEach(function(i){const o=e[i];if(o){if(!o.isValid(r[i]))throw new Error(o.message)}else if(!t)throw new Error('"'+i+'" is not allowed in "'+n+'"')})}const ai={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},ui=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];var ci=function(e,t,r,n){let i;if("function"!=typeof r||n||(n=r,r={}),r||(r={}),r=Object.assign({},r),i=n||function(e,t){if(e)throw e;return t},r.clockTimestamp&&"number"!=typeof r.clockTimestamp)return i(new mt("clockTimestamp must be a number"));if(void 0!==r.nonce&&("string"!=typeof r.nonce||""===r.nonce.trim()))return i(new mt("nonce must be a non-empty string"));if(void 0!==r.allowInvalidAsymmetricKeyTypes&&"boolean"!=typeof r.allowInvalidAsymmetricKeyTypes)return i(new mt("allowInvalidAsymmetricKeyTypes must be a boolean"));const o=r.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return i(new mt("jwt must be provided"));if("string"!=typeof e)return i(new mt("jwt must be a string"));const s=e.split(".");if(3!==s.length)return i(new mt("jwt malformed"));let a;try{a=function(e,t){var r=dt.decode(e,t=t||{});if(!r)return null;var n=r.payload;if("string"==typeof n)try{var i=JSON.parse(n);null!==i&&"object"==typeof i&&(n=i)}catch(e){}return!0===t.complete?{header:r.header,payload:n,signature:r.signature}:n}(e,{complete:!0})}catch(e){return i(e)}if(!a)return i(new mt("invalid token"));const u=a.header;let c;if("function"==typeof t){if(!n)return i(new mt("verify must be called asynchronous if secret or public key is provided as a callback"));c=t}else c=function(e,r){return r(null,t)};return c(u,function(t,n){if(t)return i(new mt("error in secret or public key callback: "+t.message));const c=""!==s[2].trim();if(!c&&n)return i(new mt("jwt signature is required"));if(c&&!n)return i(new mt("secret or public key must be provided"));if(!c&&!r.algorithms)return i(new mt('please specify "none" in "algorithms" to verify unsigned tokens'));if(null!=n&&!(n instanceof Yr))try{n=Qr(n)}catch(e){try{n=Zr("string"==typeof n?Buffer.from(n):n)}catch(e){return i(new mt("secretOrPublicKey is not valid key material"))}}if(r.algorithms||(r.algorithms="secret"===n.type?nn:["rsa","rsa-pss"].includes(n.asymmetricKeyType)?rn:"ec"===n.asymmetricKeyType?tn:en),-1===r.algorithms.indexOf(a.header.alg))return i(new mt("invalid algorithm"));if(u.alg.startsWith("HS")&&"secret"!==n.type)return i(new mt(`secretOrPublicKey must be a symmetric key when using ${u.alg}`));if(/^(?:RS|PS|ES)/.test(u.alg)&&"public"!==n.type)return i(new mt(`secretOrPublicKey must be an asymmetric key when using ${u.alg}`));if(!r.allowInvalidAsymmetricKeyTypes)try{zr(u.alg,n)}catch(e){return i(e)}let l;try{l=dt.verify(e,a.header.alg,n)}catch(e){return i(e)}if(!l)return i(new mt("invalid signature"));const f=a.payload;if(void 0!==f.nbf&&!r.ignoreNotBefore){if("number"!=typeof f.nbf)return i(new mt("invalid nbf value"));if(f.nbf>o+(r.clockTolerance||0))return i(new gt("jwt not active",new Date(1e3*f.nbf)))}if(void 0!==f.exp&&!r.ignoreExpiration){if("number"!=typeof f.exp)return i(new mt("invalid exp value"));if(o>=f.exp+(r.clockTolerance||0))return i(new wt("jwt expired",new Date(1e3*f.exp)))}if(r.audience){const e=Array.isArray(r.audience)?r.audience:[r.audience];if(!(Array.isArray(f.aud)?f.aud:[f.aud]).some(function(t){return e.some(function(e){return e instanceof RegExp?e.test(t):e===t})}))return i(new mt("jwt audience invalid. expected: "+e.join(" or ")))}if(r.issuer&&("string"==typeof r.issuer&&f.iss!==r.issuer||Array.isArray(r.issuer)&&-1===r.issuer.indexOf(f.iss)))return i(new mt("jwt issuer invalid. expected: "+r.issuer));if(r.subject&&f.sub!==r.subject)return i(new mt("jwt subject invalid. expected: "+r.subject));if(r.jwtid&&f.jti!==r.jwtid)return i(new mt("jwt jwtid invalid. expected: "+r.jwtid));if(r.nonce&&f.nonce!==r.nonce)return i(new mt("jwt nonce invalid. expected: "+r.nonce));if(r.maxAge){if("number"!=typeof f.iat)return i(new mt("iat required when maxAge is specified"));const e=Pt(r.maxAge,f.iat);if(void 0===e)return i(new mt('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(o>=e+(r.clockTolerance||0))return i(new wt("maxAge exceeded",new Date(1e3*e)))}return i(null,!0===r.complete?{header:u,payload:f,signature:a.signature}:f)})},li=function(e,t,r,n){"function"==typeof r?(n=r,r={}):r=r||{};const i="object"==typeof e&&!Buffer.isBuffer(e),o=Object.assign({alg:r.algorithm||"HS256",typ:i?"JWT":void 0,kid:r.keyid},r.header);function s(e){if(n)return n(e);throw e}if(!t&&"none"!==r.algorithm)return s(new Error("secretOrPrivateKey must have a value"));if(null!=t&&!(t instanceof ei))try{t=ri(t)}catch(e){try{t=ti("string"==typeof t?Buffer.from(t):t)}catch(e){return s(new Error("secretOrPrivateKey is not valid key material"))}}if(o.alg.startsWith("HS")&&"secret"!==t.type)return s(new Error(`secretOrPrivateKey must be a symmetric key when using ${o.alg}`));if(/^(?:RS|PS|ES)/.test(o.alg)){if("private"!==t.type)return s(new Error(`secretOrPrivateKey must be an asymmetric key when using ${o.alg}`));if(!r.allowInsecureKeySizes&&!o.alg.startsWith("ES")&&void 0!==t.asymmetricKeyDetails&&t.asymmetricKeyDetails.modulusLength<2048)return s(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${o.alg}`))}if(void 0===e)return s(new Error("payload is required"));if(i){try{!function(e){si(oi,!0,e,"payload")}(e)}catch(e){return s(e)}r.mutatePayload||(e=Object.assign({},e))}else{const t=ui.filter(function(e){return void 0!==r[e]});if(t.length>0)return s(new Error("invalid "+t.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==r.expiresIn)return s(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==r.notBefore)return s(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function(e){si(ii,!1,e,"options")}(r)}catch(e){return s(e)}if(!r.allowInvalidAsymmetricKeyTypes)try{zr(o.alg,t)}catch(e){return s(e)}const a=e.iat||Math.floor(Date.now()/1e3);if(r.noTimestamp?delete e.iat:i&&(e.iat=a),void 0!==r.notBefore){try{e.nbf=Pt(r.notBefore,a)}catch(e){return s(e)}if(void 0===e.nbf)return s(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==r.expiresIn&&"object"==typeof e){try{e.exp=Pt(r.expiresIn,a)}catch(e){return s(e)}if(void 0===e.exp)return s(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(ai).forEach(function(t){const n=ai[t];if(void 0!==r[t]){if(void 0!==e[n])return s(new Error('Bad "options.'+t+'" option. The payload already has an "'+n+'" property.'));e[n]=r[t]}});const u=r.encoding||"utf8";if("function"!=typeof n){let n=dt.sign({header:o,payload:e,secret:t,encoding:u});if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(o.alg)&&n.length<256)throw new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${o.alg}`);return n}n=n&&function(e){return function(e,t){var r;if("function"!=typeof t)throw new TypeError("Expected a function");return e=function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==Zn.call(e)}(e))return NaN;if(Qn(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Qn(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Jn,"");var r=zn.test(e);return r||Wn.test(e)?Yn(e.slice(2),r?2:8):Xn.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=void 0),r}}(2,e)}(n),dt.createSign({header:o,privateKey:t,payload:e,encoding:u}).once("error",n).once("done",function(e){if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(o.alg)&&e.length<256)return n(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${o.alg}`));n(null,e)})},fi=/*#__PURE__*/function(){function e(e,t){this.privateKey=e,this.options=t}var t=e.prototype;return t.sign=function(e){var t=oe({},this.options,{jwtid:V.v4()});return li(e,this.privateKey,t)},t.verify=function(e){return ci(e,this.privateKey,this.options)},t.refresh=function(e){var t=ci(e,this.privateKey,this.options);delete t.sub,delete t.iss,delete t.aud,delete t.iat,delete t.exp,delete t.nbf,delete t.jti;var r=oe({},this.options,{jwtid:V.v4()});return li(t,this.privateKey,r)},e}(),hi=/*#__PURE__*/function(){function e(e,t,r){this.app=k.default(),this.express_config=G.default.defaultsDeep(e,{helmet:!0,json:!0,urlencoded:!0,compression:!0,cors:{origin:!0,credentials:!0},fileupload:!0,socketio:{transports:["websocket"]},traceRequests:!1}),this.statics=t,this.routes=r}var t=e.prototype;return t.initialize=function(){try{var e=function(){return Promise.resolve(t.configureRoutes(t.routes)).then(function(){return Promise.resolve(t.errorHandler()).then(function(){})})},t=this;t.config(t.express_config);var r=function(){if(t.customizeExpress)return Promise.resolve(t.customizeExpress(t.app)).then(function(){})}();return Promise.resolve(r&&r.then?r.then(e):e())}catch(e){return Promise.reject(e)}},t.customizeExpress=function(){},t.config=function(e){if(e&&e.helmet&&this.app.use(L.default(e&&G.default.isObject(e.helmet)&&e.helmet)),e&&e.json&&this.app.use(k.default.json()),e&&e.urlencoded&&this.app.use(k.default.urlencoded({extended:!0})),e&&e.compression&&this.app.use(D.default()),e&&e.cors&&(this.app.options("*",C.default(e&&G.default.isObject(e.cors)&&e.cors)),this.app.use(C.default(e&&G.default.isObject(e.cors)&&e.cors))),e&&e.fileupload&&this.app.use(_.default()),this.statics)for(var t in this.statics)this.app.use(t,k.default.static(this.statics[t]));e&&!0===e.traceRequests&&"true"!=process.env.DISABLE_LOGGER&&this.app.use(function(e,t,r){e.requestTime=Date.now(),t.on("finish",function(){var t=F.default.parse(e.url).pathname,r=Date.now()-e.requestTime;console.debug("APIRequest["+process.pid+"]::. ["+e.method+"] (user:"+(e&&e.session&&e.session.user_id||"")+")  "+t+" |-> took: "+r+" ms"),console.debug(JSON.stringify(e.body))}),r()})},t.configureRoutes=function(e){var t=k.default.Router();this.app.use(t),this.loadRoutes(this.app,e)},t.loadRoutes=function(e,t){if(t)for(var r,n=ce(t);!(r=n()).done;){var i=r.value;if(i){var o=i.configure();if(i.entity&&(o=i.configure(i.entity,{service:i.service,table:i.table})),!G.default.isEmpty(i.routes)){var s=le.expressHandler();for(var a in i.routes){var u=i.routes[a];for(var c in u){var l=u[c];Array.isArray(l)?o[c](a,l[0],s(l[1])):o[c](a,s(l))}}}o&&e.use(o)}else console.warn("Empty route")}},t.errorHandler=function(){this.app.use(function(e,t,r,n){var i=new he;i.success=!1,i.message=e.message,console.error(e),r.status(500).json(i.toJson())})},e}(),pi=/*#__PURE__*/function(e){function t(t){var r;return r=e.call(this)||this,process.env.PORT||console.log("Using 3000 as default port. Customize via env PORT."),r.port=r.normalizePort(process.env.PORT||3e3),r.clustered=process.env.CLUSTERED,r.workers=[],r.app=t,r.executeOnlyMain=function(){},r}se(t,e);var r=t.prototype;return r.setServerCls=function(e){this.server=e},r.start=function(){try{var e=this,t=function(){if("true"!=e.clustered)return e.configureSocketIO(),e.executeOnlyMain(),Promise.resolve(e.initUnclustered()).then(function(){});e.initClustered()}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.configureSocketIO=function(){this.server.express_config&&this.server.express_config.socketio&&(this.app.io=new g.Server(this.server.express_config&&this.server.express_config.socketio),this.app.io.listen(this.port+1))},r.initClustered=function(){try{var e=this,t=function(){if(!W.default.isPrimary)return Promise.resolve(e.initUnclustered()).then(function(){console.log("Worker "+process.pid+" started")});e.configureSocketIO(),e.executeOnlyMain(),(new Z.default).on("event",function(t,r){t&&t.event&&(1==process.env.DEBUG_EVENTS&&console.debug("Received '"+t.event+"' from "+t.props.owner+" at Master"),e.app.events.emit(t.event,t.props,r))});for(var t=Y.default.cpus().length,r=0;r<t;r+=1)e.initWorker();W.default.on("exit",function(t){console.log("Worker "+t.id+" died :("),e.initWorker()})}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.initWorker=function(){var e=W.default.fork();console.log("Running worker "+e.process.pid),this.workers.push(e)},r.initUnclustered=function(){try{var e=this;e.server.port=e.port;var t=J.default.Server(e.server.app);return Promise.resolve(e.server.initialize()).then(function(){function r(){function r(){if(t.on("error",function(t){e.handleErrors(t,e.server.port)}),t.on("listening",function(){console.log("Server Worker running on port: "+e.port+"!"),e.emit("listening",e.port)}),process.env.SSL&&"true"==process.env.SSL){process.env.SSL_KEY&&process.env.SSL_CERT&&process.env.SSL_PASS||(console.error("Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed"),process.exit(0));var r={key:B.default.readFileSync(z.default.resolve(process.cwd(),process.env.SSL_KEY||"key.pem")),cert:B.default.readFileSync(z.default.resolve(process.cwd(),process.env.SSL_CERT||"cert.pem")),passphrase:process.env.SSL_PASS};process.env.SSL_PORT||console.log("Using 3443 as ssl default port. Customize via env SSL_PORT.");var n=e.normalizePort(process.env.SSL_PORT||3443),i=X.default.createServer(r,e.server.app);i.listen(n),i.on("error",function(t){e.handleErrors(t,n)}),i.on("listening",function(){console.log("Server Worker running on port: "+n+"!"),e.emit("listening_ssl",n)})}}t.listen(e.server.port);var n=function(){if(e.server.afterListen)return Promise.resolve(e.server.afterListen()).then(function(){})}();return n&&n.then?n.then(r):r()}var n=function(){if(e.server.beforeListen)return Promise.resolve(e.server.beforeListen()).then(function(){})}();return n&&n.then?n.then(r):r()})}catch(e){return Promise.reject(e)}},r.normalizePort=function(e){var t=parseInt(e,10);return isNaN(t)?e:t>=0&&t},r.handleErrors=function(e,t){if("listen"!==e.syscall)throw e;var r="string"==typeof t?"Pipe "+t:"Port "+t;switch(e.code){case"EACCES":console.error(r+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(r+" is already in use"),process.exit(1);break;default:throw e}},t}(w.EventEmitter),di=/*#__PURE__*/function(e){function t(t){var r;return(r=e.call(this)||this).messages=new Z.default,r.app=t,W.default.isWorker&&r.messages.on("event",function(t,n){t&&t.event&&process.pid!==t.props.owner&&(1==process.env.DEBUG_EVENTS&&console.debug("Receiving broadcast "+t.event+" - "+process.pid),e.prototype.emit.call(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(r),t.event,oe({},t.props),n))}),r}return se(t,e),t.prototype.emit=function(t,r,n){e.prototype.emit.call(this,t,r,n),t&&r&&W.default.isWorker&&process.pid!==r.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(t+" -> Firing from "+process.pid+" to master"),r||(r={}),r.owner=process.pid,this.messages.send("event",{event:t,props:oe({},r)},n)),t&&r&&W.default.isPrimary&&this.app&&this.app.server&&this.app.server.workers&&(1==process.env.DEBUG_EVENTS&&console.debug(t+" -> Firing from master to workers"),this.messages.send("event",{event:t,props:oe({},r)},n))},t}(w.EventEmitter),vi=Q.default.configure,mi=Q.default.getLogger,yi=/*#__PURE__*/function(){function e(){}return e.configure=function(){try{var e=M.default.promisify(B.default.readFile);return Promise.resolve(e(z.default.resolve(process.cwd(),"./log4js.json"),"utf8")).then(function(e){var t,r,n;vi(JSON.parse(e)),t=mi("log"),r=mi("error"),n=mi("debug"),console.log=function(){var e=Array.prototype.slice.call(arguments);t.log("info",e[0])},console.error=function(){var e=Array.prototype.slice.call(arguments);r.log("error",e[0])},console.info=function(){var e=Array.prototype.slice.call(arguments);t.log("info",e[0])},console.debug=function(){var e=Array.prototype.slice.call(arguments);n.log("debug",e[0])},console.custom=function(e,t,r){mi(e).log(t,r)}})}catch(e){return Promise.reject(e)}},e}();function gi(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var Ei=/*#__PURE__*/function(){function e(e,t){this.router=k.default.Router(),this.publicPathsList=[].concat(e,["/login"]),this.AuthHandler=t}var t=e.prototype;return t.configure=function(){var e=this,t=le.expressHandler();return this.router.use(t(function(){return e.check.apply(e,[].slice.call(arguments))})),this.router.post("/login",t(function(){return e.loginPost.apply(e,[].slice.call(arguments))})),this.router.post("/logout",t(function(){return e.logout.apply(e,[].slice.call(arguments))})),this.router},t.check=function(e,t,r){try{var n=this;return Promise.resolve(gi(function(){for(var i,o=ce(n.publicPathsList);!(i=o()).done;)if(null!==R.pathToRegexp(i.value).exec(F.default.parse(e.url).pathname))return r();return Promise.resolve(n.AuthHandler.check(e)).then(function(e){return e?r():t.status(403).json(new he(!1,null,"Forbidden").toJson())})},function(e){return console.error(e),t.status(403).json(new he(!1,null,"Forbidden").toJson())}))}catch(e){return Promise.reject(e)}},t.loginPost=function(e,t){try{var r,n=function(e){return r?e:t.status(401).json(new he(!1,null,"Unauthorized - Missing parameters").toJson())},i=this,o=function(){if(e.body.username)return gi(function(){return Promise.resolve(i.AuthHandler.validate(e,e.body.username,e.body.password)).then(function(e){if(e){var n=t.status(200).json(new he(!0,e).toJson());return r=1,n}var i=t.status(401).json(new he(!1,null,"Unauthorized - Incorrect credentials").toJson());return r=1,i})},function(e){console.error(e);var n=t.status(401).json(new he(!1,null,"Unauthorized - Error, check log").toJson());return r=1,n})}();return Promise.resolve(o&&o.then?o.then(n):n(o))}catch(e){return Promise.reject(e)}},t.logout=function(e,t){try{var r,n=function(e){return r?e:t.status(200).json(new he(!0).toJson())},i=this,o=function(){if(i.AuthHandler.logout)return gi(function(){return Promise.resolve(i.AuthHandler.logout(e)).then(function(){var e=t.status(200).json(new he(!0).toJson());return r=1,e})},function(e){console.error(e);var n=t.status(500).json(new he(!1,null,e).toJson());return r=1,n})}();return Promise.resolve(o&&o.then?o.then(n):n(o))}catch(e){return Promise.reject(e)}},e}(),wi=function(){if(!this.check)throw new Error("AuthHandler must have 'check' vethod");if(!this.validate)throw new Error("AuthHandler must have 'validate' vethod")},bi=/*#__PURE__*/function(e){function t(t){var r;if((r=e.call(this)||this).tokenGenerator=new fi(process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE,issuer:process.env.JWT_ISSUER,subject:process.env.JWT_SUBJECT,algorithm:process.env.JWT_ALGORITHM,expiresIn:process.env.JWT_EXPIRES}),!t)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return r.userDao=t,r}se(t,e);var r=t.prototype;return r.check=function(e){try{if(e.headers.authorization){var t=(e.headers.authorization||"").split(" ")[1]||"";if(!t)return console.error("Token needed"),Promise.resolve(!1);try{var r=this.tokenGenerator.verify(t);return r.sub&&r.username&&!ee.default(r.exp).isAfter(new Date)?(e.session=oe({},e.session,r),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return console.error(e),Promise.resolve(!1)}}return Promise.resolve(!1)}catch(e){return Promise.reject(e)}},r.validate=function(e,t,r){try{var n=this;return Promise.resolve(n.userDao.findByUsername(t)).then(function(e){return!(!e||e.username!==t||e.password!==le.encrypt(r))&&n.tokenGenerator.sign(G.default.omit(e,["password"]))})}catch(e){return Promise.reject(e)}},t}(wi),Si=/*#__PURE__*/function(e){function t(t){var r;if(r=e.call(this)||this,!t)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return r.userDao=t,r}se(t,e);var r=t.prototype;return r.check=function(e){try{var t,r=function(r){return t?r:!(!e.session||!e.session.username)},n=this,i=function(){if(e.headers.authorization){var r=(e.headers.authorization||"").split(" ")[1]||"",i=Buffer.from(r,"base64").toString().split(":");return Promise.resolve(n.validate(e,i[0],i[1])).then(function(e){return e?t=!0:(t=1,!1)})}}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},r.validate=function(e,t,r){try{return Promise.resolve(this.userDao.findByUsername(t)).then(function(n){return!(!n||n.username!==t||n.password!==le.encrypt(r)||(e.session=oe({},e.session,G.default.omit(n,["password"])),0))})}catch(e){return Promise.reject(e)}},r.logout=function(e){return new Promise(function(t){e.session&&e.session.destroy(t)})},t}(wi),Ri=new(/*#__PURE__*/function(){function e(){}var t=e.prototype;return t.init=function(e){this.connection=te.default(e)},t.setColumnAliases=function(e){this.columnAliases=e},t.test=function(){return this.connection.raw("select 1+1 as result")},e}()),Ii=/*#__PURE__*/function(){function e(){}return e.parseQueryString=function(e,t,r){var n={allowGlobalSearch:!0,caseInsensitive:!0};Ri.columnAliases&&Ri.columnAliases[r]&&(n.aliases=Ri.columnAliases[r]),void 0!==Ri.caseInsensitive&&(n.caseInsensitive=Ri.caseInsensitive),void 0!==Ri.allowGlobalSearch&&(n.allowGlobalSearch=Ri.allowGlobalSearch);var i=new A.FQLParser(n).parse(t);return new A.KnexParser(r).toKnex(e,i)},e.parseFilters=function(t,r,n){var i=t;for(var o in r){var s=r[o];if("object"==typeof s)switch(s.type){case"fql":i=e.parseQueryString(i,s.value,n);break;case"date":case"between":s.start&&s.end&&(i=i.whereBetween(o,[s.start,s.end])),s.start&&!s.end&&(i=i.where(o,">=",s.start)),!s.start&&s.end&&(i=i.where(o,">=",s.end));break;case"dateraw":case"betweenraw":s.start&&s.end&&(i=i.whereRaw(o+" BETWEEN ? AND ?",[s.start,s.end])),s.start&&!s.end&&(i=i.whereRaw(o+" >= ?",[s.start])),!s.start&&s.end&&(i=i.whereRaw(o+" >= ?",[s.end]));break;case"jsonb":i=i.whereRaw(o+" ILIKE ?",["%"+s.value+"%"]);break;case"full-text-psql":i=i.whereRaw("to_tsvector("+o+"::text) @@ to_tsquery(?)",[s.value]);break;case"greater":case"greaterraw":i=i.whereRaw(o+" > ?",[s.value]);break;case"greaterEq":case"greaterEqraw":i=i.whereRaw(o+" >= ?",[s.value]);break;case"less":case"lessraw":i=i.whereRaw(o+" < ?",[s.value]);break;case"lessEq":case"lessEqraw":i=i.whereRaw(o+" <= ?",[s.value]);break;case"exists":i=i.whereExists(o);break;case"notexists":i=i.whereNotExists(o);break;case"exact":case"exactraw":i=i.whereRaw(o+" = ?",[s.value]);break;case"in":var a=o;a.includes(",")&&(a=o.split(",")),Array.isArray(s.value)||null==s.value?null!=s.value&&(i=i.whereIn(a,s.value)):i=i.whereIn(a,s.value.split(","));break;case"inraw":Array.isArray(s.value)||null==s.value?null!=s.value&&(i=i.whereRaw(o+" IN (?)",[s.value.map(function(e){return"'"+e+"'"}).join(",")])):i=i.whereRaw(o+" IN (?)",[s.value.split(",").map(function(e){return"'"+e+"'"}).join(",")]);break;case"not":case"notraw":i=i.whereRaw(o+" != ?",[s.value]);break;case"like":case"likeraw":var u=le.replaceAll(s.value,"*","%");i=i.whereRaw(" "+o+" LIKE ?",[u]);break;case"notlike":case"notlikeraw":var c=le.replaceAll(s.value,"*","%");i=i.whereRaw(" "+o+" NOT LIKE ?",[c]);break;case"likeI":var l=le.replaceAll(s.value,"*","%");i=i.whereRaw(" "+o+" ILIKE ?",[l]);break;case"notlikeI":var f=le.replaceAll(s.value,"*","%");i=i.whereRaw(" "+o+" NOT ILIKE ?",[f]);break;case"null":case"nullraw":i=i.whereRaw(o+" is NULL");break;case"notnull":case"notnullraw":i=i.whereRaw(o+" is not NULL")}else i=i.where(o,s)}return i},e.parseSort=function(e){if(!e.field||!e.direction)return 1;var t="ASC";return"descend"===e.direction&&(t="DESC"),e.field+" "+t},e}(),Ai=/*#__PURE__*/function(){function e(){this.tableName=""}var t=e.prototype;return t.loadAllData=function(e,t){return Ri.connection.select("*").from(this.tableName).limit(t||1e4).offset(e)},t.loadFilteredData=function(e,t,r){try{var n=this,i=1;return e.sort&&(i=Ii.parseSort(e.sort)),Promise.resolve(Ri.connection.from(n.tableName).where(function(t){return Ii.parseFilters(t,G.default.omit(e,["sort","start","limit"]),n.tableName)}).orderByRaw(i).limit(r).offset(t))}catch(e){return Promise.reject(e)}},t.countFilteredData=function(e){try{var t=this;return Promise.resolve(Ri.connection.from(t.tableName).where(function(r){return Ii.parseFilters(r,G.default.omit(e,["sort","start","limit"]),t.tableName)}).count("id",{as:"total"})).then(function(e){return e&&e[0].total})}catch(e){return Promise.reject(e)}},t.loadById=function(e){try{return Promise.resolve(Ri.connection.from(this.tableName).where("id",e)).then(function(e){return e&&e[0]?e[0]:null})}catch(e){return Promise.reject(e)}},t.save=function(e){return Ri.connection.from(this.tableName).insert(e).returning("*")},t.update=function(e,t){return Ri.connection.from(this.tableName).where("id",e).update(t).returning("*")},t.delete=function(e){try{var t=this;return Promise.resolve(t.loadById(e)).then(function(r){if(!r)throw"NotFound";return Ri.connection.from(t.tableName).where("id",e).delete()})}catch(e){return Promise.reject(e)}},e}(),Pi=/*#__PURE__*/function(e){function t(t){var r;if(!(r=e.call(this,t)||this).findByUsername)throw new Error("AuthHandler must have 'findByUsername' method");return r}return se(t,e),t}(Ai);function Oi(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}var $i=/*#__PURE__*/function(){function e(){this.router=k.default.Router(),this.routes={}}var t=e.prototype;return t.configure=function(e,t){var r=this;if(!e)return this.router;var n=le.expressHandler();return this.router.get("/"+e,n(function(){return r.listEntidad.apply(r,[].slice.call(arguments))})),this.router.post("/"+e+"/list",n(function(){return r.listEntidad.apply(r,[].slice.call(arguments))})),this.router.get("/"+e+"/:id",n(function(){return r.getEntidad.apply(r,[].slice.call(arguments))})),this.router.post("/"+e,n(function(){return r.saveEntidad.apply(r,[].slice.call(arguments))})),this.router.put("/"+e+"/:id",n(function(){return r.updateEntidad.apply(r,[].slice.call(arguments))})),this.router.delete("/"+e+"/:id",n(function(){return r.deleteEntidad.apply(r,[].slice.call(arguments))})),this.service=t.service,this.table=t.table,this.router},t.listEntidad=function(e,t,r){try{var n=this,i=Oi(function(){var r=new n.service(null,n.table),i="POST"===e.method?e.body:e.query&&e.query.filters?JSON.parse(e.query.filters):{};return Promise.resolve(r.list(i,i.start,i.limit)).then(function(e){var r=new he(!0,e.data,null,e.total);t.json(r.toJson())})},function(e){r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.getEntidad=function(e,t,r){try{var n=this,i=Oi(function(){var r=new n.service(null,n.table);return Promise.resolve(r.loadById(e.params.id)).then(function(e){var r=new he(!0,e),n=200;null==e&&(n=404,r=new he(!1,null,"Element not found",0)),t.status(n).json(r.toJson())})},function(e){console.error(e);var r="";"22P02"==e.code&&(r="Expected uiid");var n=new he(!1,null,r,0);t.status(400).json(n.toJson())});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.saveEntidad=function(e,t,r){try{var n=this,i=Oi(function(){var r=new n.service(null,n.table);return Promise.resolve(r.save(e.body)).then(function(r){var n=new he(!0,r&&r[0]||{id:e.body.id});t.setHeader("Location","/entity/"+n.data.id),t.status(201).json(n.toJson())})},function(e){r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.updateEntidad=function(e,t,r){try{var n=this,i=Oi(function(){var r=new n.service(null,n.table);return Promise.resolve(r.update(e.params.id,e.body)).then(function(r){var n=new he(!0,r&&r[0]||{id:e.body.id});t.json(n.toJson())})},function(e){r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.deleteEntidad=function(e,t,r){try{var n=this,i=Oi(function(){var r=new n.service(null,n.table);return Promise.resolve(r.delete(e.params.id)).then(function(e){var r=new he(!0,e);t.status(204).json(r.toJson())})},function(e){if(console.error(e),"NotFound"==e){var n=new he(!1,null,"Element not found",0);t.status(404).json(n.toJson())}else r(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}(),Ni=/*#__PURE__*/function(){function e(e,t){this.dao=e?new e:new Ai,t&&(this.dao.tableName=t)}var t=e.prototype;return t.list=function(e,t,r){try{var n=this,i=t||0,o=r||1e3,s={};return Promise.resolve(n.dao.countFilteredData(e,i,o)).then(function(a){var u;function c(e){return u?e:Promise.resolve(n.dao.loadAllData(t,r)).then(function(e){return s.data=e,s})}s.total=a;var l=function(){if(e&&0!==Object.keys(e).length)return Promise.resolve(n.dao.loadFilteredData(e,i,o)).then(function(e){return s.data=e,u=1,s})}();return l&&l.then?l.then(c):c(l)})}catch(e){return Promise.reject(e)}},t.loadById=function(e){return this.dao.loadById(e)},t.save=function(e){return this.dao.save(e)},t.update=function(e,t){if(e)return this.dao.update(e,t)},t.delete=function(e){if(e)return this.dao.delete(e)},e}();function ji(e,t,r){if(!e.s){if(r instanceof xi){if(!r.s)return void(r.o=ji.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(ji.bind(null,e,t),ji.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}const xi=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,i=this.s;if(i){const e=1&i?t:r;if(e){try{ji(n,1,e(this.v))}catch(e){ji(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?ji(n,1,t?t(i):i):r?ji(n,1,r(i)):ji(n,2,i)}catch(e){ji(n,2,e)}},n},e}();function Ti(e){return e instanceof xi&&1&e.s}var Li=new(/*#__PURE__*/function(){function e(){this.serverClass=hi,this.clusterClass=pi}var t=e.prototype;return t.runtime=function(e){return function(e){try{var t,r,n,i,o,s,a,u=ie.default(j.hideBin(process.argv)).usage("Como usar: \n            node $0 [options] \n            \n            ** Si no se especifican parámetros el servidor arrancará normalmente. **").alias("g","generateKeys").describe("g","Genera unas claves para la aplicación").alias("c","encrypt").describe("c","Codifica el String proporcionado en base a la contraseña de .env").nargs("c",1).help("h").alias("h","help"),c=[];if(e)for(r=ce(e);!(n=r()).done;)u.alias((i=n.value).key,i.alias),i.describe&&u.describe(i.key,i.describe),0!==i.nargs&&u.nargs(i.key,i.nargs),i.boolean&&u.boolean(i.key),i.choices&&u.choices(i.key,i.choices),i.required&&c.push(i.key);0!==c.length&&u.demandOption(c);var l=u.argv;return l.generateKeys?(console.log("Generando claves para encriptación:"),console.log(le.generateKeys()),Promise.resolve(process.exit(1))):l.encrypt?(console.log("Resultado encryptación:"),console.log(le.encrypt(l.encrypt)),Promise.resolve(process.exit(1))):Promise.resolve(function(){if(e)return o=ce(e),function(e,t,r){for(var n;;){var i=e();if(Ti(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!Ti(o)){n=1;break}o=o.s}}var s=new xi,a=ji.bind(null,s,2);return(0===n?i.then(c):1===n?o.then(u):(void 0).then(function(){(i=e())?i.then?i.then(c).then(void 0,a):c(i):ji(s,1,o)})).then(void 0,a),s;function u(t){o=t;do{if(!(i=e())||Ti(i)&&!i.v)return void ji(s,1,o);if(i.then)return void i.then(c).then(void 0,a);Ti(o=r())&&(o=o.v)}while(!o||!o.then);o.then(u).then(void 0,a)}function c(e){e?(o=r())&&o.then?o.then(u).then(void 0,a):u(o):ji(s,1,o)}}(function(){return!t&&!(s=o()).done},0,function(){return a=s.value,function(){if(l[a.key])return Promise.resolve(a.fn(l)).then(function(){var e=process.exit(1);return t=1,e})}()})}())}catch(e){return Promise.reject(e)}}(e)},t.init=function(e){try{var t=function(){var t=new r.serverClass(e,r.statics,r.routes);return r.customizeExpress&&(t.customizeExpress=r.customizeExpress),r.beforeListen&&(t.beforeListen=r.beforeListen),r.afterListen&&(t.afterListen=r.afterListen),r.events=new di(r),r.i18n=new fe(null==e?void 0:e.disableI18nWatcher),Promise.resolve(r.i18n.load()).then(function(){r.server=new r.clusterClass(r),r.server.setServerCls(t),r.server.executeOnlyMain=function(){r.executeOnlyMain&&r.executeOnlyMain(),"true"==process.env.REPL_ENABLED&&r.startRepl()}})},r=this,n=function(){if("true"!=process.env.DISABLE_LOGGER)return Promise.resolve(yi.configure()).then(function(){})}();return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},t.start=function(){try{if(!this.server)throw new Error("Call init first");return Promise.resolve(this.server.start()).then(function(){})}catch(e){return Promise.reject(e)}},t.startRepl=function(){var e=this;try{re.default.createServer(function(t){var r=ne.default.start({prompt:"lisco::remote> ",input:t,output:t,terminal:!0,useColors:!0,preview:!1});r.context.app=e,r.context.Utils=le,r.context.db=Ri.connection,r.on("exit",t.end.bind(t))}).listen(process.env.REPL_PORT||5001)}catch(e){console.log("Remote REPL Conn: "+e)}console.log("Remote REPL started on port "+(process.env.REPL_PORT||5001))},e}());exports.App=Li,exports.AuthController=Ei,exports.BaseController=$i,exports.BaseKnexDao=Ai,exports.BaseService=Ni,exports.ClusterServer=pi,exports.CookieAuthHandler=Si,exports.EventHandler=di,exports.I18nLoader=fe,exports.IAuthHandler=wi,exports.IUserDao=Pi,exports.JsonResponse=he,exports.JwtAuthHandler=bi,exports.KnexConnector=Ri,exports.KnexFilterParser=Ii,exports.Logger=yi,exports.Server=hi,exports.TokenGenerator=fi,exports.Utils=le;
//# sourceMappingURL=lisco.cjs.map
