import e from"helmet";import t from"express";import r from"compression";import s from"cors";import n from"express-fileupload";import i from"url";import o from"lodash";import a from"fs";import l from"util";import c from"crypto";import u from"chokidar";import h from"buffer";import f from"stream";import*as p from"uuid";import d from"http";import m from"https";import y from"path";import v from"cluster";import{Server as g}from"socket.io";import E from"os";import{EventEmitter as w}from"events";import b from"cluster-messages";import S from"log4js";import{pathToRegexp as R}from"path-to-regexp";import $ from"moment";import{FQLParser as I,KnexParser as A}from"@landra_sistemas/fql-parser";import O from"knex";import N from"net";import T from"repl";import L from"yargs/yargs";import{hideBin as x}from"yargs/helpers";class j{static arrayToLower(e){return e.join("~").toLowerCase().split("~")}static replaceAll(e,t,r){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),r)}static encrypt(e){const t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),s=c.createCipheriv("aes-256-cbc",t,r);let n=s.update(e);return n=Buffer.concat([n,s.final()]),n.toString("hex")}static decrypt(e){const t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),s=Buffer.from(e,"hex"),n=c.createDecipheriv("aes-256-cbc",t,r);let i=n.update(s);return i=Buffer.concat([i,n.final()]),i.toString()}static sleep(e){return l.promisify(setTimeout)(e)}static generateKeys(){return{key:c.randomBytes(32).toString("hex"),iv:c.randomBytes(16).toString("hex")}}static flattenObject(e){let t,r={};for(let s in e)if(e.hasOwnProperty(s))if(e[s]&&Array===e[s].constructor)r[s]=e[s];else if("object"==typeof e[s]){t=j.flattenObject(e[s]);for(let e in t)t.hasOwnProperty(e)&&(t[e]&&Array===t.constructor||(r[s+(isNaN(e)?"."+e:"")]=t[e]))}else r[s]=e[s];return r}static unflatten(e){var t={};for(var r in e){var s=r.split(".");s.reduce(function(t,n,i){return t[n]||(t[n]=isNaN(Number(s[i+1]))?s.length-1==i?e[r]:{}:[])},t)}return t}static expressHandler(){return e=>function(...t){const r=e(...t),s=t[t.length-1];return Promise.resolve(r).catch(e=>s(e))}}}class P{constructor(e){this.watcher={},this.disableWatchers=e}async load(e){const t=e||process.env.DEFAULT_LANG;this.currentData||(this.currentData={}),this.currentDataFlat||(this.currentDataFlat={});const r=process.cwd()+"/i18n/lang_"+t+".json";this.disableWatchers||(this.watcher[t]=u.watch(r,{ignored:/(^|[/\\])\../,persistent:!0}),this.watcher[t].on("change",e=>this.loadFile(e,t))),await this.loadFile(r,t)}async loadFile(e,t){const r=l.promisify(a.readFile);try{const n=await r(e,"utf8");var s=JSON.parse(n);this.currentDataFlat[t]=j.flattenObject(s),this.currentData[t]=s}catch(e){if("ENOENT"===(null==e?void 0:e.code))return console.log("Lang file does not exist. Create it on ./i18n/lang_{xx}.json");console.error(e)}}async translate(e,t){return t||(t=process.env.DEFAULT_LANG),this.currentDataFlat&&this.currentDataFlat[t]&&this.currentDataFlat[t][e]?this.currentData[t][e]:this.currentDataFlat&&this.currentDataFlat[t]||(await this.load(t),!(this.currentDataFlat&&this.currentDataFlat[t]&&this.currentDataFlat[e]))?"undefined."+e:this.currentDataFlat[t][e]}}class k{constructor(e,t,r,s){this.data=t,this.success=e,this.total=s,this.message=r||""}toJson(){return this}}function D(){return D=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},D.apply(this,arguments)}function C(e){var t={exports:{}};return e(t,t.exports),t.exports}var _=C(function(e,t){var r=h.Buffer;function s(e,t){for(var r in e)t[r]=e[r]}function n(e,t,s){return r(e,t,s)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=h:(s(h,t),t.Buffer=n),s(r,n),n.from=function(e,t,s){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,s)},n.alloc=function(e,t,s){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=r(e);return void 0!==t?"string"==typeof s?n.fill(t,s):n.fill(t):n.fill(0),n},n.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},n.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return h.SlowBuffer(e)}}),F=_.Buffer;function G(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=F.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=F.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}l.inherits(G,f),G.prototype.write=function(e){this.buffer=F.concat([this.buffer,F.from(e)]),this.emit("data",e)},G.prototype.end=function(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1};var B=G,M=h.Buffer,U=h.SlowBuffer,K=H;function H(e,t){if(!M.isBuffer(e)||!M.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var r=0,s=0;s<e.length;s++)r|=e[s]^t[s];return 0===r}H.install=function(){M.prototype.equal=U.prototype.equal=function(e){return H(this,e)}};var V=M.prototype.equal,X=U.prototype.equal;function z(e){return(e/8|0)+(e%8==0?0:1)}H.restore=function(){M.prototype.equal=V,U.prototype.equal=X};var J={ES256:z(256),ES384:z(384),ES512:z(521)},W=function(e){var t=J[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},q=_.Buffer;function Y(e){if(q.isBuffer(e))return e;if("string"==typeof e)return q.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function Z(e,t,r){for(var s=0;t+s<r&&0===e[t+s];)++s;return e[t+s]>=128&&--s,s}var Q=function(e,t){e=Y(e);var r=W(t),s=r+1,n=e.length,i=0;if(48!==e[i++])throw new Error('Could not find expected "seq"');var o=e[i++];if(129===o&&(o=e[i++]),n-i<o)throw new Error('"seq" specified length of "'+o+'", only "'+(n-i)+'" remaining');if(2!==e[i++])throw new Error('Could not find expected "int" for "r"');var a=e[i++];if(n-i-2<a)throw new Error('"r" specified length of "'+a+'", only "'+(n-i-2)+'" available');if(s<a)throw new Error('"r" specified length of "'+a+'", max of "'+s+'" is acceptable');var l=i;if(i+=a,2!==e[i++])throw new Error('Could not find expected "int" for "s"');var c=e[i++];if(n-i!==c)throw new Error('"s" specified length of "'+c+'", expected "'+(n-i)+'"');if(s<c)throw new Error('"s" specified length of "'+c+'", max of "'+s+'" is acceptable');var u=i;if((i+=c)!==n)throw new Error('Expected to consume entire buffer, but "'+(n-i)+'" bytes remain');var h=r-a,f=r-c,p=q.allocUnsafe(h+a+f+c);for(i=0;i<h;++i)p[i]=0;e.copy(p,i,l+Math.max(-h,0),l+a);for(var d=i=r;i<d+f;++i)p[i]=0;return e.copy(p,i,u+Math.max(-f,0),u+c),(p=p.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},ee=_.Buffer,te="secret must be a string or buffer",re="key must be a string or a buffer",se="function"==typeof c.createPublicKey;function ne(e){if(!ee.isBuffer(e)&&"string"!=typeof e){if(!se)throw le(re);if("object"!=typeof e)throw le(re);if("string"!=typeof e.type)throw le(re);if("string"!=typeof e.asymmetricKeyType)throw le(re);if("function"!=typeof e.export)throw le(re)}}function ie(e){if(!ee.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw le("key must be a string, a buffer or an object")}function oe(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function ae(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var r=0;r<t;++r)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function le(e){var t=[].slice.call(arguments,1),r=l.format.bind(l,e).apply(null,t);return new TypeError(r)}function ce(e){var t;return ee.isBuffer(t=e)||"string"==typeof t||(e=JSON.stringify(e)),e}function ue(e){return function(t,r){!function(e){if(!ee.isBuffer(e)){if("string"==typeof e)return e;if(!se)throw le(te);if("object"!=typeof e)throw le(te);if("secret"!==e.type)throw le(te);if("function"!=typeof e.export)throw le(te)}}(r),t=ce(t);var s=c.createHmac("sha"+e,r);return oe((s.update(t),s.digest("base64")))}}function he(e){return function(t,r,s){var n=ue(e)(t,s);return K(ee.from(r),ee.from(n))}}function fe(e){return function(t,r){ie(r),t=ce(t);var s=c.createSign("RSA-SHA"+e);return oe((s.update(t),s.sign(r,"base64")))}}function pe(e){return function(t,r,s){ne(s),t=ce(t),r=ae(r);var n=c.createVerify("RSA-SHA"+e);return n.update(t),n.verify(s,r,"base64")}}function de(e){return function(t,r){ie(r),t=ce(t);var s=c.createSign("RSA-SHA"+e);return oe((s.update(t),s.sign({key:r,padding:c.constants.RSA_PKCS1_PSS_PADDING,saltLength:c.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function me(e){return function(t,r,s){ne(s),t=ce(t),r=ae(r);var n=c.createVerify("RSA-SHA"+e);return n.update(t),n.verify({key:s,padding:c.constants.RSA_PKCS1_PSS_PADDING,saltLength:c.constants.RSA_PSS_SALTLEN_DIGEST},r,"base64")}}function ye(e){var t=fe(e);return function(){var r=t.apply(null,arguments);return Q(r,"ES"+e)}}function ve(e){var t=pe(e);return function(r,s,n){return s=function(e,t){e=Y(e);var r=W(t),s=e.length;if(s!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+s+'"');var n=Z(e,0,r),i=Z(e,r,e.length),o=r-n,a=r-i,l=2+o+1+1+a,c=l<128,u=q.allocUnsafe((c?2:3)+l),h=0;return u[h++]=48,c?u[h++]=l:(u[h++]=129,u[h++]=255&l),u[h++]=2,u[h++]=o,n<0?(u[h++]=0,h+=e.copy(u,h,0,r)):h+=e.copy(u,h,n,r),u[h++]=2,u[h++]=a,i<0?(u[h++]=0,e.copy(u,h,r)):e.copy(u,h,r+i),u}(s,"ES"+e).toString("base64"),t(r,s,n)}}function ge(){return function(){return""}}function Ee(){return function(e,t){return""===t}}se&&(re+=" or a KeyObject",te+="or a KeyObject");var we=function(e){var t={hs:ue,rs:fe,ps:de,es:ye,none:ge},r={hs:he,rs:pe,ps:me,es:ve,none:Ee},s=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!s)throw le('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var n=(s[1]||s[3]).toLowerCase(),i=s[2];return{sign:t[n](i),verify:r[n](i)}},be=h.Buffer,Se=function(e){return"string"==typeof e?e:"number"==typeof e||be.isBuffer(e)?e.toString():JSON.stringify(e)},Re=_.Buffer;function $e(e,t){return Re.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Ie(e){var t=e.header,r=e.payload,s=e.secret||e.privateKey,n=e.encoding,i=we(t.alg),o=function(e,t,r){r=r||"utf8";var s=$e(Se(e),"binary"),n=$e(Se(t),r);return l.format("%s.%s",s,n)}(t,r,n),a=i.sign(o,s);return l.format("%s.%s",o,a)}function Ae(e){var t=new B(e.secret||e.privateKey||e.key);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=t,this.payload=new B(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}l.inherits(Ae,f),Ae.prototype.sign=function(){try{var e=Ie({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},Ae.sign=Ie;var Oe=Ae,Ne=_.Buffer,Te=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function Le(e){var t=e.split(".",1)[0];return function(e){if(function(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}(Ne.from(t,"base64").toString("binary"))}function xe(e){return e.split(".")[2]}function je(e){return Te.test(e)&&!!Le(e)}function Pe(e,t,r){if(!t){var s=new Error("Missing algorithm parameter for jws.verify");throw s.code="MISSING_ALGORITHM",s}var n=xe(e=Se(e)),i=function(e){return e.split(".",2).join(".")}(e);return we(t).verify(i,n,r)}function ke(e,t){if(t=t||{},!je(e=Se(e)))return null;var r=Le(e);if(!r)return null;var s=function(e,t){t=t||"utf8";var r=e.split(".")[1];return Ne.from(r,"base64").toString(t)}(e);return("JWT"===r.typ||t.json)&&(s=JSON.parse(s,t.encoding)),{header:r,payload:s,signature:xe(e)}}function De(e){var t=new B((e=e||{}).secret||e.publicKey||e.key);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=t,this.signature=new B(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}l.inherits(De,f),De.prototype.verify=function(){try{var e=Pe(this.signature.buffer,this.algorithm,this.key.buffer),t=ke(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},De.decode=ke,De.isValid=je,De.verify=Pe;var Ce=De,_e={ALGORITHMS:["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],sign:Oe.sign,verify:Ce.verify,decode:Ce.decode,isValid:Ce.isValid,createSign:function(e){return new Oe(e)},createVerify:function(e){return new Ce(e)}},Fe=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(Fe.prototype=Object.create(Error.prototype)).constructor=Fe;var Ge=Fe,Be=function(e,t){Ge.call(this,e),this.name="NotBeforeError",this.date=t};(Be.prototype=Object.create(Ge.prototype)).constructor=Be;var Me=Be,Ue=function(e,t){Ge.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(Ue.prototype=Object.create(Ge.prototype)).constructor=Ue;var Ke=Ue,He=1e3,Ve=60*He,Xe=60*Ve,ze=24*Xe;function Je(e,t,r,s){var n=t>=1.5*r;return Math.round(e/r)+" "+s+(n?"s":"")}var We=function(e,t){var r=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var s=function(e,t){t=t||{};var r,s,n=typeof e;if("string"===n&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*ze;case"hours":case"hour":case"hrs":case"hr":case"h":return r*Xe;case"minutes":case"minute":case"mins":case"min":case"m":return r*Ve;case"seconds":case"second":case"secs":case"sec":case"s":return r*He;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(e);if("number"===n&&isFinite(e))return t.long?(r=e,(s=Math.abs(r))>=ze?Je(r,s,ze,"day"):s>=Xe?Je(r,s,Xe,"hour"):s>=Ve?Je(r,s,Ve,"minute"):s>=He?Je(r,s,He,"second"):r+" ms"):function(e){var t=Math.abs(e);return t>=ze?Math.round(e/ze)+"d":t>=Xe?Math.round(e/Xe)+"h":t>=Ve?Math.round(e/Ve)+"m":t>=He?Math.round(e/He)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}(e);if(void 0===s)return;return Math.floor(r+s/1e3)}return"number"==typeof e?r+e:void 0},qe={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||9007199254740991,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},Ye="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{},Ze=C(function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:s,MAX_LENGTH:n}=qe,i=(t=e.exports={}).re=[],o=t.safeRe=[],a=t.src=[],l=t.t={};let c=0;const u=[["\\s",1],["\\d",n],["[a-zA-Z0-9-]",s]],h=(e,t,r)=>{const s=(e=>{for(const[t,r]of u)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),n=c++;Ye(e,n,t),l[e]=n,a[n]=t,i[n]=new RegExp(t,r?"g":void 0),o[n]=new RegExp(s,r?"g":void 0)};h("NUMERICIDENTIFIER","0|[1-9]\\d*"),h("NUMERICIDENTIFIERLOOSE","\\d+"),h("NONNUMERICIDENTIFIER","\\d*[a-zA-Z-][a-zA-Z0-9-]*"),h("MAINVERSION",`(${a[l.NUMERICIDENTIFIER]})\\.(${a[l.NUMERICIDENTIFIER]})\\.(${a[l.NUMERICIDENTIFIER]})`),h("MAINVERSIONLOOSE",`(${a[l.NUMERICIDENTIFIERLOOSE]})\\.(${a[l.NUMERICIDENTIFIERLOOSE]})\\.(${a[l.NUMERICIDENTIFIERLOOSE]})`),h("PRERELEASEIDENTIFIER",`(?:${a[l.NUMERICIDENTIFIER]}|${a[l.NONNUMERICIDENTIFIER]})`),h("PRERELEASEIDENTIFIERLOOSE",`(?:${a[l.NUMERICIDENTIFIERLOOSE]}|${a[l.NONNUMERICIDENTIFIER]})`),h("PRERELEASE",`(?:-(${a[l.PRERELEASEIDENTIFIER]}(?:\\.${a[l.PRERELEASEIDENTIFIER]})*))`),h("PRERELEASELOOSE",`(?:-?(${a[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${a[l.PRERELEASEIDENTIFIERLOOSE]})*))`),h("BUILDIDENTIFIER","[a-zA-Z0-9-]+"),h("BUILD",`(?:\\+(${a[l.BUILDIDENTIFIER]}(?:\\.${a[l.BUILDIDENTIFIER]})*))`),h("FULLPLAIN",`v?${a[l.MAINVERSION]}${a[l.PRERELEASE]}?${a[l.BUILD]}?`),h("FULL",`^${a[l.FULLPLAIN]}$`),h("LOOSEPLAIN",`[v=\\s]*${a[l.MAINVERSIONLOOSE]}${a[l.PRERELEASELOOSE]}?${a[l.BUILD]}?`),h("LOOSE",`^${a[l.LOOSEPLAIN]}$`),h("GTLT","((?:<|>)?=?)"),h("XRANGEIDENTIFIERLOOSE",`${a[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),h("XRANGEIDENTIFIER",`${a[l.NUMERICIDENTIFIER]}|x|X|\\*`),h("XRANGEPLAIN",`[v=\\s]*(${a[l.XRANGEIDENTIFIER]})(?:\\.(${a[l.XRANGEIDENTIFIER]})(?:\\.(${a[l.XRANGEIDENTIFIER]})(?:${a[l.PRERELEASE]})?${a[l.BUILD]}?)?)?`),h("XRANGEPLAINLOOSE",`[v=\\s]*(${a[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${a[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${a[l.XRANGEIDENTIFIERLOOSE]})(?:${a[l.PRERELEASELOOSE]})?${a[l.BUILD]}?)?)?`),h("XRANGE",`^${a[l.GTLT]}\\s*${a[l.XRANGEPLAIN]}$`),h("XRANGELOOSE",`^${a[l.GTLT]}\\s*${a[l.XRANGEPLAINLOOSE]}$`),h("COERCE",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?(?:$|[^\\d])`),h("COERCERTL",a[l.COERCE],!0),h("LONETILDE","(?:~>?)"),h("TILDETRIM",`(\\s*)${a[l.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",h("TILDE",`^${a[l.LONETILDE]}${a[l.XRANGEPLAIN]}$`),h("TILDELOOSE",`^${a[l.LONETILDE]}${a[l.XRANGEPLAINLOOSE]}$`),h("LONECARET","(?:\\^)"),h("CARETTRIM",`(\\s*)${a[l.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",h("CARET",`^${a[l.LONECARET]}${a[l.XRANGEPLAIN]}$`),h("CARETLOOSE",`^${a[l.LONECARET]}${a[l.XRANGEPLAINLOOSE]}$`),h("COMPARATORLOOSE",`^${a[l.GTLT]}\\s*(${a[l.LOOSEPLAIN]})$|^$`),h("COMPARATOR",`^${a[l.GTLT]}\\s*(${a[l.FULLPLAIN]})$|^$`),h("COMPARATORTRIM",`(\\s*)${a[l.GTLT]}\\s*(${a[l.LOOSEPLAIN]}|${a[l.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",h("HYPHENRANGE",`^\\s*(${a[l.XRANGEPLAIN]})\\s+-\\s+(${a[l.XRANGEPLAIN]})\\s*$`),h("HYPHENRANGELOOSE",`^\\s*(${a[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${a[l.XRANGEPLAINLOOSE]})\\s*$`),h("STAR","(<|>)?=?\\s*\\*"),h("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),h("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});const Qe=Object.freeze({loose:!0}),et=Object.freeze({});var tt=e=>e?"object"!=typeof e?Qe:e:et;const rt=/^[0-9]+$/,st=(e,t)=>{const r=rt.test(e),s=rt.test(t);return r&&s&&(e=+e,t=+t),e===t?0:r&&!s?-1:s&&!r?1:e<t?-1:1};var nt={compareIdentifiers:st,rcompareIdentifiers:(e,t)=>st(t,e)};const{MAX_LENGTH:it,MAX_SAFE_INTEGER:ot}=qe,{safeRe:at,t:lt}=Ze,{compareIdentifiers:ct}=nt;class ut{constructor(e,t){if(t=tt(t),e instanceof ut){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>it)throw new TypeError(`version is longer than ${it} characters`);Ye("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?at[lt.LOOSE]:at[lt.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>ot||this.major<0)throw new TypeError("Invalid major version");if(this.minor>ot||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>ot||this.patch<0)throw new TypeError("Invalid patch version");this.prerelease=r[4]?r[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<ot)return t}return e}):[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Ye("SemVer.compare",this.version,this.options,e),!(e instanceof ut)){if("string"==typeof e&&e===this.version)return 0;e=new ut(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof ut||(e=new ut(e,this.options)),ct(this.major,e.major)||ct(this.minor,e.minor)||ct(this.patch,e.patch)}comparePre(e){if(e instanceof ut||(e=new ut(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],s=e.prerelease[t];if(Ye("prerelease compare",t,r,s),void 0===r&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===r)return-1;if(r!==s)return ct(r,s)}while(++t)}compareBuild(e){e instanceof ut||(e=new ut(e,this.options));let t=0;do{const r=this.build[t],s=e.build[t];if(Ye("prerelease compare",t,r,s),void 0===r&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===r)return-1;if(r!==s)return ct(r,s)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let s=this.prerelease.length;for(;--s>=0;)"number"==typeof this.prerelease[s]&&(this.prerelease[s]++,s=-2);if(-1===s){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let s=[t,e];!1===r&&(s=[t]),0===ct(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=s):this.prerelease=s}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}var ht=ut,ft=(e,t,r)=>new ht(e,r).compare(new ht(t,r)),pt=(e,t,r,s)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return((e,t,r)=>0===ft(e,t,r))(e,r,s);case"!=":return((e,t,r)=>0!==ft(e,t,r))(e,r,s);case">":return((e,t,r)=>ft(e,t,r)>0)(e,r,s);case">=":return((e,t,r)=>ft(e,t,r)>=0)(e,r,s);case"<":return((e,t,r)=>ft(e,t,r)<0)(e,r,s);case"<=":return((e,t,r)=>ft(e,t,r)<=0)(e,r,s);default:throw new TypeError(`Invalid operator: ${t}`)}},dt=mt;function mt(e){var t=this;if(t instanceof mt||(t=new mt),t.tail=null,t.head=null,t.length=0,e&&"function"==typeof e.forEach)e.forEach(function(e){t.push(e)});else if(arguments.length>0)for(var r=0,s=arguments.length;r<s;r++)t.push(arguments[r]);return t}function yt(e,t){e.tail=new gt(t,e.tail,null,e),e.head||(e.head=e.tail),e.length++}function vt(e,t){e.head=new gt(t,null,e.head,e),e.tail||(e.tail=e.head),e.length++}function gt(e,t,r,s){if(!(this instanceof gt))return new gt(e,t,r,s);this.list=s,this.value=e,t?(t.next=this,this.prev=t):this.prev=null,r?(r.prev=this,this.next=r):this.next=null}mt.Node=gt,mt.create=mt,mt.prototype.removeNode=function(e){if(e.list!==this)throw new Error("removing node which does not belong to this list");var t=e.next,r=e.prev;return t&&(t.prev=r),r&&(r.next=t),e===this.head&&(this.head=t),e===this.tail&&(this.tail=r),e.list.length--,e.next=null,e.prev=null,e.list=null,t},mt.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},mt.prototype.pushNode=function(e){if(e!==this.tail){e.list&&e.list.removeNode(e);var t=this.tail;e.list=this,e.prev=t,t&&(t.next=e),this.tail=e,this.head||(this.head=e),this.length++}},mt.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)yt(this,arguments[e]);return this.length},mt.prototype.unshift=function(){for(var e=0,t=arguments.length;e<t;e++)vt(this,arguments[e]);return this.length},mt.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},mt.prototype.shift=function(){if(this.head){var e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}},mt.prototype.forEach=function(e,t){t=t||this;for(var r=this.head,s=0;null!==r;s++)e.call(t,r.value,s,this),r=r.next},mt.prototype.forEachReverse=function(e,t){t=t||this;for(var r=this.tail,s=this.length-1;null!==r;s--)e.call(t,r.value,s,this),r=r.prev},mt.prototype.get=function(e){for(var t=0,r=this.head;null!==r&&t<e;t++)r=r.next;if(t===e&&null!==r)return r.value},mt.prototype.getReverse=function(e){for(var t=0,r=this.tail;null!==r&&t<e;t++)r=r.prev;if(t===e&&null!==r)return r.value},mt.prototype.map=function(e,t){t=t||this;for(var r=new mt,s=this.head;null!==s;)r.push(e.call(t,s.value,this)),s=s.next;return r},mt.prototype.mapReverse=function(e,t){t=t||this;for(var r=new mt,s=this.tail;null!==s;)r.push(e.call(t,s.value,this)),s=s.prev;return r},mt.prototype.reduce=function(e,t){var r,s=this.head;if(arguments.length>1)r=t;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");s=this.head.next,r=this.head.value}for(var n=0;null!==s;n++)r=e(r,s.value,n),s=s.next;return r},mt.prototype.reduceReverse=function(e,t){var r,s=this.tail;if(arguments.length>1)r=t;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");s=this.tail.prev,r=this.tail.value}for(var n=this.length-1;null!==s;n--)r=e(r,s.value,n),s=s.prev;return r},mt.prototype.toArray=function(){for(var e=new Array(this.length),t=0,r=this.head;null!==r;t++)e[t]=r.value,r=r.next;return e},mt.prototype.toArrayReverse=function(){for(var e=new Array(this.length),t=0,r=this.tail;null!==r;t++)e[t]=r.value,r=r.prev;return e},mt.prototype.slice=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var r=new mt;if(t<e||t<0)return r;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=0,n=this.head;null!==n&&s<e;s++)n=n.next;for(;null!==n&&s<t;s++,n=n.next)r.push(n.value);return r},mt.prototype.sliceReverse=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var r=new mt;if(t<e||t<0)return r;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=this.length,n=this.tail;null!==n&&s>t;s--)n=n.prev;for(;null!==n&&s>e;s--,n=n.prev)r.push(n.value);return r},mt.prototype.splice=function(e,t,...r){e>this.length&&(e=this.length-1),e<0&&(e=this.length+e);for(var s=0,n=this.head;null!==n&&s<e;s++)n=n.next;var i,o,a,l,c=[];for(s=0;n&&s<t;s++)c.push(n.value),n=this.removeNode(n);for(null===n&&(n=this.tail),n!==this.head&&n!==this.tail&&(n=n.prev),s=0;s<r.length;s++)a=r[s],null===(l=(o=n)===(i=this).head?new gt(a,null,o,i):new gt(a,o,o.next,i)).next&&(i.tail=l),null===l.prev&&(i.head=l),i.length++,n=l;return c},mt.prototype.reverse=function(){for(var e=this.head,t=this.tail,r=e;null!==r;r=r.prev){var s=r.prev;r.prev=r.next,r.next=s}return this.head=t,this.tail=e,this};try{!function(e){e.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}(mt)}catch(e){}const Et=Symbol("max"),wt=Symbol("length"),bt=Symbol("lengthCalculator"),St=Symbol("allowStale"),Rt=Symbol("maxAge"),$t=Symbol("dispose"),It=Symbol("noDisposeOnSet"),At=Symbol("lruList"),Ot=Symbol("cache"),Nt=Symbol("updateAgeOnGet"),Tt=()=>1,Lt=(e,t,r)=>{const s=e[Ot].get(t);if(s){const t=s.value;if(xt(e,t)){if(Pt(e,s),!e[St])return}else r&&(e[Nt]&&(s.value.now=Date.now()),e[At].unshiftNode(s));return t.value}},xt=(e,t)=>{if(!t||!t.maxAge&&!e[Rt])return!1;const r=Date.now()-t.now;return t.maxAge?r>t.maxAge:e[Rt]&&r>e[Rt]},jt=e=>{if(e[wt]>e[Et])for(let t=e[At].tail;e[wt]>e[Et]&&null!==t;){const r=t.prev;Pt(e,t),t=r}},Pt=(e,t)=>{if(t){const r=t.value;e[$t]&&e[$t](r.key,r.value),e[wt]-=r.length,e[Ot].delete(r.key),e[At].removeNode(t)}};class kt{constructor(e,t,r,s,n){this.key=e,this.value=t,this.length=r,this.now=s,this.maxAge=n||0}}const Dt=(e,t,r,s)=>{let n=r.value;xt(e,n)&&(Pt(e,r),e[St]||(n=void 0)),n&&t.call(s,n.value,n.key,e)};var Ct=ur;class _t{constructor(e,t){if(t=tt(t),e instanceof _t)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new _t(e.raw,t);if(e instanceof Ct)return this.raw=e.value,this.set=[[e]],this.format(),this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().split(/\s+/).join(" "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter(e=>!zt(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&Jt(e[0])){this.set=[e];break}}this.format()}format(){return this.range=this.set.map(e=>e.join(" ").trim()).join("||").trim(),this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&Vt)|(this.options.loose&&Xt))+":"+e,r=Gt.get(t);if(r)return r;const s=this.options.loose;e=e.replace(s?Bt[Mt.HYPHENRANGELOOSE]:Bt[Mt.HYPHENRANGE],or(this.options.includePrerelease)),Ye("hyphen replace",e),e=e.replace(Bt[Mt.COMPARATORTRIM],Ut),Ye("comparator trim",e),e=e.replace(Bt[Mt.TILDETRIM],Kt),Ye("tilde trim",e),e=e.replace(Bt[Mt.CARETTRIM],Ht),Ye("caret trim",e);let n=e.split(" ").map(e=>qt(e,this.options)).join(" ").split(/\s+/).map(e=>ir(e,this.options));s&&(n=n.filter(e=>(Ye("loose invalid filter",e,this.options),!!e.match(Bt[Mt.COMPARATORLOOSE])))),Ye("range list",n);const i=new Map,o=n.map(e=>new Ct(e,this.options));for(const e of o){if(zt(e))return[e];i.set(e.value,e)}i.size>1&&i.has("")&&i.delete("");const a=[...i.values()];return Gt.set(t,a),a}intersects(e,t){if(!(e instanceof _t))throw new TypeError("a Range is required");return this.set.some(r=>Wt(r,t)&&e.set.some(e=>Wt(e,t)&&r.every(r=>e.every(e=>r.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new ht(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(ar(this.set[t],e,this.options))return!0;return!1}}var Ft=_t;const Gt=new class{constructor(e){if("number"==typeof e&&(e={max:e}),e||(e={}),e.max&&("number"!=typeof e.max||e.max<0))throw new TypeError("max must be a non-negative number");this[Et]=e.max||Infinity;const t=e.length||Tt;if(this[bt]="function"!=typeof t?Tt:t,this[St]=e.stale||!1,e.maxAge&&"number"!=typeof e.maxAge)throw new TypeError("maxAge must be a number");this[Rt]=e.maxAge||0,this[$t]=e.dispose,this[It]=e.noDisposeOnSet||!1,this[Nt]=e.updateAgeOnGet||!1,this.reset()}set max(e){if("number"!=typeof e||e<0)throw new TypeError("max must be a non-negative number");this[Et]=e||Infinity,jt(this)}get max(){return this[Et]}set allowStale(e){this[St]=!!e}get allowStale(){return this[St]}set maxAge(e){if("number"!=typeof e)throw new TypeError("maxAge must be a non-negative number");this[Rt]=e,jt(this)}get maxAge(){return this[Rt]}set lengthCalculator(e){"function"!=typeof e&&(e=Tt),e!==this[bt]&&(this[bt]=e,this[wt]=0,this[At].forEach(e=>{e.length=this[bt](e.value,e.key),this[wt]+=e.length})),jt(this)}get lengthCalculator(){return this[bt]}get length(){return this[wt]}get itemCount(){return this[At].length}rforEach(e,t){t=t||this;for(let r=this[At].tail;null!==r;){const s=r.prev;Dt(this,e,r,t),r=s}}forEach(e,t){t=t||this;for(let r=this[At].head;null!==r;){const s=r.next;Dt(this,e,r,t),r=s}}keys(){return this[At].toArray().map(e=>e.key)}values(){return this[At].toArray().map(e=>e.value)}reset(){this[$t]&&this[At]&&this[At].length&&this[At].forEach(e=>this[$t](e.key,e.value)),this[Ot]=new Map,this[At]=new dt,this[wt]=0}dump(){return this[At].map(e=>!xt(this,e)&&{k:e.key,v:e.value,e:e.now+(e.maxAge||0)}).toArray().filter(e=>e)}dumpLru(){return this[At]}set(e,t,r){if((r=r||this[Rt])&&"number"!=typeof r)throw new TypeError("maxAge must be a number");const s=r?Date.now():0,n=this[bt](t,e);if(this[Ot].has(e)){if(n>this[Et])return Pt(this,this[Ot].get(e)),!1;const i=this[Ot].get(e).value;return this[$t]&&(this[It]||this[$t](e,i.value)),i.now=s,i.maxAge=r,i.value=t,this[wt]+=n-i.length,i.length=n,this.get(e),jt(this),!0}const i=new kt(e,t,n,s,r);return i.length>this[Et]?(this[$t]&&this[$t](e,t),!1):(this[wt]+=i.length,this[At].unshift(i),this[Ot].set(e,this[At].head),jt(this),!0)}has(e){if(!this[Ot].has(e))return!1;const t=this[Ot].get(e).value;return!xt(this,t)}get(e){return Lt(this,e,!0)}peek(e){return Lt(this,e,!1)}pop(){const e=this[At].tail;return e?(Pt(this,e),e.value):null}del(e){Pt(this,this[Ot].get(e))}load(e){this.reset();const t=Date.now();for(let r=e.length-1;r>=0;r--){const s=e[r],n=s.e||0;if(0===n)this.set(s.k,s.v);else{const e=n-t;e>0&&this.set(s.k,s.v,e)}}}prune(){this[Ot].forEach((e,t)=>Lt(this,t,!1))}}({max:1e3}),{safeRe:Bt,t:Mt,comparatorTrimReplace:Ut,tildeTrimReplace:Kt,caretTrimReplace:Ht}=Ze,{FLAG_INCLUDE_PRERELEASE:Vt,FLAG_LOOSE:Xt}=qe,zt=e=>"<0.0.0-0"===e.value,Jt=e=>""===e.value,Wt=(e,t)=>{let r=!0;const s=e.slice();let n=s.pop();for(;r&&s.length;)r=s.every(e=>n.intersects(e,t)),n=s.pop();return r},qt=(e,t)=>(Ye("comp",e,t),e=er(e,t),Ye("caret",e),e=Zt(e,t),Ye("tildes",e),e=rr(e,t),Ye("xrange",e),e=nr(e,t),Ye("stars",e),e),Yt=e=>!e||"x"===e.toLowerCase()||"*"===e,Zt=(e,t)=>e.trim().split(/\s+/).map(e=>Qt(e,t)).join(" "),Qt=(e,t)=>e.replace(t.loose?Bt[Mt.TILDELOOSE]:Bt[Mt.TILDE],(t,r,s,n,i)=>{let o;return Ye("tilde",e,t,r,s,n,i),Yt(r)?o="":Yt(s)?o=`>=${r}.0.0 <${+r+1}.0.0-0`:Yt(n)?o=`>=${r}.${s}.0 <${r}.${+s+1}.0-0`:i?(Ye("replaceTilde pr",i),o=`>=${r}.${s}.${n}-${i} <${r}.${+s+1}.0-0`):o=`>=${r}.${s}.${n} <${r}.${+s+1}.0-0`,Ye("tilde return",o),o}),er=(e,t)=>e.trim().split(/\s+/).map(e=>tr(e,t)).join(" "),tr=(e,t)=>{Ye("caret",e,t);const r=t.includePrerelease?"-0":"";return e.replace(t.loose?Bt[Mt.CARETLOOSE]:Bt[Mt.CARET],(t,s,n,i,o)=>{let a;return Ye("caret",e,t,s,n,i,o),Yt(s)?a="":Yt(n)?a=`>=${s}.0.0${r} <${+s+1}.0.0-0`:Yt(i)?a="0"===s?`>=${s}.${n}.0${r} <${s}.${+n+1}.0-0`:`>=${s}.${n}.0${r} <${+s+1}.0.0-0`:o?(Ye("replaceCaret pr",o),a="0"===s?"0"===n?`>=${s}.${n}.${i}-${o} <${s}.${n}.${+i+1}-0`:`>=${s}.${n}.${i}-${o} <${s}.${+n+1}.0-0`:`>=${s}.${n}.${i}-${o} <${+s+1}.0.0-0`):(Ye("no pr"),a="0"===s?"0"===n?`>=${s}.${n}.${i}${r} <${s}.${n}.${+i+1}-0`:`>=${s}.${n}.${i}${r} <${s}.${+n+1}.0-0`:`>=${s}.${n}.${i} <${+s+1}.0.0-0`),Ye("caret return",a),a})},rr=(e,t)=>(Ye("replaceXRanges",e,t),e.split(/\s+/).map(e=>sr(e,t)).join(" ")),sr=(e,t)=>(e=e.trim()).replace(t.loose?Bt[Mt.XRANGELOOSE]:Bt[Mt.XRANGE],(r,s,n,i,o,a)=>{Ye("xRange",e,r,s,n,i,o,a);const l=Yt(n),c=l||Yt(i),u=c||Yt(o);return"="===s&&u&&(s=""),a=t.includePrerelease?"-0":"",l?r=">"===s||"<"===s?"<0.0.0-0":"*":s&&u?(c&&(i=0),o=0,">"===s?(s=">=",c?(n=+n+1,i=0,o=0):(i=+i+1,o=0)):"<="===s&&(s="<",c?n=+n+1:i=+i+1),"<"===s&&(a="-0"),r=`${s+n}.${i}.${o}${a}`):c?r=`>=${n}.0.0${a} <${+n+1}.0.0-0`:u&&(r=`>=${n}.${i}.0${a} <${n}.${+i+1}.0-0`),Ye("xRange return",r),r}),nr=(e,t)=>(Ye("replaceStars",e,t),e.trim().replace(Bt[Mt.STAR],"")),ir=(e,t)=>(Ye("replaceGTE0",e,t),e.trim().replace(Bt[t.includePrerelease?Mt.GTE0PRE:Mt.GTE0],"")),or=e=>(t,r,s,n,i,o,a,l,c,u,h,f,p)=>`${r=Yt(s)?"":Yt(n)?`>=${s}.0.0${e?"-0":""}`:Yt(i)?`>=${s}.${n}.0${e?"-0":""}`:o?`>=${r}`:`>=${r}${e?"-0":""}`} ${l=Yt(c)?"":Yt(u)?`<${+c+1}.0.0-0`:Yt(h)?`<${c}.${+u+1}.0-0`:f?`<=${c}.${u}.${h}-${f}`:e?`<${c}.${u}.${+h+1}-0`:`<=${l}`}`.trim(),ar=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(Ye(e[r].semver),e[r].semver!==Ct.ANY&&e[r].semver.prerelease.length>0){const s=e[r].semver;if(s.major===t.major&&s.minor===t.minor&&s.patch===t.patch)return!0}return!1}return!0},lr=Symbol("SemVer ANY");class cr{static get ANY(){return lr}constructor(e,t){if(t=tt(t),e instanceof cr){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),Ye("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.value=this.semver===lr?"":this.operator+this.semver.version,Ye("comp",this)}parse(e){const t=e.match(this.options.loose?hr[fr.COMPARATORLOOSE]:hr[fr.COMPARATOR]);if(!t)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==t[1]?t[1]:"","="===this.operator&&(this.operator=""),this.semver=t[2]?new ht(t[2],this.options.loose):lr}toString(){return this.value}test(e){if(Ye("Comparator.test",e,this.options.loose),this.semver===lr||e===lr)return!0;if("string"==typeof e)try{e=new ht(e,this.options)}catch(e){return!1}return pt(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof cr))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new Ft(e.value,t).test(this.value):""===e.operator?""===e.value||new Ft(this.value,t).test(e.semver):!((t=tt(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(pt(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(pt(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}var ur=cr;const{safeRe:hr,t:fr}=Ze;new Ct(">=0.0.0-0"),new Ct(">=0.0.0");var pr=(e,t,r)=>{try{t=new Ft(t,r)}catch(e){return!1}return t.test(e)},dr=pr(process.version,">=15.7.0"),mr=pr(process.version,">=16.9.0");const yr={ec:["ES256","ES384","ES512"],rsa:["RS256","PS256","RS384","PS384","RS512","PS512"],"rsa-pss":["PS256","PS384","PS512"]},vr={ES256:"prime256v1",ES384:"secp384r1",ES512:"secp521r1"};var gr=function(e,t){if(!e||!t)return;const r=t.asymmetricKeyType;if(!r)return;const s=yr[r];if(!s)throw new Error(`Unknown key type "${r}".`);if(!s.includes(e))throw new Error(`"alg" parameter for "${r}" key type must be one of: ${s.join(", ")}.`);if(dr)switch(r){case"ec":const r=vr[e];if(t.asymmetricKeyDetails.namedCurve!==r)throw new Error(`"alg" parameter "${e}" requires curve "${r}".`);break;case"rsa-pss":if(mr){const r=parseInt(e.slice(-3),10),{hashAlgorithm:s,mgf1HashAlgorithm:n,saltLength:i}=t.asymmetricKeyDetails;if(s!==`sha${r}`||n!==s)throw new Error(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" ${e}.`);if(void 0!==i&&i>r>>3)throw new Error(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" ${e}.`)}}},Er=pr(process.version,"^6.12.0 || >=8.0.0");const{KeyObject:wr,createSecretKey:br,createPublicKey:Sr}=c,Rr=["RS256","RS384","RS512"],$r=["ES256","ES384","ES512"],Ir=["RS256","RS384","RS512"],Ar=["HS256","HS384","HS512"];Er&&(Rr.splice(Rr.length,0,"PS256","PS384","PS512"),Ir.splice(Ir.length,0,"PS256","PS384","PS512"));var Or=/^\s+|\s+$/g,Nr=/^[-+]0x[0-9a-f]+$/i,Tr=/^0b[01]+$/i,Lr=/^0o[0-7]+$/i,xr=/^(?:0|[1-9]\d*)$/,jr=parseInt;function Pr(e){return e!=e}var kr,Dr,Cr=Object.prototype,_r=Cr.hasOwnProperty,Fr=Cr.toString,Gr=Cr.propertyIsEnumerable,Br=(kr=Object.keys,Dr=Object,function(e){return kr(Dr(e))}),Mr=Math.max;function Ur(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||xr.test(e))&&e>-1&&e%1==0&&e<t}var Kr=Array.isArray;function Hr(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!function(e){var t=Vr(e)?Fr.call(e):"";return"[object Function]"==t||"[object GeneratorFunction]"==t}(e)}function Vr(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Xr(e){return!!e&&"object"==typeof e}var zr=Object.prototype.toString,Jr=function(e){return!0===e||!1===e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==zr.call(e)},Wr=/^\s+|\s+$/g,qr=/^[-+]0x[0-9a-f]+$/i,Yr=/^0b[01]+$/i,Zr=/^0o[0-7]+$/i,Qr=parseInt,es=Object.prototype.toString;function ts(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var rs=function(e){return"number"==typeof e&&e==function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==es.call(e)}(e))return NaN;if(ts(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=ts(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Wr,"");var r=Yr.test(e);return r||Zr.test(e)?Qr(e.slice(2),r?2:8):qr.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e)},ss=Object.prototype.toString,ns=function(e){return"number"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==ss.call(e)},is=Object.prototype,os=Function.prototype.toString,as=is.hasOwnProperty,ls=os.call(Object),cs=is.toString,us=function(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object),hs=function(e){if(!function(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=cs.call(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=us(e);if(null===t)return!0;var r=as.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&os.call(r)==ls},fs=Object.prototype.toString,ps=Array.isArray,ds=function(e){return"string"==typeof e||!ps(e)&&function(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==fs.call(e)},ms=/^\s+|\s+$/g,ys=/^[-+]0x[0-9a-f]+$/i,vs=/^0b[01]+$/i,gs=/^0o[0-7]+$/i,Es=parseInt,ws=Object.prototype.toString;function bs(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}const{KeyObject:Ss,createSecretKey:Rs,createPrivateKey:$s}=c,Is=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];Er&&Is.splice(3,0,"PS256","PS384","PS512");const As={expiresIn:{isValid:function(e){return rs(e)||ds(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return rs(e)||ds(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return ds(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:function(e,t,r,s){var n;e=Hr(e)?e:(n=e)?function(e,t){return function(t,r){for(var s=-1,n=t?t.length:0,i=Array(n);++s<n;)i[s]=e[t[s]];return i}(t)}(n,function(e){return Hr(e)?function(e,t){var r=Kr(e)||function(e){return function(e){return Xr(e)&&Hr(e)}(e)&&_r.call(e,"callee")&&(!Gr.call(e,"callee")||"[object Arguments]"==Fr.call(e))}(e)?function(e,t){for(var r=-1,s=Array(e);++r<e;)s[r]=t(r);return s}(e.length,String):[],s=r.length,n=!!s;for(var i in e)!_r.call(e,i)||n&&("length"==i||Ur(i,s))||r.push(i);return r}(e):function(e){if((t=e)!==("function"==typeof(r=t&&t.constructor)&&r.prototype||Cr))return Br(e);var t,r,s=[];for(var n in Object(e))_r.call(e,n)&&"constructor"!=n&&s.push(n);return s}(e)}(n)):[],r=r&&!s?function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||Xr(e)&&"[object Symbol]"==Fr.call(e)}(e))return NaN;if(Vr(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Vr(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Or,"");var r=Tr.test(e);return r||Lr.test(e)?jr(e.slice(2),r?2:8):Nr.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(r):0;var i=e.length;return r<0&&(r=Mr(i+r,0)),function(e){return"string"==typeof e||!Kr(e)&&Xr(e)&&"[object String]"==Fr.call(e)}(e)?r<=i&&e.indexOf(t,r)>-1:!!i&&function(e,t,r){if(t!=t)return function(e,t,r,s){for(var n=e.length,i=r+-1;++i<n;)if(t(e[i],i,e))return i;return-1}(e,Pr,r);for(var s=r-1,n=e.length;++s<n;)if(e[s]===t)return s;return-1}(e,t,r)>-1}.bind(null,Is),message:'"algorithm" must be a valid string enum value'},header:{isValid:hs,message:'"header" must be an object'},encoding:{isValid:ds,message:'"encoding" must be a string'},issuer:{isValid:ds,message:'"issuer" must be a string'},subject:{isValid:ds,message:'"subject" must be a string'},jwtid:{isValid:ds,message:'"jwtid" must be a string'},noTimestamp:{isValid:Jr,message:'"noTimestamp" must be a boolean'},keyid:{isValid:ds,message:'"keyid" must be a string'},mutatePayload:{isValid:Jr,message:'"mutatePayload" must be a boolean'},allowInsecureKeySizes:{isValid:Jr,message:'"allowInsecureKeySizes" must be a boolean'},allowInvalidAsymmetricKeyTypes:{isValid:Jr,message:'"allowInvalidAsymmetricKeyTypes" must be a boolean'}},Os={iat:{isValid:ns,message:'"iat" should be a number of seconds'},exp:{isValid:ns,message:'"exp" should be a number of seconds'},nbf:{isValid:ns,message:'"nbf" should be a number of seconds'}};function Ns(e,t,r,s){if(!hs(r))throw new Error('Expected "'+s+'" to be a plain object.');Object.keys(r).forEach(function(n){const i=e[n];if(i){if(!i.isValid(r[n]))throw new Error(i.message)}else if(!t)throw new Error('"'+n+'" is not allowed in "'+s+'"')})}const Ts={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},Ls=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];var xs=function(e,t,r,s){let n;if("function"!=typeof r||s||(s=r,r={}),r||(r={}),r=Object.assign({},r),n=s||function(e,t){if(e)throw e;return t},r.clockTimestamp&&"number"!=typeof r.clockTimestamp)return n(new Ge("clockTimestamp must be a number"));if(void 0!==r.nonce&&("string"!=typeof r.nonce||""===r.nonce.trim()))return n(new Ge("nonce must be a non-empty string"));if(void 0!==r.allowInvalidAsymmetricKeyTypes&&"boolean"!=typeof r.allowInvalidAsymmetricKeyTypes)return n(new Ge("allowInvalidAsymmetricKeyTypes must be a boolean"));const i=r.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return n(new Ge("jwt must be provided"));if("string"!=typeof e)return n(new Ge("jwt must be a string"));const o=e.split(".");if(3!==o.length)return n(new Ge("jwt malformed"));let a;try{a=function(e,t){var r=_e.decode(e,t=t||{});if(!r)return null;var s=r.payload;if("string"==typeof s)try{var n=JSON.parse(s);null!==n&&"object"==typeof n&&(s=n)}catch(e){}return!0===t.complete?{header:r.header,payload:s,signature:r.signature}:s}(e,{complete:!0})}catch(e){return n(e)}if(!a)return n(new Ge("invalid token"));const l=a.header;let c;if("function"==typeof t){if(!s)return n(new Ge("verify must be called asynchronous if secret or public key is provided as a callback"));c=t}else c=function(e,r){return r(null,t)};return c(l,function(t,s){if(t)return n(new Ge("error in secret or public key callback: "+t.message));const c=""!==o[2].trim();if(!c&&s)return n(new Ge("jwt signature is required"));if(c&&!s)return n(new Ge("secret or public key must be provided"));if(!c&&!r.algorithms)return n(new Ge('please specify "none" in "algorithms" to verify unsigned tokens'));if(null!=s&&!(s instanceof wr))try{s=Sr(s)}catch(e){try{s=br("string"==typeof s?Buffer.from(s):s)}catch(e){return n(new Ge("secretOrPublicKey is not valid key material"))}}if(r.algorithms||(r.algorithms="secret"===s.type?Ar:["rsa","rsa-pss"].includes(s.asymmetricKeyType)?Ir:"ec"===s.asymmetricKeyType?$r:Rr),-1===r.algorithms.indexOf(a.header.alg))return n(new Ge("invalid algorithm"));if(l.alg.startsWith("HS")&&"secret"!==s.type)return n(new Ge(`secretOrPublicKey must be a symmetric key when using ${l.alg}`));if(/^(?:RS|PS|ES)/.test(l.alg)&&"public"!==s.type)return n(new Ge(`secretOrPublicKey must be an asymmetric key when using ${l.alg}`));if(!r.allowInvalidAsymmetricKeyTypes)try{gr(l.alg,s)}catch(e){return n(e)}let u;try{u=_e.verify(e,a.header.alg,s)}catch(e){return n(e)}if(!u)return n(new Ge("invalid signature"));const h=a.payload;if(void 0!==h.nbf&&!r.ignoreNotBefore){if("number"!=typeof h.nbf)return n(new Ge("invalid nbf value"));if(h.nbf>i+(r.clockTolerance||0))return n(new Me("jwt not active",new Date(1e3*h.nbf)))}if(void 0!==h.exp&&!r.ignoreExpiration){if("number"!=typeof h.exp)return n(new Ge("invalid exp value"));if(i>=h.exp+(r.clockTolerance||0))return n(new Ke("jwt expired",new Date(1e3*h.exp)))}if(r.audience){const e=Array.isArray(r.audience)?r.audience:[r.audience];if(!(Array.isArray(h.aud)?h.aud:[h.aud]).some(function(t){return e.some(function(e){return e instanceof RegExp?e.test(t):e===t})}))return n(new Ge("jwt audience invalid. expected: "+e.join(" or ")))}if(r.issuer&&("string"==typeof r.issuer&&h.iss!==r.issuer||Array.isArray(r.issuer)&&-1===r.issuer.indexOf(h.iss)))return n(new Ge("jwt issuer invalid. expected: "+r.issuer));if(r.subject&&h.sub!==r.subject)return n(new Ge("jwt subject invalid. expected: "+r.subject));if(r.jwtid&&h.jti!==r.jwtid)return n(new Ge("jwt jwtid invalid. expected: "+r.jwtid));if(r.nonce&&h.nonce!==r.nonce)return n(new Ge("jwt nonce invalid. expected: "+r.nonce));if(r.maxAge){if("number"!=typeof h.iat)return n(new Ge("iat required when maxAge is specified"));const e=We(r.maxAge,h.iat);if(void 0===e)return n(new Ge('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(i>=e+(r.clockTolerance||0))return n(new Ke("maxAge exceeded",new Date(1e3*e)))}return n(null,!0===r.complete?{header:l,payload:h,signature:a.signature}:h)})},js=function(e,t,r,s){"function"==typeof r?(s=r,r={}):r=r||{};const n="object"==typeof e&&!Buffer.isBuffer(e),i=Object.assign({alg:r.algorithm||"HS256",typ:n?"JWT":void 0,kid:r.keyid},r.header);function o(e){if(s)return s(e);throw e}if(!t&&"none"!==r.algorithm)return o(new Error("secretOrPrivateKey must have a value"));if(null!=t&&!(t instanceof Ss))try{t=$s(t)}catch(e){try{t=Rs("string"==typeof t?Buffer.from(t):t)}catch(e){return o(new Error("secretOrPrivateKey is not valid key material"))}}if(i.alg.startsWith("HS")&&"secret"!==t.type)return o(new Error(`secretOrPrivateKey must be a symmetric key when using ${i.alg}`));if(/^(?:RS|PS|ES)/.test(i.alg)){if("private"!==t.type)return o(new Error(`secretOrPrivateKey must be an asymmetric key when using ${i.alg}`));if(!r.allowInsecureKeySizes&&!i.alg.startsWith("ES")&&void 0!==t.asymmetricKeyDetails&&t.asymmetricKeyDetails.modulusLength<2048)return o(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${i.alg}`))}if(void 0===e)return o(new Error("payload is required"));if(n){try{!function(e){Ns(Os,!0,e,"payload")}(e)}catch(e){return o(e)}r.mutatePayload||(e=Object.assign({},e))}else{const t=Ls.filter(function(e){return void 0!==r[e]});if(t.length>0)return o(new Error("invalid "+t.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==r.expiresIn)return o(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==r.notBefore)return o(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function(e){Ns(As,!1,e,"options")}(r)}catch(e){return o(e)}if(!r.allowInvalidAsymmetricKeyTypes)try{gr(i.alg,t)}catch(e){return o(e)}const a=e.iat||Math.floor(Date.now()/1e3);if(r.noTimestamp?delete e.iat:n&&(e.iat=a),void 0!==r.notBefore){try{e.nbf=We(r.notBefore,a)}catch(e){return o(e)}if(void 0===e.nbf)return o(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==r.expiresIn&&"object"==typeof e){try{e.exp=We(r.expiresIn,a)}catch(e){return o(e)}if(void 0===e.exp)return o(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(Ts).forEach(function(t){const s=Ts[t];if(void 0!==r[t]){if(void 0!==e[s])return o(new Error('Bad "options.'+t+'" option. The payload already has an "'+s+'" property.'));e[s]=r[t]}});const l=r.encoding||"utf8";if("function"!=typeof s){let s=_e.sign({header:i,payload:e,secret:t,encoding:l});if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(i.alg)&&s.length<256)throw new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${i.alg}`);return s}s=s&&function(e){return function(e,t){var r;if("function"!=typeof t)throw new TypeError("Expected a function");return e=function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==ws.call(e)}(e))return NaN;if(bs(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=bs(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(ms,"");var r=vs.test(e);return r||gs.test(e)?Es(e.slice(2),r?2:8):ys.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=void 0),r}}(2,e)}(s),_e.createSign({header:i,privateKey:t,payload:e,encoding:l}).once("error",s).once("done",function(e){if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(i.alg)&&e.length<256)return s(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${i.alg}`));s(null,e)})};class Ps{constructor(e,t){this.privateKey=e,this.options=t}sign(e){const t=D({},this.options,{jwtid:p.v4()});return js(e,this.privateKey,t)}verify(e){return xs(e,this.privateKey,this.options)}refresh(e){const t=xs(e,this.privateKey,this.options);delete t.sub,delete t.iss,delete t.aud,delete t.iat,delete t.exp,delete t.nbf,delete t.jti;const r=D({},this.options,{jwtid:p.v4()});return js(t,this.privateKey,r)}}class ks{constructor(e,r,s){this.app=t(),this.express_config=o.defaultsDeep(e,{helmet:!0,json:!0,urlencoded:!0,compression:!0,cors:{origin:!0,credentials:!0},fileupload:!0,socketio:{transports:["websocket"]},traceRequests:!1}),this.statics=r,this.routes=s}async initialize(){this.config(this.express_config),this.customizeExpress&&await this.customizeExpress(this.app),await this.configureRoutes(this.routes),await this.errorHandler()}customizeExpress(){}config(a){if(a&&a.helmet&&this.app.use(e(a&&o.isObject(a.helmet)&&a.helmet)),a&&a.json&&this.app.use(t.json()),a&&a.urlencoded&&this.app.use(t.urlencoded({extended:!0})),a&&a.compression&&this.app.use(r()),a&&a.cors&&(this.app.options("*",s(a&&o.isObject(a.cors)&&a.cors)),this.app.use(s(a&&o.isObject(a.cors)&&a.cors))),a&&a.fileupload&&this.app.use(n()),this.statics)for(const e in this.statics)this.app.use(e,t.static(this.statics[e]));a&&!0===a.traceRequests&&"true"!=process.env.DISABLE_LOGGER&&this.app.use((e,t,r)=>{e.requestTime=Date.now(),t.on("finish",()=>{let t=i.parse(e.url).pathname,r=Date.now()-e.requestTime;console.debug("APIRequest["+process.pid+"]::. ["+e.method+"] (user:"+(e&&e.session&&e.session.user_id||"")+")  "+t+" |-> took: "+r+" ms"),console.debug(JSON.stringify(e.body))}),r()})}configureRoutes(e){const r=t.Router();this.app.use(r),this.loadRoutes(this.app,e)}loadRoutes(e,t){if(t)for(const r of t){if(!r){console.warn("Empty route");continue}let t=r.configure();if(r.entity&&(t=r.configure(r.entity,{service:r.service,table:r.table})),!o.isEmpty(r.routes)){const e=j.expressHandler();for(const s in r.routes){const n=r.routes[s];for(const r in n){const i=n[r];Array.isArray(i)?t[r](s,i[0],e(i[1])):t[r](s,e(i))}}}t&&e.use(t)}}errorHandler(){this.app.use((e,t,r,s)=>{let n=new k;n.success=!1,n.message=e.message,console.error(e),r.status(500).json(n.toJson())})}}class Ds extends w{constructor(e){super(),process.env.PORT||console.log("Using 3000 as default port. Customize via env PORT."),this.port=this.normalizePort(process.env.PORT||3e3),this.clustered=process.env.CLUSTERED,this.workers=[],this.app=e,this.executeOnlyMain=()=>{}}setServerCls(e){this.server=e}async start(){"true"==this.clustered?this.initClustered():(this.configureSocketIO(),this.executeOnlyMain(),await this.initUnclustered())}configureSocketIO(){this.server.express_config&&this.server.express_config.socketio&&(this.app.io=new g(this.server.express_config&&this.server.express_config.socketio),this.app.io.listen(this.port+1))}async initClustered(){if(v.isPrimary){this.configureSocketIO(),this.executeOnlyMain(),(new b).on("event",(e,t)=>{e&&e.event&&(1==process.env.DEBUG_EVENTS&&console.debug(`Received '${e.event}' from ${e.props.owner} at Master`),this.app.events.emit(e.event,e.props,t))});const e=E.cpus().length;for(let t=0;t<e;t+=1)this.initWorker();v.on("exit",e=>{console.log("Worker "+e.id+" died :("),this.initWorker()})}else await this.initUnclustered(),console.log(`Worker ${process.pid} started`)}initWorker(){let e=v.fork();console.log(`Running worker ${e.process.pid}`),this.workers.push(e)}async initUnclustered(){this.server.port=this.port;let e=d.Server(this.server.app);if(await this.server.initialize(),this.server.beforeListen&&await this.server.beforeListen(),e.listen(this.server.port),this.server.afterListen&&await this.server.afterListen(),e.on("error",e=>{this.handleErrors(e,this.server.port)}),e.on("listening",()=>{console.log("Server Worker running on port: "+this.port+"!"),this.emit("listening",this.port)}),process.env.SSL&&"true"==process.env.SSL){process.env.SSL_KEY&&process.env.SSL_CERT&&process.env.SSL_PASS||(console.error("Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed"),process.exit(0));var t={key:a.readFileSync(y.resolve(process.cwd(),process.env.SSL_KEY||"key.pem")),cert:a.readFileSync(y.resolve(process.cwd(),process.env.SSL_CERT||"cert.pem")),passphrase:process.env.SSL_PASS};process.env.SSL_PORT||console.log("Using 3443 as ssl default port. Customize via env SSL_PORT.");var r=this.normalizePort(process.env.SSL_PORT||3443),s=m.createServer(t,this.server.app);s.listen(r),s.on("error",e=>{this.handleErrors(e,r)}),s.on("listening",()=>{console.log("Server Worker running on port: "+r+"!"),this.emit("listening_ssl",r)})}}normalizePort(e){let t=parseInt(e,10);return isNaN(t)?e:t>=0&&t}handleErrors(e,t){if("listen"!==e.syscall)throw e;let r="string"==typeof t?"Pipe "+t:"Port "+t;switch(e.code){case"EACCES":console.error(r+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(r+" is already in use"),process.exit(1);break;default:throw e}}}class Cs extends w{constructor(e){super(),this.messages=new b,this.app=e,v.isWorker&&this.messages.on("event",(e,t)=>{e&&e.event&&process.pid!==e.props.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(`Receiving broadcast ${e.event} - ${process.pid}`),super.emit(e.event,D({},e.props),t))})}emit(e,t,r){super.emit(e,t,r),e&&t&&v.isWorker&&process.pid!==t.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(`${e} -> Firing from ${process.pid} to master`),t||(t={}),t.owner=process.pid,this.messages.send("event",{event:e,props:D({},t)},r)),e&&t&&v.isPrimary&&this.app&&this.app.server&&this.app.server.workers&&(1==process.env.DEBUG_EVENTS&&console.debug(`${e} -> Firing from master to workers`),this.messages.send("event",{event:e,props:D({},t)},r))}}const{configure:_s,getLogger:Fs}=S;class Gs{static async configure(){const e=l.promisify(a.readFile),t=await e(y.resolve(process.cwd(),"./log4js.json"),"utf8");_s(JSON.parse(t)),(()=>{const e=Fs("log"),t=Fs("error"),r=Fs("debug");console.log=function(){let t=Array.prototype.slice.call(arguments);e.log("info",t[0])},console.error=function(){let e=Array.prototype.slice.call(arguments);t.log("error",e[0])},console.info=function(){let t=Array.prototype.slice.call(arguments);e.log("info",t[0])},console.debug=function(){let e=Array.prototype.slice.call(arguments);r.log("debug",e[0])},console.custom=function(e,t,r){Fs(e).log(t,r)}})()}}class Bs{constructor(e,r){this.router=t.Router(),this.publicPathsList=[...e,"/login"],this.AuthHandler=r}configure(){const e=j.expressHandler();return this.router.use(e((...e)=>this.check(...e))),this.router.post("/login",e((...e)=>this.loginPost(...e))),this.router.post("/logout",e((...e)=>this.logout(...e))),this.router}async check(e,t,r){try{for(let t of this.publicPathsList)if(null!==R(t).exec(i.parse(e.url).pathname))return r();return await this.AuthHandler.check(e)?r():t.status(403).json(new k(!1,null,"Forbidden").toJson())}catch(e){return console.error(e),t.status(403).json(new k(!1,null,"Forbidden").toJson())}}async loginPost(e,t){if(e.body.username)try{let r=await this.AuthHandler.validate(e,e.body.username,e.body.password);return r?t.status(200).json(new k(!0,r).toJson()):t.status(401).json(new k(!1,null,"Unauthorized - Incorrect credentials").toJson())}catch(e){return console.error(e),t.status(401).json(new k(!1,null,"Unauthorized - Error, check log").toJson())}return t.status(401).json(new k(!1,null,"Unauthorized - Missing parameters").toJson())}async logout(e,t){if(this.AuthHandler.logout)try{return await this.AuthHandler.logout(e),t.status(200).json(new k(!0).toJson())}catch(e){return console.error(e),t.status(500).json(new k(!1,null,e).toJson())}return t.status(200).json(new k(!0).toJson())}}class Ms{constructor(){if(!this.check)throw new Error("AuthHandler must have 'check' vethod");if(!this.validate)throw new Error("AuthHandler must have 'validate' vethod")}}class Us extends Ms{constructor(e){if(super(),this.tokenGenerator=new Ps(process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE,issuer:process.env.JWT_ISSUER,subject:process.env.JWT_SUBJECT,algorithm:process.env.JWT_ALGORITHM,expiresIn:process.env.JWT_EXPIRES}),!e)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");this.userDao=e}async check(e){if(e.headers.authorization){const r=(e.headers.authorization||"").split(" ")[1]||"";if(!r)return console.error("Token needed"),!1;try{var t=this.tokenGenerator.verify(r);const{sub:s,username:n,exp:i}=t;return!(!s||!n||$(i).isAfter(new Date)||(e.session=D({},e.session,t),0))}catch(e){return console.error(e),!1}}return!1}async validate(e,t,r){const s=await this.userDao.findByUsername(t);return!(!s||s.username!==t||s.password!==j.encrypt(r))&&this.tokenGenerator.sign(o.omit(s,["password"]))}}class Ks extends Ms{constructor(e){if(super(),!e)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");this.userDao=e}async check(e){if(e.headers.authorization){const t=(e.headers.authorization||"").split(" ")[1]||"",r=Buffer.from(t,"base64").toString().split(":"),s=r[0],n=r[1];return!!await this.validate(e,s,n)}return!(!e.session||!e.session.username)}async validate(e,t,r){const s=await this.userDao.findByUsername(t);return!(!s||s.username!==t||s.password!==j.encrypt(r)||(e.session=D({},e.session,o.omit(s,["password"])),0))}logout(e){return new Promise(t=>{e.session&&e.session.destroy(t)})}}var Hs=new class{init(e){this.connection=O(e)}setColumnAliases(e){this.columnAliases=e}test(){return this.connection.raw("select 1+1 as result")}};class Vs{static parseQueryString(e,t,r){const s={allowGlobalSearch:!0,caseInsensitive:!0};Hs.columnAliases&&Hs.columnAliases[r]&&(s.aliases=Hs.columnAliases[r]),void 0!==Hs.caseInsensitive&&(s.caseInsensitive=Hs.caseInsensitive),void 0!==Hs.allowGlobalSearch&&(s.allowGlobalSearch=Hs.allowGlobalSearch);const n=new I(s).parse(t);return new A(r).toKnex(e,n)}static parseFilters(e,t,r){let s=e;for(let e in t){let n=t[e];if("object"==typeof n)switch(n.type){case"fql":s=Vs.parseQueryString(s,n.value,r);break;case"date":case"between":n.start&&n.end&&(s=s.whereBetween(e,[n.start,n.end])),n.start&&!n.end&&(s=s.where(e,">=",n.start)),!n.start&&n.end&&(s=s.where(e,">=",n.end));break;case"dateraw":case"betweenraw":n.start&&n.end&&(s=s.whereRaw(`${e} BETWEEN ? AND ?`,[n.start,n.end])),n.start&&!n.end&&(s=s.whereRaw(`${e} >= ?`,[n.start])),!n.start&&n.end&&(s=s.whereRaw(`${e} >= ?`,[n.end]));break;case"jsonb":s=s.whereRaw(`${e} ILIKE ?`,["%"+n.value+"%"]);break;case"full-text-psql":s=s.whereRaw(`to_tsvector(${e}::text) @@ to_tsquery(?)`,[n.value]);break;case"greater":case"greaterraw":s=s.whereRaw(`${e} > ?`,[n.value]);break;case"greaterEq":case"greaterEqraw":s=s.whereRaw(`${e} >= ?`,[n.value]);break;case"less":case"lessraw":s=s.whereRaw(`${e} < ?`,[n.value]);break;case"lessEq":case"lessEqraw":s=s.whereRaw(`${e} <= ?`,[n.value]);break;case"exists":s=s.whereExists(e);break;case"notexists":s=s.whereNotExists(e);break;case"exact":case"exactraw":s=s.whereRaw(`${e} = ?`,[n.value]);break;case"in":let t=e;t.includes(",")&&(t=e.split(",")),Array.isArray(n.value)||null==n.value?null!=n.value&&(s=s.whereIn(t,n.value)):s=s.whereIn(t,n.value.split(","));break;case"inraw":Array.isArray(n.value)||null==n.value?null!=n.value&&(s=s.whereRaw(`${e} IN (?)`,[n.value.map(e=>`'${e}'`).join(",")])):s=s.whereRaw(`${e} IN (?)`,[n.value.split(",").map(e=>`'${e}'`).join(",")]);break;case"not":case"notraw":s=s.whereRaw(`${e} != ?`,[n.value]);break;case"like":case"likeraw":let i=j.replaceAll(n.value,"*","%");s=s.whereRaw(` ${e} LIKE ?`,[i]);break;case"notlike":case"notlikeraw":let o=j.replaceAll(n.value,"*","%");s=s.whereRaw(` ${e} NOT LIKE ?`,[o]);break;case"likeI":let a=j.replaceAll(n.value,"*","%");s=s.whereRaw(` ${e} ILIKE ?`,[a]);break;case"notlikeI":let l=j.replaceAll(n.value,"*","%");s=s.whereRaw(` ${e} NOT ILIKE ?`,[l]);break;case"null":case"nullraw":s=s.whereRaw(`${e} is NULL`);break;case"notnull":case"notnullraw":s=s.whereRaw(`${e} is not NULL`)}else s=s.where(e,n)}return s}static parseSort(e){if(!e.field||!e.direction)return 1;let t="ASC";return"descend"===e.direction&&(t="DESC"),e.field+" "+t}}class Xs{constructor(){this.tableName=""}loadAllData(e,t){return Hs.connection.select("*").from(this.tableName).limit(t||1e4).offset(e)}async loadFilteredData(e,t,r){let s=1;return e.sort&&(s=Vs.parseSort(e.sort)),Hs.connection.from(this.tableName).where(t=>Vs.parseFilters(t,o.omit(e,["sort","start","limit"]),this.tableName)).orderByRaw(s).limit(r).offset(t)}async countFilteredData(e){let t=await Hs.connection.from(this.tableName).where(t=>Vs.parseFilters(t,o.omit(e,["sort","start","limit"]),this.tableName)).count("id",{as:"total"});return t&&t[0].total}async loadById(e){const t=await Hs.connection.from(this.tableName).where("id",e);return t&&t[0]?t[0]:null}save(e){return Hs.connection.from(this.tableName).insert(e).returning("*")}update(e,t){return Hs.connection.from(this.tableName).where("id",e).update(t).returning("*")}async delete(e){if(!await this.loadById(e))throw"NotFound";return Hs.connection.from(this.tableName).where("id",e).delete()}}class zs extends Xs{constructor(e){if(super(e),!this.findByUsername)throw new Error("AuthHandler must have 'findByUsername' method")}}class Js{constructor(){this.router=t.Router(),this.routes={}}configure(e,t){if(!e)return this.router;const r=j.expressHandler();return this.router.get(`/${e}`,r((...e)=>this.listEntidad(...e))),this.router.post(`/${e}/list`,r((...e)=>this.listEntidad(...e))),this.router.get(`/${e}/:id`,r((...e)=>this.getEntidad(...e))),this.router.post(`/${e}`,r((...e)=>this.saveEntidad(...e))),this.router.put(`/${e}/:id`,r((...e)=>this.updateEntidad(...e))),this.router.delete(`/${e}/:id`,r((...e)=>this.deleteEntidad(...e))),this.service=t.service,this.table=t.table,this.router}async listEntidad(e,t,r){try{let r=new this.service(null,this.table),s="POST"===e.method?e.body:e.query&&e.query.filters?JSON.parse(e.query.filters):{},n=await r.list(s,s.start,s.limit),i=new k(!0,n.data,null,n.total);t.json(i.toJson())}catch(e){r(e)}}async getEntidad(e,t,r){try{let r=new this.service(null,this.table),s=await r.loadById(e.params.id),n=new k(!0,s),i=200;null==s&&(i=404,n=new k(!1,null,"Element not found",0)),t.status(i).json(n.toJson())}catch(e){console.error(e);let r="";"22P02"==e.code&&(r="Expected uiid");let s=new k(!1,null,r,0);t.status(400).json(s.toJson())}}async saveEntidad(e,t,r){try{let r=new this.service(null,this.table),s=await r.save(e.body),n=new k(!0,s&&s[0]||{id:e.body.id});t.setHeader("Location",`/entity/${n.data.id}`),t.status(201).json(n.toJson())}catch(e){r(e)}}async updateEntidad(e,t,r){try{let r=new this.service(null,this.table),s=await r.update(e.params.id,e.body),n=new k(!0,s&&s[0]||{id:e.body.id});t.json(n.toJson())}catch(e){r(e)}}async deleteEntidad(e,t,r){try{let r=new this.service(null,this.table),s=await r.delete(e.params.id),n=new k(!0,s);t.status(204).json(n.toJson())}catch(e){if(console.error(e),"NotFound"==e){let e=new k(!1,null,"Element not found",0);t.status(404).json(e.toJson())}else r(e)}}}class Ws{constructor(e,t){this.dao=e?new e:new Xs,t&&(this.dao.tableName=t)}async list(e,t,r){const s=t||0,n=r||1e3;let i={};if(i.total=await this.dao.countFilteredData(e,s,n),e&&0!==Object.keys(e).length){let t=await this.dao.loadFilteredData(e,s,n);return i.data=t,i}return i.data=await this.dao.loadAllData(t,r),i}loadById(e){return this.dao.loadById(e)}save(e){return this.dao.save(e)}update(e,t){if(e)return this.dao.update(e,t)}delete(e){if(e)return this.dao.delete(e)}}var qs=new class{constructor(){this.serverClass=ks,this.clusterClass=Ds}runtime(e){return async function(e){const t=L(x(process.argv)).usage("Como usar: \n            node $0 [options] \n            \n            ** Si no se especifican parámetros el servidor arrancará normalmente. **").alias("g","generateKeys").describe("g","Genera unas claves para la aplicación").alias("c","encrypt").describe("c","Codifica el String proporcionado en base a la contraseña de .env").nargs("c",1).help("h").alias("h","help");let r=[];if(e)for(const s of e)t.alias(s.key,s.alias),s.describe&&t.describe(s.key,s.describe),0!==s.nargs&&t.nargs(s.key,s.nargs),s.boolean&&t.boolean(s.key),s.choices&&t.choices(s.key,s.choices),s.required&&r.push(s.key);0!==r.length&&t.demandOption(r);const s=t.argv;if(s.generateKeys)return console.log("Generando claves para encriptación:"),console.log(j.generateKeys()),process.exit(1);if(s.encrypt)return console.log("Resultado encryptación:"),console.log(j.encrypt(s.encrypt)),process.exit(1);if(e)for(const t of e)if(s[t.key])return await t.fn(s),process.exit(1)}(e)}async init(e){"true"!=process.env.DISABLE_LOGGER&&await Gs.configure();const t=new this.serverClass(e,this.statics,this.routes);this.customizeExpress&&(t.customizeExpress=this.customizeExpress),this.beforeListen&&(t.beforeListen=this.beforeListen),this.afterListen&&(t.afterListen=this.afterListen),this.events=new Cs(this),this.i18n=new P(null==e?void 0:e.disableI18nWatcher),await this.i18n.load(),this.server=new this.clusterClass(this),this.server.setServerCls(t),this.server.executeOnlyMain=()=>{this.executeOnlyMain&&this.executeOnlyMain(),"true"==process.env.REPL_ENABLED&&this.startRepl()}}async start(){if(!this.server)throw new Error("Call init first");await this.server.start()}startRepl(){try{N.createServer(e=>{const t=T.start({prompt:"lisco::remote> ",input:e,output:e,terminal:!0,useColors:!0,preview:!1});t.context.app=this,t.context.Utils=j,t.context.db=Hs.connection,t.on("exit",e.end.bind(e))}).listen(process.env.REPL_PORT||5001)}catch(e){console.log("Remote REPL Conn: "+e)}console.log(`Remote REPL started on port ${process.env.REPL_PORT||5001}`)}};export{qs as App,Bs as AuthController,Js as BaseController,Xs as BaseKnexDao,Ws as BaseService,Ds as ClusterServer,Ks as CookieAuthHandler,Cs as EventHandler,P as I18nLoader,Ms as IAuthHandler,zs as IUserDao,k as JsonResponse,Us as JwtAuthHandler,Hs as KnexConnector,Vs as KnexFilterParser,Gs as Logger,ks as Server,Ps as TokenGenerator,j as Utils};
//# sourceMappingURL=lisco.modern.js.map
