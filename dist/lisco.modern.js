import e from"helmet";import t from"express";import r from"compression";import n from"cors";import s from"express-fileupload";import o from"url";import i from"lodash";import a from"fs";import c from"util";import u from"crypto";import l from"chokidar";import f from"buffer";import p from"stream";import*as h from"uuid";import d from"http";import m from"https";import v from"path";import y from"cluster";import{Server as g}from"socket.io";import w from"os";import{EventEmitter as b}from"events";import S from"cluster-messages";import E from"log4js";import{pathToRegexp as j}from"path-to-regexp";import x from"moment";import{FQLParser as k,KnexParser as R}from"@landra_sistemas/fql-parser";import A from"knex";import O from"net";import T from"repl";import I from"yargs/yargs";import{hideBin as P}from"yargs/helpers";class N{static arrayToLower(e){return e.join("~").toLowerCase().split("~")}static replaceAll(e,t,r){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),r)}static encrypt(e){const t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),n=u.createCipheriv("aes-256-cbc",t,r);let s=n.update(e);return s=Buffer.concat([s,n.final()]),s.toString("hex")}static decrypt(e){const t=Buffer.from(process.env.CRYPT_SECRET,"hex"),r=Buffer.from(process.env.CRYPT_IV,"hex"),n=Buffer.from(e,"hex"),s=u.createDecipheriv("aes-256-cbc",t,r);let o=s.update(n);return o=Buffer.concat([o,s.final()]),o.toString()}static sleep(e){return c.promisify(setTimeout)(e)}static generateKeys(){return{key:u.randomBytes(32).toString("hex"),iv:u.randomBytes(16).toString("hex")}}static flattenObject(e){let t,r={};for(let n in e)if(e.hasOwnProperty(n))if(e[n]&&Array===e[n].constructor)r[n]=e[n];else if("object"==typeof e[n]){t=N.flattenObject(e[n]);for(let e in t)t.hasOwnProperty(e)&&(t[e]&&Array===t.constructor||(r[n+(isNaN(e)?"."+e:"")]=t[e]))}else r[n]=e[n];return r}static unflatten(e){var t={};for(var r in e){var n=r.split(".");n.reduce(function(t,s,o){return t[s]||(t[s]=isNaN(Number(n[o+1]))?n.length-1==o?e[r]:{}:[])},t)}return t}static expressHandler(){return e=>function(...t){const r=e(...t),n=t[t.length-1];return Promise.resolve(r).catch(e=>n(e))}}}class ${constructor(e){this.watcher={},this.disableWatchers=e}async load(e){const t=e||process.env.DEFAULT_LANG;this.currentData||(this.currentData={}),this.currentDataFlat||(this.currentDataFlat={});const r=process.cwd()+"/i18n/lang_"+t+".json";this.disableWatchers||(this.watcher[t]=l.watch(r,{ignored:/(^|[/\\])\../,persistent:!0}),this.watcher[t].on("change",e=>this.loadFile(e,t))),await this.loadFile(r,t)}async loadFile(e,t){const r=c.promisify(a.readFile);try{const s=await r(e,"utf8");var n=JSON.parse(s);this.currentDataFlat[t]=N.flattenObject(n),this.currentData[t]=n}catch(e){if("ENOENT"===(null==e?void 0:e.code))return console.log("Lang file does not exist. Create it on ./i18n/lang_{xx}.json");console.error(e)}}async translate(e,t){return t||(t=process.env.DEFAULT_LANG),this.currentDataFlat&&this.currentDataFlat[t]&&this.currentDataFlat[t][e]?this.currentData[t][e]:this.currentDataFlat&&this.currentDataFlat[t]||(await this.load(t),!(this.currentDataFlat&&this.currentDataFlat[t]&&this.currentDataFlat[e]))?"undefined."+e:this.currentDataFlat[t][e]}}class B{constructor(e,t,r,n){this.data=t,this.success=e,this.total=n,this.message=r||""}toJson(){return this}}function L(){return L=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},L.apply(this,arguments)}function _(e){var t={exports:{}};return e(t,t.exports),t.exports}var D=_(function(e,t){var r=f.Buffer;function n(e,t){for(var r in e)t[r]=e[r]}function s(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=f:(n(f,t),t.Buffer=s),n(r,s),s.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},s.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var s=r(e);return void 0!==t?"string"==typeof n?s.fill(t,n):s.fill(t):s.fill(0),s},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return f.SlowBuffer(e)}}),C=D.Buffer;function U(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=C.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=C.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}c.inherits(U,p),U.prototype.write=function(e){this.buffer=C.concat([this.buffer,C.from(e)]),this.emit("data",e)},U.prototype.end=function(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1};var F=U,J=f.Buffer,V=f.SlowBuffer,H=G;function G(e,t){if(!J.isBuffer(e)||!J.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var r=0,n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}G.install=function(){J.prototype.equal=V.prototype.equal=function(e){return G(this,e)}};var K=J.prototype.equal,q=V.prototype.equal;function M(e){return(e/8|0)+(e%8==0?0:1)}G.restore=function(){J.prototype.equal=K,V.prototype.equal=q};var z={ES256:M(256),ES384:M(384),ES512:M(521)},W=function(e){var t=z[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},Y=D.Buffer;function Z(e){if(Y.isBuffer(e))return e;if("string"==typeof e)return Y.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function X(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=128&&--n,n}var Q=function(e,t){e=Z(e);var r=W(t),n=r+1,s=e.length,o=0;if(48!==e[o++])throw new Error('Could not find expected "seq"');var i=e[o++];if(129===i&&(i=e[o++]),s-o<i)throw new Error('"seq" specified length of "'+i+'", only "'+(s-o)+'" remaining');if(2!==e[o++])throw new Error('Could not find expected "int" for "r"');var a=e[o++];if(s-o-2<a)throw new Error('"r" specified length of "'+a+'", only "'+(s-o-2)+'" available');if(n<a)throw new Error('"r" specified length of "'+a+'", max of "'+n+'" is acceptable');var c=o;if(o+=a,2!==e[o++])throw new Error('Could not find expected "int" for "s"');var u=e[o++];if(s-o!==u)throw new Error('"s" specified length of "'+u+'", expected "'+(s-o)+'"');if(n<u)throw new Error('"s" specified length of "'+u+'", max of "'+n+'" is acceptable');var l=o;if((o+=u)!==s)throw new Error('Expected to consume entire buffer, but "'+(s-o)+'" bytes remain');var f=r-a,p=r-u,h=Y.allocUnsafe(f+a+p+u);for(o=0;o<f;++o)h[o]=0;e.copy(h,o,c+Math.max(-f,0),c+a);for(var d=o=r;o<d+p;++o)h[o]=0;return e.copy(h,o,l+Math.max(-p,0),l+u),(h=h.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},ee=D.Buffer,te="secret must be a string or buffer",re="key must be a string or a buffer",ne="function"==typeof u.createPublicKey;function se(e){if(!ee.isBuffer(e)&&"string"!=typeof e){if(!ne)throw ce(re);if("object"!=typeof e)throw ce(re);if("string"!=typeof e.type)throw ce(re);if("string"!=typeof e.asymmetricKeyType)throw ce(re);if("function"!=typeof e.export)throw ce(re)}}function oe(e){if(!ee.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw ce("key must be a string, a buffer or an object")}function ie(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function ae(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var r=0;r<t;++r)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function ce(e){var t=[].slice.call(arguments,1),r=c.format.bind(c,e).apply(null,t);return new TypeError(r)}function ue(e){var t;return ee.isBuffer(t=e)||"string"==typeof t||(e=JSON.stringify(e)),e}function le(e){return function(t,r){!function(e){if(!ee.isBuffer(e)){if("string"==typeof e)return e;if(!ne)throw ce(te);if("object"!=typeof e)throw ce(te);if("secret"!==e.type)throw ce(te);if("function"!=typeof e.export)throw ce(te)}}(r),t=ue(t);var n=u.createHmac("sha"+e,r);return ie((n.update(t),n.digest("base64")))}}function fe(e){return function(t,r,n){var s=le(e)(t,n);return H(ee.from(r),ee.from(s))}}function pe(e){return function(t,r){oe(r),t=ue(t);var n=u.createSign("RSA-SHA"+e);return ie((n.update(t),n.sign(r,"base64")))}}function he(e){return function(t,r,n){se(n),t=ue(t),r=ae(r);var s=u.createVerify("RSA-SHA"+e);return s.update(t),s.verify(n,r,"base64")}}function de(e){return function(t,r){oe(r),t=ue(t);var n=u.createSign("RSA-SHA"+e);return ie((n.update(t),n.sign({key:r,padding:u.constants.RSA_PKCS1_PSS_PADDING,saltLength:u.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function me(e){return function(t,r,n){se(n),t=ue(t),r=ae(r);var s=u.createVerify("RSA-SHA"+e);return s.update(t),s.verify({key:n,padding:u.constants.RSA_PKCS1_PSS_PADDING,saltLength:u.constants.RSA_PSS_SALTLEN_DIGEST},r,"base64")}}function ve(e){var t=pe(e);return function(){var r=t.apply(null,arguments);return Q(r,"ES"+e)}}function ye(e){var t=he(e);return function(r,n,s){return n=function(e,t){e=Z(e);var r=W(t),n=e.length;if(n!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+n+'"');var s=X(e,0,r),o=X(e,r,e.length),i=r-s,a=r-o,c=2+i+1+1+a,u=c<128,l=Y.allocUnsafe((u?2:3)+c),f=0;return l[f++]=48,u?l[f++]=c:(l[f++]=129,l[f++]=255&c),l[f++]=2,l[f++]=i,s<0?(l[f++]=0,f+=e.copy(l,f,0,r)):f+=e.copy(l,f,s,r),l[f++]=2,l[f++]=a,o<0?(l[f++]=0,e.copy(l,f,r)):e.copy(l,f,r+o),l}(n,"ES"+e).toString("base64"),t(r,n,s)}}function ge(){return function(){return""}}function we(){return function(e,t){return""===t}}ne&&(re+=" or a KeyObject",te+="or a KeyObject");var be=function(e){var t={hs:le,rs:pe,ps:de,es:ve,none:ge},r={hs:fe,rs:he,ps:me,es:ye,none:we},n=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!n)throw ce('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var s=(n[1]||n[3]).toLowerCase(),o=n[2];return{sign:t[s](o),verify:r[s](o)}},Se=f.Buffer,Ee=function(e){return"string"==typeof e?e:"number"==typeof e||Se.isBuffer(e)?e.toString():JSON.stringify(e)},je=D.Buffer;function xe(e,t){return je.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function ke(e){var t=e.header,r=e.payload,n=e.secret||e.privateKey,s=e.encoding,o=be(t.alg),i=function(e,t,r){r=r||"utf8";var n=xe(Ee(e),"binary"),s=xe(Ee(t),r);return c.format("%s.%s",n,s)}(t,r,s),a=o.sign(i,n);return c.format("%s.%s",i,a)}function Re(e){var t=new F(e.secret||e.privateKey||e.key);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=t,this.payload=new F(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}c.inherits(Re,p),Re.prototype.sign=function(){try{var e=ke({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},Re.sign=ke;var Ae=Re,Oe=D.Buffer,Te=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function Ie(e){var t=e.split(".",1)[0];return function(e){if(function(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}(Oe.from(t,"base64").toString("binary"))}function Pe(e){return e.split(".")[2]}function Ne(e){return Te.test(e)&&!!Ie(e)}function $e(e,t,r){if(!t){var n=new Error("Missing algorithm parameter for jws.verify");throw n.code="MISSING_ALGORITHM",n}var s=Pe(e=Ee(e)),o=function(e){return e.split(".",2).join(".")}(e);return be(t).verify(o,s,r)}function Be(e,t){if(t=t||{},!Ne(e=Ee(e)))return null;var r=Ie(e);if(!r)return null;var n=function(e,t){t=t||"utf8";var r=e.split(".")[1];return Oe.from(r,"base64").toString(t)}(e);return("JWT"===r.typ||t.json)&&(n=JSON.parse(n,t.encoding)),{header:r,payload:n,signature:Pe(e)}}function Le(e){var t=new F((e=e||{}).secret||e.publicKey||e.key);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=t,this.signature=new F(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}c.inherits(Le,p),Le.prototype.verify=function(){try{var e=$e(this.signature.buffer,this.algorithm,this.key.buffer),t=Be(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},Le.decode=Be,Le.isValid=Ne,Le.verify=$e;var _e=Le,De={ALGORITHMS:["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],sign:Ae.sign,verify:_e.verify,decode:_e.decode,isValid:_e.isValid,createSign:function(e){return new Ae(e)},createVerify:function(e){return new _e(e)}},Ce=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(Ce.prototype=Object.create(Error.prototype)).constructor=Ce;var Ue=Ce,Fe=function(e,t){Ue.call(this,e),this.name="NotBeforeError",this.date=t};(Fe.prototype=Object.create(Ue.prototype)).constructor=Fe;var Je=Fe,Ve=function(e,t){Ue.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(Ve.prototype=Object.create(Ue.prototype)).constructor=Ve;var He=Ve,Ge=1e3,Ke=60*Ge,qe=60*Ke,Me=24*qe;function ze(e,t,r,n){var s=t>=1.5*r;return Math.round(e/r)+" "+n+(s?"s":"")}var We=function(e,t){var r=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var n=function(e,t){t=t||{};var r,n,s=typeof e;if("string"===s&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return r*Me;case"hours":case"hour":case"hrs":case"hr":case"h":return r*qe;case"minutes":case"minute":case"mins":case"min":case"m":return r*Ke;case"seconds":case"second":case"secs":case"sec":case"s":return r*Ge;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(e);if("number"===s&&isFinite(e))return t.long?(r=e,(n=Math.abs(r))>=Me?ze(r,n,Me,"day"):n>=qe?ze(r,n,qe,"hour"):n>=Ke?ze(r,n,Ke,"minute"):n>=Ge?ze(r,n,Ge,"second"):r+" ms"):function(e){var t=Math.abs(e);return t>=Me?Math.round(e/Me)+"d":t>=qe?Math.round(e/qe)+"h":t>=Ke?Math.round(e/Ke)+"m":t>=Ge?Math.round(e/Ge)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}(e);if(void 0===n)return;return Math.floor(r+n/1e3)}return"number"==typeof e?r+e:void 0},Ye=_(function(e,t){var r;t=e.exports=q,r="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("SEMVER"),console.log.apply(console,e)}:function(){},t.SEMVER_SPEC_VERSION="2.0.0";var n=Number.MAX_SAFE_INTEGER||9007199254740991,s=t.re=[],o=t.src=[],i=0,a=i++;o[a]="0|[1-9]\\d*";var c=i++;o[c]="[0-9]+";var u=i++;o[u]="\\d*[a-zA-Z-][a-zA-Z0-9-]*";var l=i++;o[l]="("+o[a]+")\\.("+o[a]+")\\.("+o[a]+")";var f=i++;o[f]="("+o[c]+")\\.("+o[c]+")\\.("+o[c]+")";var p=i++;o[p]="(?:"+o[a]+"|"+o[u]+")";var h=i++;o[h]="(?:"+o[c]+"|"+o[u]+")";var d=i++;o[d]="(?:-("+o[p]+"(?:\\."+o[p]+")*))";var m=i++;o[m]="(?:-?("+o[h]+"(?:\\."+o[h]+")*))";var v=i++;o[v]="[0-9A-Za-z-]+";var y=i++;o[y]="(?:\\+("+o[v]+"(?:\\."+o[v]+")*))";var g=i++,w="v?"+o[l]+o[d]+"?"+o[y]+"?";o[g]="^"+w+"$";var b="[v=\\s]*"+o[f]+o[m]+"?"+o[y]+"?",S=i++;o[S]="^"+b+"$";var E=i++;o[E]="((?:<|>)?=?)";var j=i++;o[j]=o[c]+"|x|X|\\*";var x=i++;o[x]=o[a]+"|x|X|\\*";var k=i++;o[k]="[v=\\s]*("+o[x]+")(?:\\.("+o[x]+")(?:\\.("+o[x]+")(?:"+o[d]+")?"+o[y]+"?)?)?";var R=i++;o[R]="[v=\\s]*("+o[j]+")(?:\\.("+o[j]+")(?:\\.("+o[j]+")(?:"+o[m]+")?"+o[y]+"?)?)?";var A=i++;o[A]="^"+o[E]+"\\s*"+o[k]+"$";var O=i++;o[O]="^"+o[E]+"\\s*"+o[R]+"$";var T=i++;o[T]="(?:^|[^\\d])(\\d{1,16})(?:\\.(\\d{1,16}))?(?:\\.(\\d{1,16}))?(?:$|[^\\d])";var I=i++;o[I]="(?:~>?)";var P=i++;o[P]="(\\s*)"+o[I]+"\\s+",s[P]=new RegExp(o[P],"g");var N=i++;o[N]="^"+o[I]+o[k]+"$";var $=i++;o[$]="^"+o[I]+o[R]+"$";var B=i++;o[B]="(?:\\^)";var L=i++;o[L]="(\\s*)"+o[B]+"\\s+",s[L]=new RegExp(o[L],"g");var _=i++;o[_]="^"+o[B]+o[k]+"$";var D=i++;o[D]="^"+o[B]+o[R]+"$";var C=i++;o[C]="^"+o[E]+"\\s*("+b+")$|^$";var U=i++;o[U]="^"+o[E]+"\\s*("+w+")$|^$";var F=i++;o[F]="(\\s*)"+o[E]+"\\s*("+b+"|"+o[k]+")",s[F]=new RegExp(o[F],"g");var J=i++;o[J]="^\\s*("+o[k]+")\\s+-\\s+("+o[k]+")\\s*$";var V=i++;o[V]="^\\s*("+o[R]+")\\s+-\\s+("+o[R]+")\\s*$";var H=i++;o[H]="(<|>)?=?\\s*\\*";for(var G=0;G<35;G++)r(G,o[G]),s[G]||(s[G]=new RegExp(o[G]));function K(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof q)return e;if("string"!=typeof e)return null;if(e.length>256)return null;if(!(t.loose?s[S]:s[g]).test(e))return null;try{return new q(e,t)}catch(e){return null}}function q(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof q){if(e.loose===t.loose)return e;e=e.version}else if("string"!=typeof e)throw new TypeError("Invalid Version: "+e);if(e.length>256)throw new TypeError("version is longer than 256 characters");if(!(this instanceof q))return new q(e,t);r("SemVer",e,t),this.options=t,this.loose=!!t.loose;var o=e.trim().match(t.loose?s[S]:s[g]);if(!o)throw new TypeError("Invalid Version: "+e);if(this.raw=e,this.major=+o[1],this.minor=+o[2],this.patch=+o[3],this.major>n||this.major<0)throw new TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw new TypeError("Invalid patch version");this.prerelease=o[4]?o[4].split(".").map(function(e){if(/^[0-9]+$/.test(e)){var t=+e;if(t>=0&&t<n)return t}return e}):[],this.build=o[5]?o[5].split("."):[],this.format()}t.parse=K,t.valid=function(e,t){var r=K(e,t);return r?r.version:null},t.clean=function(e,t){var r=K(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null},t.SemVer=q,q.prototype.format=function(){return this.version=this.major+"."+this.minor+"."+this.patch,this.prerelease.length&&(this.version+="-"+this.prerelease.join(".")),this.version},q.prototype.toString=function(){return this.version},q.prototype.compare=function(e){return r("SemVer.compare",this.version,this.options,e),e instanceof q||(e=new q(e,this.options)),this.compareMain(e)||this.comparePre(e)},q.prototype.compareMain=function(e){return e instanceof q||(e=new q(e,this.options)),z(this.major,e.major)||z(this.minor,e.minor)||z(this.patch,e.patch)},q.prototype.comparePre=function(e){if(e instanceof q||(e=new q(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;var t=0;do{var n=this.prerelease[t],s=e.prerelease[t];if(r("prerelease compare",t,n,s),void 0===n&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===n)return-1;if(n!==s)return z(n,s)}while(++t)},q.prototype.inc=function(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{for(var r=this.prerelease.length;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);-1===r&&this.prerelease.push(0)}t&&(this.prerelease[0]===t?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error("invalid increment argument: "+e)}return this.format(),this.raw=this.version,this},t.inc=function(e,t,r,n){"string"==typeof r&&(n=r,r=void 0);try{return new q(e,r).inc(t,n).version}catch(e){return null}},t.diff=function(e,t){if(X(e,t))return null;var r=K(e),n=K(t),s="";if(r.prerelease.length||n.prerelease.length){s="pre";var o="prerelease"}for(var i in r)if(("major"===i||"minor"===i||"patch"===i)&&r[i]!==n[i])return s+i;return o},t.compareIdentifiers=z;var M=/^[0-9]+$/;function z(e,t){var r=M.test(e),n=M.test(t);return r&&n&&(e=+e,t=+t),e===t?0:r&&!n?-1:n&&!r?1:e<t?-1:1}function W(e,t,r){return new q(e,r).compare(new q(t,r))}function Y(e,t,r){return W(e,t,r)>0}function Z(e,t,r){return W(e,t,r)<0}function X(e,t,r){return 0===W(e,t,r)}function Q(e,t,r){return 0!==W(e,t,r)}function ee(e,t,r){return W(e,t,r)>=0}function te(e,t,r){return W(e,t,r)<=0}function re(e,t,r,n){switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return X(e,r,n);case"!=":return Q(e,r,n);case">":return Y(e,r,n);case">=":return ee(e,r,n);case"<":return Z(e,r,n);case"<=":return te(e,r,n);default:throw new TypeError("Invalid operator: "+t)}}function ne(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof ne){if(e.loose===!!t.loose)return e;e=e.value}if(!(this instanceof ne))return new ne(e,t);r("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.value=this.semver===se?"":this.operator+this.semver.version,r("comp",this)}t.rcompareIdentifiers=function(e,t){return z(t,e)},t.major=function(e,t){return new q(e,t).major},t.minor=function(e,t){return new q(e,t).minor},t.patch=function(e,t){return new q(e,t).patch},t.compare=W,t.compareLoose=function(e,t){return W(e,t,!0)},t.rcompare=function(e,t,r){return W(t,e,r)},t.sort=function(e,r){return e.sort(function(e,n){return t.compare(e,n,r)})},t.rsort=function(e,r){return e.sort(function(e,n){return t.rcompare(e,n,r)})},t.gt=Y,t.lt=Z,t.eq=X,t.neq=Q,t.gte=ee,t.lte=te,t.cmp=re,t.Comparator=ne;var se={};function oe(e,t){if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),e instanceof oe)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new oe(e.raw,t);if(e instanceof ne)return new oe(e.value,t);if(!(this instanceof oe))return new oe(e,t);if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split(/\s*\|\|\s*/).map(function(e){return this.parseRange(e.trim())},this).filter(function(e){return e.length}),!this.set.length)throw new TypeError("Invalid SemVer Range: "+e);this.format()}function ie(e){return!e||"x"===e.toLowerCase()||"*"===e}function ae(e,t,r,n,s,o,i,a,c,u,l,f,p){return((t=ie(r)?"":ie(n)?">="+r+".0.0":ie(s)?">="+r+"."+n+".0":">="+t)+" "+(a=ie(c)?"":ie(u)?"<"+(+c+1)+".0.0":ie(l)?"<"+c+"."+(+u+1)+".0":f?"<="+c+"."+u+"."+l+"-"+f:"<="+a)).trim()}function ce(e,t,n){for(var s=0;s<e.length;s++)if(!e[s].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(s=0;s<e.length;s++)if(r(e[s].semver),e[s].semver!==se&&e[s].semver.prerelease.length>0){var o=e[s].semver;if(o.major===t.major&&o.minor===t.minor&&o.patch===t.patch)return!0}return!1}return!0}function ue(e,t,r){try{t=new oe(t,r)}catch(e){return!1}return t.test(e)}function le(e,t,r,n){var s,o,i,a,c;switch(e=new q(e,n),t=new oe(t,n),r){case">":s=Y,o=te,i=Z,a=">",c=">=";break;case"<":s=Z,o=ee,i=Y,a="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(ue(e,t,n))return!1;for(var u=0;u<t.set.length;++u){var l=null,f=null;if(t.set[u].forEach(function(e){e.semver===se&&(e=new ne(">=0.0.0")),f=f||e,s(e.semver,(l=l||e).semver,n)?l=e:i(e.semver,f.semver,n)&&(f=e)}),l.operator===a||l.operator===c)return!1;if((!f.operator||f.operator===a)&&o(e,f.semver))return!1;if(f.operator===c&&i(e,f.semver))return!1}return!0}ne.prototype.parse=function(e){var t=e.match(this.options.loose?s[C]:s[U]);if(!t)throw new TypeError("Invalid comparator: "+e);this.operator=t[1],"="===this.operator&&(this.operator=""),this.semver=t[2]?new q(t[2],this.options.loose):se},ne.prototype.toString=function(){return this.value},ne.prototype.test=function(e){return r("Comparator.test",e,this.options.loose),this.semver===se||("string"==typeof e&&(e=new q(e,this.options)),re(e,this.operator,this.semver,this.options))},ne.prototype.intersects=function(e,t){if(!(e instanceof ne))throw new TypeError("a Comparator is required");var r;if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return r=new oe(e.value,t),ue(this.value,r,t);if(""===e.operator)return r=new oe(this.value,t),ue(e.semver,r,t);var n=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),s=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),o=this.semver.version===e.semver.version,i=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),a=re(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),c=re(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return n||s||o&&i||a||c},t.Range=oe,oe.prototype.format=function(){return this.range=this.set.map(function(e){return e.join(" ").trim()}).join("||").trim(),this.range},oe.prototype.toString=function(){return this.range},oe.prototype.parseRange=function(e){var t=this.options.loose;e=(e=e.trim()).replace(t?s[V]:s[J],ae),r("hyphen replace",e),e=e.replace(s[F],"$1$2$3"),r("comparator trim",e,s[F]),e=(e=(e=e.replace(s[P],"$1~")).replace(s[L],"$1^")).split(/\s+/).join(" ");var n=t?s[C]:s[U],o=e.split(" ").map(function(e){return function(e,t){return r("comp",e,t),e=function(e,t){return e.trim().split(/\s+/).map(function(e){return function(e,t){return r("caret",e,t),e.replace(t.loose?s[D]:s[_],function(t,n,s,o,i){var a;return r("caret",e,t,n,s,o,i),ie(n)?a="":ie(s)?a=">="+n+".0.0 <"+(+n+1)+".0.0":ie(o)?a="0"===n?">="+n+"."+s+".0 <"+n+"."+(+s+1)+".0":">="+n+"."+s+".0 <"+(+n+1)+".0.0":i?(r("replaceCaret pr",i),a="0"===n?"0"===s?">="+n+"."+s+"."+o+"-"+i+" <"+n+"."+s+"."+(+o+1):">="+n+"."+s+"."+o+"-"+i+" <"+n+"."+(+s+1)+".0":">="+n+"."+s+"."+o+"-"+i+" <"+(+n+1)+".0.0"):(r("no pr"),a="0"===n?"0"===s?">="+n+"."+s+"."+o+" <"+n+"."+s+"."+(+o+1):">="+n+"."+s+"."+o+" <"+n+"."+(+s+1)+".0":">="+n+"."+s+"."+o+" <"+(+n+1)+".0.0"),r("caret return",a),a})}(e,t)}).join(" ")}(e,t),r("caret",e),e=function(e,t){return e.trim().split(/\s+/).map(function(e){return function(e,t){return e.replace(t.loose?s[$]:s[N],function(t,n,s,o,i){var a;return r("tilde",e,t,n,s,o,i),ie(n)?a="":ie(s)?a=">="+n+".0.0 <"+(+n+1)+".0.0":ie(o)?a=">="+n+"."+s+".0 <"+n+"."+(+s+1)+".0":i?(r("replaceTilde pr",i),a=">="+n+"."+s+"."+o+"-"+i+" <"+n+"."+(+s+1)+".0"):a=">="+n+"."+s+"."+o+" <"+n+"."+(+s+1)+".0",r("tilde return",a),a})}(e,t)}).join(" ")}(e,t),r("tildes",e),e=function(e,t){return r("replaceXRanges",e,t),e.split(/\s+/).map(function(e){return function(e,t){return(e=e.trim()).replace(t.loose?s[O]:s[A],function(t,n,s,o,i,a){r("xRange",e,t,n,s,o,i,a);var c=ie(s),u=c||ie(o),l=u||ie(i);return"="===n&&l&&(n=""),c?t=">"===n||"<"===n?"<0.0.0":"*":n&&l?(u&&(o=0),i=0,">"===n?(n=">=",u?(s=+s+1,o=0,i=0):(o=+o+1,i=0)):"<="===n&&(n="<",u?s=+s+1:o=+o+1),t=n+s+"."+o+"."+i):u?t=">="+s+".0.0 <"+(+s+1)+".0.0":l&&(t=">="+s+"."+o+".0 <"+s+"."+(+o+1)+".0"),r("xRange return",t),t})}(e,t)}).join(" ")}(e,t),r("xrange",e),e=function(e,t){return r("replaceStars",e,t),e.trim().replace(s[H],"")}(e,t),r("stars",e),e}(e,this.options)},this).join(" ").split(/\s+/);return this.options.loose&&(o=o.filter(function(e){return!!e.match(n)})),o.map(function(e){return new ne(e,this.options)},this)},oe.prototype.intersects=function(e,t){if(!(e instanceof oe))throw new TypeError("a Range is required");return this.set.some(function(r){return r.every(function(r){return e.set.some(function(e){return e.every(function(e){return r.intersects(e,t)})})})})},t.toComparators=function(e,t){return new oe(e,t).set.map(function(e){return e.map(function(e){return e.value}).join(" ").trim().split(" ")})},oe.prototype.test=function(e){if(!e)return!1;"string"==typeof e&&(e=new q(e,this.options));for(var t=0;t<this.set.length;t++)if(ce(this.set[t],e,this.options))return!0;return!1},t.satisfies=ue,t.maxSatisfying=function(e,t,r){var n=null,s=null;try{var o=new oe(t,r)}catch(e){return null}return e.forEach(function(e){o.test(e)&&(n&&-1!==s.compare(e)||(s=new q(n=e,r)))}),n},t.minSatisfying=function(e,t,r){var n=null,s=null;try{var o=new oe(t,r)}catch(e){return null}return e.forEach(function(e){o.test(e)&&(n&&1!==s.compare(e)||(s=new q(n=e,r)))}),n},t.minVersion=function(e,t){e=new oe(e,t);var r=new q("0.0.0");if(e.test(r))return r;if(r=new q("0.0.0-0"),e.test(r))return r;r=null;for(var n=0;n<e.set.length;++n)e.set[n].forEach(function(e){var t=new q(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":r&&!Y(r,t)||(r=t);break;case"<":case"<=":break;default:throw new Error("Unexpected operation: "+e.operator)}});return r&&e.test(r)?r:null},t.validRange=function(e,t){try{return new oe(e,t).range||"*"}catch(e){return null}},t.ltr=function(e,t,r){return le(e,t,"<",r)},t.gtr=function(e,t,r){return le(e,t,">",r)},t.outside=le,t.prerelease=function(e,t){var r=K(e,t);return r&&r.prerelease.length?r.prerelease:null},t.intersects=function(e,t,r){return e=new oe(e,r),t=new oe(t,r),e.intersects(t)},t.coerce=function(e){if(e instanceof q)return e;if("string"!=typeof e)return null;var t=e.match(s[T]);return null==t?null:K(t[1]+"."+(t[2]||"0")+"."+(t[3]||"0"))}}),Ze=Ye.satisfies(process.version,"^6.12.0 || >=8.0.0"),Xe=["RS256","RS384","RS512","ES256","ES384","ES512"],Qe=["RS256","RS384","RS512"],et=["HS256","HS384","HS512"];Ze&&(Xe.splice(3,0,"PS256","PS384","PS512"),Qe.splice(3,0,"PS256","PS384","PS512"));var tt=/^\s+|\s+$/g,rt=/^[-+]0x[0-9a-f]+$/i,nt=/^0b[01]+$/i,st=/^0o[0-7]+$/i,ot=/^(?:0|[1-9]\d*)$/,it=parseInt;function at(e){return e!=e}var ct,ut,lt=Object.prototype,ft=lt.hasOwnProperty,pt=lt.toString,ht=lt.propertyIsEnumerable,dt=(ct=Object.keys,ut=Object,function(e){return ct(ut(e))}),mt=Math.max;function vt(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||ot.test(e))&&e>-1&&e%1==0&&e<t}var yt=Array.isArray;function gt(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!function(e){var t=wt(e)?pt.call(e):"";return"[object Function]"==t||"[object GeneratorFunction]"==t}(e)}function wt(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function bt(e){return!!e&&"object"==typeof e}var St=Object.prototype.toString,Et=function(e){return!0===e||!1===e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==St.call(e)},jt=/^\s+|\s+$/g,xt=/^[-+]0x[0-9a-f]+$/i,kt=/^0b[01]+$/i,Rt=/^0o[0-7]+$/i,At=parseInt,Ot=Object.prototype.toString;function Tt(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var It=function(e){return"number"==typeof e&&e==function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==Ot.call(e)}(e))return NaN;if(Tt(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Tt(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(jt,"");var r=kt.test(e);return r||Rt.test(e)?At(e.slice(2),r?2:8):xt.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e)},Pt=Object.prototype.toString,Nt=function(e){return"number"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==Pt.call(e)},$t=Object.prototype,Bt=Function.prototype.toString,Lt=$t.hasOwnProperty,_t=Bt.call(Object),Dt=$t.toString,Ct=function(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object),Ut=function(e){if(!function(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=Dt.call(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=Ct(e);if(null===t)return!0;var r=Lt.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&Bt.call(r)==_t},Ft=Object.prototype.toString,Jt=Array.isArray,Vt=function(e){return"string"==typeof e||!Jt(e)&&function(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==Ft.call(e)},Ht=/^\s+|\s+$/g,Gt=/^[-+]0x[0-9a-f]+$/i,Kt=/^0b[01]+$/i,qt=/^0o[0-7]+$/i,Mt=parseInt,zt=Object.prototype.toString;function Wt(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var Yt=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];Ze&&Yt.splice(3,0,"PS256","PS384","PS512");var Zt={expiresIn:{isValid:function(e){return It(e)||Vt(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return It(e)||Vt(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return Vt(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:function(e,t,r,n){var s;e=gt(e)?e:(s=e)?function(e,t){return function(t,r){for(var n=-1,s=t?t.length:0,o=Array(s);++n<s;)o[n]=e[t[n]];return o}(t)}(s,function(e){return gt(e)?function(e,t){var r=yt(e)||function(e){return function(e){return bt(e)&&gt(e)}(e)&&ft.call(e,"callee")&&(!ht.call(e,"callee")||"[object Arguments]"==pt.call(e))}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,s=!!n;for(var o in e)!ft.call(e,o)||s&&("length"==o||vt(o,n))||r.push(o);return r}(e):function(e){if((t=e)!==("function"==typeof(r=t&&t.constructor)&&r.prototype||lt))return dt(e);var t,r,n=[];for(var s in Object(e))ft.call(e,s)&&"constructor"!=s&&n.push(s);return n}(e)}(s)):[],r=r&&!n?function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||bt(e)&&"[object Symbol]"==pt.call(e)}(e))return NaN;if(wt(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=wt(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(tt,"");var r=nt.test(e);return r||st.test(e)?it(e.slice(2),r?2:8):rt.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(r):0;var o=e.length;return r<0&&(r=mt(o+r,0)),function(e){return"string"==typeof e||!yt(e)&&bt(e)&&"[object String]"==pt.call(e)}(e)?r<=o&&e.indexOf(t,r)>-1:!!o&&function(e,t,r){if(t!=t)return function(e,t,r,n){for(var s=e.length,o=r+-1;++o<s;)if(t(e[o],o,e))return o;return-1}(e,at,r);for(var n=r-1,s=e.length;++n<s;)if(e[n]===t)return n;return-1}(e,t,r)>-1}.bind(null,Yt),message:'"algorithm" must be a valid string enum value'},header:{isValid:Ut,message:'"header" must be an object'},encoding:{isValid:Vt,message:'"encoding" must be a string'},issuer:{isValid:Vt,message:'"issuer" must be a string'},subject:{isValid:Vt,message:'"subject" must be a string'},jwtid:{isValid:Vt,message:'"jwtid" must be a string'},noTimestamp:{isValid:Et,message:'"noTimestamp" must be a boolean'},keyid:{isValid:Vt,message:'"keyid" must be a string'},mutatePayload:{isValid:Et,message:'"mutatePayload" must be a boolean'}},Xt={iat:{isValid:Nt,message:'"iat" should be a number of seconds'},exp:{isValid:Nt,message:'"exp" should be a number of seconds'},nbf:{isValid:Nt,message:'"nbf" should be a number of seconds'}};function Qt(e,t,r,n){if(!Ut(r))throw new Error('Expected "'+n+'" to be a plain object.');Object.keys(r).forEach(function(s){var o=e[s];if(o){if(!o.isValid(r[s]))throw new Error(o.message)}else if(!t)throw new Error('"'+s+'" is not allowed in "'+n+'"')})}var er={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},tr=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"],rr=function(e,t,r,n){var s;if("function"!=typeof r||n||(n=r,r={}),r||(r={}),r=Object.assign({},r),s=n||function(e,t){if(e)throw e;return t},r.clockTimestamp&&"number"!=typeof r.clockTimestamp)return s(new Ue("clockTimestamp must be a number"));if(void 0!==r.nonce&&("string"!=typeof r.nonce||""===r.nonce.trim()))return s(new Ue("nonce must be a non-empty string"));var o=r.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return s(new Ue("jwt must be provided"));if("string"!=typeof e)return s(new Ue("jwt must be a string"));var i,a=e.split(".");if(3!==a.length)return s(new Ue("jwt malformed"));try{i=function(e,t){var r=De.decode(e,t=t||{});if(!r)return null;var n=r.payload;if("string"==typeof n)try{var s=JSON.parse(n);null!==s&&"object"==typeof s&&(n=s)}catch(e){}return!0===t.complete?{header:r.header,payload:n,signature:r.signature}:n}(e,{complete:!0})}catch(e){return s(e)}if(!i)return s(new Ue("invalid token"));var c,u=i.header;if("function"==typeof t){if(!n)return s(new Ue("verify must be called asynchronous if secret or public key is provided as a callback"));c=t}else c=function(e,r){return r(null,t)};return c(u,function(t,n){if(t)return s(new Ue("error in secret or public key callback: "+t.message));var c,l=""!==a[2].trim();if(!l&&n)return s(new Ue("jwt signature is required"));if(l&&!n)return s(new Ue("secret or public key must be provided"));if(l||r.algorithms||(r.algorithms=["none"]),r.algorithms||(r.algorithms=~n.toString().indexOf("BEGIN CERTIFICATE")||~n.toString().indexOf("BEGIN PUBLIC KEY")?Xe:~n.toString().indexOf("BEGIN RSA PUBLIC KEY")?Qe:et),!~r.algorithms.indexOf(i.header.alg))return s(new Ue("invalid algorithm"));try{c=De.verify(e,i.header.alg,n)}catch(e){return s(e)}if(!c)return s(new Ue("invalid signature"));var f=i.payload;if(void 0!==f.nbf&&!r.ignoreNotBefore){if("number"!=typeof f.nbf)return s(new Ue("invalid nbf value"));if(f.nbf>o+(r.clockTolerance||0))return s(new Je("jwt not active",new Date(1e3*f.nbf)))}if(void 0!==f.exp&&!r.ignoreExpiration){if("number"!=typeof f.exp)return s(new Ue("invalid exp value"));if(o>=f.exp+(r.clockTolerance||0))return s(new He("jwt expired",new Date(1e3*f.exp)))}if(r.audience){var p=Array.isArray(r.audience)?r.audience:[r.audience];if(!(Array.isArray(f.aud)?f.aud:[f.aud]).some(function(e){return p.some(function(t){return t instanceof RegExp?t.test(e):t===e})}))return s(new Ue("jwt audience invalid. expected: "+p.join(" or ")))}if(r.issuer&&("string"==typeof r.issuer&&f.iss!==r.issuer||Array.isArray(r.issuer)&&-1===r.issuer.indexOf(f.iss)))return s(new Ue("jwt issuer invalid. expected: "+r.issuer));if(r.subject&&f.sub!==r.subject)return s(new Ue("jwt subject invalid. expected: "+r.subject));if(r.jwtid&&f.jti!==r.jwtid)return s(new Ue("jwt jwtid invalid. expected: "+r.jwtid));if(r.nonce&&f.nonce!==r.nonce)return s(new Ue("jwt nonce invalid. expected: "+r.nonce));if(r.maxAge){if("number"!=typeof f.iat)return s(new Ue("iat required when maxAge is specified"));var h=We(r.maxAge,f.iat);if(void 0===h)return s(new Ue('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(o>=h+(r.clockTolerance||0))return s(new He("maxAge exceeded",new Date(1e3*h)))}return s(null,!0===r.complete?{header:u,payload:f,signature:i.signature}:f)})},nr=function(e,t,r,n){"function"==typeof r?(n=r,r={}):r=r||{};var s="object"==typeof e&&!Buffer.isBuffer(e),o=Object.assign({alg:r.algorithm||"HS256",typ:s?"JWT":void 0,kid:r.keyid},r.header);function i(e){if(n)return n(e);throw e}if(!t&&"none"!==r.algorithm)return i(new Error("secretOrPrivateKey must have a value"));if(void 0===e)return i(new Error("payload is required"));if(s){try{!function(e){Qt(Xt,!0,e,"payload")}(e)}catch(e){return i(e)}r.mutatePayload||(e=Object.assign({},e))}else{var a=tr.filter(function(e){return void 0!==r[e]});if(a.length>0)return i(new Error("invalid "+a.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==r.expiresIn)return i(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==r.notBefore)return i(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function(e){Qt(Zt,!1,e,"options")}(r)}catch(e){return i(e)}var c=e.iat||Math.floor(Date.now()/1e3);if(r.noTimestamp?delete e.iat:s&&(e.iat=c),void 0!==r.notBefore){try{e.nbf=We(r.notBefore,c)}catch(e){return i(e)}if(void 0===e.nbf)return i(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==r.expiresIn&&"object"==typeof e){try{e.exp=We(r.expiresIn,c)}catch(e){return i(e)}if(void 0===e.exp)return i(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(er).forEach(function(t){var n=er[t];if(void 0!==r[t]){if(void 0!==e[n])return i(new Error('Bad "options.'+t+'" option. The payload already has an "'+n+'" property.'));e[n]=r[t]}});var u=r.encoding||"utf8";if("function"!=typeof n)return De.sign({header:o,payload:e,secret:t,encoding:u});n=n&&function(e){return function(e,t){var r;if("function"!=typeof t)throw new TypeError("Expected a function");return e=function(e){var t=function(e){return e?Infinity===(e=function(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==zt.call(e)}(e))return NaN;if(Wt(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Wt(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Ht,"");var r=Kt.test(e);return r||qt.test(e)?Mt(e.slice(2),r?2:8):Gt.test(e)?NaN:+e}(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}(e),r=t%1;return t==t?r?t-r:t:0}(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=void 0),r}}(2,e)}(n),De.createSign({header:o,privateKey:t,payload:e,encoding:u}).once("error",n).once("done",function(e){n(null,e)})};class sr{constructor(e,t){this.privateKey=e,this.options=t}sign(e){const t=L({},this.options,{jwtid:h.v4()});return nr(e,this.privateKey,t)}verify(e){return rr(e,this.privateKey,this.options)}refresh(e){const t=rr(e,this.privateKey,this.options);delete t.sub,delete t.iss,delete t.aud,delete t.iat,delete t.exp,delete t.nbf,delete t.jti;const r=L({},this.options,{jwtid:h.v4()});return nr(t,this.privateKey,r)}}class or{constructor(e,r,n){this.app=t(),this.express_config=i.defaultsDeep(e,{helmet:!0,json:!0,urlencoded:!0,compression:!0,cors:{origin:!0,credentials:!0},fileupload:!0,socketio:{transports:["websocket"]},traceRequests:!1}),this.statics=r,this.routes=n}async initialize(){this.config(this.express_config),this.customizeExpress&&await this.customizeExpress(this.app),await this.configureRoutes(this.routes),await this.errorHandler()}customizeExpress(){}config(a){if(a&&a.helmet&&this.app.use(e(a&&i.isObject(a.helmet)?a.helmet:void 0)),a&&a.json&&this.app.use(t.json()),a&&a.urlencoded&&this.app.use(t.urlencoded({extended:!0})),a&&a.compression&&this.app.use(r()),a&&a.cors&&(this.app.options("*",n(a&&i.isObject(a.cors)&&a.cors)),this.app.use(n(a&&i.isObject(a.cors)&&a.cors))),a&&a.fileupload&&this.app.use(s()),this.statics)for(const e in this.statics)this.app.use(e,t.static(this.statics[e]));a&&!0===a.traceRequests&&"true"!=process.env.DISABLE_LOGGER&&this.app.use((e,t,r)=>{e.requestTime=Date.now(),t.on("finish",()=>{let t=o.parse(e.url).pathname,r=Date.now()-e.requestTime;console.debug("APIRequest["+process.pid+"]::. ["+e.method+"] (user:"+(e&&e.session&&e.session.user_id||"")+")  "+t+" |-> took: "+r+" ms"),console.debug(JSON.stringify(e.body))}),r()})}configureRoutes(e){const r=t.Router();this.app.use(r),this.loadRoutes(this.app,e)}loadRoutes(e,t){if(t)for(const r of t){if(!r){console.warn("Empty route");continue}let t=r.configure();if(r.entity&&(t=r.configure(r.entity,{service:r.service,table:r.table})),!i.isEmpty(r.routes)){const e=N.expressHandler();for(const n in r.routes){const s=r.routes[n];for(const r in s){const o=s[r];Array.isArray(o)?t[r](n,o[0],e(o[1])):t[r](n,e(o))}}}t&&e.use(t)}}errorHandler(){this.app.use((e,t,r,n)=>{let s=new B;s.success=!1,s.message=e.message,console.error(e),r.status(500).json(s.toJson())})}}class ir extends b{constructor(e){super(),process.env.PORT||console.log("Using 3000 as default port. Customize via env PORT."),this.port=this.normalizePort(process.env.PORT||3e3),this.clustered=process.env.CLUSTERED,this.workers=[],this.app=e,this.executeOnlyMain=()=>{}}setServerCls(e){this.server=e}async start(){"true"==this.clustered?this.initClustered():(this.configureSocketIO(),this.executeOnlyMain(),await this.initUnclustered())}configureSocketIO(){this.server.express_config&&this.server.express_config.socketio&&(this.app.io=new g(this.server.express_config&&this.server.express_config.socketio),this.app.io.listen(this.port+1))}async initClustered(){if(y.isPrimary){this.configureSocketIO(),this.executeOnlyMain(),(new S).on("event",(e,t)=>{e&&e.event&&(1==process.env.DEBUG_EVENTS&&console.debug(`Received '${e.event}' from ${e.props.owner} at Master`),this.app.events.emit(e.event,e.props,t))});const e=w.cpus().length;for(let t=0;t<e;t+=1)this.initWorker();y.on("exit",e=>{console.log("Worker "+e.id+" died :("),this.initWorker()})}else await this.initUnclustered(),console.log(`Worker ${process.pid} started`)}initWorker(){let e=y.fork();console.log(`Running worker ${e.process.pid}`),this.workers.push(e)}async initUnclustered(){this.server.port=this.port;let e=d.Server(this.server.app);if(await this.server.initialize(),this.server.beforeListen&&await this.server.beforeListen(),e.listen(this.server.port),this.server.afterListen&&await this.server.afterListen(),e.on("error",e=>{this.handleErrors(e,this.server.port)}),e.on("listening",()=>{console.log("Server Worker running on port: "+this.port+"!"),this.emit("listening",this.port)}),process.env.SSL&&"true"==process.env.SSL){process.env.SSL_KEY&&process.env.SSL_CERT&&process.env.SSL_PASS||(console.error("Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed"),process.exit(0));var t={key:a.readFileSync(v.resolve(process.cwd(),process.env.SSL_KEY||"key.pem")),cert:a.readFileSync(v.resolve(process.cwd(),process.env.SSL_CERT||"cert.pem")),passphrase:process.env.SSL_PASS};process.env.SSL_PORT||console.log("Using 3443 as ssl default port. Customize via env SSL_PORT.");var r=this.normalizePort(process.env.SSL_PORT||3443),n=m.createServer(t,this.server.app);n.listen(r),n.on("error",e=>{this.handleErrors(e,r)}),n.on("listening",()=>{console.log("Server Worker running on port: "+r+"!"),this.emit("listening_ssl",r)})}}normalizePort(e){let t=parseInt(e,10);return isNaN(t)?e:t>=0&&t}handleErrors(e,t){if("listen"!==e.syscall)throw e;let r="string"==typeof t?"Pipe "+t:"Port "+t;switch(e.code){case"EACCES":console.error(r+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(r+" is already in use"),process.exit(1);break;default:throw e}}}class ar extends b{constructor(e){super(),this.messages=new S,this.app=e,y.isWorker&&this.messages.on("event",(e,t)=>{e&&e.event&&process.pid!==e.props.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(`Receiving broadcast ${e.event} - ${process.pid}`),super.emit(e.event,L({},e.props),t))})}emit(e,t,r){super.emit(e,t,r),e&&t&&y.isWorker&&process.pid!==t.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(`${e} -> Firing from ${process.pid} to master`),t||(t={}),t.owner=process.pid,this.messages.send("event",{event:e,props:L({},t)},r)),e&&t&&y.isPrimary&&this.app&&this.app.server&&this.app.server.workers&&(1==process.env.DEBUG_EVENTS&&console.debug(`${e} -> Firing from master to workers`),this.messages.send("event",{event:e,props:L({},t)},r))}}const{configure:cr,getLogger:ur}=E;class lr{static async configure(){const e=c.promisify(a.readFile),t=await e(v.resolve(process.cwd(),"./log4js.json"),"utf8");cr(JSON.parse(t)),(()=>{const e=ur("log"),t=ur("error"),r=ur("debug");console.log=function(){let t=Array.prototype.slice.call(arguments);e.log("info",t[0])},console.error=function(){let e=Array.prototype.slice.call(arguments);t.log("error",e[0])},console.info=function(){let t=Array.prototype.slice.call(arguments);e.log("info",t[0])},console.debug=function(){let e=Array.prototype.slice.call(arguments);r.log("debug",e[0])},console.custom=function(e,t,r){ur(e).log(t,r)}})()}}class fr{constructor(e,r){this.router=t.Router(),this.publicPathsList=[...e,"/login"],this.AuthHandler=r}configure(){const e=N.expressHandler();return this.router.use(e((...e)=>this.check(...e))),this.router.post("/login",e((...e)=>this.loginPost(...e))),this.router.post("/logout",e((...e)=>this.logout(...e))),this.router}async check(e,t,r){try{for(let t of this.publicPathsList)if(null!==j(t).exec(o.parse(e.url).pathname))return r();return await this.AuthHandler.check(e)?r():t.status(403).json(new B(!1,null,"Forbidden").toJson())}catch(e){return console.error(e),t.status(403).json(new B(!1,null,"Forbidden").toJson())}}async loginPost(e,t){if(e.body.username)try{let r=await this.AuthHandler.validate(e,e.body.username,e.body.password);return r?t.status(200).json(new B(!0,r).toJson()):t.status(401).json(new B(!1,null,"Unauthorized - Incorrect credentials").toJson())}catch(e){return console.error(e),t.status(401).json(new B(!1,null,"Unauthorized - Error, check log").toJson())}return t.status(401).json(new B(!1,null,"Unauthorized - Missing parameters").toJson())}async logout(e,t){if(this.AuthHandler.logout)try{return await this.AuthHandler.logout(e),t.status(200).json(new B(!0).toJson())}catch(e){return console.error(e),t.status(500).json(new B(!1,null,e).toJson())}return t.status(200).json(new B(!0).toJson())}}class pr{constructor(){if(!this.check)throw new Error("AuthHandler must have 'check' vethod");if(!this.validate)throw new Error("AuthHandler must have 'validate' vethod")}}class hr extends pr{constructor(e){if(super(),this.tokenGenerator=new sr(process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE,issuer:process.env.JWT_ISSUER,subject:process.env.JWT_SUBJECT,algorithm:process.env.JWT_ALGORITHM,expiresIn:process.env.JWT_EXPIRES}),!e)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");this.userDao=e}async check(e){if(e.headers.authorization){const r=(e.headers.authorization||"").split(" ")[1]||"";if(!r)return console.error("Token needed"),!1;try{var t=this.tokenGenerator.verify(r);const{sub:n,username:s,exp:o}=t;return!(!n||!s||x(o).isAfter(new Date)||(e.session=L({},e.session,t),0))}catch(e){return console.error(e),!1}}return!1}async validate(e,t,r){const n=await this.userDao.findByUsername(t);return!(!n||n.username!==t||n.password!==N.encrypt(r))&&this.tokenGenerator.sign(i.omit(n,["password"]))}}class dr extends pr{constructor(e){if(super(),!e)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");this.userDao=e}async check(e){if(e.headers.authorization){const t=(e.headers.authorization||"").split(" ")[1]||"",r=Buffer.from(t,"base64").toString().split(":"),n=r[0],s=r[1];return!!await this.validate(e,n,s)}return!(!e.session||!e.session.username)}async validate(e,t,r){const n=await this.userDao.findByUsername(t);return!(!n||n.username!==t||n.password!==N.encrypt(r)||(e.session=L({},e.session,i.omit(n,["password"])),0))}logout(e){return new Promise(t=>{e.session&&e.session.destroy(t)})}}var mr=new class{init(e){this.connection=A(e)}setColumnAliases(e){this.columnAliases=e}test(){return this.connection.raw("select 1+1 as result")}};class vr{static parseQueryString(e,t,r){const n={allowGlobalSearch:!0,caseInsensitive:!0};mr.columnAliases&&mr.columnAliases[r]&&(n.aliases=mr.columnAliases[r]),void 0!==mr.caseInsensitive&&(n.caseInsensitive=mr.caseInsensitive),void 0!==mr.allowGlobalSearch&&(n.allowGlobalSearch=mr.allowGlobalSearch);const s=new k(n).parse(t);return new R(r).toKnex(e,s)}static parseFilters(e,t,r){let n=e;for(let e in t){let s=t[e];if("object"==typeof s)switch(s.type){case"fql":n=vr.parseQueryString(n,s.value,r);break;case"date":case"between":s.start&&s.end&&(n=n.whereBetween(e,[s.start,s.end])),s.start&&!s.end&&(n=n.where(e,">=",s.start)),!s.start&&s.end&&(n=n.where(e,">=",s.end));break;case"dateraw":case"betweenraw":s.start&&s.end&&(n=n.whereRaw(`${e} BETWEEN ? AND ?`,[s.start,s.end])),s.start&&!s.end&&(n=n.whereRaw(`${e} >= ?`,[s.start])),!s.start&&s.end&&(n=n.whereRaw(`${e} >= ?`,[s.end]));break;case"jsonb":n=n.whereRaw(`${e} ILIKE ?`,["%"+s.value+"%"]);break;case"full-text-psql":n=n.whereRaw(`to_tsvector(${e}::text) @@ to_tsquery(?)`,[s.value]);break;case"greater":case"greaterraw":n=n.whereRaw(`${e} > ?`,[s.value]);break;case"greaterEq":case"greaterEqraw":n=n.whereRaw(`${e} >= ?`,[s.value]);break;case"less":case"lessraw":n=n.whereRaw(`${e} < ?`,[s.value]);break;case"lessEq":case"lessEqraw":n=n.whereRaw(`${e} <= ?`,[s.value]);break;case"exists":n=n.whereExists(e);break;case"notexists":n=n.whereNotExists(e);break;case"exact":case"exactraw":n=n.whereRaw(`${e} = ?`,[s.value]);break;case"in":let t=e;t.includes(",")&&(t=e.split(",")),Array.isArray(s.value)||null==s.value?null!=s.value&&(n=n.whereIn(t,s.value)):n=n.whereIn(t,s.value.split(","));break;case"inraw":Array.isArray(s.value)||null==s.value?null!=s.value&&(n=n.whereRaw(`${e} IN (?)`,[s.value.map(e=>`'${e}'`).join(",")])):n=n.whereRaw(`${e} IN (?)`,[s.value.split(",").map(e=>`'${e}'`).join(",")]);break;case"not":case"notraw":n=n.whereRaw(`${e} != ?`,[s.value]);break;case"like":case"likeraw":let o=N.replaceAll(s.value,"*","%");n=n.whereRaw(` ${e} LIKE ?`,[o]);break;case"notlike":case"notlikeraw":let i=N.replaceAll(s.value,"*","%");n=n.whereRaw(` ${e} NOT LIKE ?`,[i]);break;case"likeI":let a=N.replaceAll(s.value,"*","%");n=n.whereRaw(` ${e} ILIKE ?`,[a]);break;case"notlikeI":let c=N.replaceAll(s.value,"*","%");n=n.whereRaw(` ${e} NOT ILIKE ?`,[c]);break;case"null":case"nullraw":n=n.whereRaw(`${e} is NULL`);break;case"notnull":case"notnullraw":n=n.whereRaw(`${e} is not NULL`)}else n=n.where(e,s)}return n}static parseSort(e){if(!e.field||!e.direction)return 1;let t="ASC";return"descend"===e.direction&&(t="DESC"),e.field+" "+t}}class yr{constructor(){this.tableName=""}loadAllData(e,t){return mr.connection.select("*").from(this.tableName).limit(t||1e4).offset(e)}async loadFilteredData(e,t,r){let n=1;return e.sort&&(n=vr.parseSort(e.sort)),mr.connection.from(this.tableName).where(t=>vr.parseFilters(t,i.omit(e,["sort","start","limit"]),this.tableName)).orderByRaw(n).limit(r).offset(t)}async countFilteredData(e){let t=await mr.connection.from(this.tableName).where(t=>vr.parseFilters(t,i.omit(e,["sort","start","limit"]),this.tableName)).count("id",{as:"total"});return t&&t[0].total}async loadById(e){const t=await mr.connection.from(this.tableName).where("id",e);return t&&t[0]?t[0]:null}save(e){return mr.connection.from(this.tableName).insert(e).returning("*")}update(e,t){return mr.connection.from(this.tableName).where("id",e).update(t).returning("*")}async delete(e){if(!await this.loadById(e))throw"NotFound";return mr.connection.from(this.tableName).where("id",e).delete()}}class gr extends yr{constructor(e){if(super(e),!this.findByUsername)throw new Error("AuthHandler must have 'findByUsername' method")}}class wr{constructor(){this.router=t.Router(),this.routes={}}configure(e,t){if(!e)return this.router;const r=N.expressHandler();return this.router.get(`/${e}`,r((...e)=>this.listEntidad(...e))),this.router.post(`/${e}/list`,r((...e)=>this.listEntidad(...e))),this.router.get(`/${e}/:id`,r((...e)=>this.getEntidad(...e))),this.router.post(`/${e}`,r((...e)=>this.saveEntidad(...e))),this.router.put(`/${e}/:id`,r((...e)=>this.updateEntidad(...e))),this.router.delete(`/${e}/:id`,r((...e)=>this.deleteEntidad(...e))),this.service=t.service,this.table=t.table,this.router}async listEntidad(e,t,r){try{let r=new this.service(null,this.table),n="POST"===e.method?e.body:e.query&&e.query.filters?JSON.parse(e.query.filters):{},s=await r.list(n,n.start,n.limit),o=new B(!0,s.data,null,s.total);t.json(o.toJson())}catch(e){r(e)}}async getEntidad(e,t,r){try{let r=new this.service(null,this.table),n=await r.loadById(e.params.id),s=new B(!0,n),o=200;null==n&&(o=404,s=new B(!1,null,"Element not found",0)),t.status(o).json(s.toJson())}catch(e){console.error(e);let r="";"22P02"==e.code&&(r="Expected uiid");let n=new B(!1,null,r,0);t.status(400).json(n.toJson())}}async saveEntidad(e,t,r){try{let r=new this.service(null,this.table),n=await r.save(e.body),s=new B(!0,n&&n[0]||{id:e.body.id});t.setHeader("Location",`/entity/${s.data.id}`),t.status(201).json(s.toJson())}catch(e){r(e)}}async updateEntidad(e,t,r){try{let r=new this.service(null,this.table),n=await r.update(e.params.id,e.body),s=new B(!0,n&&n[0]||{id:e.body.id});t.json(s.toJson())}catch(e){r(e)}}async deleteEntidad(e,t,r){try{let r=new this.service(null,this.table),n=await r.delete(e.params.id),s=new B(!0,n);t.status(204).json(s.toJson())}catch(e){if(console.error(e),"NotFound"==e){let e=new B(!1,null,"Element not found",0);t.status(404).json(e.toJson())}else r(e)}}}class br{constructor(e,t){this.dao=e?new e:new yr,t&&(this.dao.tableName=t)}async list(e,t,r){const n=t||0,s=r||1e3;let o={};if(o.total=await this.dao.countFilteredData(e,n,s),e&&0!==Object.keys(e).length){let t=await this.dao.loadFilteredData(e,n,s);return o.data=t,o}return o.data=await this.dao.loadAllData(t,r),o}loadById(e){return this.dao.loadById(e)}save(e){return this.dao.save(e)}update(e,t){if(e)return this.dao.update(e,t)}delete(e){if(e)return this.dao.delete(e)}}var Sr=new class{constructor(){this.serverClass=or,this.clusterClass=ir}runtime(e){return async function(e){const t=I(P(process.argv)).usage("Como usar: \n            node $0 [options] \n            \n            ** Si no se especifican parámetros el servidor arrancará normalmente. **").alias("g","generateKeys").describe("g","Genera unas claves para la aplicación").alias("c","encrypt").describe("c","Codifica el String proporcionado en base a la contraseña de .env").nargs("c",1).help("h").alias("h","help");let r=[];if(e)for(const n of e)t.alias(n.key,n.alias),n.describe&&t.describe(n.key,n.describe),0!==n.nargs&&t.nargs(n.key,n.nargs),n.boolean&&t.boolean(n.key),n.choices&&t.choices(n.key,n.choices),n.required&&r.push(n.key);0!==r.length&&t.demandOption(r);const n=t.argv;if(n.generateKeys)return console.log("Generando claves para encriptación:"),console.log(N.generateKeys()),process.exit(1);if(n.encrypt)return console.log("Resultado encryptación:"),console.log(N.encrypt(n.encrypt)),process.exit(1);if(e)for(const t of e)if(n[t.key])return await t.fn(n),process.exit(1)}(e)}async init(e){"true"!=process.env.DISABLE_LOGGER&&await lr.configure();const t=new this.serverClass(e,this.statics,this.routes);this.customizeExpress&&(t.customizeExpress=this.customizeExpress),this.beforeListen&&(t.beforeListen=this.beforeListen),this.afterListen&&(t.afterListen=this.afterListen),this.events=new ar(this),this.i18n=new $(null==e?void 0:e.disableI18nWatcher),await this.i18n.load(),this.server=new this.clusterClass(this),this.server.setServerCls(t),this.server.executeOnlyMain=()=>{this.executeOnlyMain&&this.executeOnlyMain(),"true"==process.env.REPL_ENABLED&&this.startRepl()}}async start(){if(!this.server)throw new Error("Call init first");await this.server.start()}startRepl(){try{O.createServer(e=>{const t=T.start({prompt:"lisco::remote> ",input:e,output:e,terminal:!0,useColors:!0,preview:!1});t.context.app=this,t.context.Utils=N,t.context.db=mr.connection,t.on("exit",e.end.bind(e))}).listen(process.env.REPL_PORT||5001)}catch(e){console.log("Remote REPL Conn: "+e)}console.log(`Remote REPL started on port ${process.env.REPL_PORT||5001}`)}};export{Sr as App,fr as AuthController,wr as BaseController,yr as BaseKnexDao,br as BaseService,ir as ClusterServer,dr as CookieAuthHandler,ar as EventHandler,$ as I18nLoader,pr as IAuthHandler,gr as IUserDao,B as JsonResponse,hr as JwtAuthHandler,mr as KnexConnector,vr as KnexFilterParser,lr as Logger,or as Server,sr as TokenGenerator,N as Utils};
//# sourceMappingURL=lisco.modern.js.map
