!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("helmet"),require("express"),require("compression"),require("cors"),require("express-fileupload"),require("url"),require("lodash"),require("fs"),require("util"),require("crypto"),require("chokidar"),require("jsonwebtoken"),require("uuid"),require("http"),require("https"),require("path"),require("cluster"),require("socket.io"),require("os"),require("events"),require("cluster-messages"),require("log4js"),require("path-to-regexp"),require("moment"),require("@landra_sistemas/fql-parser"),require("knex"),require("net"),require("repl"),require("yargs/yargs"),require("yargs/helpers")):"function"==typeof define&&define.amd?define(["exports","helmet","express","compression","cors","express-fileupload","url","lodash","fs","util","crypto","chokidar","jsonwebtoken","uuid","http","https","path","cluster","socket.io","os","events","cluster-messages","log4js","path-to-regexp","moment","@landra_sistemas/fql-parser","knex","net","repl","yargs/yargs","yargs/helpers"],r):r((e||self).lisco={},e.helmet,e.express,e.compression,e.cors,e.expressFileupload,e.url,e.lodash,e.fs,e.util,e.crypto,e.chokidar,e.jsonwebtoken,e.uuid,e.http,e.https,e.path,e.cluster,e.socket_io,e.os,e.events,e.clusterMessages,e.log4Js,e.pathToRegexp,e.moment,e.fqlParser,e.knex,e.net,e.repl,e.yargs,e.helpers)}(this,function(e,r,t,n,o,s,i,a,u,c,l,f,h,d,p,v,m,y,w,g,b,P,E,S,k,j,x,R,A,L,D){function O(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function _(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}}),r.default=e,r}var q=/*#__PURE__*/O(r),T=/*#__PURE__*/O(t),I=/*#__PURE__*/O(n),N=/*#__PURE__*/O(o),C=/*#__PURE__*/O(s),F=/*#__PURE__*/O(i),U=/*#__PURE__*/O(a),B=/*#__PURE__*/O(u),J=/*#__PURE__*/O(c),K=/*#__PURE__*/O(l),G=/*#__PURE__*/O(f),z=/*#__PURE__*/O(h),H=/*#__PURE__*/_(d),W=/*#__PURE__*/O(p),M=/*#__PURE__*/O(v),Y=/*#__PURE__*/O(m),V=/*#__PURE__*/O(y),$=/*#__PURE__*/O(g),Q=/*#__PURE__*/O(P),X=/*#__PURE__*/O(E),Z=/*#__PURE__*/O(k),ee=/*#__PURE__*/O(x),re=/*#__PURE__*/O(R),te=/*#__PURE__*/O(A),ne=/*#__PURE__*/O(L);function oe(){return oe=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},oe.apply(this,arguments)}function se(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,ie(e,r)}function ie(e,r){return ie=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,r){return e.__proto__=r,e},ie(e,r)}function ae(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function ue(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return ae(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?ae(e,r):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var ce=/*#__PURE__*/function(){function e(){}return e.arrayToLower=function(e){return e.join("~").toLowerCase().split("~")},e.replaceAll=function(e,r,t){return e.replace(new RegExp(r.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),t)},e.encrypt=function(e){var r=Buffer.from(process.env.CRYPT_SECRET,"hex"),t=Buffer.from(process.env.CRYPT_IV,"hex"),n=K.default.createCipheriv("aes-256-cbc",r,t),o=n.update(e);return(o=Buffer.concat([o,n.final()])).toString("hex")},e.decrypt=function(e){var r=Buffer.from(process.env.CRYPT_SECRET,"hex"),t=Buffer.from(process.env.CRYPT_IV,"hex"),n=Buffer.from(e,"hex"),o=K.default.createDecipheriv("aes-256-cbc",r,t),s=o.update(n);return(s=Buffer.concat([s,o.final()])).toString()},e.sleep=function(e){return J.default.promisify(setTimeout)(e)},e.generateKeys=function(){return{key:K.default.randomBytes(32).toString("hex"),iv:K.default.randomBytes(16).toString("hex")}},e.flattenObject=function(r){var t,n={};for(var o in r)if(r.hasOwnProperty(o))if(r[o]&&Array===r[o].constructor)n[o]=r[o];else if("object"==typeof r[o])for(var s in t=e.flattenObject(r[o]))t.hasOwnProperty(s)&&(t[s]&&Array===t.constructor||(n[o+(isNaN(s)?"."+s:"")]=t[s]));else n[o]=r[o];return n},e.unflatten=function(e){var r={};for(var t in e){var n=t.split(".");n.reduce(function(r,o,s){return r[o]||(r[o]=isNaN(Number(n[s+1]))?n.length-1==s?e[t]:{}:[])},r)}return r},e.expressHandler=function(){return function(e){return function(){var r=[].slice.call(arguments),t=e.apply(void 0,r),n=r[r.length-1];return Promise.resolve(t).catch(function(e){return n(e)})}}},e}(),le=/*#__PURE__*/function(){function e(){this.watcher={}}var r=e.prototype;return r.load=function(e){try{var r=this,t=e||process.env.DEFAULT_LANG;r.currentData||(r.currentData={}),r.currentDataFlat||(r.currentDataFlat={});var n=process.cwd()+"/i18n/lang_"+t+".json";return r.watcher[t]=G.default.watch(n,{ignored:/(^|[/\\])\../,persistent:!0}),r.watcher[t].on("change",function(e){return r.loadFile(e,t)}),Promise.resolve(r.loadFile(n,t)).then(function(){})}catch(e){return Promise.reject(e)}},r.loadFile=function(e,r){try{var t=this,n=J.default.promisify(B.default.readFile);return Promise.resolve(function(o,s){try{var i=Promise.resolve(n(e,"utf8")).then(function(e){var n=JSON.parse(e);t.currentDataFlat[r]=ce.flattenObject(n),t.currentData[r]=n})}catch(e){return s(e)}return i&&i.then?i.then(void 0,s):i}(0,function(e){if("ENOENT"===(null==e?void 0:e.code))return console.log("Lang file does not exist. Create it on ./i18n/lang_{xx}.json");console.error(e)}))}catch(e){return Promise.reject(e)}},r.translate=function(e,r){try{var t,n=function(r){return t?r:"undefined."+e},o=this;if(r||(r=process.env.DEFAULT_LANG),o.currentDataFlat&&o.currentDataFlat[r]&&o.currentDataFlat[r][e])return Promise.resolve(o.currentData[r][e]);var s=function(){if(!o.currentDataFlat||!o.currentDataFlat[r])return Promise.resolve(o.load(r)).then(function(){if(o.currentDataFlat&&o.currentDataFlat[r]&&o.currentDataFlat[e])return t=1,o.currentDataFlat[r][e]})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e}(),fe=/*#__PURE__*/function(){function e(e,r,t,n){this.data=r,this.success=e,this.total=n,this.message=t||""}return e.prototype.toJson=function(){return this},e}(),he=/*#__PURE__*/function(){function e(e,r){this.privateKey=e,this.options=r}var r=e.prototype;return r.sign=function(e){var r=oe({},this.options,{jwtid:H.v4()});return z.default.sign(e,this.privateKey,r)},r.verify=function(e){return z.default.verify(e,this.privateKey,this.options)},r.refresh=function(e){var r=z.default.verify(e,this.privateKey,this.options);delete r.sub,delete r.iss,delete r.aud,delete r.iat,delete r.exp,delete r.nbf,delete r.jti;var t=oe({},this.options,{jwtid:H.v4()});return z.default.sign(r,this.privateKey,t)},e}(),de=/*#__PURE__*/function(){function e(e,r,t){this.app=T.default(),this.express_config=U.default.defaultsDeep(e,{helmet:!0,json:!0,urlencoded:!0,compression:!0,cors:{origin:!0,credentials:!0},fileupload:!0,socketio:{transports:["websocket"]},traceRequests:!1}),this.statics=r,this.routes=t}var r=e.prototype;return r.initialize=function(){try{var e=function(){return Promise.resolve(r.configureRoutes(r.routes)).then(function(){return Promise.resolve(r.errorHandler()).then(function(){})})},r=this;r.config(r.express_config);var t=function(){if(r.customizeExpress)return Promise.resolve(r.customizeExpress(r.app)).then(function(){})}();return Promise.resolve(t&&t.then?t.then(e):e())}catch(e){return Promise.reject(e)}},r.customizeExpress=function(){},r.config=function(e){if(e&&e.helmet&&this.app.use(q.default(e&&U.default.isObject(e.helmet)&&e.helmet)),e&&e.json&&this.app.use(T.default.json()),e&&e.urlencoded&&this.app.use(T.default.urlencoded({extended:!0})),e&&e.compression&&this.app.use(I.default()),e&&e.cors&&(this.app.options("*",N.default(e&&U.default.isObject(e.cors)&&e.cors)),this.app.use(N.default(e&&U.default.isObject(e.cors)&&e.cors))),e&&e.fileupload&&this.app.use(C.default()),this.statics)for(var r in this.statics)this.app.use(r,T.default.static(this.statics[r]));e&&!0===e.traceRequests&&"true"!=process.env.DISABLE_LOGGER&&this.app.use(function(e,r,t){e.requestTime=Date.now(),r.on("finish",function(){var r=F.default.parse(e.url).pathname,t=Date.now()-e.requestTime;console.debug("APIRequest["+process.pid+"]::. ["+e.method+"] (user:"+(e&&e.session&&e.session.user_id||"")+")  "+r+" |-> took: "+t+" ms"),console.debug(JSON.stringify(e.body))}),t()})},r.configureRoutes=function(e){var r=T.default.Router();this.app.use(r),this.loadRoutes(this.app,e)},r.loadRoutes=function(e,r){if(r)for(var t,n=ue(r);!(t=n()).done;){var o=t.value;if(o){var s=o.configure();if(o.entity&&(s=o.configure(o.entity,{service:o.service,table:o.table})),!U.default.isEmpty(o.routes)){var i=ce.expressHandler();for(var a in o.routes){var u=o.routes[a];for(var c in u){var l=u[c];Array.isArray(l)?s[c](a,l[0],i(l[1])):s[c](a,i(l))}}}s&&e.use(s)}else console.warn("Empty route")}},r.errorHandler=function(){this.app.use(function(e,r,t,n){var o=new fe;o.success=!1,o.message=e.message,console.error(e),t.status(500).json(o.toJson())})},e}(),pe=/*#__PURE__*/function(e){function r(r){var t;return t=e.call(this)||this,process.env.PORT||console.log("Using 3000 as default port. Customize via env PORT."),t.port=t.normalizePort(process.env.PORT||3e3),t.clustered=process.env.CLUSTERED,t.workers=[],t.app=r,t.executeOnlyMain=function(){},t}se(r,e);var t=r.prototype;return t.setServerCls=function(e){this.server=e},t.start=function(){try{var e=this,r=function(){if("true"!=e.clustered)return e.configureSocketIO(),e.executeOnlyMain(),Promise.resolve(e.initUnclustered()).then(function(){});e.initClustered()}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.configureSocketIO=function(){this.server.express_config&&this.server.express_config.socketio&&(this.app.io=new w.Server(this.server.express_config&&this.server.express_config.socketio),this.app.io.listen(this.port+1))},t.initClustered=function(){try{var e=this,r=function(){if(!V.default.isPrimary)return Promise.resolve(e.initUnclustered()).then(function(){console.log("Worker "+process.pid+" started")});e.configureSocketIO(),e.executeOnlyMain(),(new Q.default).on("event",function(r,t){r&&r.event&&(1==process.env.DEBUG_EVENTS&&console.debug("Received '"+r.event+"' from "+r.props.owner+" at Master"),e.app.events.emit(r.event,r.props,t))});for(var r=$.default.cpus().length,t=0;t<r;t+=1)e.initWorker();V.default.on("exit",function(r){console.log("Worker "+r.id+" died :("),e.initWorker()})}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.initWorker=function(){var e=V.default.fork();console.log("Running worker "+e.process.pid),this.workers.push(e)},t.initUnclustered=function(){try{var e=this;e.server.port=e.port;var r=W.default.Server(e.server.app);return Promise.resolve(e.server.initialize()).then(function(){function t(){function t(){if(r.on("error",function(r){e.handleErrors(r,e.server.port)}),r.on("listening",function(){console.log("Server Worker running on port: "+e.port+"!"),e.emit("listening",e.port)}),process.env.SSL&&"true"==process.env.SSL){process.env.SSL_KEY&&process.env.SSL_CERT&&process.env.SSL_PASS||(console.error("Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed"),process.exit(0));var t={key:B.default.readFileSync(Y.default.resolve(process.cwd(),process.env.SSL_KEY||"key.pem")),cert:B.default.readFileSync(Y.default.resolve(process.cwd(),process.env.SSL_CERT||"cert.pem")),passphrase:process.env.SSL_PASS};process.env.SSL_PORT||console.log("Using 3443 as ssl default port. Customize via env SSL_PORT.");var n=e.normalizePort(process.env.SSL_PORT||3443),o=M.default.createServer(t,e.server.app);o.listen(n),o.on("error",function(r){e.handleErrors(r,n)}),o.on("listening",function(){console.log("Server Worker running on port: "+n+"!"),e.emit("listening_ssl",n)})}}r.listen(e.server.port);var n=function(){if(e.server.afterListen)return Promise.resolve(e.server.afterListen()).then(function(){})}();return n&&n.then?n.then(t):t()}var n=function(){if(e.server.beforeListen)return Promise.resolve(e.server.beforeListen()).then(function(){})}();return n&&n.then?n.then(t):t()})}catch(e){return Promise.reject(e)}},t.normalizePort=function(e){var r=parseInt(e,10);return isNaN(r)?e:r>=0&&r},t.handleErrors=function(e,r){if("listen"!==e.syscall)throw e;var t="string"==typeof r?"Pipe "+r:"Port "+r;switch(e.code){case"EACCES":console.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(t+" is already in use"),process.exit(1);break;default:throw e}},r}(b.EventEmitter),ve=/*#__PURE__*/function(e){function r(r){var t;return(t=e.call(this)||this).messages=new Q.default,t.app=r,V.default.isWorker&&t.messages.on("event",function(r,n){r&&r.event&&process.pid!==r.props.owner&&(1==process.env.DEBUG_EVENTS&&console.debug("Receiving broadcast "+r.event+" - "+process.pid),e.prototype.emit.call(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t),r.event,oe({},r.props),n))}),t}return se(r,e),r.prototype.emit=function(r,t,n){e.prototype.emit.call(this,r,t,n),r&&t&&V.default.isWorker&&process.pid!==t.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(r+" -> Firing from "+process.pid+" to master"),t||(t={}),t.owner=process.pid,this.messages.send("event",{event:r,props:oe({},t)},n)),r&&t&&V.default.isPrimary&&this.app&&this.app.server&&this.app.server.workers&&(1==process.env.DEBUG_EVENTS&&console.debug(r+" -> Firing from master to workers"),this.messages.send("event",{event:r,props:oe({},t)},n))},r}(b.EventEmitter),me=X.default.configure,ye=X.default.getLogger,we=/*#__PURE__*/function(){function e(){}return e.configure=function(){try{var e=J.default.promisify(B.default.readFile);return Promise.resolve(e(Y.default.resolve(process.cwd(),"./log4js.json"),"utf8")).then(function(e){var r,t,n;me(JSON.parse(e)),r=ye("log"),t=ye("error"),n=ye("debug"),console.log=function(){var e=Array.prototype.slice.call(arguments);r.log("info",e[0])},console.error=function(){var e=Array.prototype.slice.call(arguments);t.log("error",e[0])},console.info=function(){var e=Array.prototype.slice.call(arguments);r.log("info",e[0])},console.debug=function(){var e=Array.prototype.slice.call(arguments);n.log("debug",e[0])},console.custom=function(e,r,t){ye(e).log(r,t)}})}catch(e){return Promise.reject(e)}},e}();function ge(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var be=/*#__PURE__*/function(){function e(e,r){this.router=T.default.Router(),this.publicPathsList=[].concat(e,["/login"]),this.AuthHandler=r}var r=e.prototype;return r.configure=function(){var e=this,r=ce.expressHandler();return this.router.use(r(function(){return e.check.apply(e,[].slice.call(arguments))})),this.router.post("/login",r(function(){return e.loginPost.apply(e,[].slice.call(arguments))})),this.router.post("/logout",r(function(){return e.logout.apply(e,[].slice.call(arguments))})),this.router},r.check=function(e,r,t){try{var n=this;return Promise.resolve(ge(function(){for(var o,s=ue(n.publicPathsList);!(o=s()).done;)if(null!==S.pathToRegexp(o.value).exec(F.default.parse(e.url).pathname))return t();return Promise.resolve(n.AuthHandler.check(e)).then(function(e){return e?t():r.status(403).json(new fe(!1,null,"Forbidden").toJson())})},function(e){return console.error(e),r.status(403).json(new fe(!1,null,"Forbidden").toJson())}))}catch(e){return Promise.reject(e)}},r.loginPost=function(e,r){try{var t,n=function(e){return t?e:r.status(401).json(new fe(!1,null,"Unauthorized - Missing parameters").toJson())},o=this,s=function(){if(e.body.username)return ge(function(){return Promise.resolve(o.AuthHandler.validate(e,e.body.username,e.body.password)).then(function(e){if(e){var n=r.status(200).json(new fe(!0,e).toJson());return t=1,n}var o=r.status(401).json(new fe(!1,null,"Unauthorized - Incorrect credentials").toJson());return t=1,o})},function(e){console.error(e);var n=r.status(401).json(new fe(!1,null,"Unauthorized - Error, check log").toJson());return t=1,n})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},r.logout=function(e,r){try{var t,n=function(e){return t?e:r.status(200).json(new fe(!0).toJson())},o=this,s=function(){if(o.AuthHandler.logout)return ge(function(){return Promise.resolve(o.AuthHandler.logout(e)).then(function(){var e=r.status(200).json(new fe(!0).toJson());return t=1,e})},function(e){console.error(e);var n=r.status(500).json(new fe(!1,null,e).toJson());return t=1,n})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e}(),Pe=function(){if(!this.check)throw new Error("AuthHandler must have 'check' vethod");if(!this.validate)throw new Error("AuthHandler must have 'validate' vethod")},Ee=/*#__PURE__*/function(e){function r(r){var t;if((t=e.call(this)||this).tokenGenerator=new he(process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE,issuer:process.env.JWT_ISSUER,subject:process.env.JWT_SUBJECT,algorithm:process.env.JWT_ALGORITHM,expiresIn:process.env.JWT_EXPIRES}),!r)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return t.userDao=r,t}se(r,e);var t=r.prototype;return t.check=function(e){try{if(e.headers.authorization){var r=(e.headers.authorization||"").split(" ")[1]||"";if(!r)return console.error("Token needed"),Promise.resolve(!1);try{var t=this.tokenGenerator.verify(r);return t.sub&&t.username&&!Z.default(t.exp).isAfter(new Date)?(e.session=oe({},e.session,t),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return console.error(e),Promise.resolve(!1)}}return Promise.resolve(!1)}catch(e){return Promise.reject(e)}},t.validate=function(e,r,t){try{var n=this;return Promise.resolve(n.userDao.findByUsername(r)).then(function(e){return!(!e||e.username!==r||e.password!==ce.encrypt(t))&&n.tokenGenerator.sign(U.default.omit(e,["password"]))})}catch(e){return Promise.reject(e)}},r}(Pe),Se=/*#__PURE__*/function(e){function r(r){var t;if(t=e.call(this)||this,!r)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return t.userDao=r,t}se(r,e);var t=r.prototype;return t.check=function(e){try{var r,t=function(t){return r?t:!(!e.session||!e.session.username)},n=this,o=function(){if(e.headers.authorization){var t=(e.headers.authorization||"").split(" ")[1]||"",o=Buffer.from(t,"base64").toString().split(":");return Promise.resolve(n.validate(e,o[0],o[1])).then(function(e){return e?r=!0:(r=1,!1)})}}();return Promise.resolve(o&&o.then?o.then(t):t(o))}catch(e){return Promise.reject(e)}},t.validate=function(e,r,t){try{return Promise.resolve(this.userDao.findByUsername(r)).then(function(n){return!(!n||n.username!==r||n.password!==ce.encrypt(t)||(e.session=oe({},e.session,U.default.omit(n,["password"])),0))})}catch(e){return Promise.reject(e)}},t.logout=function(e){return new Promise(function(r){e.session&&e.session.destroy(r)})},r}(Pe),ke=new(/*#__PURE__*/function(){function e(){}var r=e.prototype;return r.init=function(e){this.connection=ee.default(e)},r.setColumnAliases=function(e){this.columnAliases=e},r.test=function(){return this.connection.raw("select 1+1 as result")},e}()),je=/*#__PURE__*/function(){function e(){}return e.parseQueryString=function(e,r,t){var n={allowGlobalSearch:!0,caseInsensitive:!0};ke.columnAliases&&ke.columnAliases[t]&&(n.aliases=ke.columnAliases[t]),void 0!==ke.caseInsensitive&&(n.caseInsensitive=ke.caseInsensitive),void 0!==ke.allowGlobalSearch&&(n.allowGlobalSearch=ke.allowGlobalSearch);var o=new j.FQLParser(n).parse(r);return new j.KnexParser(t).toKnex(e,o)},e.parseFilters=function(r,t,n){var o=r;for(var s in t){var i=t[s];if("object"==typeof i)switch(i.type){case"fql":o=e.parseQueryString(o,i.value,n);break;case"date":case"between":i.start&&i.end&&(o=o.whereBetween(s,[i.start,i.end])),i.start&&!i.end&&(o=o.where(s,">=",i.start)),!i.start&&i.end&&(o=o.where(s,">=",i.end));break;case"dateraw":case"betweenraw":i.start&&i.end&&(o=o.whereRaw(s+" BETWEEN ? AND ?",[i.start,i.end])),i.start&&!i.end&&(o=o.whereRaw(s+" >= ?",[i.start])),!i.start&&i.end&&(o=o.whereRaw(s+" >= ?",[i.end]));break;case"jsonb":o=o.whereRaw(s+" ILIKE ?",["%"+i.value+"%"]);break;case"full-text-psql":o=o.whereRaw("to_tsvector("+s+"::text) @@ to_tsquery(?)",[i.value]);break;case"greater":case"greaterraw":o=o.whereRaw(s+" > ?",[i.value]);break;case"greaterEq":case"greaterEqraw":o=o.whereRaw(s+" >= ?",[i.value]);break;case"less":case"lessraw":o=o.whereRaw(s+" < ?",[i.value]);break;case"lessEq":case"lessEqraw":o=o.whereRaw(s+" <= ?",[i.value]);break;case"exists":o=o.whereExists(s);break;case"notexists":o=o.whereNotExists(s);break;case"exact":case"exactraw":o=o.whereRaw(s+" = ?",[i.value]);break;case"in":var a=s;a.includes(",")&&(a=s.split(",")),Array.isArray(i.value)||null==i.value?null!=i.value&&(o=o.whereIn(a,i.value)):o=o.whereIn(a,i.value.split(","));break;case"inraw":Array.isArray(i.value)||null==i.value?null!=i.value&&(o=o.whereRaw(s+" IN (?)",[i.value.map(function(e){return"'"+e+"'"}).join(",")])):o=o.whereRaw(s+" IN (?)",[i.value.split(",").map(function(e){return"'"+e+"'"}).join(",")]);break;case"not":case"notraw":o=o.whereRaw(s+" != ?",[i.value]);break;case"like":case"likeraw":var u=ce.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" LIKE ?",[u]);break;case"notlike":case"notlikeraw":var c=ce.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" NOT LIKE ?",[c]);break;case"likeI":var l=ce.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" ILIKE ?",[l]);break;case"notlikeI":var f=ce.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" NOT ILIKE ?",[f]);break;case"null":case"nullraw":o=o.whereRaw(s+" is NULL");break;case"notnull":case"notnullraw":o=o.whereRaw(s+" is not NULL")}else o=o.where(s,i)}return o},e.parseSort=function(e){if(!e.field||!e.direction)return 1;var r="ASC";return"descend"===e.direction&&(r="DESC"),e.field+" "+r},e}(),xe=/*#__PURE__*/function(){function e(){this.tableName=""}var r=e.prototype;return r.loadAllData=function(e,r){return ke.connection.select("*").from(this.tableName).limit(r||1e4).offset(e)},r.loadFilteredData=function(e,r,t){try{var n=this,o=1;return e.sort&&(o=je.parseSort(e.sort)),Promise.resolve(ke.connection.from(n.tableName).where(function(r){return je.parseFilters(r,U.default.omit(e,["sort","start","limit"]),n.tableName)}).orderByRaw(o).limit(t).offset(r))}catch(e){return Promise.reject(e)}},r.countFilteredData=function(e){try{var r=this;return Promise.resolve(ke.connection.from(r.tableName).where(function(t){return je.parseFilters(t,U.default.omit(e,["sort","start","limit"]),r.tableName)}).count("id",{as:"total"})).then(function(e){return e&&e[0].total})}catch(e){return Promise.reject(e)}},r.loadById=function(e){try{return Promise.resolve(ke.connection.from(this.tableName).where("id",e)).then(function(e){return e&&e[0]?e[0]:null})}catch(e){return Promise.reject(e)}},r.save=function(e){return ke.connection.from(this.tableName).insert(e).returning("*")},r.update=function(e,r){return ke.connection.from(this.tableName).where("id",e).update(r).returning("*")},r.delete=function(e){try{var r=this;return Promise.resolve(r.loadById(e)).then(function(t){if(!t)throw"NotFound";return ke.connection.from(r.tableName).where("id",e).delete()})}catch(e){return Promise.reject(e)}},e}(),Re=/*#__PURE__*/function(e){function r(r){var t;if(!(t=e.call(this,r)||this).findByUsername)throw new Error("AuthHandler must have 'findByUsername' method");return t}return se(r,e),r}(xe);function Ae(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var Le=/*#__PURE__*/function(){function e(){this.router=T.default.Router(),this.routes={}}var r=e.prototype;return r.configure=function(e,r){var t=this;if(!e)return this.router;var n=ce.expressHandler();return this.router.get("/"+e,n(function(){return t.listEntidad.apply(t,[].slice.call(arguments))})),this.router.post("/"+e+"/list",n(function(){return t.listEntidad.apply(t,[].slice.call(arguments))})),this.router.get("/"+e+"/:id",n(function(){return t.getEntidad.apply(t,[].slice.call(arguments))})),this.router.post("/"+e,n(function(){return t.saveEntidad.apply(t,[].slice.call(arguments))})),this.router.put("/"+e+"/:id",n(function(){return t.updateEntidad.apply(t,[].slice.call(arguments))})),this.router.delete("/"+e+"/:id",n(function(){return t.deleteEntidad.apply(t,[].slice.call(arguments))})),this.service=r.service,this.table=r.table,this.router},r.listEntidad=function(e,r,t){try{var n=this,o=Ae(function(){var t=new n.service(null,n.table),o="POST"===e.method?e.body:e.query&&e.query.filters?JSON.parse(e.query.filters):{};return Promise.resolve(t.list(o,o.start,o.limit)).then(function(e){var t=new fe(!0,e.data,null,e.total);r.json(t.toJson())})},function(e){t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.getEntidad=function(e,r,t){try{var n=this,o=Ae(function(){var t=new n.service(null,n.table);return Promise.resolve(t.loadById(e.params.id)).then(function(e){var t=new fe(!0,e),n=200;null==e&&(n=404,t=new fe(!1,null,"Element not found",0)),r.status(n).json(t.toJson())})},function(e){console.error(e);var t="";"22P02"==e.code&&(t="Expected uiid");var n=new fe(!1,null,t,0);r.status(400).json(n.toJson())});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.saveEntidad=function(e,r,t){try{var n=this,o=Ae(function(){var t=new n.service(null,n.table);return Promise.resolve(t.save(e.body)).then(function(t){var n=new fe(!0,t&&t[0]||{id:e.body.id});r.setHeader("Location","/entity/"+n.data.id),r.status(201).json(n.toJson())})},function(e){t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.updateEntidad=function(e,r,t){try{var n=this,o=Ae(function(){var t=new n.service(null,n.table);return Promise.resolve(t.update(e.params.id,e.body)).then(function(t){var n=new fe(!0,t&&t[0]||{id:e.body.id});r.json(n.toJson())})},function(e){t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},r.deleteEntidad=function(e,r,t){try{var n=this,o=Ae(function(){var t=new n.service(null,n.table);return Promise.resolve(t.delete(e.params.id)).then(function(e){var t=new fe(!0,e);r.status(204).json(t.toJson())})},function(e){if(console.error(e),"NotFound"==e){var n=new fe(!1,null,"Element not found",0);r.status(404).json(n.toJson())}else t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}(),De=/*#__PURE__*/function(){function e(e,r){this.dao=e?new e:new xe,r&&(this.dao.tableName=r)}var r=e.prototype;return r.list=function(e,r,t){try{var n=this,o=r||0,s=t||1e3,i={};return Promise.resolve(n.dao.countFilteredData(e,o,s)).then(function(a){var u;function c(e){return u?e:Promise.resolve(n.dao.loadAllData(r,t)).then(function(e){return i.data=e,i})}i.total=a;var l=function(){if(e&&0!==Object.keys(e).length)return Promise.resolve(n.dao.loadFilteredData(e,o,s)).then(function(e){return i.data=e,u=1,i})}();return l&&l.then?l.then(c):c(l)})}catch(e){return Promise.reject(e)}},r.loadById=function(e){return this.dao.loadById(e)},r.save=function(e){return this.dao.save(e)},r.update=function(e,r){if(e)return this.dao.update(e,r)},r.delete=function(e){if(e)return this.dao.delete(e)},e}();function Oe(e,r,t){if(!e.s){if(t instanceof _e){if(!t.s)return void(t.o=Oe.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(Oe.bind(null,e,r),Oe.bind(null,e,2));e.s=r,e.v=t;var n=e.o;n&&n(e)}}const _e=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){const n=new e,o=this.s;if(o){const e=1&o?r:t;if(e){try{Oe(n,1,e(this.v))}catch(e){Oe(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?Oe(n,1,r?r(o):o):t?Oe(n,1,t(o)):Oe(n,2,o)}catch(e){Oe(n,2,e)}},n},e}();function qe(e){return e instanceof _e&&1&e.s}var Te=new(/*#__PURE__*/function(){function e(){this.serverClass=de,this.clusterClass=pe}var r=e.prototype;return r.runtime=function(e){return function(e){try{var r,t,n,o,s,i,a,u=ne.default(D.hideBin(process.argv)).usage("Como usar: \n            node $0 [options] \n            \n            ** Si no se especifican parámetros el servidor arrancará normalmente. **").alias("g","generateKeys").describe("g","Genera unas claves para la aplicación").alias("c","encrypt").describe("c","Codifica el String proporcionado en base a la contraseña de .env").nargs("c",1).help("h").alias("h","help"),c=[];if(e)for(t=ue(e);!(n=t()).done;)u.alias((o=n.value).key,o.alias),o.describe&&u.describe(o.key,o.describe),0!==o.nargs&&u.nargs(o.key,o.nargs),o.boolean&&u.boolean(o.key),o.choices&&u.choices(o.key,o.choices),o.required&&c.push(o.key);0!==c.length&&u.demandOption(c);var l=u.argv;return l.generateKeys?(console.log("Generando claves para encriptación:"),console.log(ce.generateKeys()),Promise.resolve(process.exit(1))):l.encrypt?(console.log("Resultado encryptación:"),console.log(ce.encrypt(l.encrypt)),Promise.resolve(process.exit(1))):Promise.resolve(function(){if(e)return s=ue(e),function(e,r,t){for(var n;;){var o=e();if(qe(o)&&(o=o.v),!o)return s;if(o.then){n=0;break}var s=t();if(s&&s.then){if(!qe(s)){n=1;break}s=s.s}}var i=new _e,a=Oe.bind(null,i,2);return(0===n?o.then(c):1===n?s.then(u):(void 0).then(function(){(o=e())?o.then?o.then(c).then(void 0,a):c(o):Oe(i,1,s)})).then(void 0,a),i;function u(r){s=r;do{if(!(o=e())||qe(o)&&!o.v)return void Oe(i,1,s);if(o.then)return void o.then(c).then(void 0,a);qe(s=t())&&(s=s.v)}while(!s||!s.then);s.then(u).then(void 0,a)}function c(e){e?(s=t())&&s.then?s.then(u).then(void 0,a):u(s):Oe(i,1,s)}}(function(){return!r&&!(i=s()).done},0,function(){return a=i.value,function(){if(l[a.key])return Promise.resolve(a.fn(l)).then(function(){var e=process.exit(1);return r=1,e})}()})}())}catch(e){return Promise.reject(e)}}(e)},r.init=function(e){try{var r=function(){var r=new t.serverClass(e,t.statics,t.routes);return t.customizeExpress&&(r.customizeExpress=t.customizeExpress),t.beforeListen&&(r.beforeListen=t.beforeListen),t.afterListen&&(r.afterListen=t.afterListen),t.events=new ve(t),t.i18n=new le,Promise.resolve(t.i18n.load()).then(function(){t.server=new t.clusterClass(t),t.server.setServerCls(r),t.server.executeOnlyMain=function(){t.executeOnlyMain&&t.executeOnlyMain(),"true"==process.env.REPL_ENABLED&&t.startRepl()}})},t=this,n=function(){if("true"!=process.env.DISABLE_LOGGER)return Promise.resolve(we.configure()).then(function(){})}();return Promise.resolve(n&&n.then?n.then(r):r())}catch(e){return Promise.reject(e)}},r.start=function(){try{if(!this.server)throw new Error("Call init first");return Promise.resolve(this.server.start()).then(function(){})}catch(e){return Promise.reject(e)}},r.startRepl=function(){var e=this;try{re.default.createServer(function(r){var t=te.default.start({prompt:"lisco::remote> ",input:r,output:r,terminal:!0,useColors:!0,preview:!1});t.context.app=e,t.context.Utils=ce,t.context.db=ke.connection,t.on("exit",r.end.bind(r))}).listen(process.env.REPL_PORT||5001)}catch(e){console.log("Remote REPL Conn: "+e)}console.log("Remote REPL started on port "+(process.env.REPL_PORT||5001))},e}());e.App=Te,e.AuthController=be,e.BaseController=Le,e.BaseKnexDao=xe,e.BaseService=De,e.ClusterServer=pe,e.CookieAuthHandler=Se,e.EventHandler=ve,e.I18nLoader=le,e.IAuthHandler=Pe,e.IUserDao=Re,e.JsonResponse=fe,e.JwtAuthHandler=Ee,e.KnexConnector=ke,e.KnexFilterParser=je,e.Logger=we,e.Server=de,e.TokenGenerator=he,e.Utils=ce});
//# sourceMappingURL=lisco.umd.js.map
