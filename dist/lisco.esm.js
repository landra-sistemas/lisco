import e from"helmet";import r from"express";import t from"compression";import n from"cors";import o from"express-fileupload";import s from"url";import i from"lodash";import a from"fs";import c from"util";import u from"crypto";import l from"chokidar";import f from"jsonwebtoken";import*as p from"uuid";import v from"http";import h from"https";import d from"path";import m from"cluster";import{Server as y}from"socket.io";import w from"os";import{EventEmitter as g}from"events";import b from"cluster-messages";import P from"log4js";import{pathToRegexp as E}from"path-to-regexp";import S from"moment";import{FQLParser as j,KnexParser as k}from"@landra_sistemas/fql-parser";import R from"knex";import x from"net";import L from"repl";import A from"yargs/yargs";import{hideBin as D}from"yargs/helpers";function _(){return _=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},_.apply(this,arguments)}function O(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,N(e,r)}function N(e,r){return N=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,r){return e.__proto__=r,e},N(e,r)}function I(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function T(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return I(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?I(e,r):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var C=/*#__PURE__*/function(){function e(){}return e.arrayToLower=function(e){return e.join("~").toLowerCase().split("~")},e.replaceAll=function(e,r,t){return e.replace(new RegExp(r.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),t)},e.encrypt=function(e){var r=Buffer.from(process.env.CRYPT_SECRET,"hex"),t=Buffer.from(process.env.CRYPT_IV,"hex"),n=u.createCipheriv("aes-256-cbc",r,t),o=n.update(e);return(o=Buffer.concat([o,n.final()])).toString("hex")},e.decrypt=function(e){var r=Buffer.from(process.env.CRYPT_SECRET,"hex"),t=Buffer.from(process.env.CRYPT_IV,"hex"),n=Buffer.from(e,"hex"),o=u.createDecipheriv("aes-256-cbc",r,t),s=o.update(n);return(s=Buffer.concat([s,o.final()])).toString()},e.sleep=function(e){return c.promisify(setTimeout)(e)},e.generateKeys=function(){return{key:u.randomBytes(32).toString("hex"),iv:u.randomBytes(16).toString("hex")}},e.flattenObject=function(r){var t,n={};for(var o in r)if(r.hasOwnProperty(o))if(r[o]&&Array===r[o].constructor)n[o]=r[o];else if("object"==typeof r[o])for(var s in t=e.flattenObject(r[o]))t.hasOwnProperty(s)&&(t[s]&&Array===t.constructor||(n[o+(isNaN(s)?"."+s:"")]=t[s]));else n[o]=r[o];return n},e.unflatten=function(e){var r={};for(var t in e){var n=t.split(".");n.reduce(function(r,o,s){return r[o]||(r[o]=isNaN(Number(n[s+1]))?n.length-1==s?e[t]:{}:[])},r)}return r},e.expressHandler=function(){return function(e){return function(){var r=[].slice.call(arguments),t=e.apply(void 0,r),n=r[r.length-1];return Promise.resolve(t).catch(function(e){return n(e)})}}},e}(),F=/*#__PURE__*/function(){function e(){this.watcher={}}var r=e.prototype;return r.load=function(e){try{var r=this,t=e||process.env.DEFAULT_LANG;r.currentData||(r.currentData={}),r.currentDataFlat||(r.currentDataFlat={});var n=process.cwd()+"/i18n/lang_"+t+".json";return r.watcher[t]=l.watch(n,{ignored:/(^|[/\\])\../,persistent:!0}),r.watcher[t].on("change",function(e){return r.loadFile(e,t)}),Promise.resolve(r.loadFile(n,t)).then(function(){})}catch(e){return Promise.reject(e)}},r.loadFile=function(e,r){try{var t=this,n=c.promisify(a.readFile);return Promise.resolve(function(o,s){try{var i=Promise.resolve(n(e,"utf8")).then(function(e){var n=JSON.parse(e);t.currentDataFlat[r]=C.flattenObject(n),t.currentData[r]=n})}catch(e){return s(e)}return i&&i.then?i.then(void 0,s):i}(0,function(e){if("ENOENT"===(null==e?void 0:e.code))return console.log("Lang file does not exist. Create it on ./i18n/lang_{xx}.json");console.error(e)}))}catch(e){return Promise.reject(e)}},r.translate=function(e,r){try{var t,n=function(r){return t?r:"undefined."+e},o=this;if(r||(r=process.env.DEFAULT_LANG),o.currentDataFlat&&o.currentDataFlat[r]&&o.currentDataFlat[r][e])return Promise.resolve(o.currentData[r][e]);var s=function(){if(!o.currentDataFlat||!o.currentDataFlat[r])return Promise.resolve(o.load(r)).then(function(){if(o.currentDataFlat&&o.currentDataFlat[r]&&o.currentDataFlat[e])return t=1,o.currentDataFlat[r][e]})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e}(),U=/*#__PURE__*/function(){function e(e,r,t,n){this.data=r,this.success=e,this.total=n,this.message=t||""}return e.prototype.toJson=function(){return this},e}(),B=/*#__PURE__*/function(){function e(e,r){this.privateKey=e,this.options=r}var r=e.prototype;return r.sign=function(e){var r=_({},this.options,{jwtid:p.v4()});return f.sign(e,this.privateKey,r)},r.verify=function(e){return f.verify(e,this.privateKey,this.options)},r.refresh=function(e){var r=f.verify(e,this.privateKey,this.options);delete r.sub,delete r.iss,delete r.aud,delete r.iat,delete r.exp,delete r.nbf,delete r.jti;var t=_({},this.options,{jwtid:p.v4()});return f.sign(r,this.privateKey,t)},e}(),J=/*#__PURE__*/function(){function a(e,t,n){this.app=r(),this.express_config=i.defaultsDeep(e,{helmet:!0,json:!0,urlencoded:!0,compression:!0,cors:{origin:!0,credentials:!0},fileupload:!0,socketio:{transports:["websocket"]},traceRequests:!1}),this.statics=t,this.routes=n}var c=a.prototype;return c.initialize=function(){try{var e=function(){return Promise.resolve(r.configureRoutes(r.routes)).then(function(){return Promise.resolve(r.errorHandler()).then(function(){})})},r=this;r.config(r.express_config);var t=function(){if(r.customizeExpress)return Promise.resolve(r.customizeExpress(r.app)).then(function(){})}();return Promise.resolve(t&&t.then?t.then(e):e())}catch(e){return Promise.reject(e)}},c.customizeExpress=function(){},c.config=function(a){if(a&&a.helmet&&this.app.use(e(a&&i.isObject(a.helmet)&&a.helmet)),a&&a.json&&this.app.use(r.json()),a&&a.urlencoded&&this.app.use(r.urlencoded({extended:!0})),a&&a.compression&&this.app.use(t()),a&&a.cors&&(this.app.options("*",n(a&&i.isObject(a.cors)&&a.cors)),this.app.use(n(a&&i.isObject(a.cors)&&a.cors))),a&&a.fileupload&&this.app.use(o()),this.statics)for(var c in this.statics)this.app.use(c,r.static(this.statics[c]));a&&!0===a.traceRequests&&"true"!=process.env.DISABLE_LOGGER&&this.app.use(function(e,r,t){e.requestTime=Date.now(),r.on("finish",function(){var r=s.parse(e.url).pathname,t=Date.now()-e.requestTime;console.debug("APIRequest["+process.pid+"]::. ["+e.method+"] (user:"+(e&&e.session&&e.session.user_id||"")+")  "+r+" |-> took: "+t+" ms"),console.debug(JSON.stringify(e.body))}),t()})},c.configureRoutes=function(e){var t=r.Router();this.app.use(t),this.loadRoutes(this.app,e)},c.loadRoutes=function(e,r){if(r)for(var t,n=T(r);!(t=n()).done;){var o=t.value;if(o){var s=o.configure();if(o.entity&&(s=o.configure(o.entity,{service:o.service,table:o.table})),!i.isEmpty(o.routes)){var a=C.expressHandler();for(var c in o.routes){var u=o.routes[c];for(var l in u){var f=u[l];Array.isArray(f)?s[l](c,f[0],a(f[1])):s[l](c,a(f))}}}s&&e.use(s)}else console.warn("Empty route")}},c.errorHandler=function(){this.app.use(function(e,r,t,n){var o=new U;o.success=!1,o.message=e.message,console.error(e),t.status(500).json(o.toJson())})},a}(),z=/*#__PURE__*/function(e){function r(r){var t;return t=e.call(this)||this,process.env.PORT||console.log("Using 3000 as default port. Customize via env PORT."),t.port=t.normalizePort(process.env.PORT||3e3),t.clustered=process.env.CLUSTERED,t.workers=[],t.app=r,t.executeOnlyMain=function(){},t}O(r,e);var t=r.prototype;return t.setServerCls=function(e){this.server=e},t.start=function(){try{var e=this,r=function(){if("true"!=e.clustered)return e.configureSocketIO(),e.executeOnlyMain(),Promise.resolve(e.initUnclustered()).then(function(){});e.initClustered()}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.configureSocketIO=function(){this.server.express_config&&this.server.express_config.socketio&&(this.app.io=new y(this.server.express_config&&this.server.express_config.socketio),this.app.io.listen(this.port+1))},t.initClustered=function(){try{var e=this,r=function(){if(!m.isPrimary)return Promise.resolve(e.initUnclustered()).then(function(){console.log("Worker "+process.pid+" started")});e.configureSocketIO(),e.executeOnlyMain(),(new b).on("event",function(r,t){r&&r.event&&(1==process.env.DEBUG_EVENTS&&console.debug("Received '"+r.event+"' from "+r.props.owner+" at Master"),e.app.events.emit(r.event,r.props,t))});for(var r=w.cpus().length,t=0;t<r;t+=1)e.initWorker();m.on("exit",function(r){console.log("Worker "+r.id+" died :("),e.initWorker()})}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.initWorker=function(){var e=m.fork();console.log("Running worker "+e.process.pid),this.workers.push(e)},t.initUnclustered=function(){try{var e=this;e.server.port=e.port;var r=v.Server(e.server.app);return Promise.resolve(e.server.initialize()).then(function(){function t(){function t(){if(r.on("error",function(r){e.handleErrors(r,e.server.port)}),r.on("listening",function(){console.log("Server Worker running on port: "+e.port+"!"),e.emit("listening",e.port)}),process.env.SSL&&"true"==process.env.SSL){process.env.SSL_KEY&&process.env.SSL_CERT&&process.env.SSL_PASS||(console.error("Invalid SSL configuration. SLL_KEY, SSL_CERT and SSL_PASS needed"),process.exit(0));var t={key:a.readFileSync(d.resolve(process.cwd(),process.env.SSL_KEY||"key.pem")),cert:a.readFileSync(d.resolve(process.cwd(),process.env.SSL_CERT||"cert.pem")),passphrase:process.env.SSL_PASS};process.env.SSL_PORT||console.log("Using 3443 as ssl default port. Customize via env SSL_PORT.");var n=e.normalizePort(process.env.SSL_PORT||3443),o=h.createServer(t,e.server.app);o.listen(n),o.on("error",function(r){e.handleErrors(r,n)}),o.on("listening",function(){console.log("Server Worker running on port: "+n+"!"),e.emit("listening_ssl",n)})}}r.listen(e.server.port);var n=function(){if(e.server.afterListen)return Promise.resolve(e.server.afterListen()).then(function(){})}();return n&&n.then?n.then(t):t()}var n=function(){if(e.server.beforeListen)return Promise.resolve(e.server.beforeListen()).then(function(){})}();return n&&n.then?n.then(t):t()})}catch(e){return Promise.reject(e)}},t.normalizePort=function(e){var r=parseInt(e,10);return isNaN(r)?e:r>=0&&r},t.handleErrors=function(e,r){if("listen"!==e.syscall)throw e;var t="string"==typeof r?"Pipe "+r:"Port "+r;switch(e.code){case"EACCES":console.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(t+" is already in use"),process.exit(1);break;default:throw e}},r}(g),G=/*#__PURE__*/function(e){function r(r){var t;return(t=e.call(this)||this).messages=new b,t.app=r,m.isWorker&&t.messages.on("event",function(r,n){r&&r.event&&process.pid!==r.props.owner&&(1==process.env.DEBUG_EVENTS&&console.debug("Receiving broadcast "+r.event+" - "+process.pid),e.prototype.emit.call(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t),r.event,_({},r.props),n))}),t}return O(r,e),r.prototype.emit=function(r,t,n){e.prototype.emit.call(this,r,t,n),r&&t&&m.isWorker&&process.pid!==t.owner&&(1==process.env.DEBUG_EVENTS&&console.debug(r+" -> Firing from "+process.pid+" to master"),t||(t={}),t.owner=process.pid,this.messages.send("event",{event:r,props:_({},t)},n)),r&&t&&m.isPrimary&&this.app&&this.app.server&&this.app.server.workers&&(1==process.env.DEBUG_EVENTS&&console.debug(r+" -> Firing from master to workers"),this.messages.send("event",{event:r,props:_({},t)},n))},r}(g),K=P.configure,q=P.getLogger,H=/*#__PURE__*/function(){function e(){}return e.configure=function(){try{var e=c.promisify(a.readFile);return Promise.resolve(e(d.resolve(process.cwd(),"./log4js.json"),"utf8")).then(function(e){var r,t,n;K(JSON.parse(e)),r=q("log"),t=q("error"),n=q("debug"),console.log=function(){var e=Array.prototype.slice.call(arguments);r.log("info",e[0])},console.error=function(){var e=Array.prototype.slice.call(arguments);t.log("error",e[0])},console.info=function(){var e=Array.prototype.slice.call(arguments);r.log("info",e[0])},console.debug=function(){var e=Array.prototype.slice.call(arguments);n.log("debug",e[0])},console.custom=function(e,r,t){q(e).log(r,t)}})}catch(e){return Promise.reject(e)}},e}();function W(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var M=/*#__PURE__*/function(){function e(e,t){this.router=r.Router(),this.publicPathsList=[].concat(e,["/login"]),this.AuthHandler=t}var t=e.prototype;return t.configure=function(){var e=this,r=C.expressHandler();return this.router.use(r(function(){return e.check.apply(e,[].slice.call(arguments))})),this.router.post("/login",r(function(){return e.loginPost.apply(e,[].slice.call(arguments))})),this.router.post("/logout",r(function(){return e.logout.apply(e,[].slice.call(arguments))})),this.router},t.check=function(e,r,t){try{var n=this;return Promise.resolve(W(function(){for(var o,i=T(n.publicPathsList);!(o=i()).done;)if(null!==E(o.value).exec(s.parse(e.url).pathname))return t();return Promise.resolve(n.AuthHandler.check(e)).then(function(e){return e?t():r.status(403).json(new U(!1,null,"Forbidden").toJson())})},function(e){return console.error(e),r.status(403).json(new U(!1,null,"Forbidden").toJson())}))}catch(e){return Promise.reject(e)}},t.loginPost=function(e,r){try{var t,n=function(e){return t?e:r.status(401).json(new U(!1,null,"Unauthorized - Missing parameters").toJson())},o=this,s=function(){if(e.body.username)return W(function(){return Promise.resolve(o.AuthHandler.validate(e,e.body.username,e.body.password)).then(function(e){if(e){var n=r.status(200).json(new U(!0,e).toJson());return t=1,n}var o=r.status(401).json(new U(!1,null,"Unauthorized - Incorrect credentials").toJson());return t=1,o})},function(e){console.error(e);var n=r.status(401).json(new U(!1,null,"Unauthorized - Error, check log").toJson());return t=1,n})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},t.logout=function(e,r){try{var t,n=function(e){return t?e:r.status(200).json(new U(!0).toJson())},o=this,s=function(){if(o.AuthHandler.logout)return W(function(){return Promise.resolve(o.AuthHandler.logout(e)).then(function(){var e=r.status(200).json(new U(!0).toJson());return t=1,e})},function(e){console.error(e);var n=r.status(500).json(new U(!1,null,e).toJson());return t=1,n})}();return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},e}(),Y=function(){if(!this.check)throw new Error("AuthHandler must have 'check' vethod");if(!this.validate)throw new Error("AuthHandler must have 'validate' vethod")},V=/*#__PURE__*/function(e){function r(r){var t;if((t=e.call(this)||this).tokenGenerator=new B(process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE,issuer:process.env.JWT_ISSUER,subject:process.env.JWT_SUBJECT,algorithm:process.env.JWT_ALGORITHM,expiresIn:process.env.JWT_EXPIRES}),!r)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return t.userDao=r,t}O(r,e);var t=r.prototype;return t.check=function(e){try{if(e.headers.authorization){var r=(e.headers.authorization||"").split(" ")[1]||"";if(!r)return console.error("Token needed"),Promise.resolve(!1);try{var t=this.tokenGenerator.verify(r);return t.sub&&t.username&&!S(t.exp).isAfter(new Date)?(e.session=_({},e.session,t),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return console.error(e),Promise.resolve(!1)}}return Promise.resolve(!1)}catch(e){return Promise.reject(e)}},t.validate=function(e,r,t){try{var n=this;return Promise.resolve(n.userDao.findByUsername(r)).then(function(e){return!(!e||e.username!==r||e.password!==C.encrypt(t))&&n.tokenGenerator.sign(i.omit(e,["password"]))})}catch(e){return Promise.reject(e)}},r}(Y),$=/*#__PURE__*/function(e){function r(r){var t;if(t=e.call(this)||this,!r)throw new Error("Need 'UserDao' for user validation. Create 'UserDao' class extending 'IUserDao'");return t.userDao=r,t}O(r,e);var t=r.prototype;return t.check=function(e){try{var r,t=function(t){return r?t:!(!e.session||!e.session.username)},n=this,o=function(){if(e.headers.authorization){var t=(e.headers.authorization||"").split(" ")[1]||"",o=Buffer.from(t,"base64").toString().split(":");return Promise.resolve(n.validate(e,o[0],o[1])).then(function(e){return e?r=!0:(r=1,!1)})}}();return Promise.resolve(o&&o.then?o.then(t):t(o))}catch(e){return Promise.reject(e)}},t.validate=function(e,r,t){try{return Promise.resolve(this.userDao.findByUsername(r)).then(function(n){return!(!n||n.username!==r||n.password!==C.encrypt(t)||(e.session=_({},e.session,i.omit(n,["password"])),0))})}catch(e){return Promise.reject(e)}},t.logout=function(e){return new Promise(function(r){e.session&&e.session.destroy(r)})},r}(Y),Q=new(/*#__PURE__*/function(){function e(){}var r=e.prototype;return r.init=function(e){this.connection=R(e)},r.setColumnAliases=function(e){this.columnAliases=e},r.test=function(){return this.connection.raw("select 1+1 as result")},e}()),X=/*#__PURE__*/function(){function e(){}return e.parseQueryString=function(e,r,t){var n={allowGlobalSearch:!0,caseInsensitive:!0};Q.columnAliases&&Q.columnAliases[t]&&(n.aliases=Q.columnAliases[t]),void 0!==Q.caseInsensitive&&(n.caseInsensitive=Q.caseInsensitive),void 0!==Q.allowGlobalSearch&&(n.allowGlobalSearch=Q.allowGlobalSearch);var o=new j(n).parse(r);return new k(t).toKnex(e,o)},e.parseFilters=function(r,t,n){var o=r;for(var s in t){var i=t[s];if("object"==typeof i)switch(i.type){case"fql":o=e.parseQueryString(o,i.value,n);break;case"date":case"between":i.start&&i.end&&(o=o.whereBetween(s,[i.start,i.end])),i.start&&!i.end&&(o=o.where(s,">=",i.start)),!i.start&&i.end&&(o=o.where(s,">=",i.end));break;case"dateraw":case"betweenraw":i.start&&i.end&&(o=o.whereRaw(s+" BETWEEN ? AND ?",[i.start,i.end])),i.start&&!i.end&&(o=o.whereRaw(s+" >= ?",[i.start])),!i.start&&i.end&&(o=o.whereRaw(s+" >= ?",[i.end]));break;case"jsonb":o=o.whereRaw(s+" ILIKE ?",["%"+i.value+"%"]);break;case"full-text-psql":o=o.whereRaw("to_tsvector("+s+"::text) @@ to_tsquery(?)",[i.value]);break;case"greater":case"greaterraw":o=o.whereRaw(s+" > ?",[i.value]);break;case"greaterEq":case"greaterEqraw":o=o.whereRaw(s+" >= ?",[i.value]);break;case"less":case"lessraw":o=o.whereRaw(s+" < ?",[i.value]);break;case"lessEq":case"lessEqraw":o=o.whereRaw(s+" <= ?",[i.value]);break;case"exists":o=o.whereExists(s);break;case"notexists":o=o.whereNotExists(s);break;case"exact":case"exactraw":o=o.whereRaw(s+" = ?",[i.value]);break;case"in":var a=s;a.includes(",")&&(a=s.split(",")),Array.isArray(i.value)||null==i.value?null!=i.value&&(o=o.whereIn(a,i.value)):o=o.whereIn(a,i.value.split(","));break;case"inraw":Array.isArray(i.value)||null==i.value?null!=i.value&&(o=o.whereRaw(s+" IN (?)",[i.value.map(function(e){return"'"+e+"'"}).join(",")])):o=o.whereRaw(s+" IN (?)",[i.value.split(",").map(function(e){return"'"+e+"'"}).join(",")]);break;case"not":case"notraw":o=o.whereRaw(s+" != ?",[i.value]);break;case"like":case"likeraw":var c=C.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" LIKE ?",[c]);break;case"notlike":case"notlikeraw":var u=C.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" NOT LIKE ?",[u]);break;case"likeI":var l=C.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" ILIKE ?",[l]);break;case"notlikeI":var f=C.replaceAll(i.value,"*","%");o=o.whereRaw(" "+s+" NOT ILIKE ?",[f]);break;case"null":case"nullraw":o=o.whereRaw(s+" is NULL");break;case"notnull":case"notnullraw":o=o.whereRaw(s+" is not NULL")}else o=o.where(s,i)}return o},e.parseSort=function(e){if(!e.field||!e.direction)return 1;var r="ASC";return"descend"===e.direction&&(r="DESC"),e.field+" "+r},e}(),Z=/*#__PURE__*/function(){function e(){this.tableName=""}var r=e.prototype;return r.loadAllData=function(e,r){return Q.connection.select("*").from(this.tableName).limit(r||1e4).offset(e)},r.loadFilteredData=function(e,r,t){try{var n=this,o=1;return e.sort&&(o=X.parseSort(e.sort)),Promise.resolve(Q.connection.from(n.tableName).where(function(r){return X.parseFilters(r,i.omit(e,["sort","start","limit"]),n.tableName)}).orderByRaw(o).limit(t).offset(r))}catch(e){return Promise.reject(e)}},r.countFilteredData=function(e){try{var r=this;return Promise.resolve(Q.connection.from(r.tableName).where(function(t){return X.parseFilters(t,i.omit(e,["sort","start","limit"]),r.tableName)}).count("id",{as:"total"})).then(function(e){return e&&e[0].total})}catch(e){return Promise.reject(e)}},r.loadById=function(e){try{return Promise.resolve(Q.connection.from(this.tableName).where("id",e)).then(function(e){return e&&e[0]?e[0]:null})}catch(e){return Promise.reject(e)}},r.save=function(e){return Q.connection.from(this.tableName).insert(e).returning("*")},r.update=function(e,r){return Q.connection.from(this.tableName).where("id",e).update(r).returning("*")},r.delete=function(e){try{var r=this;return Promise.resolve(r.loadById(e)).then(function(t){if(!t)throw"NotFound";return Q.connection.from(r.tableName).where("id",e).delete()})}catch(e){return Promise.reject(e)}},e}(),ee=/*#__PURE__*/function(e){function r(r){var t;if(!(t=e.call(this,r)||this).findByUsername)throw new Error("AuthHandler must have 'findByUsername' method");return t}return O(r,e),r}(Z);function re(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var te=/*#__PURE__*/function(){function e(){this.router=r.Router(),this.routes={}}var t=e.prototype;return t.configure=function(e,r){var t=this;if(!e)return this.router;var n=C.expressHandler();return this.router.get("/"+e,n(function(){return t.listEntidad.apply(t,[].slice.call(arguments))})),this.router.post("/"+e+"/list",n(function(){return t.listEntidad.apply(t,[].slice.call(arguments))})),this.router.get("/"+e+"/:id",n(function(){return t.getEntidad.apply(t,[].slice.call(arguments))})),this.router.post("/"+e,n(function(){return t.saveEntidad.apply(t,[].slice.call(arguments))})),this.router.put("/"+e+"/:id",n(function(){return t.updateEntidad.apply(t,[].slice.call(arguments))})),this.router.delete("/"+e+"/:id",n(function(){return t.deleteEntidad.apply(t,[].slice.call(arguments))})),this.service=r.service,this.table=r.table,this.router},t.listEntidad=function(e,r,t){try{var n=this,o=re(function(){var t=new n.service(null,n.table),o="POST"===e.method?e.body:e.query&&e.query.filters?JSON.parse(e.query.filters):{};return Promise.resolve(t.list(o,o.start,o.limit)).then(function(e){var t=new U(!0,e.data,null,e.total);r.json(t.toJson())})},function(e){t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.getEntidad=function(e,r,t){try{var n=this,o=re(function(){var t=new n.service(null,n.table);return Promise.resolve(t.loadById(e.params.id)).then(function(e){var t=new U(!0,e),n=200;null==e&&(n=404,t=new U(!1,null,"Element not found",0)),r.status(n).json(t.toJson())})},function(e){console.error(e);var t="";"22P02"==e.code&&(t="Expected uiid");var n=new U(!1,null,t,0);r.status(400).json(n.toJson())});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.saveEntidad=function(e,r,t){try{var n=this,o=re(function(){var t=new n.service(null,n.table);return Promise.resolve(t.save(e.body)).then(function(t){var n=new U(!0,t&&t[0]||{id:e.body.id});r.setHeader("Location","/entity/"+n.data.id),r.status(201).json(n.toJson())})},function(e){t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.updateEntidad=function(e,r,t){try{var n=this,o=re(function(){var t=new n.service(null,n.table);return Promise.resolve(t.update(e.params.id,e.body)).then(function(t){var n=new U(!0,t&&t[0]||{id:e.body.id});r.json(n.toJson())})},function(e){t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.deleteEntidad=function(e,r,t){try{var n=this,o=re(function(){var t=new n.service(null,n.table);return Promise.resolve(t.delete(e.params.id)).then(function(e){var t=new U(!0,e);r.status(204).json(t.toJson())})},function(e){if(console.error(e),"NotFound"==e){var n=new U(!1,null,"Element not found",0);r.status(404).json(n.toJson())}else t(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}(),ne=/*#__PURE__*/function(){function e(e,r){this.dao=e?new e:new Z,r&&(this.dao.tableName=r)}var r=e.prototype;return r.list=function(e,r,t){try{var n=this,o=r||0,s=t||1e3,i={};return Promise.resolve(n.dao.countFilteredData(e,o,s)).then(function(a){var c;function u(e){return c?e:Promise.resolve(n.dao.loadAllData(r,t)).then(function(e){return i.data=e,i})}i.total=a;var l=function(){if(e&&0!==Object.keys(e).length)return Promise.resolve(n.dao.loadFilteredData(e,o,s)).then(function(e){return i.data=e,c=1,i})}();return l&&l.then?l.then(u):u(l)})}catch(e){return Promise.reject(e)}},r.loadById=function(e){return this.dao.loadById(e)},r.save=function(e){return this.dao.save(e)},r.update=function(e,r){if(e)return this.dao.update(e,r)},r.delete=function(e){if(e)return this.dao.delete(e)},e}();function oe(e,r,t){if(!e.s){if(t instanceof se){if(!t.s)return void(t.o=oe.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(oe.bind(null,e,r),oe.bind(null,e,2));e.s=r,e.v=t;var n=e.o;n&&n(e)}}const se=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){const n=new e,o=this.s;if(o){const e=1&o?r:t;if(e){try{oe(n,1,e(this.v))}catch(e){oe(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?oe(n,1,r?r(o):o):t?oe(n,1,t(o)):oe(n,2,o)}catch(e){oe(n,2,e)}},n},e}();function ie(e){return e instanceof se&&1&e.s}var ae=new(/*#__PURE__*/function(){function e(){this.serverClass=J,this.clusterClass=z}var r=e.prototype;return r.runtime=function(e){return function(e){try{var r,t,n,o,s,i,a,c=A(D(process.argv)).usage("Como usar: \n            node $0 [options] \n            \n            ** Si no se especifican parámetros el servidor arrancará normalmente. **").alias("g","generateKeys").describe("g","Genera unas claves para la aplicación").alias("c","encrypt").describe("c","Codifica el String proporcionado en base a la contraseña de .env").nargs("c",1).help("h").alias("h","help"),u=[];if(e)for(t=T(e);!(n=t()).done;)c.alias((o=n.value).key,o.alias),o.describe&&c.describe(o.key,o.describe),0!==o.nargs&&c.nargs(o.key,o.nargs),o.boolean&&c.boolean(o.key),o.choices&&c.choices(o.key,o.choices),o.required&&u.push(o.key);0!==u.length&&c.demandOption(u);var l=c.argv;return l.generateKeys?(console.log("Generando claves para encriptación:"),console.log(C.generateKeys()),Promise.resolve(process.exit(1))):l.encrypt?(console.log("Resultado encryptación:"),console.log(C.encrypt(l.encrypt)),Promise.resolve(process.exit(1))):Promise.resolve(function(){if(e)return s=T(e),function(e,r,t){for(var n;;){var o=e();if(ie(o)&&(o=o.v),!o)return s;if(o.then){n=0;break}var s=t();if(s&&s.then){if(!ie(s)){n=1;break}s=s.s}}var i=new se,a=oe.bind(null,i,2);return(0===n?o.then(u):1===n?s.then(c):(void 0).then(function(){(o=e())?o.then?o.then(u).then(void 0,a):u(o):oe(i,1,s)})).then(void 0,a),i;function c(r){s=r;do{if(!(o=e())||ie(o)&&!o.v)return void oe(i,1,s);if(o.then)return void o.then(u).then(void 0,a);ie(s=t())&&(s=s.v)}while(!s||!s.then);s.then(c).then(void 0,a)}function u(e){e?(s=t())&&s.then?s.then(c).then(void 0,a):c(s):oe(i,1,s)}}(function(){return!r&&!(i=s()).done},0,function(){return a=i.value,function(){if(l[a.key])return Promise.resolve(a.fn(l)).then(function(){var e=process.exit(1);return r=1,e})}()})}())}catch(e){return Promise.reject(e)}}(e)},r.init=function(e){try{var r=function(){var r=new t.serverClass(e,t.statics,t.routes);return t.customizeExpress&&(r.customizeExpress=t.customizeExpress),t.beforeListen&&(r.beforeListen=t.beforeListen),t.afterListen&&(r.afterListen=t.afterListen),t.events=new G(t),t.i18n=new F,Promise.resolve(t.i18n.load()).then(function(){t.server=new t.clusterClass(t),t.server.setServerCls(r),t.server.executeOnlyMain=function(){t.executeOnlyMain&&t.executeOnlyMain(),"true"==process.env.REPL_ENABLED&&t.startRepl()}})},t=this,n=function(){if("true"!=process.env.DISABLE_LOGGER)return Promise.resolve(H.configure()).then(function(){})}();return Promise.resolve(n&&n.then?n.then(r):r())}catch(e){return Promise.reject(e)}},r.start=function(){try{if(!this.server)throw new Error("Call init first");return Promise.resolve(this.server.start()).then(function(){})}catch(e){return Promise.reject(e)}},r.startRepl=function(){var e=this;try{x.createServer(function(r){var t=L.start({prompt:"lisco::remote> ",input:r,output:r,terminal:!0,useColors:!0,preview:!1});t.context.app=e,t.context.Utils=C,t.context.db=Q.connection,t.on("exit",r.end.bind(r))}).listen(process.env.REPL_PORT||5001)}catch(e){console.log("Remote REPL Conn: "+e)}console.log("Remote REPL started on port "+(process.env.REPL_PORT||5001))},e}());export{ae as App,M as AuthController,te as BaseController,Z as BaseKnexDao,ne as BaseService,z as ClusterServer,$ as CookieAuthHandler,G as EventHandler,F as I18nLoader,Y as IAuthHandler,ee as IUserDao,U as JsonResponse,V as JwtAuthHandler,Q as KnexConnector,X as KnexFilterParser,H as Logger,J as Server,B as TokenGenerator,C as Utils};
//# sourceMappingURL=lisco.esm.js.map
